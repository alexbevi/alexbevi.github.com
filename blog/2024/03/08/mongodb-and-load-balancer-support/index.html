<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="MongoDB and Load Balancer Support" /><meta property="og:locale" content="en" /><meta name="description" content="Overview" /><meta property="og:description" content="Overview" /><link rel="canonical" href="https://www.alexbevi.com/blog/2024/03/08/mongodb-and-load-balancer-support/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2024/03/08/mongodb-and-load-balancer-support/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content=" https://www.alexbevi.com/images/mongodb-logo.png " /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-03-08T08:37:25-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content=" https://www.alexbevi.com/images/mongodb-logo.png " /><meta property="twitter:title" content="MongoDB and Load Balancer Support" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-05-02T05:29:16-04:00","datePublished":"2024-03-08T08:37:25-05:00","description":"Overview","headline":"MongoDB and Load Balancer Support","image":" https://www.alexbevi.com/images/mongodb-logo.png ","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2024/03/08/mongodb-and-load-balancer-support/"},"url":"https://www.alexbevi.com/blog/2024/03/08/mongodb-and-load-balancer-support/"}</script><title>MongoDB and Load Balancer Support | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="/assets/lib/glightbox/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script defer src="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.umd.min.js"></script> <script defer src="/assets/lib/glightbox/glightbox.min.js"></script> <script defer src="/assets/lib/clipboard/clipboard.min.js"></script> <script defer src="/assets/lib/dayjs/dayjs.min.js"></script> <script defer src="/assets/lib/dayjs/locale/en.js"></script> <script defer src="/assets/lib/dayjs/plugin/relativeTime.js"></script> <script defer src="/assets/lib/dayjs/plugin/localizedFormat.js"></script> <script defer src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script><meta name="google-adsense-account" content="ca-pub-6215800856413580"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src=" /./images/avatar.png " width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ALEX BEVILACQUA</a><p class="site-subtitle fst-italic mb-0">my little corner of the interwebs</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/specifications/" class="nav-link"> <i class="fa-fw fas fa-book"></i> <span>SPECIFICATIONS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>MongoDB and Load Balancer Support</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>MongoDB and Load Balancer Support</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1709905045" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 8, 2024 </time> </span> <span> Updated <time data-ts="1746178156" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 2, 2025 </time> </span><div class="mt-3 mb-3"> <a href=" /images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src=" /images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1946 words" > <em>10 min</em> read </span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">MongoDB and Load Balancer Support</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">MongoDB and Load Balancer Support</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><h2 id="overview"><span class="me-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>A load balancer enhances your application‚Äôs scalability, availability, and performance by efficiently distributing traffic across multiple servers based on a number of <a href="https://kemptechnologies.com/load-balancer/load-balancing-algorithms-techniques">algorithms and techniques</a> - but what about your database? MongoDB is a distributed database, but can it be placed behind a load balancer?</p><p>Astute readers of MongoDB‚Äôs Node.js driver‚Äôs <a href="https://github.com/mongodb/node-mongodb-native/tree/main/test#load-balanced"><code class="language-plaintext highlighter-rouge">test</code> README</a> may have noticed at some point that there is mention of a testing methodology for load balancers, and <a href="https://www.mongodb.com/community/forums/t/load-balancing-mongos/247301">as some in the community have found</a> you can find <a href="https://jira.mongodb.org/browse/SERVER-58502">public <code class="language-plaintext highlighter-rouge">SERVER</code> tickets</a> that also allude to this functionality existing.</p><p>Digging further you‚Äôll find the <a href="https://github.com/mongodb/specifications/blob/master/source/load-balancers/load-balancers.rst"><em>Load Balancer Support</em></a> specification for MongoDB‚Äôs drivers which states <em>‚ÄúTo specify to the driver to operate in load balancing mode, a connection string option of <code class="language-plaintext highlighter-rouge">loadBalanced=true</code> MUST be added to the connection string‚Äù</em> ‚Ä¶ but how do you actually make that work?</p><p>In this post we‚Äôre going to explore why MongoDB nodes couldn‚Äôt previously be placed behind an <a href="https://www.f5.com/glossary/layer-4-load-balancing">L4 load balancer</a>, and what changed in MongoDB 5.3 that may actually make this possible!</p><h3 id="replication"><span class="me-2">Replication</span><a href="#replication" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Coordination of data distribution and ensuring high availability is done via <a href="https://www.mongodb.com/docs/manual/replication/">replication</a>, which requires the cluster to be aware at all times which node is the <a href="https://www.mongodb.com/docs/manual/core/replica-set-members/#primary">primary</a> and which are <a href="https://www.mongodb.com/docs/manual/core/replica-set-members/#secondaries">secondaries</a>.</p><p>As there can only be one primary, any application targeting the cluster will need to be aware of the current topology as well, as trying to write to a secondary will fail:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="nb">require</span> <span class="s1">'mongo'</span>
<span class="c1"># connect directly to a secondary host in a local replica set</span>
<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'mongodb://localhost:27018/test?directConnection=true'</span><span class="p">)</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="ss">:foo</span><span class="p">]</span>
<span class="n">collection</span><span class="p">.</span><span class="nf">insert_one</span> <span class="ss">bar: </span><span class="s2">"baz"</span>

<span class="c1"># =&gt; Mongo::Error::OperationFailure: [10107:NotWritablePrimary]: not primary (on localhost:27018, legacy retry, attempt 1)</span>
</pre></table></code></div></div><p>All official MongoDB drivers implement the <a href="https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst"><em>Server Discovery and Monitoring</em></a> specification to ensure applications can route requests to the appropriate servers (as outlined in the <a href="https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.md"><em>Server Selection</em></a> specification). When you have a single application instance with a single connection pool (as outlined in the <a href="https://github.com/mongodb/specifications/blob/master/source/connection-monitoring-and-pooling/connection-monitoring-and-pooling.md"><em>Connection Monitoring and Pooling</em></a> specification) the number of connections to the cluster is easy to identify, but application deployment configurations can vary and scale.</p><p>Thanks to MongoDB drivers all consistently providing connection monitoring and pooling functionality, external connection pooling solutions aren‚Äôt required (ex: <a href="https://www.pgpool.net/mediawiki/index.php/Main_Page">Pgpool</a>, <a href="https://www.pgbouncer.org/">PgBouncer</a>). This allows applications built using MongoDB drivers to be resilient and scalable out of the box, but based on what we understand regarding <a href="https://alexbevi.com/blog/2023/07/04/how-many-connections-is-my-application-establishing-to-my-mongodb-cluster/">the number of connections applications establish to MongoDB clusters</a> it stands to reason that at a certain point as our application deployments increase, so will our connections.</p><p><strong>Can I use a load balancer though?</strong></p><p>Due to the need for these additional monitoring connections it has been difficult (impossible?) to place a load balancer between applications and a MongoDB replica set - though adventurous users have developed <a href="https://blog.danman.eu/mongodb-haproxy/">some interesting HAProxy configurations</a> in the past to try and solve this problem. The problem you‚Äôd face is that though read requests can be routed to any available server, write requests <em>must</em> target the cluster primary.</p><p>For the sake of argument you may ask <em>‚Äúwhat if I had a 100% read workload?‚Äù</em>. In that case you <em>could</em> put your hosts behind a load balancer, but you‚Äôll likely run into issues as soon as you try and iterate a cursor (see <a href="https://www.mongodb.com/docs/manual/reference/command/getMore/"><code class="language-plaintext highlighter-rouge">getMore</code></a>). Operations such as <a href="https://www.mongodb.com/docs/manual/reference/command/find/"><code class="language-plaintext highlighter-rouge">find</code></a> or <a href="https://www.mongodb.com/docs/manual/reference/command/aggregate/"><code class="language-plaintext highlighter-rouge">aggregate</code></a> return a cursor (<code class="language-plaintext highlighter-rouge">cursorId</code>) which only exists on the originating server the command targeted. Attempting to execute a <code class="language-plaintext highlighter-rouge">getMore</code> on the wrong server will result in a <code class="language-plaintext highlighter-rouge">CursorNotFound</code> error being returned, which can be <a href="https://alexbevi.com/blog/2021/12/29/troubleshooting-mongodb-cursor-xxxxxx-not-found-errors/">challenging to troubleshoot</a>.</p><h3 id="sharding"><span class="me-2">Sharding</span><a href="#sharding" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Fortunately, MongoDB already offers a form of ‚Äúload balancing‚Äù for <a href="https://www.mongodb.com/docs/manual/sharding/#sharded-cluster">sharded clusters</a> in the form of the <a href="https://www.mongodb.com/docs/manual/core/sharded-cluster-query-router/">sharded cluster query router</a> (<code class="language-plaintext highlighter-rouge">mongos</code>).</p><p>Assuming the cluster is sharded and if there is more than one <code class="language-plaintext highlighter-rouge">mongos</code> instance in the <a href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-seed-list">connection seed list</a>, the driver determines which <code class="language-plaintext highlighter-rouge">mongos</code> is the ‚Äúclosest‚Äù (i.e. the member with the lowest average network round-trip-time) and calculates the latency window by adding the average round-trip-time of this ‚Äúclosest‚Äù <code class="language-plaintext highlighter-rouge">mongos</code> instance and the <code class="language-plaintext highlighter-rouge">localThresholdMS</code>. The driver will load balance randomly across the <code class="language-plaintext highlighter-rouge">mongos</code> instances that fall within the latency window.</p><p><strong>Can I use a load balancer though?</strong></p><p>Sharding introduces a routing layer between the application and the cluster members, which slightly simplifies how drivers route operations as there is no longer a need to track replica set state. You may think this would make placing a pool of <code class="language-plaintext highlighter-rouge">mongos</code>‚Äô behind a load balancer straightforward, but as Craig Wilson describes in a <a href="http://craiggwilson.com/2013/10/21/load-balanced-mongos/">2013 blog post</a>, similar issues will still arise when trying to iterate cursors. Note that though Craig‚Äôs post references the <a href="https://www.mongodb.com/docs/manual/legacy-opcodes/">legacy opcodes</a>, the situation would be the same if using newer drivers that leverage <a href="https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/#std-label-wire-op-msg"><code class="language-plaintext highlighter-rouge">OP_MSG</code></a> and <a href="https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/#std-label-wire-op-compressed"><code class="language-plaintext highlighter-rouge">OP_COMPRESSED</code></a>.</p><p>Note that the <em>Server Selection</em> specification <a href="https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.md#cursors">calls out that</a> <em>‚ÄúCursor operations [‚Ä¶] do not go through the server selection process. Cursor operations must be sent to the original server that received the query [‚Ä¶]‚Äù</em>. As this state information would not be tracked within the load balancer, issues would arise if a cursor operation were attempted and a balancer returned a different server where the cursor didn‚Äôt exist.</p><h3 id="operationcount-based-server-selection"><span class="me-2"><code class="language-plaintext highlighter-rouge">operationCount</code>-based Server Selection</span><a href="#operationcount-based-server-selection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As it is a form of ‚Äúload balancing‚Äù it‚Äôs worth just calling out that in an effort to alleviate runaway connection creation scenarios (‚Äúconnection storms‚Äù) the drivers <a href="https://github.com/mongodb/specifications/blob/master/source/server-selection/server-selection.md#operationcount-based-selection-within-the-latency-window-multi-threaded-or-async">approximate an individual server‚Äôs load</a> by tracking the number of concurrent operations that node is processing (<code class="language-plaintext highlighter-rouge">operationCount</code>) and then routing operations to servers with less load. This should reduce the number of new operations routed towards nodes that are busier and thus increase the number routed towards nodes that are servicing operations faster or are simply less busy.</p><h2 id="load-balancer-support"><span class="me-2">Load Balancer Support</span><a href="#load-balancer-support" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When you see a ticket called <a href="https://jira.mongodb.org/browse/SERVER-58207">‚ÄúEnable Feature flag for Support for Deploying MongoDB behind a L4 Load Balancer‚Äù</a> closed out as fixed for MongoDB 6.0.0-rc0 and 5.3.0-rc3 it‚Äôs hard not to get excited - but what does this mean? After doing a bit of digging you‚Äôll find that <code class="language-plaintext highlighter-rouge">mongos</code>‚Äô now support a proxy protocol which is configured via the <a href="https://github.com/mongodb/mongo/blob/r7.0.6/src/mongo/s/mongos_server_parameters.idl#L66-L74"><code class="language-plaintext highlighter-rouge">loadBalancerPort</code></a> startup parameter.</p><p>Given that there‚Äôs a driver specification, driver implementations (such as for the <a href="https://jira.mongodb.org/browse/NODE-3011">Node.js driver</a> and <a href="https://jira.mongodb.org/browse/RUBY-2515">Ruby driver</a>) and server support it should be possible to configure a sharded cluster to utilize the proxy protocol.</p><blockquote class="prompt-danger"><p>Before we proceed it‚Äôs worth calling out that this is not considered an officially supported configuration. Until MongoDB‚Äôs server team promotes this as a valid production configuration it should be considered experimental if used with a self-managed deployment.</p></blockquote><h3 id="configuration"><span class="me-2">Configuration</span><a href="#configuration" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>For our test we‚Äôll be configuring a single-shard sharded cluster with 5 <code class="language-plaintext highlighter-rouge">mongos</code>‚Äô behind an <a href="https://www.haproxy.org/">HAProxy</a> load balancer. Assuming you‚Äôre already familiar with <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-haproxy-and-load-balancing-concepts">HAProxy and load balancing concepts</a>, we‚Äôll be setting up a <a href="https://www.haproxy.com/documentation/haproxy-configuration-tutorials/load-balancing/tcp/#enable-tcp-mode">TCP proxy</a> to perform <code class="language-plaintext highlighter-rouge">roundrobin</code> balancing.</p><h4 id="1-setup-a-local-sharded-cluster"><span class="me-2">1. Setup a local sharded cluster</span><a href="#1-setup-a-local-sharded-cluster" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>First we need a local sharded cluster, which we‚Äôll provision using <a href="https://github.com/aheckmann/m"><code class="language-plaintext highlighter-rouge">m</code> - the MongoDB version manager</a> and <a href="https://github.com/rueckstiess/mtools"><code class="language-plaintext highlighter-rouge">mtools</code></a>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>m 7.0.6-ent
mlaunch init <span class="nt">--replicaset</span> <span class="nt">--nodes</span> 3 <span class="nt">--shards</span> 1 <span class="nt">--csrs</span> <span class="nt">--mongos</span> 5 <span class="nt">--binarypath</span> <span class="si">$(</span>m bin 7.0.6-ent<span class="si">)</span> <span class="nt">--bind_ip_all</span>
mlaunch stop
</pre></table></code></div></div><p>This configuration will yield a single <a href="https://www.mongodb.com/docs/manual/core/sharded-cluster-shards/">shard</a> with 3 nodes, a <a href="https://www.mongodb.com/docs/manual/core/sharded-cluster-config-servers/#replica-set-config-servers">config server replica set</a> and 5 <code class="language-plaintext highlighter-rouge">mongos</code>‚Äô. Once started, we immediately stop the cluster as some additional (manual) configuration is required.</p><h4 id="2-update-the-cluster-configuration-to-enable-proxy-protocol"><span class="me-2">2. Update the cluster configuration to enable proxy protocol</span><a href="#2-update-the-cluster-configuration-to-enable-proxy-protocol" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Since we need to modify the startup parameters for our <code class="language-plaintext highlighter-rouge">mongos</code>‚Äô we‚Äôll update the configuration file that <code class="language-plaintext highlighter-rouge">mlaunch</code> (part of <code class="language-plaintext highlighter-rouge">mtools</code>) uses.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">''</span> <span class="s1">'s/ --port 27017 / --port 27017 --setParameter loadBalancerPort=37017 /g'</span> data/.mlaunch_startup
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">''</span> <span class="s1">'s/ --port 27018 / --port 27018 --setParameter loadBalancerPort=37018 /g'</span> data/.mlaunch_startup
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">''</span> <span class="s1">'s/ --port 27019 / --port 27019 --setParameter loadBalancerPort=37019 /g'</span> data/.mlaunch_startup
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">''</span> <span class="s1">'s/ --port 27020 / --port 27020 --setParameter loadBalancerPort=37020 /g'</span> data/.mlaunch_startup
<span class="nb">sed</span> <span class="nt">-i</span> <span class="s1">''</span> <span class="s1">'s/ --port 27021 / --port 27021 --setParameter loadBalancerPort=37021 /g'</span> data/.mlaunch_startup
mlaunch start
</pre></table></code></div></div><p>The above commands just append a <a href="https://www.mongodb.com/docs/manual/reference/command/setParameter/"><code class="language-plaintext highlighter-rouge">setParameter</code></a> call as a command line option so we can configure the <code class="language-plaintext highlighter-rouge">loadBalancerPort</code> parameter of each <code class="language-plaintext highlighter-rouge">mongos</code>. Once completed we restart the cluster.</p><h4 id="3-configure-haproxy"><span class="me-2">3. Configure HAproxy</span><a href="#3-configure-haproxy" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>As we‚Äôre using HAproxy for our test we‚Äôll to build out our custom configuration. The example below will write to a <code class="language-plaintext highlighter-rouge">mongodb-lb.conf</code> file, which will then be read by <code class="language-plaintext highlighter-rouge">haproxy</code> to create our load balanced endpoint. I‚Äôm not going to go into detail as to what all the options below mean, but if you want to investigate further see <a href="https://www.haproxy.com/documentation/haproxy-configuration-manual/latest/">HAproxy‚Äôs configuration manual</a>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
</pre><td class="rouge-code"><pre><span class="nb">tee </span>mongodb-lb.conf <span class="o">&gt;</span> /dev/null <span class="o">&lt;&lt;</span><span class="no">EOT</span><span class="sh">
global
  log stdout local0 debug
  maxconn 4096

defaults
  log global
  mode tcp
  timeout connect  5000ms
  timeout client  30000ms
  timeout server  30000ms
  retries 3

default-server on-error fastinter error-limit 3 inter 3000ms fastinter 1000ms downinter 300s fall 3

frontend stats
    mode http
    bind *:8404
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST

listen mongos
  bind      *:37000
  option    tcplog
  balance   roundrobin
  server    mongos01 *:37017 check send-proxy-v2
  server    mongos02 *:37018 check send-proxy-v2
  server    mongos03 *:37019 check send-proxy-v2
  server    mongos04 *:37020 check send-proxy-v2
  server    mongos05 *:37021 check send-proxy-v2
</span><span class="no">EOT

</span>haproxy <span class="nt">-f</span> mongodb-lb.conf <span class="o">&gt;</span> haproxy.log 2&gt;&amp;1 &amp;
</pre></table></code></div></div><p>To make monitoring a little easier you‚Äôll notice we‚Äôve enabled <a href="https://www.haproxy.com/blog/exploring-the-haproxy-stats-page">HAProxy‚Äôs stats frontend</a>.</p><h4 id="4-test-application-connectivity-through-the-load-balancer"><span class="me-2">4. Test application connectivity through the load balancer</span><a href="#4-test-application-connectivity-through-the-load-balancer" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>Since the <a href="https://www.mongodb.com/docs/mongodb-shell/">MongoDB Shell</a> uses the <a href="https://www.mongodb.com/docs/drivers/node/current/">Node.js driver</a> internally we can use to validate if our load balancer is configured properly. We‚Äôve setup HAProxy to listen on port 37000, so we should be able to connect to that directly:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>mongosh <span class="nt">--quiet</span> <span class="s2">"mongodb://localhost:37000/test"</span>
MongoServerSelectionError: The server is being accessed through a load balancer, but this driver does not have load balancing enabled
</pre></table></code></div></div><p>Seems the driver knows we‚Äôre trying to connect to a load balancer, but we‚Äôre missing an option. This is where the <code class="language-plaintext highlighter-rouge">loadBalanced=true</code> option comes into play. Appending this to our connection string will allow us to run an arbitrary workload successfully:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre>mongosh <span class="nt">--quiet</span> <span class="s2">"mongodb://localhost:37000/test?loadBalanced=true"</span> <span class="nt">--eval</span> <span class="s2">"while(true) { result = db.foo.insertOne({ d: new Date() }); print(result); sleep(500); }"</span>
<span class="o">{</span>
  acknowledged: <span class="nb">true</span>,
  insertedId: ObjectId<span class="o">(</span><span class="s1">'65eb13b122c34af3037c094d'</span><span class="o">)</span>
<span class="o">}</span>
<span class="o">{</span>
  acknowledged: <span class="nb">true</span>,
  insertedId: ObjectId<span class="o">(</span><span class="s1">'65eb13b222c34af3037c094e'</span><span class="o">)</span>
<span class="o">}</span>
<span class="o">{</span>
  acknowledged: <span class="nb">true</span>,
  insertedId: ObjectId<span class="o">(</span><span class="s1">'65eb13b222c34af3037c094f'</span><span class="o">)</span>
<span class="o">}</span>
...
</pre></table></code></div></div><p>Success! It is worth noting though that this configuration works for us locally as we have direct control of the <code class="language-plaintext highlighter-rouge">mongos</code> processes startup parameters.</p><blockquote class="prompt-warning"><p>If you have a MongoDB Atlas sharded cluster, the <code class="language-plaintext highlighter-rouge">mongos</code>‚Äô cannot manually be placed behind a load balancer as startup parameter configuration access is not available!</p></blockquote><h2 id="conclusion"><span class="me-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that we can successfully connect to our load balanced endpoint it‚Äôs worth doing a little chaos testing to see how workloads react. The script I shared previously just loops infinitely inserting documents into a collection - but what happens if we kill one or two <code class="language-plaintext highlighter-rouge">mongos</code> processes?</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre>mlaunch stop 27017
mlaunch stop 27019
mlaunch list
Detected mongod version: 7.0.6

PROCESS          PORT     STATUS     PID

mongos           27017    down       -
mongos           27018    running    28006
mongos           27019    down       -
mongos           27020    running    28013
mongos           27021    running    28016

config server    27025    running    27979

shard01
    mongod       27022    running    27994
    mongod       27023    running    27998
    mongod       27024    running    27991
</pre></table></code></div></div><p>Using <code class="language-plaintext highlighter-rouge">mlaunch</code> I just stopped two of the query routers and waited for a while. The inserts kept on - inserting - so I guess we can consider that a successful test. Note that this is obviously not extensive and should not be taken as a guarantee of any sort, but if this is a configuration that interests you give it a shot and let me know what you find.</p><p><a href=" /images/load-balancer-01.png" class="popup img-link shimmer"><img src=" /images/load-balancer-01.png" alt="" loading="lazy"></a></p><p>Don‚Äôt forget that you have a web-based stats UI configured that you can refer to üòâ.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/mongodb/">MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/drivers/" class="post-tag no-text-decoration" >drivers</a> <a href="/tags/networking/" class="post-tag no-text-decoration" >networking</a> <a href="/tags/connections/" class="post-tag no-text-decoration" >connections</a> <a href="/tags/load-balancing/" class="post-tag no-text-decoration" >load-balancing</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MongoDB%20and%20Load%20Balancer%20Support%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F03%2F08%2Fmongodb-and-load-balancer-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MongoDB%20and%20Load%20Balancer%20Support%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F03%2F08%2Fmongodb-and-load-balancer-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F03%2F08%2Fmongodb-and-load-balancer-support%2F&text=MongoDB%20and%20Load%20Balancer%20Support%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F03%2F08%2Fmongodb-and-load-balancer-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=MongoDB%20and%20Load%20Balancer%20Support%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F03%2F08%2Fmongodb-and-load-balancer-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <a href="https://bsky.app/intent/compose?text=MongoDB%20and%20Load%20Balancer%20Support%20-%20ALEX%20BEVILACQUA%20https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F03%2F08%2Fmongodb-and-load-balancer-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Bluesky" aria-label="Bluesky"> <i class="fa-fw fa-brands fa-bluesky"></i> </a> <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F03%2F08%2Fmongodb-and-load-balancer-support%2F&title=MongoDB%20and%20Load%20Balancer%20Support%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit"> <i class="fa-fw fa-brands fa-square-reddit"></i> </a> <a href="https://www.threads.net/intent/post?text=MongoDB%20and%20Load%20Balancer%20Support%20-%20ALEX%20BEVILACQUA%20https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F03%2F08%2Fmongodb-and-load-balancer-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Threads" aria-label="Threads"> <i class="fa-fw fa-brands fa-square-threads"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2023/02/01/leisure-suit-larry-2/">Leisure Suit Larry Goes Looking for Love (in Several Wrong Places) (Sierra On-Line) - 1988</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/07/kabul-spy/">Kabul Spy (Sirius Software) - 1982</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/07/eternam/">Eternam (Infogrames) - 1992</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/08/emmanuelle/">Emmanuelle (Coktel Vision) - 1989</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/10/beneath-a-steel-sky/">Beneath a Steel Sky (Revolution Software) - 1994</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/blog/2024/02/05/node-dot-js-driver-failing-to-connect-due-to-unsafe-legacy-renegotiation-disabled/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1707142013" data-df="ll" > Feb 5, 2024 </time><h4 class="pt-0 my-2">Node.js Driver failing to connect due to "unsafe legacy renegotiation disabled"</h4><div class="text-muted"><p>Overview In this community forum post there was a report of the MongoDB Node.js driver failing to connect with the following error: MongoServerSelectionError: C8320000:error:0A000152:SSL routi...</p></div></div></a></article><article class="col"> <a href="/blog/2023/11/13/querysrv-errors-when-connecting-to-mongodb-atlas/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1699904533" data-df="ll" > Nov 13, 2023 </time><h4 class="pt-0 my-2">querySrv errors when connecting to MongoDB Atlas</h4><div class="text-muted"><p>If your application uses MongoDB‚Äôs Node.js driver or Mongoose ODM, occasionally you may observe errors such as querySrv ECONNREFUSED _mongodb._tcp.cluster0.abcde.mongodb.net or Error: querySrv ETIM...</p></div></div></a></article><article class="col"> <a href="/blog/2024/04/26/event-monitoring-with-mongoose/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1714139932" data-df="ll" > Apr 26, 2024 </time><h4 class="pt-0 my-2">Event Monitoring with Mongoose</h4><div class="text-muted"><p>I previously wrote about MongoDB Driver Monitoring, but there are ODM libraries and framework integrations that are built atop the drivers that can take advantage of this functionality. For exampl...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/blog/2024/02/28/ecoquest/" class="btn btn-outline-primary" aria-label="Older" ><p>EcoQuest: The Search for Cetus (Sierra On-Line) - 1991</p></a> <a href="/blog/2024/03/20/codename-iceman/" class="btn btn-outline-primary" aria-label="Newer" ><p>Codename: ICEMAN (Sierra On-Line) - 1989</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>¬© <time>2025</time> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.2.4" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2024/03/08/mongodb-and-load-balancer-support/'; this.page.identifier = '/blog/2024/03/08/mongodb-and-load-balancer-support/'; }; function addDisqus() { let disqusThread = document.createElement('div'); let paragraph = document.createElement('p'); disqusThread.id = 'disqus_thread'; paragraph.className = 'text-center text-muted small'; paragraph.innerHTML = 'Comments powered by <a href="https://disqus.com/">Disqus</a>.'; disqusThread.appendChild(paragraph); const footer = document.querySelector('footer'); footer.insertAdjacentElement("beforebegin", disqusThread); }function reloadDisqus(event) { if (event.source === window && event.data && event.data.id === Theme.ID) {if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } addDisqus(); if (Theme.switchable) { addEventListener('message', reloadDisqus); }var disqusObserver = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); disqusObserver.disconnect(); } }, { threshold: [0] } ); disqusObserver.observe(document.getElementById('disqus_thread')); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
