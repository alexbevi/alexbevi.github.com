<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Do Not Use Mutexes in Finalizers" /><meta name="author" content="Dmitry Rybakov" /><meta property="og:locale" content="en" /><meta name="description" content="Reposted from Dmitry’s blog. Canonical URL points to his original post." /><meta property="og:description" content="Reposted from Dmitry’s blog. Canonical URL points to his original post." /><link rel="canonical" href="https://comandeo.dev/2023/01/01/mutexes-in-finalizers.html" /><meta property="og:url" content="https://comandeo.dev/2023/01/01/mutexes-in-finalizers.html" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content=" https://www.alexbevi.com/images/ruby-banner-2.jpg " /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-05-09T13:27:41-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content=" https://www.alexbevi.com/images/ruby-banner-2.jpg " /><meta property="twitter:title" content="Do Not Use Mutexes in Finalizers" /><meta name="twitter:site" content="@alexbevi" /><meta name="twitter:creator" content="@Dmitry Rybakov" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Dmitry Rybakov","url":"https://comandeo.dev"},"dateModified":"2025-09-04T14:28:23-04:00","datePublished":"2024-05-09T13:27:41-04:00","description":"Reposted from Dmitry’s blog. Canonical URL points to his original post.","headline":"Do Not Use Mutexes in Finalizers","image":" https://www.alexbevi.com/images/ruby-banner-2.jpg ","mainEntityOfPage":{"@type":"WebPage","@id":"https://comandeo.dev/2023/01/01/mutexes-in-finalizers.html"},"url":"https://comandeo.dev/2023/01/01/mutexes-in-finalizers.html"}</script><title>Do Not Use Mutexes in Finalizers | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="/assets/lib/glightbox/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script defer src="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.umd.min.js"></script> <script defer src="/assets/lib/glightbox/glightbox.min.js"></script> <script defer src="/assets/lib/clipboard/clipboard.min.js"></script> <script defer src="/assets/lib/dayjs/dayjs.min.js"></script> <script defer src="/assets/lib/dayjs/locale/en.js"></script> <script defer src="/assets/lib/dayjs/plugin/relativeTime.js"></script> <script defer src="/assets/lib/dayjs/plugin/localizedFormat.js"></script> <script defer src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script><meta name="google-adsense-account" content="ca-pub-6215800856413580"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src=" /./images/avatar.png " width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ALEX BEVILACQUA</a><p class="site-subtitle fst-italic mb-0">my little corner of the interwebs</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/specifications/" class="nav-link"> <i class="fa-fw fas fa-book"></i> <span>SPECIFICATIONS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Do Not Use Mutexes in Finalizers</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Do Not Use Mutexes in Finalizers</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1715275661" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 9, 2024 </time> </span> <span> Updated <time data-ts="1757010503" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 4, 2025 </time> </span><div class="mt-3 mb-3"> <a href=" /images/ruby-banner-2.jpg" class="popup img-link preview-img shimmer"><img src=" /images/ruby-banner-2.jpg" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://comandeo.dev">Dmitry Rybakov</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1271 words" > <em>7 min</em> read </span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Do Not Use Mutexes in Finalizers</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Do Not Use Mutexes in Finalizers</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><blockquote class="prompt-tip"><p>Reposted from <a href="https://comandeo.dev/2023/01/01/mutexes-in-finalizers.html">Dmitry’s blog</a>. Canonical URL points to his original post.</p></blockquote><p>Ruby allows a developer to specify a <em>finalizer</em> proc for an object. This proc is called after an object was destroyed. This is a very useful mechanism that can be used for some cleanup when the object is gone. However, it turned out that there are limitations to what you can do inside finalizers. And these limitations are the same as ones for a signal trap. So, if you write a finalizer, you should follow the <a href="https://github.com/ruby/ruby/blob/master/doc/signals.rdoc">documentation for signal traps</a>.</p><p>Some time ago a user opened an issue in our bug tracker. In his logs he noticed an exception raised by the MongoDB Ruby driver:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>`synchronize': can't be called from trap context (ThreadError)
</pre></table></code></div></div><p>From the logs, we could see that the exception was raised when calling synchronize on a mutex inside the finalizer. However, the exception says that synchronize can’t be called from a “trap context”. What is that, and how is it related to our finalizers?</p><p>Finalizer is a proc that will be called when a specific object is about to be destroyed by garbage collection. In the MongoDB Ruby driver, we use finalizers to close unused cursors. A cursor is returned in response to a query and can be iterated to retrieve results. Cursors are a very convenient mechanism; however, cursors are server-side objects, and every cursor consumes server memory. Therefore, it is a good idea to let the server know if a cursor is unused so that the resources are released. So, if an object that represents a cursor is destroyed, the cursor is definitely unused and can be closed.</p><p>Below is a very simplified example of how this can be done:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">Cursor</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">finalize</span><span class="p">(</span><span class="n">cursor_id</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
    <span class="nb">proc</span> <span class="k">do</span>
      <span class="nb">puts</span> <span class="s2">"Killing cursor </span><span class="si">#{</span><span class="n">cursor_id</span><span class="si">}</span><span class="s2"> on </span><span class="si">#{</span><span class="n">database</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">collection</span><span class="si">}</span><span class="s2">"</span>
      <span class="c1"># Execute command to close cursor</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
    <span class="c1"># Initialize the cursor</span>
    <span class="no">ObjectSpace</span><span class="p">.</span><span class="nf">define_finalizer</span><span class="p">(</span>
      <span class="nb">self</span><span class="p">,</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">finalize</span><span class="p">(</span><span class="vi">@id</span><span class="p">,</span> <span class="vi">@database</span><span class="p">,</span> <span class="vi">@collection</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p>We can ask Ruby to do the garbage collection by calling <code class="language-plaintext highlighter-rouge">GC.start</code>, so we can test the code.</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">Cursor</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'database'</span><span class="p">,</span> <span class="s1">'collection'</span><span class="p">)</span> <span class="p">}</span>
<span class="no">GC</span><span class="p">.</span><span class="nf">start</span>

<span class="c1"># =&gt; Killing cursor 258 on database.collection</span>
<span class="c1"># =&gt; Killing cursor 938 on database.collection</span>
<span class="c1"># =&gt; Killing cursor 791 on database.collection</span>
<span class="c1"># =&gt; Killing cursor 705 on database.collection</span>
<span class="c1"># =&gt; Killing cursor 114 on database.collection</span>
</pre></table></code></div></div><p>So far so good. Of course, this solution is far from ideal. Here we send a command to the server every time the finalizer is called. First, this will block the main thread. Further, it will issue one command per cursor, which is not ideal. We can also reduce the number of commands we send by killing all cursors for a collection in one command. So, we came up with an idea for the cursor reaper — a background thread that wakes up from time to time and kills unused cursors:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="k">class</span> <span class="nc">CursorReaper</span>
  <span class="no">Task</span> <span class="o">=</span> <span class="no">Struct</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="ss">:database</span><span class="p">,</span> <span class="ss">:collection</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@mutex</span> <span class="o">=</span> <span class="no">Mutex</span><span class="p">.</span><span class="nf">new</span>
    <span class="vi">@tasks</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">schedule</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
    <span class="vi">@mutex</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
      <span class="vi">@tasks</span> <span class="o">&lt;&lt;</span> <span class="no">Task</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">kill_cursors</span>
    <span class="vi">@mutex</span><span class="p">.</span><span class="nf">synchronize</span> <span class="k">do</span>
      <span class="k">while</span> <span class="n">task</span> <span class="o">=</span> <span class="vi">@tasks</span><span class="p">.</span><span class="nf">pop</span>
        <span class="nb">puts</span> <span class="s2">"Killing cursor </span><span class="si">#{</span><span class="n">task</span><span class="p">.</span><span class="nf">id</span><span class="si">}</span><span class="s2"> on </span><span class="si">#{</span><span class="n">task</span><span class="p">.</span><span class="nf">database</span><span class="si">}</span><span class="s2">.</span><span class="si">#{</span><span class="n">task</span><span class="p">.</span><span class="nf">collection</span><span class="si">}</span><span class="s2">"</span>
        <span class="c1"># Group cursors per collection</span>
      <span class="k">end</span>
    <span class="k">end</span>
    <span class="c1"># Execute commands to close cursors</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Cursor</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">finalize</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">reaper</span><span class="p">)</span>
    <span class="nb">proc</span> <span class="k">do</span>
      <span class="n">reaper</span><span class="p">.</span><span class="nf">schedule</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="n">database</span><span class="p">,</span> <span class="n">collection</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">collection</span><span class="p">,</span> <span class="n">reaper</span><span class="p">)</span>
    <span class="c1"># Initialize the cursor</span>
    <span class="no">ObjectSpace</span><span class="p">.</span><span class="nf">define_finalizer</span><span class="p">(</span>
      <span class="nb">self</span><span class="p">,</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">finalize</span><span class="p">(</span><span class="vi">@id</span><span class="p">,</span> <span class="vi">@database</span><span class="p">,</span> <span class="vi">@collection</span><span class="p">,</span> <span class="n">reaper</span><span class="p">)</span>
    <span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p>Note that there is a mutex in the CursorReaper class. The kill_cursors method of the reaper will be called in a background thread, hence the locking. Let’s test it:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="n">reaper</span> <span class="o">=</span> <span class="no">CursorReaper</span><span class="p">.</span><span class="nf">new</span>
<span class="n">reaper_thread</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">reaper</span><span class="p">.</span><span class="nf">kill_cursors</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="mi">5</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">Cursor</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'database'</span><span class="p">,</span> <span class="s1">'collection'</span><span class="p">,</span> <span class="n">reaper</span><span class="p">)</span> <span class="p">}</span>
<span class="no">GC</span><span class="p">.</span><span class="nf">start</span>
<span class="n">reaper_thread</span><span class="p">.</span><span class="nf">join</span>

<span class="c1"># =&gt; Killing cursor 205 on database.collection</span>
<span class="c1"># =&gt; Killing cursor 847 on database.collection</span>
<span class="c1"># =&gt; Killing cursor 284 on database.collection</span>
<span class="c1"># =&gt; Killing cursor 609 on database.collection</span>
<span class="c1"># =&gt; Killing cursor 485 on database.collection</span>
</pre></table></code></div></div><p>Still, no error, even though the latter example calls synchronize inside the finalizer. What is the difference between the example and the real-world situation? In the example, we trigger garbage collection manually. Normally this is triggered by Ruby itself. What if we create so many objects that Ruby actually starts the GC?</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="n">reaper</span> <span class="o">=</span> <span class="no">CursorReaper</span><span class="p">.</span><span class="nf">new</span>
<span class="n">reaper_thread</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">reaper</span><span class="p">.</span><span class="nf">kill_cursors</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">populator_thread</span> <span class="o">=</span> <span class="no">Thread</span><span class="p">.</span><span class="nf">new</span> <span class="k">do</span>
  <span class="kp">loop</span> <span class="k">do</span>
    <span class="mi">5000</span><span class="p">.</span><span class="nf">times</span> <span class="p">{</span> <span class="no">Cursor</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'database'</span><span class="p">,</span> <span class="s1">'collection'</span><span class="p">,</span> <span class="n">reaper</span><span class="p">)</span> <span class="p">}</span>
    <span class="nb">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="p">[</span><span class="n">reaper_thread</span><span class="p">,</span> <span class="n">populator_thread</span><span class="p">].</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:join</span><span class="p">)</span>
</pre></table></code></div></div><p>Yes, this code actually reproduces the problem, and the exception is raised! So, it looks like finalizers are executed inside a signal trap. Therefore, to fix the problem we should just <a href="https://github.com/ruby/ruby/blob/master/doc/signals.rdoc">follow the documentation</a> and not use operations that are not allowed inside the traps. In our case with the cursor reaper, we got rid of mutexes in finalizers by using a queue data structure, and the bug was fixed.</p><h2 id="we-need-to-go-deeper"><span class="me-2">We Need to Go Deeper</span><a href="#we-need-to-go-deeper" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Even though the problem was gone, I decided to find out whether finalizers are really executed inside a signal trap. I though maybe Ruby VM uses signals internally to trigger garbage collection. I could not find any mentions about such a usage of signals, so I had to read Ruby source code. It tuned out to be fun, and the outcome was very unexpected!</p><p>I started by finding where the error <em>“can’t be called from trap context”</em> is raised. I found it in <code class="language-plaintext highlighter-rouge">do_mutex_lock</code> function inside <code class="language-plaintext highlighter-rouge">thread_sync.c</code> file:</p><div class="language-c highlighter-rouge"><div class="code-header"> <span data-label-text="C"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="cm">/* When running trap handler */</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">FL_TEST_RAW</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">MUTEX_ALLOW_TRAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
  <span class="n">th</span><span class="o">-&gt;</span><span class="n">ec</span><span class="o">-&gt;</span><span class="n">interrupt_mask</span> <span class="o">&amp;</span> <span class="n">TRAP_INTERRUPT_MASK</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">rb_raise</span><span class="p">(</span><span class="n">rb_eThreadError</span><span class="p">,</span> <span class="s">"can't be called from trap context"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So, what is actually verified is whether the execution context has a <code class="language-plaintext highlighter-rouge">TRAP_INTERRUPT_MASK</code> flag set. This flag is set in three functions: <code class="language-plaintext highlighter-rouge">rb_postponed_job_flush</code> in <code class="language-plaintext highlighter-rouge">vm_trace.c</code>, <code class="language-plaintext highlighter-rouge">rb_threadptr_execute_interrupts</code> in <code class="language-plaintext highlighter-rouge">thread.c</code>, and <code class="language-plaintext highlighter-rouge">signal_exec</code> in <code class="language-plaintext highlighter-rouge">signal.c</code>. After some debugging, I found out that in our case the flag is set in the <code class="language-plaintext highlighter-rouge">rb_postponed_job_flush</code> function. Actually, this is also confirmed by this comment for the <code class="language-plaintext highlighter-rouge">rb_gc</code> function in <code class="language-plaintext highlighter-rouge">gc.h</code>:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>* Finalisers are deferred until we can handle interrupts. See * `rb_postponed_job_flush` in vm_trace.c.
</pre></table></code></div></div><p>Alright, now it is more or less clear what is going on. Finalizers are not executed immediately after an object is “garbage collected”. Instead, a postponed job is created and scheduled. Such jobs are executed in the <code class="language-plaintext highlighter-rouge">rb_postponed_job_flush</code> function. This function sets the <code class="language-plaintext highlighter-rouge">TRAP_INTERRUPT_MASK</code> flag, which is later checked by <code class="language-plaintext highlighter-rouge">do_mutex_lock</code>. Hence the error. I even found <a href="https://github.com/ruby/ruby/commit/05459d1a33db59c47e98e327c9f52808ebc76a3f">the commit</a> that introduces the current behavior, and <a href="https://bugs.ruby-lang.org/issues/10595">a bug</a> that was fixed by this commit. It looks like the Ruby team wanted to make sure that finalizers are never interrupted by a signal; as a side effect, code inside finalizers is treated as code inside a signal trap.</p><p><em>To summarize, finalizers are <strong>not</strong> executed inside a signal trap; however, Ruby applies the same restrictions to signal traps and finalizers. This is not documented anywhere; further, the exception raised is a bit misleading. Be careful!</em></p><p>P.S. It is still unclear why we did not see the exception when we trigger the garbage collection manually. I wasn’t able to find the answer; maybe this is a topic for my next article.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/programming/">Programming</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/ruby/" class="post-tag no-text-decoration" >ruby</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Do%20Not%20Use%20Mutexes%20in%20Finalizers%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F05%2F09%2Fdo-not-use-mutexes-in-finalizers%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Do%20Not%20Use%20Mutexes%20in%20Finalizers%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F05%2F09%2Fdo-not-use-mutexes-in-finalizers%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F05%2F09%2Fdo-not-use-mutexes-in-finalizers%2F&text=Do%20Not%20Use%20Mutexes%20in%20Finalizers%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F05%2F09%2Fdo-not-use-mutexes-in-finalizers%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Do%20Not%20Use%20Mutexes%20in%20Finalizers%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F05%2F09%2Fdo-not-use-mutexes-in-finalizers%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <a href="https://bsky.app/intent/compose?text=Do%20Not%20Use%20Mutexes%20in%20Finalizers%20-%20ALEX%20BEVILACQUA%20https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F05%2F09%2Fdo-not-use-mutexes-in-finalizers%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Bluesky" aria-label="Bluesky"> <i class="fa-fw fa-brands fa-bluesky"></i> </a> <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F05%2F09%2Fdo-not-use-mutexes-in-finalizers%2F&title=Do%20Not%20Use%20Mutexes%20in%20Finalizers%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit"> <i class="fa-fw fa-brands fa-square-reddit"></i> </a> <a href="https://www.threads.net/intent/post?text=Do%20Not%20Use%20Mutexes%20in%20Finalizers%20-%20ALEX%20BEVILACQUA%20https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2024%2F05%2F09%2Fdo-not-use-mutexes-in-finalizers%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Threads" aria-label="Threads"> <i class="fa-fw fa-brands fa-square-threads"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2023/02/08/emmanuelle/">Emmanuelle (Coktel Vision) - 1989</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/10/beneath-a-steel-sky/">Beneath a Steel Sky (Revolution Software) - 1994</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/13/rise-of-the-dragon/">Rise of the Dragon (Dynamix) - 1990</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/13/ruby-on-rails-global-summit-23/">Ruby on Rails Global Summit '23</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/15/urban-runner/">Urban Runner (Coktel Vision) - 1996</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/javascript/">javascript</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/blog/2023/02/13/ruby-on-rails-global-summit-23/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1676311701" data-df="ll" > Feb 13, 2023 </time><h4 class="pt-0 my-2">Ruby on Rails Global Summit '23</h4><div class="text-muted"><p>This year (January 24, 2023) I had the opportunity to present at Ruby on Rails Global Summit ‘23, which was a Geekle sponsored event. As I’m currently a Senior Product Manager at MongoDB focusing o...</p></div></div></a></article><article class="col"> <a href="/blog/2022/12/14/tablecheck-empowering-restaurants-with-best-in-class-booking-tools-powered-by-mongodb/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1671047383" data-df="ll" > Dec 14, 2022 </time><h4 class="pt-0 my-2">TableCheck: Empowering Restaurants with Best-in-Class Booking Tools Powered by MongoDB</h4><div class="text-muted"><p>Cross posted from the MongoDB Developer Center TableCheck is the world’s premiere booking and guest platform. Headquartered in Tokyo, they empower restaurants with tools to elevate their guest ex...</p></div></div></a></article><article class="col"> <a href="/blog/2022/11/02/mongodb-orms-odms-and-libraries/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1667384920" data-df="ll" > Nov 2, 2022 </time><h4 class="pt-0 my-2">MongoDB ORMs, ODMs, and Libraries</h4><div class="text-muted"><p>Cross posted from the MongoDB Developer Center Though developers have always been capable of manually writing complex queries to interact with a database, this approach can be tedious and error-p...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/blog/2024/04/30/the-secret-of-monkey-island/" class="btn btn-outline-primary" aria-label="Older" ><p>The Secret of Monkey Island (Lucasfilm Games) - 1990</p></a> <a href="/blog/2024/05/10/hugo-ii-whodunit/" class="btn btn-outline-primary" aria-label="Newer" ><p>Hugo II, Whodunit? (Gray Design Associates) - 1991</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/javascript/">javascript</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2024/05/09/do-not-use-mutexes-in-finalizers/'; this.page.identifier = '/blog/2024/05/09/do-not-use-mutexes-in-finalizers/'; }; function addDisqus() { let disqusThread = document.createElement('div'); let paragraph = document.createElement('p'); disqusThread.id = 'disqus_thread'; paragraph.className = 'text-center text-muted small'; paragraph.innerHTML = 'Comments powered by <a href="https://disqus.com/">Disqus</a>.'; disqusThread.appendChild(paragraph); const footer = document.querySelector('footer'); footer.insertAdjacentElement("beforebegin", disqusThread); }function reloadDisqus(event) { if (event.source === window && event.data && event.data.id === Theme.ID) {if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } addDisqus(); if (Theme.switchable) { addEventListener('message', reloadDisqus); }var disqusObserver = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); disqusObserver.disconnect(); } }, { threshold: [0] } ); disqusObserver.observe(document.getElementById('disqus_thread')); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
