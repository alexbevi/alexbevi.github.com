<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Ensuring a MongoDB Replica Set Member’s Priority Takeover Succeeds" /><meta name="author" content="Alex Bevilacqua" /><meta property="og:locale" content="en_US" /><meta name="description" content="High availability implies a system has been designed for durability, redundancy, and automatic failover such that the applications supported by the system can operate continuously and without downtime for a long period of time. MongoDB replica sets support high availability when deployed according to the documented best practices." /><meta property="og:description" content="High availability implies a system has been designed for durability, redundancy, and automatic failover such that the applications supported by the system can operate continuously and without downtime for a long period of time. MongoDB replica sets support high availability when deployed according to the documented best practices." /><link rel="canonical" href="https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-10-21T07:11:18-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Ensuring a MongoDB Replica Set Member’s Priority Takeover Succeeds" /><meta name="twitter:site" content="@alexbevi" /><meta name="twitter:creator" content="@Alex Bevilacqua" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"headline":"Ensuring a MongoDB Replica Set Member’s Priority Takeover Succeeds","dateModified":"2021-11-11T06:55:46-05:00","datePublished":"2021-10-21T07:11:18-04:00","url":"https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/"},"author":{"@type":"Person","name":"Alex Bevilacqua"},"description":"High availability implies a system has been designed for durability, redundancy, and automatic failover such that the applications supported by the system can operate continuously and without downtime for a long period of time. MongoDB replica sets support high availability when deployed according to the documented best practices.","@type":"BlogPosting","@context":"https://schema.org"}</script><title>Ensuring a MongoDB Replica Set Member's Priority Takeover Succeeds | ALEX BEVILACQUA</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/galleria.min.js"></script><link href="//cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/themes/classic/galleria.classic.min.css" media="screen, projection" rel="stylesheet" type="text/css" /><style> /* This rule is read by Galleria to define the gallery height: */ .galleria{ width: 700px; height: 400px; background: #000 } .responsive-wrap iframe{ max-width: 100%;}</style><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle font-italic">my little corner of the interwebs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/alexbevi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/alexbevi" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener"> <i class="fab fa-reddit"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/blog"> Blog </a> </span> <span> <a href="/2021"> 2021 </a> </span> <span> <a href="/10"> 10 </a> </span> <span> <a href="/21"> 21 </a> </span> <span>Ensuring a MongoDB Replica Set Member's Priority Takeover Succeeds</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Ensuring a MongoDB Replica Set Member's Priority Takeover Succeeds</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Oct 21, 2021, 7:11 AM -0400" > Oct 21 <i class="unloaded">2021-10-21T07:11:18-04:00</i> </span> by <span class="author"> Alex Bevilacqua </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Nov 11, 2021, 6:55 AM -0500" > Nov 11 <i class="unloaded">2021-11-11T06:55:46-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2353 words">13 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/mongodb-logo.png" class="preview-img" alt="MongoDB Logo"><p>High availability implies a system has been designed for durability, redundancy, and automatic failover such that the applications supported by the system can operate continuously and without downtime for a long period of time. MongoDB replica sets support high availability when deployed according to the <a href="https://docs.mongodb.com/manual/administration/production-checklist-operations/#std-label-production-checklist-replication">documented best practices</a>.</p><p>The <code class="language-plaintext highlighter-rouge">priority</code> settings of replica set members affect both the timing and the outcome of <a href="https://docs.mongodb.com/manual/core/replica-set-elections/">elections</a> for primary. Higher-priority members are more likely to call elections, and are more likely to win. The MongoDB documentation outlines a procedure to <a href="https://docs.mongodb.com/manual/tutorial/force-member-to-be-primary/#force-a-member-to-be-primary-by-setting-its-priority-high">Force a Member to be Primary by Setting its Priority High</a>, which can be easily demonstrated by changing the replica set’s priorities through a <a href="https://docs.mongodb.com/manual/reference/command/replSetReconfig/"><code class="language-plaintext highlighter-rouge">replSetReconfig</code></a> command.</p><p>In this article we will demonstrate how to utilize replica set member priority to ensure a given node assumes the <a href="https://docs.mongodb.com/manual/core/replica-set-primary/">primary</a> role under ideal circumstances, as well as under load (when there is consistent replication lag).</p><h2 id="initial-setup">Initial Setup</h2><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="c"># setup a PSS replica set</span>
mlaunch init <span class="nt">--replicaset</span> <span class="nt">--nodes</span> 3 <span class="nt">--binarypath</span> <span class="si">$(</span>m bin 4.2.17-ent<span class="si">)</span>
<span class="c"># using the mongo shell reconfigure the set</span>
<span class="c"># with the 3rd node having a priority of 10</span>
mongo <span class="s2">"mongodb://localhost:27017/?replicaset=replset"</span> <span class="nt">--quiet</span> <span class="se">\</span>
  <span class="nt">--eval</span> <span class="s2">"c = rs.conf(); c.members[2].priority = 10; rs.reconfig(c)"</span>
</pre></table></code></div></div><p>To setup the replica set the <a href="https://github.com/aheckmann/m"><code class="language-plaintext highlighter-rouge">m</code> version manager</a> is used along with <a href="https://github.com/rueckstiess/mtools"><code class="language-plaintext highlighter-rouge">mtools</code></a>. Once the replica set is reconfigured via the <code class="language-plaintext highlighter-rouge">mongo</code> shell, checking the logs for the <code class="language-plaintext highlighter-rouge">rs3</code> node that should now be <code class="language-plaintext highlighter-rouge">PRIMARY</code> should show the results of the priority takeover:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">tail</span> <span class="nt">-n</span> 1000 data/replset/rs3/mongod.log | <span class="nb">grep</span> <span class="nt">-E</span> <span class="s2">"(ELECTION|REPL)"</span>
</pre></table></code></div></div><pre><code class="language-log">2021-10-06T06:50:38.730-0400 I  REPL     [replexec-2] New replica set config in use: { _id: "replset", version: 2, protocolVersion: 1, writeConcernMajorityJournalDefault: true, members: [ { _id: 0, host: "localhost:27017", arbiterOnly: false, buildIndexes: true, hidden: false, priority: 1.0, tags: {}, slaveDelay: 0, votes: 1 }, { _id: 1, host: "localhost:27018", arbiterOnly: false, buildIndexes: true, hidden: false, priority: 1.0, tags: {}, slaveDelay: 0, votes: 1 }, { _id: 2, host: "localhost:27019", arbiterOnly: false, buildIndexes: true, hidden: false, priority: 10.0, tags: {}, slaveDelay: 0, votes: 1 } ], settings: { chainingAllowed: true, heartbeatIntervalMillis: 2000, heartbeatTimeoutSecs: 10, electionTimeoutMillis: 10000, catchUpTimeoutMillis: -1, catchUpTakeoverDelayMillis: 30000, getLastErrorModes: {}, getLastErrorDefaults: { w: 1, wtimeout: 0 }, replicaSetId: ObjectId('615d7f403cd84ab3e708fdea') } }
2021-10-06T06:50:38.730-0400 I  REPL     [replexec-2] This node is localhost:27019 in the config
2021-10-06T06:50:38.737-0400 I  ELECTION [replexec-3] Scheduling priority takeover at 2021-10-06T06:50:48.909-0400
2021-10-06T06:50:48.911-0400 I  REPL     [replexec-4] Canceling priority takeover callback
2021-10-06T06:50:48.911-0400 I  ELECTION [replexec-4] Starting an election for a priority takeover
2021-10-06T06:50:48.911-0400 I  ELECTION [replexec-4] conducting a dry run election to see if we could be elected. current term: 1
2021-10-06T06:50:48.912-0400 I  REPL     [replexec-4] Scheduling remote command request for vote request: RemoteCommand 183 -- target:localhost:27017 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: true, term: 1, candidateIndex: 2, configVersion: 2, lastCommittedOp: { ts: Timestamp(1633517438, 1), t: 1 } }
2021-10-06T06:50:48.912-0400 I  REPL     [replexec-4] Scheduling remote command request for vote request: RemoteCommand 184 -- target:localhost:27018 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: true, term: 1, candidateIndex: 2, configVersion: 2, lastCommittedOp: { ts: Timestamp(1633517438, 1), t: 1 } }
2021-10-06T06:50:48.912-0400 I  ELECTION [replexec-9] VoteRequester(term 1 dry run) received a yes vote from localhost:27017; response message: { term: 1, voteGranted: true, reason: "", ok: 1.0, $clusterTime: { clusterTime: Timestamp(1633517438, 1), signature: { hash: BinData(0, 0000000000000000000000000000000000000000), keyId: 0 } }, operationTime: Timestamp(1633517438, 1) }
2021-10-06T06:50:48.912-0400 I  ELECTION [replexec-5] dry election run succeeded, running for election in term 2
2021-10-06T06:50:48.941-0400 I  REPL     [replexec-5] Scheduling remote command request for vote request: RemoteCommand 185 -- target:localhost:27017 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: false, term: 2, candidateIndex: 2, configVersion: 2, lastCommittedOp: { ts: Timestamp(1633517438, 1), t: 1 } }
2021-10-06T06:50:48.942-0400 I  REPL     [replexec-5] Scheduling remote command request for vote request: RemoteCommand 186 -- target:localhost:27018 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: false, term: 2, candidateIndex: 2, configVersion: 2, lastCommittedOp: { ts: Timestamp(1633517438, 1), t: 1 } }
2021-10-06T06:50:48.957-0400 I  ELECTION [replexec-1] VoteRequester(term 2) received a yes vote from localhost:27018; response message: { term: 2, voteGranted: true, reason: "", ok: 1.0, $clusterTime: { clusterTime: Timestamp(1633517438, 1), signature: { hash: BinData(0, 0000000000000000000000000000000000000000), keyId: 0 } }, operationTime: Timestamp(1633517438, 1) }
2021-10-06T06:50:48.960-0400 I  ELECTION [replexec-8] election succeeded, assuming primary role in term 2
2021-10-06T06:50:48.961-0400 I  REPL     [replexec-8] transition to PRIMARY from SECONDARY
</code></pre><p>The above example will work every time on a local cluster with no traffic and no lag. What happens when we start applying some traffic to this cluster using a process that supports <a href="https://docs.mongodb.com/manual/core/retryable-writes/">Retryable Writes</a>?</p><h2 id="retryable-workload">Retryable Workload</h2><p>Retryable writes allow MongoDB drivers to automatically retry certain write operations a single time if they encounter network errors, or if they cannot find a healthy primary in the replica sets or sharded cluster. Based on this guarantee our assumption would be that the write workload should continue uninterrupted:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>curl <span class="nt">-s</span> https://gist.githubusercontent.com/alexbevi/955c6675337107e16d637233f865b1e3/raw/cca0390f6c30898140cc55490930b80c5cad527b/template.json | <span class="se">\</span>
  mgeneratejs <span class="nt">-n</span> 5000000 | <span class="se">\</span>
  mongoimport <span class="nt">--uri</span> <span class="s2">"mongodb://localhost:27017/test?replicaSet=replset&amp;w=majority&amp;retryWrites=true"</span> <span class="nt">--collection</span> data <span class="nt">--numInsertionWorkers</span> 1 <span class="nt">--drop</span>
</pre></table></code></div></div><p>The <a href="https://docs.mongodb.com/database-tools/mongoimport/"><code class="language-plaintext highlighter-rouge">mongoimport</code></a> command, along with <a href="https://github.com/rueckstiess/mgeneratejs"><code class="language-plaintext highlighter-rouge">mgeneratejs</code></a> are used to generate data and write the results to the <code class="language-plaintext highlighter-rouge">test.data</code> namespace. Note the version of <code class="language-plaintext highlighter-rouge">mongoimport</code> used is &gt; 100.2.1 as this ensures retryable writes are supported (per <a href="https://jira.mongodb.org/browse/TOOLS-2745">TOOLS-2745</a>).</p><p>Assuming the retryable writes guarantee is accurate, performing another <code class="language-plaintext highlighter-rouge">replSetReconfig</code> to shift the highest priority to another node should allow the election to occur without interrupting the <code class="language-plaintext highlighter-rouge">mongoimport</code> workload.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/priority-takeover-001.png" alt="" /></p><p>Using <a href="https://github.com/tmux/tmux/wiki"><code class="language-plaintext highlighter-rouge">tmux</code></a> to manage multiple terminals (as seen in the screenshot above), the <code class="language-plaintext highlighter-rouge">mongoimport</code> (left panel) continues to import data while the election is triggered and completes (per the logs of the new <code class="language-plaintext highlighter-rouge">PRIMARY</code> in the right panel).</p><h2 id="retryable-workload-with-an-oplog-delay">Retryable Workload with an Oplog Delay</h2><p>In the above example the <code class="language-plaintext highlighter-rouge">mongoimport</code> workload was able to successfully continue with retryable writes enabled. Retryable writes are not a requirement in this scenario however (per the <a href="https://github.com/mongodb/specifications/blob/master/source/retryable-writes/retryable-writes.rst#determining-retryable-errors">Retryable Writes Specification</a>) having this feature enabled will ensure server errors such as <code class="language-plaintext highlighter-rouge">NotWritablePrimary</code>, <code class="language-plaintext highlighter-rouge">NotPrimaryNoSecondaryOk</code>, <code class="language-plaintext highlighter-rouge">NotPrimaryOrSecondary</code>, <code class="language-plaintext highlighter-rouge">PrimarySteppedDown</code> will be retried.</p><p>Next we want to run the same test but with an artificial lag introduced to the node that is expected to step up as primary due to priority.</p><h2 id="simulating-an-oplog-delay">Simulating an Oplog Delay</h2><p>Replication lag is a delay between an operation on the primary and the application of that operation from the oplog to the secondary (see <a href="https://docs.mongodb.com/manual/tutorial/troubleshoot-replica-sets/#check-the-replication-lag">“Check Replication Lag”</a>). Our test above was able to easily complete a priority takeover and election as the nodes are all on the same host (<code class="language-plaintext highlighter-rouge">localhost</code>) and there should be virtually no delay between writes and replicated operations.</p><p>The following script uses the <a href="https://docs.mongodb.com/manual/reference/command/fsync/"><code class="language-plaintext highlighter-rouge">fsync</code></a> and <a href="https://docs.mongodb.com/manual/reference/command/fsyncUnlock"><code class="language-plaintext highlighter-rouge">fsyncUnlock</code></a> commands to block a target node from performing writes. By doing this in a timed fashion we can simulate replication lag on a secondary as the node cannot apply writes from the oplog while it is locked.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
</pre><td class="rouge-code"><pre><span class="c1">// file: secondaryDelay.js</span>
<span class="c1">//</span>
<span class="c1">// the host:port of the node to connect to and lock/unlock</span>
<span class="kd">const</span> <span class="nx">NODE</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">localhost:27019</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// how long to block operations (in milliseconds)</span>
<span class="kd">const</span> <span class="nx">DELAY</span> <span class="o">=</span> <span class="mi">3500</span><span class="p">;</span>
<span class="kd">function</span> <span class="nx">delaySecondary</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">t</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">getDB</span><span class="p">(</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">).</span><span class="nx">fsyncLock</span><span class="p">();</span>
  <span class="nx">sleep</span><span class="p">(</span><span class="nx">t</span><span class="p">);</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">getDB</span><span class="p">(</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">).</span><span class="nx">fsyncUnlock</span><span class="p">();</span>
  <span class="c1">// print secondary replication info to show lag</span>
  <span class="nx">print</span><span class="p">(</span><span class="nx">db</span><span class="p">.</span><span class="nx">printSecondaryReplicationInfo</span><span class="p">());</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">(</span><span class="nx">NODE</span><span class="p">);</span>
<span class="k">while</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">delaySecondary</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span> <span class="nx">DELAY</span><span class="p">);</span>
  <span class="nx">sleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>When the <code class="language-plaintext highlighter-rouge">secondaryDelay.js</code> script is run and the replica set reconfiguration is performed, the priority takeover should now fail.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/priority-takeover-002.png" alt="" /></p><p>To simulate the failure, the following commands were running in <code class="language-plaintext highlighter-rouge">tmux</code> windows:</p><ol><li><code class="language-plaintext highlighter-rouge">mongoimport</code><li><code class="language-plaintext highlighter-rouge">mongo --quiet secondaryDelay.js</code><li><code class="language-plaintext highlighter-rouge">mongo "mongodb://localhost:27017/?replicaset=replset" --quiet --eval "c = rs.conf(); c.members[0].priority = 1; c.members[2].priority = 10; rs.reconfig(c)"</code><li><code class="language-plaintext highlighter-rouge">tail -n 1000 data/replset/rs3/mongod.log | grep -E "(ELECTION|REPL)"</code></ol><pre><code class="language-log">2021-10-21T06:53:56.388-0400 I  ELECTION [replexec-12] Scheduling priority takeover at 2021-10-21T06:54:07.210-0400
2021-10-21T06:54:07.210-0400 I  REPL     [replexec-10] Canceling priority takeover callback
2021-10-21T06:54:07.210-0400 I  ELECTION [replexec-10] Starting an election for a priority takeover
2021-10-21T06:54:07.210-0400 I  ELECTION [replexec-10] conducting a dry run election to see if we could be elected. current term: 7
2021-10-21T06:54:07.210-0400 I  REPL     [replexec-10] Scheduling remote command request for vote request: RemoteCommand 1129 -- target:localhost:27017 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: true, term: 7, candidateIndex: 2, configVersion: 9, lastCommittedOp: { ts: Timestamp(1634813644, 1000), t: 7 } }
2021-10-21T06:54:07.211-0400 I  REPL     [replexec-10] Scheduling remote command request for vote request: RemoteCommand 1130 -- target:localhost:27018 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: true, term: 7, candidateIndex: 2, configVersion: 9, lastCommittedOp: { ts: Timestamp(1634813644, 1000), t: 7 } }
2021-10-21T06:54:07.211-0400 I  ELECTION [replexec-9] VoteRequester(term 7 dry run) received a no vote from localhost:27017 with reason "candidate's data is staler than mine. candidate's last applied OpTime: { ts: Timestamp(1634813644, 1000), t: 7 }, my last applied OpTime: { ts: Timestamp(1634813645, 1000), t: 7 }"; response message: { term: 7, voteGranted: false, reason: "candidate's data is staler than mine. candidate's last applied OpTime: { ts: Timestamp(1634813644, 1000), t: 7 }, my last applied OpTime: { ts: Timest...", ok: 1.0, $clusterTime: { clusterTime: Timestamp(1634813645, 1000), signature: { hash: BinData(0, 0000000000000000000000000000000000000000), keyId: 0 } }, operationTime: Timestamp(1634813645, 1000) }
2021-10-21T06:54:07.211-0400 I  ELECTION [replexec-2] VoteRequester(term 7 dry run) received a no vote from localhost:27018 with reason "candidate's data is staler than mine. candidate's last applied OpTime: { ts: Timestamp(1634813644, 1000), t: 7 }, my last applied OpTime: { ts: Timestamp(1634813645, 1000), t: 7 }"; response message: { term: 7, voteGranted: false, reason: "candidate's data is staler than mine. candidate's last applied OpTime: { ts: Timestamp(1634813644, 1000), t: 7 }, my last applied OpTime: { ts: Timest...", ok: 1.0, $clusterTime: { clusterTime: Timestamp(1634813645, 1000), signature: { hash: BinData(0, 0000000000000000000000000000000000000000), keyId: 0 } }, operationTime: Timestamp(1634813645, 1000) }
2021-10-21T06:54:07.211-0400 I  ELECTION [replexec-2] not running for primary, we received insufficient votes
2021-10-21T06:54:07.211-0400 I  ELECTION [replexec-2] Lost dry run election
</code></pre><p>The simulation is successful if we can verify the priority takeover could not complete due to <em>“candidate’s data is staler than mine”</em> failures. This implies the node trying to run for election requested votes from other nodes, which voted “no” as the candidate node needs to catch up. Note that if the oplog of the candidate node is <strong>more than 2 seconds behind</strong>, the priority takeover will not be scheduled and a failure such as the following will be logged:</p><pre><code class="language-log">2021-10-21T06:55:18.490-0400 I  ELECTION [replexec-13] Not starting an election for a priority takeover, since we are not electable due to: Not standing for election because member is not caught up enough to the most up-to-date member to call for priority takeover - must be within 2 seconds (mask 0x80)
</code></pre><p>Note that this threshold is defined by the <a href="https://github.com/mongodb/mongo/blob/r5.0.3/src/mongo/db/repl/topology_coordinator.idl"><code class="language-plaintext highlighter-rouge">priorityTakeoverFreshnessWindowSeconds</code></a> server parameter which controls how caught up in replication a secondary with higher priority than the current primary must be before it will call for a priority takeover election.</p><h2 id="ensuring-priority-takeover-when-lagging">Ensuring Priority Takeover when Lagging</h2><p>Assuming a 1-2 second delay is consistent, the priority takeover will continually be rescheduled but the election will always fail.</p><p>This particular scenario can be overcome using a combination of <a href="https://docs.mongodb.com/manual/reference/command/replSetFreeze/"><code class="language-plaintext highlighter-rouge">replSetFreeze</code></a> and <a href="https://docs.mongodb.com/manual/reference/command/replSetStepDown/"><code class="language-plaintext highlighter-rouge">replSetStepDown</code></a> as follows.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// file: freezeAndStepdown.js</span>
<span class="c1">//</span>
<span class="kd">function</span> <span class="nx">stepDown</span><span class="p">()</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">host</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">hello</span><span class="p">().</span><span class="nx">primary</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span>
  <span class="nx">printjson</span><span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">({</span> <span class="na">replSetStepDown</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span> <span class="na">secondaryCatchUpPeriodSecs</span><span class="p">:</span> <span class="mi">20</span> <span class="p">}));</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">freezeNode</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Mongo</span><span class="p">(</span><span class="nx">host</span><span class="p">)</span>
  <span class="nx">print</span><span class="p">(</span><span class="dl">"</span><span class="s2">Freezing </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">host</span><span class="p">)</span>
  <span class="nx">client</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">({</span> <span class="na">replSetFreeze</span><span class="p">:</span> <span class="mi">30</span> <span class="p">})</span>
<span class="p">}</span>

<span class="nx">freezeNode</span><span class="p">(</span><span class="dl">"</span><span class="s2">localhost:27017</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">freezeNode</span><span class="p">(</span><span class="dl">"</span><span class="s2">localhost:27018</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">stepDown</span><span class="p">();</span>
</pre></table></code></div></div><p>All other replica set members aside from the one we’ve given the highest priority (<code class="language-plaintext highlighter-rouge">localhost:27019</code> in our scenario) are first frozen to prevent them from seeking election for 30 seconds. The primary is then stepped down with a <code class="language-plaintext highlighter-rouge">secondaryCatchUpPeriodSecs</code> of 20 seconds set to allow eligible secondaries to catch up to the primary. As all other nodes are frozen and won’t seek election, the only remaining node which was consistently lagging will catch up and stand for election.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/priority-takeover-003.png" alt="" /></p><p>Our previous reproduction using <code class="language-plaintext highlighter-rouge">tmux</code> is updated as follows to produce this result:</p><ol><li><code class="language-plaintext highlighter-rouge">tail -n 1000 data/replset/rs3/mongod.log | grep -E "(ELECTION|REPL)"</code><li><code class="language-plaintext highlighter-rouge">mongoimport</code><li><code class="language-plaintext highlighter-rouge">mongo --quiet secondaryDelay.js</code><li><code class="language-plaintext highlighter-rouge">mongo "mongodb://localhost:27017/?replicaset=replset" --quiet --eval "c = rs.conf(); c.members[0].priority = 1; c.members[2].priority = 10; rs.reconfig(c)"</code><li><code class="language-plaintext highlighter-rouge">mongo --quiet freezeAndStepdown.js</code></ol><p>The end result should be the priority takeover attempt resulting in a successful dry run election and subsequent election.</p><pre><code class="language-log">2021-10-21T10:30:04.892-0400 I  ELECTION [replexec-15] not running for primary, we received insufficient votes
2021-10-21T10:30:04.907-0400 I  ELECTION [replexec-15] Lost dry run election
2021-10-21T10:30:05.772-0400 I  ELECTION [replexec-20] Scheduling priority takeover at 2021-10-21T10:30:16.346-0400
2021-10-21T10:30:09.777-0400 I  REPL     [replexec-14] Member localhost:27017 is now in state SECONDARY
2021-10-21T10:30:16.346-0400 I  REPL     [replexec-24] Canceling priority takeover callback
2021-10-21T10:30:16.346-0400 I  ELECTION [replexec-24] Starting an election for a priority takeover
2021-10-21T10:30:16.346-0400 I  ELECTION [replexec-24] conducting a dry run election to see if we could be elected. current term: 14
2021-10-21T10:30:16.346-0400 I  REPL     [replexec-24] Scheduling remote command request for vote request: RemoteCommand 6065 -- target:localhost:27017 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: true, term: 14, candidateIndex: 2, configVersion: 16, lastCommittedOp: { ts: Timestamp(1634826609, 1000), t: 14 } }
2021-10-21T10:30:16.346-0400 I  REPL     [replexec-24] Scheduling remote command request for vote request: RemoteCommand 6066 -- target:localhost:27018 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: true, term: 14, candidateIndex: 2, configVersion: 16, lastCommittedOp: { ts: Timestamp(1634826609, 1000), t: 14 } }
2021-10-21T10:30:16.347-0400 I  ELECTION [replexec-23] VoteRequester(term 14 dry run) received a yes vote from localhost:27017; response message: { term: 14, voteGranted: true, reason: "", ok: 1.0, $clusterTime: { clusterTime: Timestamp(1634826609, 1000), signature: { hash: BinData(0, 0000000000000000000000000000000000000000), keyId: 0 } }, operationTime: Timestamp(1634826609, 1000) }
2021-10-21T10:30:16.347-0400 I  ELECTION [replexec-23] dry election run succeeded, running for election in term 15
2021-10-21T10:30:18.621-0400 I  REPL     [replexec-22] Scheduling remote command request for vote request: RemoteCommand 6069 -- target:localhost:27017 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: false, term: 15, candidateIndex: 2, configVersion: 16, lastCommittedOp: { ts: Timestamp(1634826609, 1000), t: 14 } }
2021-10-21T10:30:18.621-0400 I  REPL     [replexec-22] Scheduling remote command request for vote request: RemoteCommand 6070 -- target:localhost:27018 db:admin cmd:{ replSetRequestVotes: 1, setName: "replset", dryRun: false, term: 15, candidateIndex: 2, configVersion: 16, lastCommittedOp: { ts: Timestamp(1634826609, 1000), t: 14 } }
2021-10-21T10:30:18.635-0400 I  ELECTION [replexec-15] VoteRequester(term 15) received a yes vote from localhost:27017; response message: { term: 15, voteGranted: true, reason: "", ok: 1.0, $clusterTime: { clusterTime: Timestamp(1634826609, 1000), signature: { hash: BinData(0, 0000000000000000000000000000000000000000), keyId: 0 } }, operationTime: Timestamp(1634826609, 1000) }
2021-10-21T10:30:18.638-0400 I  ELECTION [replexec-23] election succeeded, assuming primary role in term 15
2021-10-21T10:30:18.638-0400 I  REPL     [replexec-23] transition to PRIMARY from SECONDARY
</code></pre><p>From the screenshots we can see that during all election attempts the <code class="language-plaintext highlighter-rouge">mongoimport</code> workload continued to operate without issue.</p><p>Did this article help you? Let me know in the comments below ;)</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/replication/" class="post-tag no-text-decoration" >replication</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Ensuring a MongoDB Replica Set Member's Priority Takeover Succeeds - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Ensuring a MongoDB Replica Set Member's Priority Takeover Succeeds - ALEX BEVILACQUA&u=https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Ensuring a MongoDB Replica Set Member's Priority Takeover Succeeds - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Ensuring a MongoDB Replica Set Member's Priority Takeover Succeeds - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2021/12/23/mongodb-driver-specifications/">MongoDB Driver Specifications</a><li><a href="/blog/2021/12/29/troubleshooting-mongodb-cursor-xxxxxx-not-found-errors/">Troubleshooting 'MongoDB Cursor xxxxxx not found' Errors</a><li><a href="/blog/2021/07/28/adventure-games-1980-1999/">Journey into Adventure Games (1980-1999)</a><li><a href="/blog/2021/12/18/just-finished-sword-of-hope/">Just Finished - Sword of Hope</a><li><a href="/blog/2021/12/22/sanitarium/">Sanitarium (DreamForge Intertainment) - 1998</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/replication/">replication</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2020/02/13/mongodb-initial-sync-progress-monitoring/"><div class="card-body"> <span class="timeago small" > Feb 13, 2020 <i class="unloaded">2020-02-13T12:34:49-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MongoDB Initial Sync Progress Monitoring</h3><div class="text-muted small"><p> Sometimes our replica set members fall off the oplog and the node needs to be resynced. When this happens, an Initial Sync is required, which does the following: Clones all databases except the...</p></div></div></a></div><div class="card"> <a href="/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/"><div class="card-body"> <span class="timeago small" > Nov 20, 2020 <i class="unloaded">2020-11-20T10:31:26-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MongoDB 5.0 Initial Sync Progress Monitoring Improvements</h3><div class="text-muted small"><p> &lt;SHAMELESS_PLUG&gt; My previous article about initial sync progress monitoring got some attention, and as I’m a Technical Services Engineer at MongoDB, I got to provide direct feedback during t...</p></div></div></a></div><div class="card"> <a href="/blog/2021/03/23/visualizing-a-replica-sets-sync-source-chain/"><div class="card-body"> <span class="timeago small" > Mar 23 <i class="unloaded">2021-03-23T10:47:41-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Visualizing a Replica Set's Sync Source Chain</h3><div class="text-muted small"><p> A MongoDB replica set is a group of mongod processes that maintain the same data set. The PRIMARY node receives all write operations and The SECONDARY nodes replicate the PRIMARY’s oplog and apply ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2021/10/07/mongodb-versioned-api/" class="btn btn-outline-primary" prompt="Older"><p>MongoDB Versioned API</p></a> <a href="/blog/2021/10/27/just-finished-brain-lord/" class="btn btn-outline-primary" prompt="Newer"><p>Just Finished - Brain Lord</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//alexbevi.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Ensuring a MongoDB Replica Set Member's Priority Takeover Succeeds'; this.page.url = 'https://www.alexbevi.com/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/'; this.page.identifier = '/blog/2021/10/21/ensuring-replica-set-priority-takeover-success/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/replication/">replication</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.alexbevi.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script type="text/javascript" src="/assets/js/lightbox.js"></script><link rel="stylesheet" href="/assets/css/lightbox.css">
