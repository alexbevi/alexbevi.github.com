<!doctype html>
    <!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
    <!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
    <!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
    <!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->

    
      
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Analysis and Optimization of an N+1 Scenario in Mongoid - ALEX BEVILACQUA</title>
        <meta name="author" content="Alex Bevilacqua">
        
        <meta name="description" content="Analysis and Optimization of an N+1 Scenario in Mongoid Mar 26th, 2021 mongodb mongoid ruby Comments Last Updated: Mar 26, 2021 The N + 1 queries &hellip;">
        
        <meta name="viewport" content="width=device-width">
        <link rel="canonical" href="http://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid">

        <link href='http://fonts.googleapis.com/css?family=Droid+Serif:400,400italic' rel='stylesheet' type='text/css'>
        <link href="http://fonts.googleapis.com/css?family=Droid+Sans" rel="stylesheet" type="text/css">

        
        <link href="/favicon.png" rel="icon">
        <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet">
        <link href="/atom.xml" rel="alternate" title="ALEX BEVILACQUA" type="application/atom+xml">
        <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/galleria/1.4.2/galleria.min.js" type="text/javascript"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/galleria/1.4.2/themes/classic/galleria.classic.min.js" type="text/javascript"></script>
<link href="//cdnjs.cloudflare.com/ajax/libs/galleria/1.4.2/themes/classic/galleria.classic.min.css" media="screen, projection" rel="stylesheet" type="text/css" />
<style>
  /* This rule is read by Galleria to define the gallery height: */
  #galleria{height:320px}
</style>

        <link href='/stylesheets/data-table.css' rel='stylesheet' type='text/css'>
    </head>


    <body >

        <header id="header">
    <div class="row">
    <div class="col-xs-12 col-sm-8 col-md-4">
        <a href="/" class="site-title">ALEX BEVILACQUA</a>
    </div>
    <div class="col-xs-12 col-sm-4 col-md-8">
        <nav>
    <input type="checkbox" id="toggle">
    <label for="toggle" class="toggle" data-open="Main Menu" data-close="Close Menu"></label>
    <ul class="menu">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/reviews">Reviews</a></li>
  <li><a href="/projects">Projects</a></li>
  <li><a href="/about">About Me</a></li>
</ul>

</nav>

    </div>
</div>

</header>


        <div id="main-content">

            <!--[if lte IE 9]>
<div class="row upgrade-row">
    <div class="col-lg-12">
        <div class="upgrade">
            <i class="upgrade__icon fa fa-warning"></i>
            <h1 class="upgrade__title h6">Ohnoes!</h1>
            <p class="upgrade__text">
                Unfortunately, certain parts of this site may not display correctly in your version of Internet Explorer!<br>
                If possible, you should consider <a href="http://browsehappy.com/">upgrading your browser</a>.
            </p>
        </div>
    </div>
</div>
<!-- <![endif]-->


            

            <div class="row top-xs center-sm center-md center-lg site-wrapper">
                
                <div class="col-xs-12 col-sm-10 col-md-8 col-lg-8">
                
                    <article class="article article--single">
    <header class="article__header">
    
        <h1 class="article__title">Analysis and Optimization of an N+1 Scenario in Mongoid</h1>
    

    
        <div class="article__meta clearfix">
            






    <time class="article__date pull-left" datetime="2021-03-26T09:16:09-04:00" pubdate><i class="fa fa-calendar"></i> Mar 26th, 2021</time>




            

    <div class="article__tags pull-left">
        <i class="fa fa-tags"></i>
        <ul class="unstyled">
        

            
                <li><a class='category' href='/blog/categories/mongodb/'>mongodb</a></li>
            
                <li><a class='category' href='/blog/categories/mongoid/'>mongoid</a></li>
            
                <li><a class='category' href='/blog/categories/ruby/'>ruby</a></li>
            
        
        </ul>
    </div>


            
                <a class="pull-right" href="#disqus_thread">
                    Comments <i class="fa fa-comment"></i>
                </a>
            
        </div>
    
</header>




    <p class="clearfix"><small class="pull-right"><em>Last Updated: Mar 26, 2021</em></small></p>
    <p>The <code>N + 1</code> queries problem is a common issue Rails applications face whereby iterating an array of models and accessing an association results in a sub-optimal pattern of recurring queries.</p>

<p>To address this Rails offers <a href="https://guides.rubyonrails.org/active_record_querying.html#eager-loading-associations">Eager Loading Associations</a> and there are gems (such as <a href="https://github.com/flyerhzm/bullet">bullet</a>) that can be used to detect the <code>N + 1</code> pattern in an application.</p>

<p>This <code>N + 1</code> problem can manifest in any <a href="https://medium.com/spidernitt/orm-and-odm-a-brief-introduction-369046ec57eb">ODM or ORM</a>, including when working with MongoDB and Ruby.</p>

<p>For the purposes of this example we have a Ruby application that is using the <a href="https://docs.mongodb.com/mongoid/current/">Mongoid</a> ODM with a minimal <a href="https://docs.mongodb.com/mongoid/current/tutorials/mongoid-documents/">Document</a> model that contains a single <a href="https://docs.mongodb.com/mongoid/current/tutorials/mongoid-documents/#fields">Field</a> definition. The scripts to setup the cluster and seed the data are shared at the end of this article (see <em>Reproduction</em>).</p>

<!-- MORE -->


<p>Our model only defines a single field, but an external process updates the underlying document in the MongoDB cluster with telemetry entries. As no schema is enforced, this is perfectly valid however the documents may grow too large over time for which we&rsquo;ve written the following Ruby application to periodically clean up:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># mongoid_n_plus_1.rb</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;benchmark&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;bundler/inline&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">gemfile</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;mongoid&#39;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;mongo&#39;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Mongoid</span><span class="o">.</span><span class="n">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">uri</span><span class="p">:</span> <span class="s2">&quot;mongodb://localhost:27017,localhost:27018,localhost:27019/test&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Test</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="nb">String</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># return all entries from the document that aren&#39;t defined as Mongoid fields</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">entries</span>
</span><span class='line'>    <span class="kp">attr</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">clone</span>
</span><span class='line'>    <span class="kp">attr</span><span class="o">.</span><span class="n">delete_if</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="nb">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">key?</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="kp">attr</span><span class="o">.</span><span class="n">sort</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">compact!</span>
</span><span class='line'>    <span class="c1"># unset each field that doesn&#39;t belong to the Mongoid document as an</span>
</span><span class='line'>    <span class="c1"># explicitly defined field</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">entry</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">unset</span> <span class="n">entry</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using a Ruby REPL we can require the above code and verify it&rsquo;s connecting to our cluster and interacting with our document:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&gt;</span> <span class="n">require_relative</span> <span class="s1">&#39;mongoid_n_plus_1&#39;</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="no">Test</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="c1">#&lt;Test _id: 1.0, name: &quot;Alex&quot;&gt;</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="mi">10000</span>
</span><span class='line'><span class="o">&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">entries</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">15</span><span class="o">]</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="o">[[</span><span class="s2">&quot;2021-03-25T10:30:21&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:22&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:23&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:24&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:25&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:26&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:27&quot;</span><span class="p">,</span> <span class="mi">7</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:28&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:29&quot;</span><span class="p">,</span> <span class="mi">9</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:30&quot;</span><span class="p">,</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:31&quot;</span><span class="p">,</span> <span class="mi">11</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:32&quot;</span><span class="p">,</span> <span class="mi">12</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:33&quot;</span><span class="p">,</span> <span class="mi">13</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:34&quot;</span><span class="p">,</span> <span class="mi">14</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:35&quot;</span><span class="p">,</span> <span class="mi">15</span><span class="o">.</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'> <span class="o">[</span><span class="s2">&quot;2021-03-25T10:30:36&quot;</span><span class="p">,</span> <span class="mi">16</span><span class="o">.</span><span class="mi">0</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next let&rsquo;s measure our <code>compact!</code> operations:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&gt;</span> <span class="nb">puts</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">measure</span> <span class="p">{</span> <span class="n">t</span><span class="o">.</span><span class="n">compact!</span> <span class="p">}</span>
</span><span class='line'>  <span class="mi">17</span><span class="o">.</span><span class="mi">319826</span>   <span class="mi">1</span><span class="o">.</span><span class="mo">025</span><span class="mi">931</span>  <span class="mi">18</span><span class="o">.</span><span class="mi">345757</span> <span class="p">(</span> <span class="mi">55</span><span class="o">.</span><span class="mo">0044</span><span class="mi">95</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We&rsquo;re only modifying a single document, after reviewing the FTDC<sup><a href="#fn1">1</a></sup> it appears there are about 10K update operations issued, which is taking about a minute to completed.</p>

<p><img src="/images/nplus1-1.png"></p>

<p>After reviewing the documentation for MongoDB&rsquo;s <a href="https://docs.mongodb.com/manual/reference/operator/update/unset/"><code>$unset</code></a> update operator it appears we can pass more than one field at a time. If this is the case, we can send a single command with a list of 10K fields as opposed to 10K commands with a single field each.</p>

<p>To test this we modify our <code>compact!</code> method as follow:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">compact!</span>
</span><span class='line'>    <span class="c1"># each field in the `entries` array is a [k,v] array</span>
</span><span class='line'>    <span class="c1"># map the `k` (field) values into a single array and send them all</span>
</span><span class='line'>    <span class="c1"># as a single unset command</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">unset</span> <span class="nb">self</span><span class="o">.</span><span class="n">entries</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:first</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>After testing this the result confirms our theory and the performance is significantly better:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&gt;</span> <span class="nb">puts</span> <span class="no">Benchmark</span><span class="o">.</span><span class="n">measure</span> <span class="p">{</span> <span class="n">t</span><span class="o">.</span><span class="n">compact!</span> <span class="p">}</span>
</span><span class='line'>  <span class="mi">0</span><span class="o">.</span><span class="mi">150776</span>   <span class="mi">0</span><span class="o">.</span><span class="mo">00250</span><span class="mi">9</span>   <span class="mi">0</span><span class="o">.</span><span class="mi">153285</span> <span class="p">(</span>  <span class="mi">0</span><span class="o">.</span><span class="mi">273297</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reviewing the FTDC again shows only a single command was issued:</p>

<p><img src="/images/nplus1-2.png"></p>

<p>Anytime operations are being sent to the server from within a loop there may be an opportunity to group/batch actions in a more efficient manner. The first step to improving performance is being able to identify an opportunity for improvement, which I hope this article helps you do.</p>

<p>Happy Coding!</p>

<h3>Reproduction</h3>

<h4>Setup</h4>

<p>First, we spin up a local <a href="https://docs.mongodb.com/manual/replication">replica set</a> using some open source MongoDB helper utilities (see <a href="https://github.com/aheckmann/m"><code>m</code></a> and <a href="https://github.com/rueckstiess/mtools"><code>mtools</code></a>):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>m 4.2.13
</span><span class='line'>mlaunch init --replicaset --nodes <span class="m">3</span> --binarypath <span class="k">$(</span>m bin 4.2.13<span class="k">)</span> --host localhost --bind_ip_all
</span><span class='line'>mongo <span class="s2">&quot;mongodb://localhost:27017,localhost:27018,localhost:27019/test&quot;</span> test.js
</span></code></pre></td></tr></table></div></figure>


<p>The JavaScript file (<code>test.js</code>) above is used to seed the collection with a single document and 10,000 telemetry entries:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">// test.js</span>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span><span class="o">:</span> <span class="s2">&quot;Alex&quot;</span> <span class="p">});</span>
</span><span class='line'>
</span><span class='line'><span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">();</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'><span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>   <span class="nx">d</span><span class="p">.</span><span class="nx">setSeconds</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">getSeconds</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>   <span class="nx">update</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nx">toISOString</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">_id</span><span class="o">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$set</span><span class="o">:</span> <span class="nx">update</span> <span class="p">})</span>
</span></code></pre></td></tr></table></div></figure>


<p>From the <a href="https://docs.mongodb.com/manual/mongo/"><code>mongo</code></a> or <a href="https://docs.mongodb.com/mongodb-shell/"><code>mongosh</code></a> the result of this script can be verified:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'> mongo <span class="s2">&quot;mongodb://localhost:27017,localhost:27018,localhost:27019/test&quot;</span> --quiet --eval <span class="s1">&#39;db.tests.find().pretty()&#39;</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s2">&quot;_id&quot;</span>: 1,
</span><span class='line'>  <span class="s2">&quot;name&quot;</span>: <span class="s2">&quot;Alex&quot;</span>,
</span><span class='line'>  <span class="s2">&quot;2021-03-25T10:55:23&quot;</span>: 1,
</span><span class='line'>  <span class="s2">&quot;2021-03-25T10:55:24&quot;</span>: 2,
</span><span class='line'>  <span class="s2">&quot;2021-03-25T10:55:25&quot;</span>: 3,
</span><span class='line'>  <span class="s2">&quot;2021-03-25T10:55:26&quot;</span>: 4,
</span><span class='line'>  ...
</span><span class='line'>  <span class="s2">&quot;2021-03-25T13:41:59&quot;</span>: 9997,
</span><span class='line'>  <span class="s2">&quot;2021-03-25T13:42:00&quot;</span>: 9998,
</span><span class='line'>  <span class="s2">&quot;2021-03-25T13:42:01&quot;</span>: 9999,
</span><span class='line'>  <span class="s2">&quot;2021-03-25T13:42:02&quot;</span>: 10000
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<hr>


<p><small><a name="fn1">1</a>: As a MongoDB Technical Services engineer I have access to tools we can use to parse the cluster&rsquo;s <code>FTDC</code> (see <a href="/blog/2020/01/26/what-is-mongodb-ftdc-aka-diagnostic-dot-data/">&ldquo;What is MongoDB FTDC (aka. diagnostic.data)&rdquo;</a> for more info) and visualize time series performance telemetry, which were used to generate the following charts.</small></p>



</article>

  <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/" data-via="alexbevi" data-counturl="http://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/" >Tweet</a>
  
  
  
    <script src="//platform.linkedin.com/in.js" type="text/javascript">
    lang: en_US
  </script>
  <script type="IN/Share" data-url="http://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/" data-counter="right"></script>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
  <script type="text/javascript" src="//www.reddit.com/buttonlite.js?i=5"></script>
</div>



<section id="disqus">
    <h1 class="disqus__title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
</section>


                </div>

                
                <aside class="sidebar col-xs-12 col-md-4 col-lg-4">
                    <div class="row">

    
        <section class="hire--aside col-xs-12 col-sm-10 col-md-12">
            
    



    




<div class="hire hire--available hire--vibrant">
    <a class="hire__link" href="mailto:alex@alexbevi.com?subject=New%20job%20opportunity">
        Need a developer?
    </a>
</div>


        </section>
    

    
<section class="social col-xs-12 col-sm-6 col-md-12">
    <h1>
        Follow me!
    </h1>
    <ul class="unstyled">
        
        
        
        <li><a class="facebook" href="//facebook.com/alexbevi"><i class="fa fa-facebook-square"></i> Facebook</a></li>
        <li><a class="github" href="//github.com/alexbevi"><i class="fa fa-github"></i> Github</a></li>
        <li><a class="googleplus" href="//plus.google.com/+alexbevilacqua"><i class="fa fa-google-plus-square"></i> Google+</a></li>
        
        
        <li><a class="linkedin" href="//linkedin.com/in/alexbevi"><i class="fa fa-linkedin-square"></i> LinkedIn</a></li>
        
        <li><a class="reddit" href="//reddit.com/user/alexbevi"><i class="fa fa-reddit"></i> reddit</a></li>
        <li><a class="stackoverflow" href="//stackoverflow.com/users/195509"><i class="fa fa-stack-overflow"></i> StackOverflow</a></li>
        <li><a class="twitter" href="//twitter.com/alexbevi"><i class="fa fa-twitter"></i> Twitter</a></li>
        
    </ul>
</section>



    <section id="recent-posts" class="col-xs-12 col-sm-6 col-md-12">
    <h1>Recent Posts</h1>
    <ul class="divided">
        
        <li class="post">
            <a href="/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/">Analysis and Optimization of an N+1 Scenario in Mongoid</a>
        </li>
        
        <li class="post">
            <a href="/blog/2021/03/23/visualizing-a-replica-sets-sync-source-chain/">Visualizing a Replica Set's Sync Source Chain</a>
        </li>
        
        <li class="post">
            <a href="/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/">MongoDB 5.0 Initial Sync Progress Monitoring Improvements</a>
        </li>
        
        <li class="post">
            <a href="/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/">MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</a>
        </li>
        
        <li class="post">
            <a href="/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/">Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule</a>
        </li>
        
    </ul>
</section>
<section>
  <h2>Looking for Something to Read?</h1>
  <a href="http://www.packtpub.com/redmine-plugin-extension-and-development/book" target ="_blank">
    <img src="/images/8748OS_mockupcover_normal_0.jpg" alt="Redmine Plugin Extension and Development">
  </a>

  <ul>
    <li>Gain access to powerful and useful features by hooking into Redmine's underlying infrastructure</li>
    <li>Real-world examples that will help you in building cross-platform applications using Redmine</li>
    <li>Full of illustrations, tips, and tricks to facilitate the development of plugins and extensions</li>
  </ul>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6215800856413580",
            enable_page_level_ads: true
       });
  </script>
</section>

<section id="github-repos" class="col-xs-12 col-sm-6 col-md-12">
    <h1>
        GitHub Repos
        
        <small class="pull-right">
            <a class="btn" href="//github.com/alexbevi" title="@alexbevi on GitHub" target="_blank">
                <i class="fa fa-external-link"></i>
            </a>
        </small>
        
    </h1>
    <ul id="gh_repos" class="divided">
        <li class="loading">
            <i class="fa fa-spinner fa-spin"></i>
        </li>
    </ul>
</section>





<section id="twitter-timeline" class="col-xs-12 col-sm-6 col-md-12">
    <h1>
        Latest Tweets
        
        <small class="pull-right">
            <a class="btn" href="//twitter.com/alexbevi" title="@alexbevi on Twitter" target="_blank">
                <i class="fa fa-external-link"></i>
            </a>
        </small>
        
    </h1>

    <a class="twitter-timeline" data-dnt="true" href="//twitter.com/alexbevi"  data-widget-id="448022650414051328"  data-link-color="#049cdb" data-tweet-limit="" data-chrome="noheader nofooter transparent noscrollbar">Tweets by @alexbevi</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>



</div>

                </aside>
                
            </div>
        </div>

        

    
    




<footer class="footer">
    <div class="row middle-xs">
        
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
            <p class="footer__copyright">
    All content copyright Alex Bevilacqua.<br>
    Code under <a href="//github.com/coogie/oscailte/blob/master/README.md">MIT Licence</a>.
</p>

        </div>
        
        
    </div>
</footer>

        

<script type="text/javascript">
      var disqus_shortname = 'alexbevi';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/';
        var disqus_url = 'http://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>





  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
<script src="//crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
<script defer src="/javascripts/octopress.js"></script>


<script>
    var _gaq=[['_setAccount','UA-36490021-1'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>



<script>
    var disqus_shortname = 'alexbevi';
    
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/';
        var disqus_url = 'http://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/';
        var disqus_script = 'embed.js';
    
    (function () {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<script>
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'alexbevi',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
</script>
<script src="/javascripts/github.js"></script>







    </body>

</html>
