<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Analysis and Optimization of an N+1 Scenario in Mongoid" /><meta property="og:locale" content="en" /><meta name="description" content="The N + 1 queries problem is a common issue Rails applications face whereby iterating an array of models and accessing an association results in a sub-optimal pattern of recurring queries." /><meta property="og:description" content="The N + 1 queries problem is a common issue Rails applications face whereby iterating an array of models and accessing an association results in a sub-optimal pattern of recurring queries." /><link rel="canonical" href="https://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content=" https://www.alexbevi.com/images/mongodb-logo.png " /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-03-26T09:16:09-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content=" https://www.alexbevi.com/images/mongodb-logo.png " /><meta property="twitter:title" content="Analysis and Optimization of an N+1 Scenario in Mongoid" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-09-04T14:24:04-04:00","datePublished":"2021-03-26T09:16:09-04:00","description":"The N + 1 queries problem is a common issue Rails applications face whereby iterating an array of models and accessing an association results in a sub-optimal pattern of recurring queries.","headline":"Analysis and Optimization of an N+1 Scenario in Mongoid","image":" https://www.alexbevi.com/images/mongodb-logo.png ","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/"},"url":"https://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/"}</script><title>Analysis and Optimization of an N+1 Scenario in Mongoid | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="/assets/lib/glightbox/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script defer src="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.umd.min.js"></script> <script defer src="/assets/lib/glightbox/glightbox.min.js"></script> <script defer src="/assets/lib/clipboard/clipboard.min.js"></script> <script defer src="/assets/lib/dayjs/dayjs.min.js"></script> <script defer src="/assets/lib/dayjs/locale/en.js"></script> <script defer src="/assets/lib/dayjs/plugin/relativeTime.js"></script> <script defer src="/assets/lib/dayjs/plugin/localizedFormat.js"></script> <script defer src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script><meta name="google-adsense-account" content="ca-pub-6215800856413580"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src=" /./images/avatar.png " width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ALEX BEVILACQUA</a><p class="site-subtitle fst-italic mb-0">my little corner of the interwebs</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/specifications/" class="nav-link"> <i class="fa-fw fas fa-book"></i> <span>SPECIFICATIONS</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Analysis and Optimization of an N+1 Scenario in Mongoid</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>Analysis and Optimization of an N+1 Scenario in Mongoid</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1616764569" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 26, 2021 </time> </span> <span> Updated <time data-ts="1757010244" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 4, 2025 </time> </span><div class="mt-3 mb-3"> <a href=" /images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src=" /images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="851 words" > <em>4 min</em> read </span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">Analysis and Optimization of an N+1 Scenario in Mongoid</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">Analysis and Optimization of an N+1 Scenario in Mongoid</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><p>The <code class="language-plaintext highlighter-rouge">N + 1</code> queries problem is a common issue Rails applications face whereby iterating an array of models and accessing an association results in a sub-optimal pattern of recurring queries.</p><p>To address this Rails offers <a href="https://guides.rubyonrails.org/active_record_querying.html#eager-loading-associations">Eager Loading Associations</a> and there are gems (such as <a href="https://github.com/flyerhzm/bullet">bullet</a>) that can be used to detect the <code class="language-plaintext highlighter-rouge">N + 1</code> pattern in an application.</p><p>This <code class="language-plaintext highlighter-rouge">N + 1</code> problem can manifest in any <a href="https://medium.com/spidernitt/orm-and-odm-a-brief-introduction-369046ec57eb">ODM or ORM</a>, including when working with MongoDB and Ruby.</p><p>For the purposes of this example we have a Ruby application that is using the <a href="https://docs.mongodb.com/mongoid/current/">Mongoid</a> ODM with a minimal <a href="https://docs.mongodb.com/mongoid/current/tutorials/mongoid-documents/">Document</a> model that contains a single <a href="https://docs.mongodb.com/mongoid/current/tutorials/mongoid-documents/#fields">Field</a> definition. The scripts to setup the cluster and seed the data are shared at the end of this article (see <em>Reproduction</em>).</p><p>Our model only defines a single field, but an external process updates the underlying document in the MongoDB cluster with telemetry entries. As no schema is enforced, this is perfectly valid however the documents may grow too large over time for which we’ve written the following Ruby application to periodically clean up:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="c1">#</span>
<span class="c1"># mongoid_n_plus_1.rb</span>
<span class="c1">#</span>
<span class="nb">require</span> <span class="s1">'benchmark'</span>
<span class="nb">require</span> <span class="s1">'bundler/inline'</span>

<span class="n">gemfile</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s1">'https://rubygems.org'</span>

  <span class="n">gem</span> <span class="s1">'mongoid'</span>
  <span class="n">gem</span> <span class="s1">'mongo'</span>
<span class="k">end</span>

<span class="no">Mongoid</span><span class="p">.</span><span class="nf">configure</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
  <span class="n">config</span><span class="p">.</span><span class="nf">clients</span><span class="p">.</span><span class="nf">default</span> <span class="o">=</span> <span class="p">{</span>
    <span class="ss">uri: </span><span class="s2">"mongodb://localhost:27017,localhost:27018,localhost:27019/test"</span>
  <span class="p">}</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Test</span>
  <span class="kp">include</span> <span class="no">Mongoid</span><span class="o">::</span><span class="no">Document</span>

  <span class="n">field</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">type: </span><span class="no">String</span>

  <span class="c1"># return all entries from the document that aren't defined as Mongoid fields</span>
  <span class="k">def</span> <span class="nf">entries</span>
    <span class="kp">attr</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">attributes</span><span class="p">.</span><span class="nf">dup</span>
    <span class="kp">attr</span><span class="p">.</span><span class="nf">delete_if</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="nb">self</span><span class="p">.</span><span class="nf">fields</span><span class="p">.</span><span class="nf">key?</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="p">}</span>
    <span class="kp">attr</span><span class="p">.</span><span class="nf">sort</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">compact!</span>
    <span class="c1"># unset each field that doesn't belong to the Mongoid document as an</span>
    <span class="c1"># explicitly defined field</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">entries</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">entry</span><span class="o">|</span>
      <span class="nb">self</span><span class="p">.</span><span class="nf">unset</span> <span class="n">entry</span><span class="p">.</span><span class="nf">first</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></table></code></div></div><p>Using a Ruby REPL we can require the above code and verify it’s connecting to our cluster and interacting with our document:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="nb">require_relative</span> <span class="s1">'mongoid_n_plus_1'</span>
 <span class="o">=&gt;</span> <span class="kp">true</span>
<span class="o">&gt;</span> <span class="n">t</span> <span class="o">=</span> <span class="no">Test</span><span class="p">.</span><span class="nf">first</span>
<span class="o">=&gt;</span> <span class="c1">#&lt;Test _id: 1.0, name: "Alex"&gt;</span>
<span class="o">&gt;</span> <span class="n">t</span><span class="p">.</span><span class="nf">entries</span><span class="p">.</span><span class="nf">length</span>
<span class="o">=&gt;</span> <span class="mi">10000</span>
<span class="o">&gt;</span> <span class="n">t</span><span class="p">.</span><span class="nf">entries</span><span class="p">[</span><span class="mi">0</span><span class="o">..</span><span class="mi">15</span><span class="p">]</span>
<span class="o">=&gt;</span> <span class="p">[[</span><span class="s2">"2021-03-25T10:30:21"</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:22"</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:23"</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:24"</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:25"</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:26"</span><span class="p">,</span> <span class="mf">6.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:27"</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:28"</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:29"</span><span class="p">,</span> <span class="mf">9.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:30"</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:31"</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:32"</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:33"</span><span class="p">,</span> <span class="mf">13.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:34"</span><span class="p">,</span> <span class="mf">14.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:35"</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">],</span>
 <span class="p">[</span><span class="s2">"2021-03-25T10:30:36"</span><span class="p">,</span> <span class="mf">16.0</span><span class="p">]]</span>
</pre></table></code></div></div><p>Next let’s measure our <code class="language-plaintext highlighter-rouge">compact!</code> operations:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="nb">puts</span> <span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="p">{</span> <span class="n">t</span><span class="p">.</span><span class="nf">compact!</span> <span class="p">}</span>
  <span class="mf">17.319826</span>   <span class="mf">1.025931</span>  <span class="mf">18.345757</span> <span class="p">(</span> <span class="mf">55.004495</span><span class="p">)</span>
</pre></table></code></div></div><p>We’re only modifying a single document, after reviewing the FTDC<sup><a href="#fn1">1</a></sup> it appears there are about 10K update operations issued, which is taking about a minute to completed.</p><p><a href=" /images/nplus1-1.png" class="popup img-link shimmer"><img src=" /images/nplus1-1.png" alt="" loading="lazy"></a></p><p>After reviewing the documentation for MongoDB’s <a href="https://docs.mongodb.com/manual/reference/operator/update/unset/"><code class="language-plaintext highlighter-rouge">$unset</code></a> update operator it appears we can pass more than one field at a time. If this is the case, we can send a single command with a list of 10K fields as opposed to 10K commands with a single field each.</p><p>To test this we modify our <code class="language-plaintext highlighter-rouge">compact!</code> method as follow:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>  <span class="k">def</span> <span class="nf">compact!</span>
    <span class="c1"># each field in the `entries` array is a [k,v] array</span>
    <span class="c1"># map the `k` (field) values into a single array and send them all</span>
    <span class="c1"># as a single unset command</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">unset</span> <span class="nb">self</span><span class="p">.</span><span class="nf">entries</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:first</span><span class="p">)</span>
  <span class="k">end</span>
</pre></table></code></div></div><p>After testing this the result confirms our theory and the performance is significantly better:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="o">&gt;</span> <span class="nb">puts</span> <span class="no">Benchmark</span><span class="p">.</span><span class="nf">measure</span> <span class="p">{</span> <span class="n">t</span><span class="p">.</span><span class="nf">compact!</span> <span class="p">}</span>
  <span class="mf">0.150776</span>   <span class="mf">0.002509</span>   <span class="mf">0.153285</span> <span class="p">(</span>  <span class="mf">0.273297</span><span class="p">)</span>
</pre></table></code></div></div><p>Reviewing the FTDC again shows only a single command was issued:</p><p><a href=" /images/nplus1-2.png" class="popup img-link shimmer"><img src=" /images/nplus1-2.png" alt="" loading="lazy"></a></p><p>Anytime operations are being sent to the server from within a loop there may be an opportunity to group/batch actions in a more efficient manner. The first step to improving performance is being able to identify an opportunity for improvement, which I hope this article helps you do.</p><p>Happy Coding!</p><h3 id="reproduction"><span class="me-2">Reproduction</span><a href="#reproduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First, we spin up a local <a href="https://docs.mongodb.com/manual/replication">replica set</a> using some open source MongoDB helper utilities (see <a href="https://github.com/aheckmann/m"><code class="language-plaintext highlighter-rouge">m</code></a> and <a href="https://github.com/rueckstiess/mtools"><code class="language-plaintext highlighter-rouge">mtools</code></a>):</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>m 4.2.13
mlaunch init <span class="nt">--replicaset</span> <span class="nt">--nodes</span> 3 <span class="nt">--binarypath</span> <span class="si">$(</span>m bin 4.2.13<span class="si">)</span> <span class="nt">--host</span> localhost <span class="nt">--bind_ip_all</span>
mongo <span class="s2">"mongodb://localhost:27017,localhost:27018,localhost:27019/test"</span> test.js
</pre></table></code></div></div><p>The JavaScript file (<code class="language-plaintext highlighter-rouge">test.js</code>) above is used to seed the collection with a single document and 10,000 telemetry entries:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="c1">// test.js</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nf">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Alex</span><span class="dl">"</span> <span class="p">});</span>

<span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">();</span>
<span class="kd">var</span> <span class="nx">update</span> <span class="o">=</span> <span class="p">{};</span>
<span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">10000</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
   <span class="nx">d</span><span class="p">.</span><span class="nf">setSeconds</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">getSeconds</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
   <span class="nx">update</span><span class="p">[</span><span class="nx">d</span><span class="p">.</span><span class="nf">toISOString</span><span class="p">().</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">.</span><span class="dl">'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">tests</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="nx">update</span> <span class="p">})</span>
</pre></table></code></div></div><p>From the <a href="https://docs.mongodb.com/manual/mongo/"><code class="language-plaintext highlighter-rouge">mongo</code></a> or <a href="https://docs.mongodb.com/mongodb-shell/"><code class="language-plaintext highlighter-rouge">mongosh</code></a> the result of this script can be verified:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre> mongo <span class="s2">"mongodb://localhost:27017,localhost:27018,localhost:27019/test"</span> <span class="nt">--quiet</span> <span class="nt">--eval</span> <span class="s1">'db.tests.find().pretty()'</span>
<span class="o">{</span>
  <span class="s2">"_id"</span>: 1,
  <span class="s2">"name"</span>: <span class="s2">"Alex"</span>,
  <span class="s2">"2021-03-25T10:55:23"</span>: 1,
  <span class="s2">"2021-03-25T10:55:24"</span>: 2,
  <span class="s2">"2021-03-25T10:55:25"</span>: 3,
  <span class="s2">"2021-03-25T10:55:26"</span>: 4,
  ...
  <span class="s2">"2021-03-25T13:41:59"</span>: 9997,
  <span class="s2">"2021-03-25T13:42:00"</span>: 9998,
  <span class="s2">"2021-03-25T13:42:01"</span>: 9999,
  <span class="s2">"2021-03-25T13:42:02"</span>: 10000
<span class="o">}</span>
</pre></table></code></div></div><hr /><p><small><a name="fn1">1</a>: As a MongoDB Technical Services engineer I have access to tools we can use to parse the cluster’s <code class="language-plaintext highlighter-rouge">FTDC</code> (see <a href="/blog/2020/01/26/what-is-mongodb-ftdc-aka-diagnostic-dot-data/">“What is MongoDB FTDC (aka. diagnostic.data)”</a> for more info) and visualize time series performance telemetry, which were used to generate the following charts.</small></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/ruby/">Ruby</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/mongoid/" class="post-tag no-text-decoration" >mongoid</a> <a href="/tags/ruby/" class="post-tag no-text-decoration" >ruby</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Analysis%20and%20Optimization%20of%20an%20N+1%20Scenario%20in%20Mongoid%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2021%2F03%2F26%2Fanalysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Analysis%20and%20Optimization%20of%20an%20N+1%20Scenario%20in%20Mongoid%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2021%2F03%2F26%2Fanalysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2021%2F03%2F26%2Fanalysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid%2F&text=Analysis%20and%20Optimization%20of%20an%20N+1%20Scenario%20in%20Mongoid%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2021%2F03%2F26%2Fanalysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Analysis%20and%20Optimization%20of%20an%20N+1%20Scenario%20in%20Mongoid%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2021%2F03%2F26%2Fanalysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <a href="https://bsky.app/intent/compose?text=Analysis%20and%20Optimization%20of%20an%20N+1%20Scenario%20in%20Mongoid%20-%20ALEX%20BEVILACQUA%20https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2021%2F03%2F26%2Fanalysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Bluesky" aria-label="Bluesky"> <i class="fa-fw fa-brands fa-bluesky"></i> </a> <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2021%2F03%2F26%2Fanalysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid%2F&title=Analysis%20and%20Optimization%20of%20an%20N+1%20Scenario%20in%20Mongoid%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit"> <i class="fa-fw fa-brands fa-square-reddit"></i> </a> <a href="https://www.threads.net/intent/post?text=Analysis%20and%20Optimization%20of%20an%20N+1%20Scenario%20in%20Mongoid%20-%20ALEX%20BEVILACQUA%20https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2021%2F03%2F26%2Fanalysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Threads" aria-label="Threads"> <i class="fa-fw fa-brands fa-square-threads"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2023/02/08/emmanuelle/">Emmanuelle (Coktel Vision) - 1989</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/10/beneath-a-steel-sky/">Beneath a Steel Sky (Revolution Software) - 1994</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/13/rise-of-the-dragon/">Rise of the Dragon (Dynamix) - 1990</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/13/ruby-on-rails-global-summit-23/">Ruby on Rails Global Summit '23</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/15/urban-runner/">Urban Runner (Coktel Vision) - 1996</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/javascript/">javascript</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/blog/2014/06/23/troubleshooting-a-mongoid-connection-issue/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1403533678" data-df="ll" > Jun 23, 2014 </time><h4 class="pt-0 my-2">Troubleshooting a Mongoid Connection Issue</h4><div class="text-muted"><p>I’ve been struggling with an issue for a while now regarding Mongoid connections just freezing when the host is not on localhost. I’ve tried posting this on stack overflow and GitHub, but haven’t r...</p></div></div></a></article><article class="col"> <a href="/blog/2022/09/09/performance-profiling-a-mongoid-issue-using-appprofiler/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1662720061" data-df="ll" > Sep 9, 2022 </time><h4 class="pt-0 my-2">Performance Profiling a Mongoid Issue Using AppProfiler</h4><div class="text-muted"><p>In [MONGOID-4889](https://jira.mongodb.org/browse/MONGOID-4889) the claim was made that assignment of a large number of embedded documents to an instance of a model will take increasingly longer as...</p></div></div></a></article><article class="col"> <a href="/blog/2022/12/14/tablecheck-empowering-restaurants-with-best-in-class-booking-tools-powered-by-mongodb/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1671047383" data-df="ll" > Dec 14, 2022 </time><h4 class="pt-0 my-2">TableCheck: Empowering Restaurants with Best-in-Class Booking Tools Powered by MongoDB</h4><div class="text-muted"><p>> Cross posted from the [MongoDB Developer Center](https://www.mongodb.com/developer/products/mongodb/customer-success-ruby-tablecheck/) {: .prompt-info } [TableCheck](https://tablecheck.com/) is ...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/blog/2021/03/23/visualizing-a-replica-sets-sync-source-chain/" class="btn btn-outline-primary" aria-label="Older" ><p>Visualizing a Replica Set's Sync Source Chain</p></a> <a href="/blog/2021/03/28/same-blog-new-look/" class="btn btn-outline-primary" aria-label="Newer" ><p>Same Blog, New Look!</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/javascript/">javascript</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/'; this.page.identifier = '/blog/2021/03/26/analysis-and-optimization-of-an-n-plus-1-scenario-in-mongoid/'; }; function addDisqus() { let disqusThread = document.createElement('div'); let paragraph = document.createElement('p'); disqusThread.id = 'disqus_thread'; paragraph.className = 'text-center text-muted small'; paragraph.innerHTML = 'Comments powered by <a href="https://disqus.com/">Disqus</a>.'; disqusThread.appendChild(paragraph); const footer = document.querySelector('footer'); footer.insertAdjacentElement("beforebegin", disqusThread); }function reloadDisqus(event) { if (event.source === window && event.data && event.data.id === Theme.ID) {if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } addDisqus(); if (Theme.switchable) { addEventListener('message', reloadDisqus); }var disqusObserver = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); disqusObserver.disconnect(); } }, { threshold: [0] } ); disqusObserver.observe(document.getElementById('disqus_thread')); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
