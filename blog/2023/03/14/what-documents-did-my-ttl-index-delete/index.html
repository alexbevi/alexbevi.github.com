<!DOCTYPE html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="What documents did my TTL index delete?" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://www.alexbevi.com/blog/2023/03/14/what-documents-did-my-ttl-index-delete/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2023/03/14/what-documents-did-my-ttl-index-delete/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-03-14T07:32:05-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="twitter:title" content="What documents did my TTL index delete?" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-09T12:45:05-04:00","datePublished":"2023-03-14T07:32:05-04:00","description":"Introduction","headline":"What documents did my TTL index delete?","image":"https://www.alexbevi.com/images/mongodb-logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2023/03/14/what-documents-did-my-ttl-index-delete/"},"url":"https://www.alexbevi.com/blog/2023/03/14/what-documents-did-my-ttl-index-delete/"}</script><title>What documents did my TTL index delete? | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="stylesheet" href="/assets/lib/bootstrap/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup/magnific-popup.css"> <script src="/assets/lib/jquery/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener('change', () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.notify(); } /* flipMode() */ } /* ModeToggle */ const modeToggle = new ModeToggle(); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><body data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/images/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle font-italic">my little corner of the interwebs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer"> <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me"> <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer"> <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer"> <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer"> <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer"> <i class="fab fa-reddit"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>What documents did my TTL index delete?</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>What documents did my TTL index delete?</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1678793525" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Mar 14, 2023 </em> </span> <span> Updated <em class="" data-ts="1683650705" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 9, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1331 words"> <em>7 min</em> read </span></div></div></div><div class="post-content"><h2 id="introduction"><span class="mr-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Have you ever had one or more documents removed from a MongoDB collection and you weren’t sure what they were? This can potentially occur if you have a TTL index defined, however the approach being shared below can be adapted to filter the replica set oplog for deletes over any custom time frame you may be interested in. Once the <code class="language-plaintext highlighter-rouge">_id</code> values of the deleted documents have been identified, the replica set oplog can be further filtered to attempt to surface details about the detailed documents.</p><h2 id="overview"><span class="mr-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p><a href="https://www.mongodb.com/docs/manual/core/index-ttl/">TTL indexes</a> are special single-field indexes that MongoDB can use to automatically remove documents from a collection after a certain amount of time or at a specific clock time. Data expiration is useful for certain types of information like machine generated event data, logs, and session information that only need to persist in a database for a finite amount of time.</p><p>The actual removal of documents is handled by a separate thread within the <a href="https://www.mongodb.com/docs/v6.0/reference/program/mongod/#mongodb-binary-bin.mongod"><code class="language-plaintext highlighter-rouge">mongod</code></a> process called the <a href="https://github.com/mongodb/mongo/blob/r6.2.1/src/mongo/db/catalog/README.md#the-ttlmonitor"><code class="language-plaintext highlighter-rouge">TTLMonitor</code></a> (enabled by default via <a href="https://www.mongodb.com/docs/v5.0/reference/parameters/#mongodb-parameter-param.ttlMonitorEnabled"><code class="language-plaintext highlighter-rouge">ttlMonitorEnabled</code></a>), which will wake up and check all TTL indexes for expired documents every 60 seconds (the default value of <code class="language-plaintext highlighter-rouge">ttlMonitorSleepSecs</code>).</p><p>By default the <code class="language-plaintext highlighter-rouge">mongod</code> logs won’t record any information about TTL index activity unless the operation happens to exceed the <a href="https://www.mongodb.com/docs/manual/reference/command/profile/#command-fields">slow query threshold</a> (default of <code class="language-plaintext highlighter-rouge">100ms</code> - may be different in <a href="https://www.mongodb.com/docs/atlas/">MongoDB Atlas</a>). For the purposes of this article we want to see more information regarding TTL index activity so we’ll begin by increasing the <a href="https://www.mongodb.com/docs/manual/reference/method/db.setLogLevel/#set-verbosity-level-for-a-component">log verbosity for the <code class="language-plaintext highlighter-rouge">index</code> component</a>:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nf">setLogLevel</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="dl">'</span><span class="s1">index</span><span class="dl">'</span><span class="p">);</span>
</pre></table></code></div></div><blockquote class="prompt-info"><p>The <code class="language-plaintext highlighter-rouge">setLogLevel</code> helper calls the <a href="https://www.mongodb.com/docs/master/reference/command/setParameter"><code class="language-plaintext highlighter-rouge">setParameter</code></a> command, which is <a href="https://www.mongodb.com/docs/atlas/unsupported-commands/">unsupported in MongoDB Atlas</a></p></blockquote><p>As we continue to monitor the <code class="language-plaintext highlighter-rouge">mongod</code> log we’ll begin to see messages such as the following begin to be recorded:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:41:26.314-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"D1"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">22533</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"running TTL job for index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"config.tenantMigrationRecipients"</span><span class="p">,</span><span class="nl">"key"</span><span class="p">:{</span><span class="nl">"expireAt"</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"TenantMigrationRecipientTTLIndex"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:41:26.314-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"I"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">5479200</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"Deleted expired documents using index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"config.tenantMigrationRecipients"</span><span class="p">,</span><span class="nl">"index"</span><span class="p">:</span><span class="s2">"TenantMigrationRecipientTTLIndex"</span><span class="p">,</span><span class="nl">"numDeleted"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"durationMillis"</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:41:26.314-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"D1"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">22533</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"running TTL job for index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"config.external_validation_keys"</span><span class="p">,</span><span class="nl">"key"</span><span class="p">:{</span><span class="nl">"ttlExpiresAt"</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"ExternalKeysTTLIndex"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:41:26.315-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"I"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">5479200</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"Deleted expired documents using index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"config.external_validation_keys"</span><span class="p">,</span><span class="nl">"index"</span><span class="p">:</span><span class="s2">"ExternalKeysTTLIndex"</span><span class="p">,</span><span class="nl">"numDeleted"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"durationMillis"</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:41:26.315-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"D1"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">22533</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"running TTL job for index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"config.tenantMigrationDonors"</span><span class="p">,</span><span class="nl">"key"</span><span class="p">:{</span><span class="nl">"expireAt"</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"TenantMigrationDonorTTLIndex"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:41:26.315-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"I"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">5479200</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"Deleted expired documents using index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"config.tenantMigrationDonors"</span><span class="p">,</span><span class="nl">"index"</span><span class="p">:</span><span class="s2">"TenantMigrationDonorTTLIndex"</span><span class="p">,</span><span class="nl">"numDeleted"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"durationMillis"</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:41:26.315-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"D1"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">22533</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"running TTL job for index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"config.system.sessions"</span><span class="p">,</span><span class="nl">"key"</span><span class="p">:{</span><span class="nl">"lastUse"</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"lsidTTLIndex"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:41:26.315-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"I"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">5479200</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"Deleted expired documents using index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"config.system.sessions"</span><span class="p">,</span><span class="nl">"index"</span><span class="p">:</span><span class="s2">"lsidTTLIndex"</span><span class="p">,</span><span class="nl">"numDeleted"</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="nl">"durationMillis"</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span><span class="w">
</span></pre></table></code></div></div><p>The above logs represent pre-existing TTL indexes MongoDB creates to expire documents from internal collections. As these indexes are out of scope for this article we’ll skip over them for now and create a custom TTL index to fit our needs.</p><h2 id="setup"><span class="mr-2">Setup</span><a href="#setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">createIndex</span><span class="p">({</span> <span class="dl">"</span><span class="s2">created_at</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="na">expireAfterSeconds</span><span class="p">:</span> <span class="mi">10</span> <span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()});</span>
</pre></table></code></div></div><p>Our new collection now has a single document, which should expire after 10 seconds of being created. Note that the timing will almost never be exact as the TTL monitor will only activate every minute.</p><p>The test cluster we’re running on is a <a href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-replica-set">replica set</a>, and as such we’re only monitoring the logs for the <a href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-primary"><code class="language-plaintext highlighter-rouge">primary</code></a> member. The reason for this can be found in the <a href="https://www.mongodb.com/docs/manual/core/index-ttl/#replica-sets">TTL Indexes documentation regarding replica set behavior</a>:</p><blockquote><p>On replica set members, the TTL background thread <em>only</em> deletes documents when a member is in state <code class="language-plaintext highlighter-rouge">primary</code>. The TTL background thread is idle when a member is in state <a href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-secondary"><code class="language-plaintext highlighter-rouge">secondary</code></a>. Secondary members replicate deletion operations from the primary.</p></blockquote><p>Within a minute or two a log entry similar to the following will be recorded that indicates our <code class="language-plaintext highlighter-rouge">test.foo</code> namespace has been processed, the <code class="language-plaintext highlighter-rouge">created_at_1</code> index has been executed and our document was expired:</p><div class="language-json highlighter-rouge"><div class="code-header"> <span data-label-text="JSON"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:47:41.336-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"D1"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">22533</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"running TTL job for index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"test.foo"</span><span class="p">,</span><span class="nl">"key"</span><span class="p">:{</span><span class="nl">"created_at"</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span><span class="nl">"name"</span><span class="p">:</span><span class="s2">"created_at_1"</span><span class="p">}}</span><span class="w">
</span><span class="p">{</span><span class="nl">"t"</span><span class="p">:{</span><span class="nl">"$date"</span><span class="p">:</span><span class="s2">"2023-03-14T06:47:41.336-04:00"</span><span class="p">},</span><span class="nl">"s"</span><span class="p">:</span><span class="s2">"I"</span><span class="p">,</span><span class="nl">"c"</span><span class="p">:</span><span class="s2">"INDEX"</span><span class="p">,</span><span class="nl">"id"</span><span class="p">:</span><span class="mi">5479200</span><span class="p">,</span><span class="nl">"ctx"</span><span class="p">:</span><span class="s2">"TTLMonitor"</span><span class="p">,</span><span class="nl">"msg"</span><span class="p">:</span><span class="s2">"Deleted expired documents using index"</span><span class="p">,</span><span class="nl">"attr"</span><span class="p">:{</span><span class="nl">"namespace"</span><span class="p">:</span><span class="s2">"test.foo"</span><span class="p">,</span><span class="nl">"index"</span><span class="p">:</span><span class="s2">"created_at_1"</span><span class="p">,</span><span class="nl">"numDeleted"</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span><span class="nl">"durationMillis"</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span><span class="w">
</span></pre></table></code></div></div><p>Unfortunately all this presents us with is confirmation that one document (<code class="language-plaintext highlighter-rouge">"numDeleted":1</code>) was removed, but is it possible to find out <em>what</em> was removed?</p><h2 id="enter-the-oplog"><span class="mr-2">Enter the Oplog</span><a href="#enter-the-oplog" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>As the cluster we’re connected to is a replica set all write operations are recorded in the <a href="https://www.mongodb.com/docs/manual/core/replica-set-oplog/">operations log (oplog)</a>. The oplog is a <a href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-capped-collection">capped collection</a> present on each replica set member, and as such we can query it directly to see what write operations have propagated at a given time!</p><p>Using the log entry above that confirmed 1 document was deleted we can prepare the following operation to filter the contents of the oplog collection:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// the namespace from the log entry indicating nDeleted &gt; 0</span>
<span class="c1">// that we're interested in</span>
<span class="kd">var</span> <span class="nx">ns</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">test.foo</span><span class="dl">"</span><span class="p">;</span>
<span class="c1">// the time (with timezone) from the log message</span>
<span class="kd">var</span> <span class="nx">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="dl">"</span><span class="s2">2023-03-14T06:47:41.336-04:00</span><span class="dl">"</span><span class="p">);</span>
<span class="c1">// the number of seconds between TTLMonitor sweeps - default: 60</span>
<span class="kd">var</span> <span class="nx">ttlSleep</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">adminCommand</span><span class="p">({</span>
  <span class="na">getParameter</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">ttlMonitorSleepSecs</span><span class="p">:</span> <span class="mi">1</span>
<span class="p">}).</span><span class="nx">ttlMonitorSleepSecs</span><span class="p">;</span>
<span class="c1">// get the time (in milliseconds) of the starting time and convert</span>
<span class="c1">// the TTLMonitor sleep threshold to milliseconds</span>
<span class="kd">var</span> <span class="nx">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(</span><span class="nx">t1</span><span class="p">.</span><span class="nf">getTime</span><span class="p">()</span> <span class="o">+</span> <span class="p">(</span><span class="nx">ttlSleep</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">getSiblingDB</span><span class="p">(</span><span class="dl">"</span><span class="s2">local</span><span class="dl">"</span><span class="p">).</span><span class="nx">oplog</span><span class="p">.</span><span class="nx">rs</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span>
  <span class="na">op</span><span class="p">:</span> <span class="dl">"</span><span class="s2">d</span><span class="dl">"</span><span class="p">,</span>
  <span class="na">ns</span><span class="p">:</span> <span class="nx">ns</span><span class="p">,</span>
  <span class="na">wall</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gte</span><span class="p">:</span> <span class="nx">t1</span><span class="p">,</span> <span class="na">$lt</span><span class="p">:</span> <span class="nx">t2</span> <span class="p">}</span>
<span class="p">});</span>
</pre></table></code></div></div><blockquote class="prompt-danger"><p>Any query targeting the oplog will perform a full collection scan as you cannot create indexes on the oplog collection!</p></blockquote><p>The above operation is purposely more verbose than necessary to illustrate where all the necessary pieces of information came from. Once this is executed it should return a single document as seen below, which represents the document that was deleted:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="p">[</span>
  <span class="p">{</span>
    <span class="dl">"</span><span class="s2">op</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">d</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">ns</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test.foo</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">ui</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">$binary</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">base64</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">K4vB+Oh9RgC5scSLCiYWiA==</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">subType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">04</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">o</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">$oid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">641050bae52e6d96ee3c40fa</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">ts</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">$timestamp</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1678790861</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">i</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">v</span><span class="dl">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">wall</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">$date</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2023-03-14T10:47:41.336Z</span><span class="dl">"</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></table></code></div></div><p>The only information the oplog records for <a href="https://www.mongodb.com/docs/manual/reference/command/delete/"><code class="language-plaintext highlighter-rouge">delete</code></a> commands is the <code class="language-plaintext highlighter-rouge">_id</code> value of the document that was removed. Unless you manage your own custom <code class="language-plaintext highlighter-rouge">_id</code> generation, the values will likely just be generated <a href="https://www.mongodb.com/docs/manual/reference/method/ObjectId/">ObjectId</a> values.</p><p>We can try to find out additional information about this deleted document by extracting the <code class="language-plaintext highlighter-rouge">_id</code> from the oplog document’s <code class="language-plaintext highlighter-rouge">o</code> field, and using that to further filter the oplog:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nf">getSiblingDB</span><span class="p">(</span><span class="dl">"</span><span class="s2">local</span><span class="dl">"</span><span class="p">).</span><span class="nx">oplog</span><span class="p">.</span><span class="nx">rs</span><span class="p">.</span><span class="nf">find</span><span class="p">({</span>
  <span class="c1">// filter by namespace</span>
  <span class="na">ns</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test.foo</span><span class="dl">"</span><span class="p">,</span>
  <span class="c1">// filter by insert or update</span>
  <span class="na">op</span><span class="p">:</span> <span class="p">{</span> <span class="na">$in</span><span class="p">:</span> <span class="p">[</span><span class="dl">"</span><span class="s2">i</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">u</span><span class="dl">"</span><span class="p">]</span> <span class="p">},</span>
  <span class="c1">// filter on the o2._id field as it will be present</span>
  <span class="c1">// in both inserts and updates</span>
  <span class="dl">"</span><span class="s2">o2._id</span><span class="dl">"</span><span class="p">:</span> <span class="nc">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">641050bae52e6d96ee3c40fa</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}).</span><span class="nf">sort</span><span class="p">({</span> <span class="na">ts</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="p">});</span>
</pre></table></code></div></div><p>As documents within the <a href="https://www.mongodb.com/docs/manual/reference/local-database/#mongodb-data-local.oplog.rs"><code class="language-plaintext highlighter-rouge">local.oplog.rs</code></a> namespace will eventually roll over the above query is <strong>not guaranteed to return anything</strong>, however it’s possible that document creation or update commands may still exist that can give you additional information regarding what this removed document contained:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
</pre><td class="rouge-code"><pre><span class="p">[</span>
  <span class="p">{</span>
    <span class="dl">"</span><span class="s2">lsid</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">$binary</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">base64</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">SHocj0XsSTC25zlbzywaOA==</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">subType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">04</span><span class="dl">"</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">uid</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">$binary</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">base64</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=</span><span class="dl">"</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">subType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">00</span><span class="dl">"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">txnNumber</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="c1">// an insert operation</span>
    <span class="dl">"</span><span class="s2">op</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">i</span><span class="dl">"</span><span class="p">,</span>
    <span class="c1">// the namespace the document was created in</span>
    <span class="dl">"</span><span class="s2">ns</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test.foo</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">ui</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">$binary</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">base64</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">K4vB+Oh9RgC5scSLCiYWiA==</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">subType</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">04</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="c1">// this field contains the values that were set when</span>
    <span class="c1">// the document was created</span>
    <span class="dl">"</span><span class="s2">o</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">$oid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">641050bae52e6d96ee3c40fa</span><span class="dl">"</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">created_at</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">$date</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2023-03-14T10:47:22.445Z</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">o2</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">$oid</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">641050bae52e6d96ee3c40fa</span><span class="dl">"</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">stmtId</span><span class="dl">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">ts</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">$timestamp</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:</span> <span class="mi">1678790842</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">i</span><span class="dl">"</span><span class="p">:</span> <span class="mi">4</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">v</span><span class="dl">"</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="c1">// when the document was created</span>
    <span class="dl">"</span><span class="s2">wall</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">$date</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">2023-03-14T10:47:22.448Z</span><span class="dl">"</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">prevOpTime</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
      <span class="dl">"</span><span class="s2">ts</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">$timestamp</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span>
          <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
          <span class="dl">"</span><span class="s2">i</span><span class="dl">"</span><span class="p">:</span> <span class="mi">0</span>
        <span class="p">}</span>
      <span class="p">},</span>
      <span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">]</span>
</pre></table></code></div></div><p>The result above represents an <a href="https://www.mongodb.com/docs/manual/reference/command/insert/"><code class="language-plaintext highlighter-rouge">insert</code></a> and under the <code class="language-plaintext highlighter-rouge">o</code> field contains the values that were initially set.</p><p>As stated earlier, this method is not guaranteed to work, however it may prove useful if you’re trying to identify what document was deleted and your <a href="https://www.mongodb.com/docs/manual/core/replica-set-oplog/#oplog-window">oplog window</a> is large enough that it still contains the document’s creation. See <a href="https://www.mongodb.com/docs/manual/tutorial/change-oplog-size/">Change the Size of the Oplog</a> for more information regarding sizing the oplog.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/indexing/" class="post-tag no-text-decoration" >indexing</a> <a href="/tags/ttl/" class="post-tag no-text-decoration" >ttl</a> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=What%20documents%20did%20my%20TTL%20index%20delete?%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F03%2F14%2Fwhat-documents-did-my-ttl-index-delete%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=What%20documents%20did%20my%20TTL%20index%20delete?%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F03%2F14%2Fwhat-documents-did-my-ttl-index-delete%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F03%2F14%2Fwhat-documents-did-my-ttl-index-delete%2F&text=What%20documents%20did%20my%20TTL%20index%20delete?%20-%20ALEX%20BEVILACQUA" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F03%2F14%2Fwhat-documents-did-my-ttl-index-delete%2F" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=What%20documents%20did%20my%20TTL%20index%20delete?%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F03%2F14%2Fwhat-documents-did-my-ttl-index-delete%2F" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2021/08/15/princess-tomato-in-the-salad-kingdom/">Princess Tomato in the Salad Kingdom (Hudson Soft) - 1984</a><li><a href="/blog/2021/08/16/shadowgate/">Shadowgate (ICOM Simulations) - 1987</a><li><a href="/blog/2022/12/31/nightshade/">Nightshade (Beam Software) - 1992</a><li><a href="/blog/2023/02/07/eternam/">Eternam (Infogrames) - 1992</a><li><a href="/blog/2021/07/28/adventure-games-1980-1999/">Let's Adventure! A Journey into Adventure Games (1980-1999)</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/linux/">linux</a></div></div></div><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div><script src="/assets/lib/tocbot/tocbot.min.js"></script></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2022/01/24/generate-mongodb-index-utilization-report/"><div class="card-body"> <em class="small" data-ts="1643035790" data-df="ll" > Jan 24, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Generate MongoDB Index Utilization Report</h3><div class="text-muted small"><p> When MongoDB 3.2 introduced the $indexStats aggregation pipeline stage accesses details were suddenly accessible to users. As a result, scripts could now be written to better understand how frequen...</p></div></div></a></div><div class="card"> <a href="/blog/2022/09/15/createindex-error-values-in-v-2-index-key-pattern-cannot-be-of-type-object/"><div class="card-body"> <em class="small" data-ts="1663238846" data-df="ll" > Sep 15, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Solving a mongorestore failure due to 'Values in v:2 index key pattern cannot be of type object.'</h3><div class="text-muted small"><p> Starting with MongoDB 4.4, the MongoDB Database Tools are now released separately from the MongoDB Server and use their own versioning, with an initial version of 100.0.0. Previously, these tools w...</p></div></div></a></div><div class="card"> <a href="/blog/2022/11/29/efficiently-identifying-duplicates-using-mongodb/"><div class="card-body"> <em class="small" data-ts="1669737052" data-df="ll" > Nov 29, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Efficiently Identifying Duplicates using MongoDB</h3><div class="text-muted small"><p> Efficiently Identifying Duplicates using MongoDB One question that comes up time and again on Stack Overflow or the MongoDB Developer Forums is “how can I find duplicate X and get a list of Y that...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2023/03/10/full-throttle/" class="btn btn-outline-primary" prompt="Older"><p>Full Throttle (LucasArts) - 1995</p></a> <a href="/blog/2023/03/23/geisha/" class="btn btn-outline-primary" prompt="Newer"><p>Geisha (Coktel Vision) - 1990</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2023/03/14/what-documents-did-my-ttl-index-delete/'; this.page.identifier = '/blog/2023/03/14/what-documents-did-my-ttl-index-delete/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/linux/">linux</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><footer><div class="container pl-lg-4 pr-lg-4"><div class="d-flex justify-content-between align-items-center text-muted ml-md-3 mr-md-3"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0">Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a>.</p></div></div></div></footer><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="/assets/lib/magnific-popup/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/lazysizes/lazysizes.min.js"></script> <script src="/assets/lib/clipboard/clipboard.min.js"></script> <script src="/assets/lib/dayjs/dayjs.min.js"></script> <script src="/assets/lib/dayjs/locale/en.min.js"></script> <script src="/assets/lib/dayjs/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/lib/bootstrap/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
