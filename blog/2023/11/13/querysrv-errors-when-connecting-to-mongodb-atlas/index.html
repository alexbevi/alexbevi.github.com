<!doctype html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="querySrv errors when connecting to MongoDB Atlas" /><meta property="og:locale" content="en" /><meta name="description" content="If your application uses MongoDB’s Node.js driver or Mongoose ODM, occasionally you may observe errors such as querySrv ECONNREFUSED _mongodb._tcp.cluster0.abcde.mongodb.net or Error: querySrv ETIMEOUT _mongodb._tcp.cluster0.abcde.mongodb.net being thrown. The MongoDB Atlas documentation outlines several methods to troubleshoot connection issues, including how to handle “Connection Refused using SRV Connection String” scenarios, but why does this happen in the first place?" /><meta property="og:description" content="If your application uses MongoDB’s Node.js driver or Mongoose ODM, occasionally you may observe errors such as querySrv ECONNREFUSED _mongodb._tcp.cluster0.abcde.mongodb.net or Error: querySrv ETIMEOUT _mongodb._tcp.cluster0.abcde.mongodb.net being thrown. The MongoDB Atlas documentation outlines several methods to troubleshoot connection issues, including how to handle “Connection Refused using SRV Connection String” scenarios, but why does this happen in the first place?" /><link rel="canonical" href="https://www.alexbevi.com/blog/2023/11/13/querysrv-errors-when-connecting-to-mongodb-atlas/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2023/11/13/querysrv-errors-when-connecting-to-mongodb-atlas/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-11-13T14:42:13-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="twitter:title" content="querySrv errors when connecting to MongoDB Atlas" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-11-22T16:16:09-05:00","datePublished":"2023-11-13T14:42:13-05:00","description":"If your application uses MongoDB’s Node.js driver or Mongoose ODM, occasionally you may observe errors such as querySrv ECONNREFUSED _mongodb._tcp.cluster0.abcde.mongodb.net or Error: querySrv ETIMEOUT _mongodb._tcp.cluster0.abcde.mongodb.net being thrown. The MongoDB Atlas documentation outlines several methods to troubleshoot connection issues, including how to handle “Connection Refused using SRV Connection String” scenarios, but why does this happen in the first place?","headline":"querySrv errors when connecting to MongoDB Atlas","image":"https://www.alexbevi.com/images/mongodb-logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2023/11/13/querysrv-errors-when-connecting-to-mongodb-atlas/"},"url":"https://www.alexbevi.com/blog/2023/11/13/querysrv-errors-when-connecting-to-mongodb-atlas/"}</script><title>querySrv errors when connecting to MongoDB Atlas | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="/assets/lib/bootstrap/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup/magnific-popup.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><script> (function(d,t) { var BASE_URL="http://10.0.0.56:3000"; var g=d.createElement(t),s=d.getElementsByTagName(t)[0]; g.src=BASE_URL+"/packs/js/sdk.js"; g.defer = true; g.async = true; s.parentNode.insertBefore(g,s); g.onload=function(){ window.chatwootSDK.run({ websiteToken: 'LPMrgkwevLKztni9ThkNcoeS', baseUrl: BASE_URL }) } })(document,"script"); </script><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/images/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle fst-italic">my little corner of the interwebs</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>querySrv errors when connecting to MongoDB Atlas</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>querySrv errors when connecting to MongoDB Atlas</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1699904533" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Nov 13, 2023 </em> </span> <span> Updated <em class="" data-ts="1700687769" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Nov 22, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1335 words" > <em>7 min</em> read </span></div></div></div><div class="post-content"><p>If your application uses MongoDB’s <a href="https://www.mongodb.com/docs/drivers/node/current/">Node.js driver</a> or <a href="https://mongoosejs.com/">Mongoose ODM</a>, occasionally you may observe errors such as <code class="language-plaintext highlighter-rouge">querySrv ECONNREFUSED _mongodb._tcp.cluster0.abcde.mongodb.net</code> or <code class="language-plaintext highlighter-rouge">Error: querySrv ETIMEOUT _mongodb._tcp.cluster0.abcde.mongodb.net</code> being thrown. The MongoDB Atlas documentation outlines several methods to <a href="https://www.mongodb.com/docs/atlas/troubleshoot-connection/">troubleshoot connection issues</a>, including how to handle <a href="https://www.mongodb.com/docs/atlas/troubleshoot-connection/#connection-refused-using-srv-connection-string">“Connection Refused using SRV Connection String”</a> scenarios, but why does this happen in the first place?</p><h2 id="about-dns-seedlists"><span class="me-2">About DNS seedlists</span><a href="#about-dns-seedlists" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To coincide with the release of MongoDB 3.6, all drivers (at the time) implemented the <a href="https://github.com/mongodb/specifications/blob/master/source/initial-dns-seedlist-discovery/initial-dns-seedlist-discovery.rst">initial DNS seedlist discovery</a> specification to ensure connections could be established using the new <a href="https://www.mongodb.com/docs/manual/reference/connection-string/#std-label-connections-dns-seedlist"><code class="language-plaintext highlighter-rouge">SRV</code> connection string format</a>, as well as the legacy <a href="https://www.mongodb.com/docs/manual/reference/connection-string/#standard-connection-string-format">standard connection string format</a>.</p><p>This functionality was introduced to abstract away the complexity of MongoDB’s connection strings (for MongoDB Atlas users at least) by moving the component parts of a <a href="https://www.mongodb.com/docs/manual/reference/connection-string/">connection string</a> to two DNS records: a <a href="https://en.wikipedia.org/wiki/SRV_record">service record (<code class="language-plaintext highlighter-rouge">SRV</code>)</a> and a <a href="https://en.wikipedia.org/wiki/TXT_record">text record (<code class="language-plaintext highlighter-rouge">TXT</code>)</a>.</p><p>Users now only need to supply a connection string such as <code class="language-plaintext highlighter-rouge">mongodb+srv://&lt;username&gt;:&lt;password&gt;@cluster0.abcde.mongodb.net/myFirstDatabase</code>, and regardless as to whether the underlying cluster was a replica set or sharded, the connection string would remain the same. Furthermore, use of <code class="language-plaintext highlighter-rouge">mongodb+srv://</code> enables drivers to detect additions/removals of <code class="language-plaintext highlighter-rouge">mongos</code> in a sharded cluster<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p><p>Tools such as <a href="https://linux.die.net/man/1/nslookup"><code class="language-plaintext highlighter-rouge">nslookup</code></a> or <a href="https://linux.die.net/man/1/dig"><code class="language-plaintext highlighter-rouge">dig</code></a> can be used to view the contents of these DNS records, such as in the following example:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="nv">$ </span>dig srv _mongodb._tcp.cluster0.abcde.mongodb.net

<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.18.18-0ubuntu0.22.04.1-Ubuntu &lt;&lt;<span class="o">&gt;&gt;</span> srv _mongodb._tcp.cluster0.abcde.mongodb.net
<span class="p">;;</span> global options: +cmd
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 24529
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;_mongodb._tcp.cluster0.abcde.mongodb.net. IN SRV

;; ANSWER SECTION:
_mongodb._tcp.cluster0.abcde.mongodb.net. 60 IN SRV 0 0 27017 cluster0-shard-00-01.abcde.mongodb.net.
_mongodb._tcp.cluster0.abcde.mongodb.net. 60 IN SRV 0 0 27017 cluster0-shard-00-02.abcde.mongodb.net.
_mongodb._tcp.cluster0.abcde.mongodb.net. 60 IN SRV 0 0 27017 cluster0-shard-00-00.abcde.mongodb.net.

</span><span class="nv">$ </span><span class="sh">dig txt cluster0.abcde.mongodb.net

; &lt;&lt;&gt;&gt; DiG 9.18.18-0ubuntu0.22.04.1-Ubuntu &lt;&lt;&gt;&gt; txt cluster0.abcde.mongodb.net
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 35223
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 65494
;; QUESTION SECTION:
;cluster0.abcde.mongodb.net.	IN	TXT

;; ANSWER SECTION:
cluster0.abcde.mongodb.net. 60 IN	TXT	"authSource=admin&amp;replicaSet=atlas-abcde-shard-0"
</span></pre></table></code></div></div><h2 id="what-can-go-wrong"><span class="me-2">What can go wrong?</span><a href="#what-can-go-wrong" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>MongoDB’s drivers require the information from <em>both</em> DNS queries in order to successfully establish, authenticate and authorize a connection to a MongoDB Atlas cluster. If either of these queries fail, only part of the connection string details will be present, and if the driver doesn’t error out right away, the subsequent connection attempt may be missing necessary information.</p><p>For example, per the <a href="https://github.com/mongodb/specifications/blob/master/source/auth/auth.rst#implementation">Authentication specification</a> regarding connection string options, when it comes to selecting the authentication source:</p><ol><li>if <a href="https://www.mongodb.com/docs/manual/reference/connection-string/#mongodb-urioption-urioption.authSource"><code class="language-plaintext highlighter-rouge">authSource</code></a> is specified, it is used.<li>otherwise, if database is specified (in the connection string), it is used.<li>otherwise, the <code class="language-plaintext highlighter-rouge">admin</code> database is used.</ol><p>Given this order of operations, if the <code class="language-plaintext highlighter-rouge">SRV</code> record resolves, but the <code class="language-plaintext highlighter-rouge">TXT</code> record <em>doesn’t</em>, assuming the driver doesn’t error out first the database provided in the connection string will be used for authentication. Using our original example of <code class="language-plaintext highlighter-rouge">mongodb+srv://&lt;username&gt;:&lt;password&gt;@cluster0.abcde.mongodb.net/myFirstDatabase</code>, the <code class="language-plaintext highlighter-rouge">myFirstDatabase</code> database will be used to authenticate …. which will result in an authentication failure such as <code class="language-plaintext highlighter-rouge">MongoServerError: Authentication failed</code>.</p><p>Furthermore, though MongoDB’s drivers support automatic retryability of <a href="https://www.mongodb.com/docs/manual/core/retryable-reads/">reads</a> and <a href="https://www.mongodb.com/docs/manual/core/retryable-writes/">writes</a>, these DNS query failures aren’t retryable. There is currently a project proposed (<a href="https://jira.mongodb.org/browse/DRIVERS-2757">DRIVERS-2757</a>) to improve this in the future, but for now these errors bubble up to the application immediately.</p><h2 id="can-these-issues-be-prevented"><span class="me-2">Can these issues be prevented?</span><a href="#can-these-issues-be-prevented" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The best way to avoid these issues entirely is to just use the legacy <a href="https://www.mongodb.com/docs/manual/reference/connection-string/#standard-connection-string-format">standard connection string format</a>. If you’re connecting to a replica set, the <a href="https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst">server discovery and monitoring</a> functionality of each driver will ensure topology changes are automatically discovered.</p><p>Note that this will prevent new <code class="language-plaintext highlighter-rouge">mongos</code>’ from being discovered in a sharded cluster, however if you don’t anticipate these to change frequently this will likely be a non-issue as well.</p><h2 id="are-other-drivers-affected"><span class="me-2">Are other drivers affected?</span><a href="#are-other-drivers-affected" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Failure to resolve DNS records can affect all MongoDB drivers, however it’s highly unlikely you’ll actually encounter this in a production setting. As there still remains a non-zero chance this issue will manifest, here are some examples of failures you may see from other drivers:</p><h3 id="ruby-driver"><span class="me-2">Ruby driver</span><a href="#ruby-driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Mongo::Error::NoSRVRecords: The DNS query returned no SRV records for 'cluster0.abcde.mongodb.net'
</pre></table></code></div></div><h3 id="java-driver-or-spring-boot-mongodb"><span class="me-2">Java driver or Spring Boot MongoDB</span><a href="#java-driver-or-spring-boot-mongodb" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre># Example 1
Caused by: com.mongodb.MongoTimeoutException: Timed out after 30000 ms while waiting to connect. Client view of cluster state is {type=UNKNOWN, srvResolutionException=com.mongodb.MongoConfigurationException: Unable to look up SRV record for host cluster0-shard-00-01.abcde.mongodb.net, servers=[]}


# Example 2
Caused by: com.mongodb.MongoConfigurationException: Unable to look up SRV record for host cluster0.abcde.mongodb.net
        at com.mongodb.internal.dns.DnsResolver.resolveHostFromSrvRecords(DnsResolver.java:79)
        at com.mongodb.ConnectionString.&lt;init&gt;(ConnectionString.java:321)
        at com.mongodb.MongoClientURI.&lt;init&gt;(MongoClientURI.java:234)
</pre></table></code></div></div><h3 id="python-driver"><span class="me-2">Python driver</span><a href="#python-driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre># Example 1
pymongo.errors.ConfigurationError: The DNS query name does not exist: _mongodb._tcp.cluster0.abcde.mongodb.net.

# Example 2
Exception has occurred: ConfigurationError
The DNS operation timed out after 20.001205682754517 seconds
dns.exception.Timeout: The DNS operation timed out after 20.001205682754517 seconds
</pre></table></code></div></div><h3 id="cnet-driver"><span class="me-2">C#/.NET driver</span><a href="#cnet-driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre># Example 1
cluster0.abcde.mongodb.net IN TXT on x.x.x.x:53 timed out or is a transient error. A connection attempt failed because the connected party did not properly respond after a period of time, or established connection failed because connected host has failed to respond.

# Example 2
DnsClient.DnsResponseException:
at DnsClient.LookupClient.ResolveQuery (DnsClient, Version=1.6.0.0, Culture=neutral, PublicKeyToken=4574bb5573c51424)
at DnsClient.LookupClient.QueryInternal (DnsClient, Version=1.6.0.0, Culture=neutral, PublicKeyToken=4574bb5573c51424)
at DnsClient.LookupClient.Query (DnsClient, Version=1.6.0.0, Culture=neutral, PublicKeyToken=4574bb5573c51424)
at MongoDB.Driver.Core.Misc.DnsClientWrapper.ResolveTxtRecords (MongoDB.Driver.Core, Version=2.15.1.0, Culture=neutral, PublicKeyToken=null)
at MongoDB.Driver.Core.Configuration.ConnectionString.Resolve (MongoDB.Driver.Core, Version=2.15.1.0, Culture=neutral, PublicKeyToken=null)
at MongoDB.Driver.MongoUrl.Resolve (MongoDB.Driver, Version=2.15.1.0, Culture=neutral, PublicKeyToken=null)
at MongoDB.Driver.MongoClientSettings.FromUrl (MongoDB.Driver, Version=2.15.1.0, Culture=neutral, PublicKeyToken=null)

# Example 3
System.TimeoutException: A timeout occured after 30000ms selecting a server using CompositeServerSelector{ Selectors = MongoDB.Driver.MongoClient+AreSessionsSupportedServerSelector, LatencyLimitingServerSelector{ AllowedLatencyRange = 00:00:00.0200000 } }. Client view of cluster state is { ClusterId : "1", ConnectionMode : "Automatic", Type : "Unknown", State : "Disconnected", Servers : [], DnsMonitorException : "DnsClient.DnsResponseException: Query 54148 =&gt; _mongodb._tcp.cluster0.abcde.mongodb.net IN SRV on x.x.x.x:53 timed out or is a transient error.
 ---&gt; System.Net.Sockets.SocketException (110): Connection timed out
   at System.Net.Sockets.Socket.Receive(Byte[] buffer, Int32 offset, Int32 size, SocketFlags socketFlags)
   at DnsClient.DnsUdpMessageHandler.Query(IPEndPoint server, DnsRequestMessage request, TimeSpan timeout)
   at DnsClient.LookupClient.ResolveQuery(IReadOnlyList`1 servers, DnsQuerySettings settings, DnsMessageHandler handler, DnsRequestMessage request, LookupClientAudit audit)
   --- End of inner exception stack trace ---
   at DnsClient.LookupClient.ResolveQuery(IReadOnlyList`1 servers, DnsQuerySettings settings, DnsMessageHandler handler, DnsRequestMessage request, LookupClientAudit audit)
   at DnsClient.LookupClient.QueryInternal(DnsQuestion question, DnsQuerySettings queryOptions, IReadOnlyCollection`1 servers)
   at DnsClient.LookupClient.Query(DnsQuestion question)
   at DnsClient.LookupClient.Query(String query, QueryType queryType, QueryClass queryClass)
</pre></table></code></div></div><h3 id="php-driver"><span class="me-2">PHP driver</span><a href="#php-driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Fatal error: Uncaught MongoDB\Driver\Exception\InvalidArgumentException: Failed to parse URI options: Failed to look up SRV record "_mongodb._tcp.cluster0.abcde.mongodb.net": The requested name is valid but does not have an IP address.
</pre></table></code></div></div><h3 id="go-driver"><span class="me-2">Go driver</span><a href="#go-driver" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>error parsing command line options: error parsing uri: lookup cluster0.abcde.mongodb.net on x.x.x.x:53: cannot unmarshal DNS message
</pre></table></code></div></div><p>Note that (per the <a href="https://pkg.go.dev/go.mongodb.org/mongo-driver/mongo#hdr-Potential_DNS_Issues">MongoDB Go driver documentation</a>):</p><blockquote><p>Building with Go 1.11+ and using connection strings with the <code class="language-plaintext highlighter-rouge">mongodb+srv</code> scheme is unfortunately incompatible with some DNS servers in the wild due to the change introduced in https://github.com/golang/go/issues/10622. You may receive an error with the message “cannot unmarshal DNS message” while running an operation when using DNS servers that non-compliantly compress SRV records. Old versions of <code class="language-plaintext highlighter-rouge">kube-dns</code> and the native DNS resolver (<code class="language-plaintext highlighter-rouge">systemd-resolver</code>) on Ubuntu 18.04 are known to be non-compliant in this manner. We suggest using a different DNS server (8.8.8.8 is the common default), and, if that’s not possible, avoiding the <code class="language-plaintext highlighter-rouge">mongodb+srv</code> scheme.</p></blockquote><h2 id="dns-is-hard-"><span class="me-2">DNS is hard …</span><a href="#dns-is-hard-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>It sure can be, as intermittent/transient network events can also impact MongoDB drivers’ ability to resolve DNS queries. The drivers (typically) rely on low-level OS APIs (such as <a href="https://linux.die.net/man/3/getaddrinfo"><code class="language-plaintext highlighter-rouge">getaddrinfo</code></a>) for network address and service translation. As such you may occasionally get errors such as <code class="language-plaintext highlighter-rouge">MongooseServerSelectionError: getaddrinfo EAI_AGAIN cluster0-shard-00-01.abcde.mongodb.net</code> even when using the legacy (<code class="language-plaintext highlighter-rouge">mongodb://</code>) URI scheme.</p><hr /><p><strong>Footnotes</strong></p><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p><small>Sharded clusters could detect additions/removals of <code class="language-plaintext highlighter-rouge">mongos</code>’ if the driver(s) have implemented the <a href="https://github.com/mongodb/specifications/blob/master/source/polling-srv-records-for-mongos-discovery/polling-srv-records-for-mongos-discovery.rst">polling <code class="language-plaintext highlighter-rouge">SRV</code> records for <code class="language-plaintext highlighter-rouge">mongos</code> discovery</a> specification</small> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/drivers/" class="post-tag no-text-decoration" >drivers</a> <a href="/tags/networking/" class="post-tag no-text-decoration" >networking</a> <a href="/tags/connections/" class="post-tag no-text-decoration" >connections</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=querySrv%20errors%20when%20connecting%20to%20MongoDB%20Atlas%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F11%2F13%2Fquerysrv-errors-when-connecting-to-mongodb-atlas%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=querySrv%20errors%20when%20connecting%20to%20MongoDB%20Atlas%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F11%2F13%2Fquerysrv-errors-when-connecting-to-mongodb-atlas%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F11%2F13%2Fquerysrv-errors-when-connecting-to-mongodb-atlas%2F&text=querySrv%20errors%20when%20connecting%20to%20MongoDB%20Atlas%20-%20ALEX%20BEVILACQUA" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F11%2F13%2Fquerysrv-errors-when-connecting-to-mongodb-atlas%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=querySrv%20errors%20when%20connecting%20to%20MongoDB%20Atlas%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F11%2F13%2Fquerysrv-errors-when-connecting-to-mongodb-atlas%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo" > <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2023/12/21/combine-gopro-files-with-ffmpeg/">Combine GoPro Files with FFmpeg</a><li class="text-truncate lh-lg"> <a href="/blog/2023/10/24/adventureland/">Adventureland (Adventure International) - 1982</a><li class="text-truncate lh-lg"> <a href="/blog/2023/12/16/police-quest-iii/">Police Quest III: The Kindred (Sierra On-Line) - 1991</a><li class="text-truncate lh-lg"> <a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Let's Adventure! Reviewed Games Sorted by Score</a><li class="text-truncate lh-lg"> <a href="/blog/2021/07/28/adventure-games-1980-1999/">Let's Adventure! A Journey into Adventure Games (1980-1999)</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/snes/">snes</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/blog/2023/05/04/round-trips-to-authenticate-a-mongodb-client-connection/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1683225652" data-df="ll" > May 4, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>Round Trips to Authenticate a MongoDB Client Connection</h4><div class="text-muted small"><p> When MongoDB Drivers establish a connection with a MongoDB cluster a number of network round trips are performed. This can result in increased latency when measuring the time to response of an oper...</p></div></div></a></div><div class="col"> <a href="/blog/2023/07/04/how-many-connections-is-my-application-establishing-to-my-mongodb-cluster/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1688480174" data-df="ll" > Jul 4, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>How Many Connections is My Application Establishing to My MongoDB Cluster?</h4><div class="text-muted small"><p> MongoDB Atlas is the best way to host your MongoDB data, but it’s important to be aware that like any other managed service there can be limitations. For example, MongoDB Atlas - depending on the s...</p></div></div></a></div><div class="col"> <a href="/blog/2021/12/23/mongodb-driver-specifications/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1640272099" data-df="ll" > Dec 23, 2021 </em><h4 class="pt-0 my-2" data-toc-skip>MongoDB Driver Specifications</h4><div class="text-muted small"><p> To ensure official MongoDB Drivers are developed with consistent functionality and APIs MongoDB maintains a set of public specifications (see GitHub Repository) that driver engineers can reference ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2023/10/26/lost-in-time/" class="btn btn-outline-primary" prompt="Older" ><p>Lost in Time (Coktel Vision) - 1993</p></a> <a href="/blog/2023/11/14/the-black-cauldron/" class="btn btn-outline-primary" prompt="Newer" ><p>The Black Cauldron (Sierra On-Line) - 1986</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2023/11/13/querysrv-errors-when-connecting-to-mongodb-atlas/'; this.page.identifier = '/blog/2023/11/13/querysrv-errors-when-connecting-to-mongodb-atlas/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/snes/">snes</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a></p><p>© 2023 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="/assets/lib/jquery/jquery.min.js"></script> <script src="/assets/lib/bootstrap/bootstrap.bundle.min.js"></script> <script src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script src="/assets/lib/lazysizes/lazysizes.min.js"></script> <script src="/assets/lib/magnific-popup/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/clipboard/clipboard.min.js"></script> <script src="/assets/lib/dayjs/dayjs.min.js"></script> <script src="/assets/lib/dayjs/locale/en.min.js"></script> <script src="/assets/lib/dayjs/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs/plugin/localizedFormat.min.js"></script> <script src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
