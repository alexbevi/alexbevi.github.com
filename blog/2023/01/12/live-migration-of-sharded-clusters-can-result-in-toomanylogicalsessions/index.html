<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Live Migration of Sharded Clusters to MongoDB Atlas could result in TooManyLogicalSessions Errors" /><meta name="author" content="Alex Bevilacqua" /><meta property="og:locale" content="en_US" /><meta name="description" content="The following is more of a diagnostic journey than anything else, and does not reflect a current issue with MongoDB Atlas." /><meta property="og:description" content="The following is more of a diagnostic journey than anything else, and does not reflect a current issue with MongoDB Atlas." /><link rel="canonical" href="https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-01-12T15:14:50-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Live Migration of Sharded Clusters to MongoDB Atlas could result in TooManyLogicalSessions Errors" /><meta name="twitter:site" content="@alexbevi" /><meta name="twitter:creator" content="@Alex Bevilacqua" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alex Bevilacqua"},"dateModified":"2023-01-13T12:29:02-05:00","datePublished":"2023-01-12T15:14:50-05:00","description":"The following is more of a diagnostic journey than anything else, and does not reflect a current issue with MongoDB Atlas.","headline":"Live Migration of Sharded Clusters to MongoDB Atlas could result in TooManyLogicalSessions Errors","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/"},"url":"https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/"}</script><title>Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors | ALEX BEVILACQUA</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/galleria.min.js"></script><link href="//cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/themes/classic/galleria.classic.min.css" media="screen, projection" rel="stylesheet" type="text/css" /><style> /* This rule is read by Galleria to define the gallery height: */ .galleria{ width: 700px; height: 400px; background: #000 } .responsive-wrap iframe{ max-width: 100%;}</style><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle font-italic">my little corner of the interwebs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href=" https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href=" /feed.xml " aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href=" https://linkedin.com/in/alexbevi " aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" https://stackoverflow.com/users/195509 " aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <a href=" https://www.facebook.com/alexbevi " aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href=" https://reddit.com/user/alexbevi " aria-label="reddit" target="_blank" rel="noopener"> <i class="fab fa-reddit"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> Blog </span> <span> 2023 </span> <span> 01 </span> <span> 12 </span> <span>Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Jan 12, 2023, 3:14 PM -0500" > Jan 12 <i class="unloaded">2023-01-12T15:14:50-05:00</i> </span> by <span class="author"> Alex Bevilacqua </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Fri, Jan 13, 2023, 12:29 PM -0500" > Jan 13 <i class="unloaded">2023-01-13T12:29:02-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1188 words">6 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/mongodb-logo.png" class="preview-img" alt="MongoDB Logo"><div class="note info"> <small>The following is more of a diagnostic journey than anything else, and does not reflect a current issue with MongoDB Atlas.</small></div><p>While I was still working as a Technical Services Engineer at MongoDB in 2021 a small number of customers were reporting that their applications would start throwing errors similar to the following after upgrading from MongoDB 3.6 to 4.0:</p><blockquote><p><code class="language-plaintext highlighter-rouge">Command failed with error 261: 'cannot add session into the cache' on server xxx.yyy.zzz.com:27017. The full response is { "ok" : 0.0, "errmsg" : "cannot add session into the cache", "code" : 261, "codeName" : "TooManyLogicalSessions" }</code></p></blockquote><p>When this error would occur, no further operations could be run against that shard until the <code class="language-plaintext highlighter-rouge">mongod</code> process was restarted. Clusters would not immediately exceed their logical session limit and it could take days or weeks for some clusters to reach this failure condition depending on their level of activity.</p><p>After much investigation the issue boiled down to a confluence of the following scenarios:</p><ol><li>A <a href="https://www.mongodb.com/docs/manual/core/sharded-cluster-components/">Sharded Cluster</a> was <a href="https://www.mongodb.com/docs/atlas/import/live-import-sharded/">Live Migrated to MongoDB Atlas</a><li>The original sharded cluster (correctly) had more than 1 chunk associated with the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection<li>When Live Migrate was finalizing, the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> entry was removed from <code class="language-plaintext highlighter-rouge">config.collections</code> but only one (of many) chunks were removed from <code class="language-plaintext highlighter-rouge">config.chunks</code></ol><p>… but why?</p><h2 id="technical-details">Technical Details</h2><p>To provide <a href="https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/#causal-consistency">causal consistency</a>, <a href="https://docs.mongodb.com/manual/release-notes/3.6/#client-sessions">MongoDB 3.6 introduced client sessions</a>. The underlying framework used by client sessions to support causal consistency (as well as <a href="https://docs.mongodb.com/manual/core/retryable-writes/#retryable-writes">retryable writes</a>) are <a href="https://docs.mongodb.com/manual/reference/server-sessions/">server sessions</a>.</p><p>Per the <a href="https://github.com/mongodb/specifications/blob/master/source/sessions/driver-sessions.rst#how-to-check-whether-a-deployment-supports-sessions">Driver Sessions Specification</a>, starting with MongoDB 3.6, MongoDB Drivers associate all operations with a server session (with the exception of unacknowledged writes). The logic defined in this spec regarding <a href="https://github.com/mongodb/specifications/blob/master/source/sessions/driver-sessions.rst#how-to-check-whether-a-deployment-supports-sessions">“How to Check Whether a Deployment Supports Sessions”</a> states that:</p><ol><li>If the <a href="https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#topologydescription"><code class="language-plaintext highlighter-rouge">TopologyDescription</code></a> and connection type indicate that<ul><li>the driver is not connected to any servers, <strong>OR</strong><li>is not a direct connection <strong>AND</strong> is not connected to a data-bearing server then a driver must do a server selection for any server whose type is data-bearing. Server selection will either time out or result in a <code class="language-plaintext highlighter-rouge">TopologyDescription</code> that includes at least one connected, data-bearing server.</ul><li>Having verified in step 1 that the <code class="language-plaintext highlighter-rouge">TopologyDescription</code> includes at least one connected server a driver can now determine whether sessions are supported by inspecting the <a href="https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#topologytype"><code class="language-plaintext highlighter-rouge">TopologyType</code></a> and <code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code> property.</ol><p>With MongoDB 3.6, the <code class="language-plaintext highlighter-rouge">hello</code> command when targeting a sharded cluster will only return the <a href="https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#logical-session-timeout"><code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code></a> under two conditions:</p><ol><li>(Starting with MongoDB 3.6.0 via <a href="https://jira.mongodb.org/browse/SERVER-31777">SERVER-31777</a>) When the <a href="https://docs.mongodb.com/manual/reference/command/setFeatureCompatibilityVersion/index.html"><code class="language-plaintext highlighter-rouge">featureCompatibilityVersion</code> is set</a> to “3.6” <strong>AND</strong><li>(Starting with MongoDB 3.6.9 via <a href="https://jira.mongodb.org/browse/SERVER-37631">SERVER-37631</a>) The cluster has a valid <a href="https://docs.mongodb.com/manual/reference/config-database/#config.`system.sessions`"><code class="language-plaintext highlighter-rouge">system.sessions</code> collection</a></ol><p>Starting in MongoDB 4.0, an <code class="language-plaintext highlighter-rouge">hello</code> command when targeting a sharded cluster will <em>always</em> return <code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code>, as the <code class="language-plaintext highlighter-rouge">featureCompatibilityVersion</code> test has been removed (via <a href="https://jira.mongodb.org/browse/SERVER-32460">SERVER-32460</a>). The test for a valid <code class="language-plaintext highlighter-rouge">system.sessions</code> collections was not included in MongoDB 4.0.</p><p>As a result, if the cluster contains a “broken” <code class="language-plaintext highlighter-rouge">system.sessions</code> collection the following can occur:</p><ul><li>On MongoDB 3.6, <code class="language-plaintext highlighter-rouge">hello</code> doesn’t return <code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code> which causes the driver to determine that sessions are not supported on this cluster, resulting in logical sessions not being used<li>On MongoDB 4.0, <code class="language-plaintext highlighter-rouge">hello</code> <em>always</em> returns <code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code>, resulting in the driver enabling logical sessions. If a “broken” <code class="language-plaintext highlighter-rouge">system.sessions</code> collection exists, the sessions are not persisted/expired properly which can result in cluster failure once the <a href="https://www.mongodb.com/docs/v4.0/reference/parameters/#param.maxSessions"><code class="language-plaintext highlighter-rouge">maxSessions</code></a> threshold (default: 1,000,000) is reached.</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/toomanysession.png" alt="" /> <em>Screenshot from a tool used to chart <a href="/blog/2020/01/26/what-is-mongodb-ftdc-aka-diagnostic-dot-data/">FTDC</a> telemetry</em></p><h2 id="what-is-the-systemsessions-collection">What is the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection</h2><p>The <code class="language-plaintext highlighter-rouge">system.sessions</code> collection stores session records that are available to all members of the deployment.</p><p>When a user creates a session on a <code class="language-plaintext highlighter-rouge">mongod</code> or <code class="language-plaintext highlighter-rouge">mongos</code> instance, the record of the session initially exists only in-memory on the instance. Periodically, the instance will sync its cached sessions to the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection; at which time, they are visible to all members of the deployment.</p><p>In a sharded cluster, the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection is sharded. When adding a shard to the sharded cluster, if the shard to add already contains its own <code class="language-plaintext highlighter-rouge">system.sessions</code> collection, MongoDB drops the new shard’s <code class="language-plaintext highlighter-rouge">system.sessions</code> collection during the add process.</p><h2 id="what-is-a-broken-systemsessions-collection">What is a “broken” <code class="language-plaintext highlighter-rouge">system.sessions</code> collection</h2><p>The <code class="language-plaintext highlighter-rouge">system.sessions</code> collection is expected to be sharded, however in some cases, the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection may be mistakenly created on the <a href="https://docs.mongodb.com/manual/core/sharded-cluster-config-servers/">Config Servers</a> as an unsharded collection. Each sharded node in a cluster expects to be able to write documents to the sessions collection, which is why it is necessary for the sessions collection to be sharded.</p><p>When the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection is “broken” the <code class="language-plaintext highlighter-rouge">LogicalSessionCache*</code> threads will emit log messages such as the following:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>// Primary Shard Logs
2021-03-12T19:32:51.551+0000 I CONTROL  [LogicalSessionCacheRefresh] Sessions collection is not set up; waiting until next sessions refresh interval: Collection config.system.sessions is not sharded.
2021-03-12T19:32:51.556+0000 I CONTROL  [LogicalSessionCacheReap] Sessions collection is not set up; waiting until next sessions reap interval: Collection config.system.sessions is not sharded.

// Config Server Logs
2021-03-12T18:32:31.725+0000 I CONTROL  [LogicalSessionCacheRefresh] Failed to create config.system.sessions: Not primary while running findAndModify command on collection config.locks, will try again at the next refresh interval
</pre></table></code></div></div><h2 id="how-does-the-systemsessions-collection-break-in-atlas">How does the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection “break” in Atlas</h2><p>At the time of investigation the working hypothesis was that there was a defect associated with the Live Migration process for Sharded Clusters. When the Live Migration tool was run the following was observed:</p><ol><li>When the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection is migrated it is not initially sharded<li>There are, however <a href="https://docs.mongodb.com/manual/core/sharding-data-partitioning/">chunks</a> associated with the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection<li>Reviewing the <a href="https://docs.mongodb.com/manual/core/replica-set-oplog/"><code class="language-plaintext highlighter-rouge">oplog</code></a> for the Config Server replica set shows an entry where the config.<code class="language-plaintext highlighter-rouge">system.sessions</code> collection is removed from the <a href="https://docs.mongodb.com/manual/reference/config-database/#config.collections"><code class="language-plaintext highlighter-rouge">config.collections</code></a> collection along with an entry in the <a href="https://docs.mongodb.com/manual/reference/config-database/#config.chunks"><code class="language-plaintext highlighter-rouge">config.chunks</code></a> collection:<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>{ "ts" : Timestamp(1616135732, 11), "t" : NumberLong(2), "h" : NumberLong("-2957928371374723467"), "v" : 2, "op" : "d", "ns" : "config.chunks", "ui" : UUID("933eed1e-f9a6-4ad7-93e5-f799e0d41484"), "wall" : ISODate("2021-03-19T06:35:32.598Z"), "o" : { "_id" : "config.`system.sessions`-_id_MinKey" } }
{ "ts" : Timestamp(1616135732, 12), "t" : NumberLong(2), "h" : NumberLong("7339349496984671905"), "v" : 2, "op" : "d", "ns" : "config.collections", "ui" : UUID("703ea46b-44c6-435c-8dc3-91f9cf287c08"), "wall" : ISODate("2021-03-19T06:35:32.607Z"), "o" : { "_id" : "config.`system.sessions`" } }
</pre></table></code></div></div></ol><p>Based on this observation it appeared that during the live migration’s temporary data/metadata cleanup process (for a sharded cluster), the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection was being removed from the <code class="language-plaintext highlighter-rouge">config.collections</code> collection which makes it appear to the cluster that config.<code class="language-plaintext highlighter-rouge">system.sessions</code> is unsharded.</p><p>The <code class="language-plaintext highlighter-rouge">LogicalSessionCacheRefresh</code> thread should automatically recreate the collection as sharded in this case, however as there are still chunks associated with the collection this process failed and was retried indefinitely.</p><h2 id="identification--mitigation">Identification &amp; Mitigation</h2><p>Any sharded cluster can be tested for an incorrectly (“broken”) configured <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection (caused by the suspected deficiency in Live Migrate or otherwise) by connecting (via the <code class="language-plaintext highlighter-rouge">mongo</code> or <code class="language-plaintext highlighter-rouge">mongosh</code> shell) and running:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">getSiblingDB</span><span class="p">(</span><span class="dl">'</span><span class="s1">config</span><span class="dl">'</span><span class="p">).</span><span class="nx">system</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">stats</span><span class="p">()[</span><span class="dl">'</span><span class="s1">sharded</span><span class="dl">'</span><span class="p">]</span>
</pre></table></code></div></div><p>If the result of the above command is NOT <code class="language-plaintext highlighter-rouge">true</code> (either <code class="language-plaintext highlighter-rouge">false</code> or blank), performing the following actions on the cluster would address the issue:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// Connect to the PRIMARY member of CSRS and ALL Shard PRIMARY members</span>
<span class="c1">// and run the following command</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">system</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// Connect to a single mongos configured for your cluster and run the following</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">getSiblingDB</span><span class="p">(</span><span class="dl">'</span><span class="s1">config</span><span class="dl">'</span><span class="p">).</span><span class="nx">chunks</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span> <span class="p">{</span><span class="na">ns</span><span class="p">:</span><span class="dl">'</span><span class="s1">config.system.sessions</span><span class="dl">'</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">adminCommand</span><span class="p">(</span><span class="dl">"</span><span class="s2">flushRouterConfig</span><span class="dl">"</span><span class="p">)</span>
</pre></table></code></div></div><p>Hopefully you’ll never find yourself in a situation such as the one described above, but if you do this guide may be useful for getting your cluster back up and running.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/sharding/" class="post-tag no-text-decoration" >sharding</a> <a href="/tags/diagnostics/" class="post-tag no-text-decoration" >diagnostics</a> <a href="/tags/troubleshooting/" class="post-tag no-text-decoration" >troubleshooting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors - ALEX BEVILACQUA&u=https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2021/07/28/adventure-games-1980-1999/">Journey into Adventure Games (1980-1999)</a><li><a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Adventure Games (1980-1999): Sorted by Score</a><li><a href="/blog/2023/02/08/emmanuelle/">Emmanuelle (Coktel Vision) - 1989</a><li><a href="/blog/2023/02/07/eternam/">Eternam (Infogrames) - 1992</a><li><a href="/blog/2023/02/07/kabul-spy/">Kabul Spy (Sirius Software) - 1982</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/scripting/">scripting</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2016/02/10/identifying-failing-system-dot-js-functions-in-mongodb/"><div class="card-body"> <span class="timeago small" > Feb 10, 2016 <i class="unloaded">2016-02-10T15:17:56-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Identifying failing system.js functions in MongoDB</h3><div class="text-muted small"><p> laptop(mongod-3.2.1) test&gt; db.loadServerScripts() 2016-02-10T15:18:42.322-0500 E QUERY [thread1] SyntaxError: unterminated string literal : DB.prototype.loadServerScripts/&lt;@src/mongo/shell...</p></div></div></a></div><div class="card"> <a href="/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/"><div class="card-body"> <span class="timeago small" > Feb 10, 2016 <i class="unloaded">2016-02-10T20:38:38-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Recovering a WiredTiger collection from a corrupt MongoDB installation</h3><div class="text-muted small"><p> April, 1 2019: I've received a LOT of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a --rep...</p></div></div></a></div><div class="card"> <a href="/blog/2018/05/28/troubleshooting-a-mongodb-performance-issue/"><div class="card-body"> <span class="timeago small" > May 28, 2018 <i class="unloaded">2018-05-28T09:14:03-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Troubleshooting a MongoDB Performance Issue</h3><div class="text-muted small"><p> UPDATE (2018-06-28): I actually sent a link to this article to the author of the previous blog post and in her reply she indicates that the improvements to cache management and checkpoint areas wer...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2023/01/12/cruise-for-a-corpse/" class="btn btn-outline-primary" prompt="Older"><p>Cruise for a Corpse (Delphine Software International) - 1991</p></a> <a href="/blog/2023/01/13/will-upgrading-my-mongodb-server-version-break-my-application/" class="btn btn-outline-primary" prompt="Newer"><p>Will Upgrading My MongoDB Server Version Break My Application?</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//alexbevi.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors'; this.page.url = 'https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/'; this.page.identifier = '/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/scripting/">scripting</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.alexbevi.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script type="text/javascript" src="/assets/js/lightbox.js"></script><link rel="stylesheet" href="/assets/css/lightbox.css">
