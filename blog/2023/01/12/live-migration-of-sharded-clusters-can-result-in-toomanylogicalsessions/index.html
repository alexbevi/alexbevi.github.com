<!doctype html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Live Migration of Sharded Clusters to MongoDB Atlas could result in TooManyLogicalSessions Errors" /><meta property="og:locale" content="en" /><meta name="description" content="The following is more of a diagnostic journey than anything else, and does not reflect a current issue with MongoDB Atlas." /><meta property="og:description" content="The following is more of a diagnostic journey than anything else, and does not reflect a current issue with MongoDB Atlas." /><link rel="canonical" href="https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-01-12T15:14:50-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="twitter:title" content="Live Migration of Sharded Clusters to MongoDB Atlas could result in TooManyLogicalSessions Errors" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-09T12:45:05-04:00","datePublished":"2023-01-12T15:14:50-05:00","description":"The following is more of a diagnostic journey than anything else, and does not reflect a current issue with MongoDB Atlas.","headline":"Live Migration of Sharded Clusters to MongoDB Atlas could result in TooManyLogicalSessions Errors","image":"https://www.alexbevi.com/images/mongodb-logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/"},"url":"https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/"}</script><title>Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="stylesheet" href="/assets/lib/bootstrap/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup/magnific-popup.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/images/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle fst-italic">my little corner of the interwebs</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1673554490" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jan 12, 2023 </em> </span> <span> Updated <em class="" data-ts="1683650705" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 9, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1188 words" > <em>6 min</em> read </span></div></div></div><div class="post-content"><blockquote class="prompt-info"><p>The following is more of a diagnostic journey than anything else, and does not reflect a current issue with MongoDB Atlas.</p></blockquote><p>While I was still working as a Technical Services Engineer at MongoDB in 2021 a small number of customers were reporting that their applications would start throwing errors similar to the following after upgrading from MongoDB 3.6 to 4.0:</p><blockquote><p><code class="language-plaintext highlighter-rouge">Command failed with error 261: 'cannot add session into the cache' on server xxx.yyy.zzz.com:27017. The full response is { "ok" : 0.0, "errmsg" : "cannot add session into the cache", "code" : 261, "codeName" : "TooManyLogicalSessions" }</code></p></blockquote><p>When this error would occur, no further operations could be run against that shard until the <code class="language-plaintext highlighter-rouge">mongod</code> process was restarted. Clusters would not immediately exceed their logical session limit and it could take days or weeks for some clusters to reach this failure condition depending on their level of activity.</p><p>After much investigation the issue boiled down to a confluence of the following scenarios:</p><ol><li>A <a href="https://www.mongodb.com/docs/manual/core/sharded-cluster-components/">Sharded Cluster</a> was <a href="https://www.mongodb.com/docs/atlas/import/live-import-sharded/">Live Migrated to MongoDB Atlas</a><li>The original sharded cluster (correctly) had more than 1 chunk associated with the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection<li>When Live Migrate was finalizing, the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> entry was removed from <code class="language-plaintext highlighter-rouge">config.collections</code> but only one (of many) chunks were removed from <code class="language-plaintext highlighter-rouge">config.chunks</code></ol><p>… but why?</p><h2 id="technical-details"><span class="me-2">Technical Details</span><a href="#technical-details" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To provide <a href="https://docs.mongodb.com/manual/core/read-isolation-consistency-recency/#causal-consistency">causal consistency</a>, <a href="https://docs.mongodb.com/manual/release-notes/3.6/#client-sessions">MongoDB 3.6 introduced client sessions</a>. The underlying framework used by client sessions to support causal consistency (as well as <a href="https://docs.mongodb.com/manual/core/retryable-writes/#retryable-writes">retryable writes</a>) are <a href="https://docs.mongodb.com/manual/reference/server-sessions/">server sessions</a>.</p><p>Per the <a href="https://github.com/mongodb/specifications/blob/master/source/sessions/driver-sessions.rst#how-to-check-whether-a-deployment-supports-sessions">Driver Sessions Specification</a>, starting with MongoDB 3.6, MongoDB Drivers associate all operations with a server session (with the exception of unacknowledged writes). The logic defined in this spec regarding <a href="https://github.com/mongodb/specifications/blob/master/source/sessions/driver-sessions.rst#how-to-check-whether-a-deployment-supports-sessions">“How to Check Whether a Deployment Supports Sessions”</a> states that:</p><ol><li>If the <a href="https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#topologydescription"><code class="language-plaintext highlighter-rouge">TopologyDescription</code></a> and connection type indicate that<ul><li>the driver is not connected to any servers, <strong>OR</strong><li>is not a direct connection <strong>AND</strong> is not connected to a data-bearing server then a driver must do a server selection for any server whose type is data-bearing. Server selection will either time out or result in a <code class="language-plaintext highlighter-rouge">TopologyDescription</code> that includes at least one connected, data-bearing server.</ul><li>Having verified in step 1 that the <code class="language-plaintext highlighter-rouge">TopologyDescription</code> includes at least one connected server a driver can now determine whether sessions are supported by inspecting the <a href="https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#topologytype"><code class="language-plaintext highlighter-rouge">TopologyType</code></a> and <code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code> property.</ol><p>With MongoDB 3.6, the <code class="language-plaintext highlighter-rouge">hello</code> command when targeting a sharded cluster will only return the <a href="https://github.com/mongodb/specifications/blob/master/source/server-discovery-and-monitoring/server-discovery-and-monitoring.rst#logical-session-timeout"><code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code></a> under two conditions:</p><ol><li>(Starting with MongoDB 3.6.0 via <a href="https://jira.mongodb.org/browse/SERVER-31777">SERVER-31777</a>) When the <a href="https://docs.mongodb.com/manual/reference/command/setFeatureCompatibilityVersion/index.html"><code class="language-plaintext highlighter-rouge">featureCompatibilityVersion</code> is set</a> to “3.6” <strong>AND</strong><li>(Starting with MongoDB 3.6.9 via <a href="https://jira.mongodb.org/browse/SERVER-37631">SERVER-37631</a>) The cluster has a valid <a href="https://docs.mongodb.com/manual/reference/config-database/#config.`system.sessions`"><code class="language-plaintext highlighter-rouge">system.sessions</code> collection</a></ol><p>Starting in MongoDB 4.0, an <code class="language-plaintext highlighter-rouge">hello</code> command when targeting a sharded cluster will <em>always</em> return <code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code>, as the <code class="language-plaintext highlighter-rouge">featureCompatibilityVersion</code> test has been removed (via <a href="https://jira.mongodb.org/browse/SERVER-32460">SERVER-32460</a>). The test for a valid <code class="language-plaintext highlighter-rouge">system.sessions</code> collections was not included in MongoDB 4.0.</p><p>As a result, if the cluster contains a “broken” <code class="language-plaintext highlighter-rouge">system.sessions</code> collection the following can occur:</p><ul><li>On MongoDB 3.6, <code class="language-plaintext highlighter-rouge">hello</code> doesn’t return <code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code> which causes the driver to determine that sessions are not supported on this cluster, resulting in logical sessions not being used<li>On MongoDB 4.0, <code class="language-plaintext highlighter-rouge">hello</code> <em>always</em> returns <code class="language-plaintext highlighter-rouge">logicalSessionTimeoutMinutes</code>, resulting in the driver enabling logical sessions. If a “broken” <code class="language-plaintext highlighter-rouge">system.sessions</code> collection exists, the sessions are not persisted/expired properly which can result in cluster failure once the <a href="https://www.mongodb.com/docs/v4.0/reference/parameters/#param.maxSessions"><code class="language-plaintext highlighter-rouge">maxSessions</code></a> threshold (default: 1,000,000) is reached.</ul><p><a href="/images/toomanysession.png" class="popup img-link "><img data-src="/images/toomanysession.png" alt="" class="lazyload" data-proofer-ignore></a> <em>Screenshot from a tool used to chart <a href="/blog/2020/01/26/what-is-mongodb-ftdc-aka-diagnostic-dot-data/">FTDC</a> telemetry</em></p><h2 id="what-is-the-systemsessions-collection"><span class="me-2">What is the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection</span><a href="#what-is-the-systemsessions-collection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <code class="language-plaintext highlighter-rouge">system.sessions</code> collection stores session records that are available to all members of the deployment.</p><p>When a user creates a session on a <code class="language-plaintext highlighter-rouge">mongod</code> or <code class="language-plaintext highlighter-rouge">mongos</code> instance, the record of the session initially exists only in-memory on the instance. Periodically, the instance will sync its cached sessions to the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection; at which time, they are visible to all members of the deployment.</p><p>In a sharded cluster, the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection is sharded. When adding a shard to the sharded cluster, if the shard to add already contains its own <code class="language-plaintext highlighter-rouge">system.sessions</code> collection, MongoDB drops the new shard’s <code class="language-plaintext highlighter-rouge">system.sessions</code> collection during the add process.</p><h2 id="what-is-a-broken-systemsessions-collection"><span class="me-2">What is a “broken” <code class="language-plaintext highlighter-rouge">system.sessions</code> collection</span><a href="#what-is-a-broken-systemsessions-collection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <code class="language-plaintext highlighter-rouge">system.sessions</code> collection is expected to be sharded, however in some cases, the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection may be mistakenly created on the <a href="https://docs.mongodb.com/manual/core/sharded-cluster-config-servers/">Config Servers</a> as an unsharded collection. Each sharded node in a cluster expects to be able to write documents to the sessions collection, which is why it is necessary for the sessions collection to be sharded.</p><p>When the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection is “broken” the <code class="language-plaintext highlighter-rouge">LogicalSessionCache*</code> threads will emit log messages such as the following:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>// Primary Shard Logs
2021-03-12T19:32:51.551+0000 I CONTROL  [LogicalSessionCacheRefresh] Sessions collection is not set up; waiting until next sessions refresh interval: Collection config.system.sessions is not sharded.
2021-03-12T19:32:51.556+0000 I CONTROL  [LogicalSessionCacheReap] Sessions collection is not set up; waiting until next sessions reap interval: Collection config.system.sessions is not sharded.

// Config Server Logs
2021-03-12T18:32:31.725+0000 I CONTROL  [LogicalSessionCacheRefresh] Failed to create config.system.sessions: Not primary while running findAndModify command on collection config.locks, will try again at the next refresh interval
</pre></table></code></div></div><h2 id="how-does-the-systemsessions-collection-break-in-atlas"><span class="me-2">How does the <code class="language-plaintext highlighter-rouge">system.sessions</code> collection “break” in Atlas</span><a href="#how-does-the-systemsessions-collection-break-in-atlas" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>At the time of investigation the working hypothesis was that there was a defect associated with the Live Migration process for Sharded Clusters. When the Live Migration tool was run the following was observed:</p><ol><li>When the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection is migrated it is not initially sharded<li>There are, however <a href="https://docs.mongodb.com/manual/core/sharding-data-partitioning/">chunks</a> associated with the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection<li>Reviewing the <a href="https://docs.mongodb.com/manual/core/replica-set-oplog/"><code class="language-plaintext highlighter-rouge">oplog</code></a> for the Config Server replica set shows an entry where the config.<code class="language-plaintext highlighter-rouge">system.sessions</code> collection is removed from the <a href="https://docs.mongodb.com/manual/reference/config-database/#config.collections"><code class="language-plaintext highlighter-rouge">config.collections</code></a> collection along with an entry in the <a href="https://docs.mongodb.com/manual/reference/config-database/#config.chunks"><code class="language-plaintext highlighter-rouge">config.chunks</code></a> collection:<div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>{ "ts" : Timestamp(1616135732, 11), "t" : NumberLong(2), "h" : NumberLong("-2957928371374723467"), "v" : 2, "op" : "d", "ns" : "config.chunks", "ui" : UUID("933eed1e-f9a6-4ad7-93e5-f799e0d41484"), "wall" : ISODate("2021-03-19T06:35:32.598Z"), "o" : { "_id" : "config.`system.sessions`-_id_MinKey" } }
{ "ts" : Timestamp(1616135732, 12), "t" : NumberLong(2), "h" : NumberLong("7339349496984671905"), "v" : 2, "op" : "d", "ns" : "config.collections", "ui" : UUID("703ea46b-44c6-435c-8dc3-91f9cf287c08"), "wall" : ISODate("2021-03-19T06:35:32.607Z"), "o" : { "_id" : "config.`system.sessions`" } }
</pre></table></code></div></div></ol><p>Based on this observation it appeared that during the live migration’s temporary data/metadata cleanup process (for a sharded cluster), the <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection was being removed from the <code class="language-plaintext highlighter-rouge">config.collections</code> collection which makes it appear to the cluster that config.<code class="language-plaintext highlighter-rouge">system.sessions</code> is unsharded.</p><p>The <code class="language-plaintext highlighter-rouge">LogicalSessionCacheRefresh</code> thread should automatically recreate the collection as sharded in this case, however as there are still chunks associated with the collection this process failed and was retried indefinitely.</p><h2 id="identification--mitigation"><span class="me-2">Identification &amp; Mitigation</span><a href="#identification--mitigation" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Any sharded cluster can be tested for an incorrectly (“broken”) configured <code class="language-plaintext highlighter-rouge">config.system.sessions</code> collection (caused by the suspected deficiency in Live Migrate or otherwise) by connecting (via the <code class="language-plaintext highlighter-rouge">mongo</code> or <code class="language-plaintext highlighter-rouge">mongosh</code> shell) and running:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nf">getSiblingDB</span><span class="p">(</span><span class="dl">'</span><span class="s1">config</span><span class="dl">'</span><span class="p">).</span><span class="nx">system</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nf">stats</span><span class="p">()[</span><span class="dl">'</span><span class="s1">sharded</span><span class="dl">'</span><span class="p">]</span>
</pre></table></code></div></div><p>If the result of the above command is NOT <code class="language-plaintext highlighter-rouge">true</code> (either <code class="language-plaintext highlighter-rouge">false</code> or blank), performing the following actions on the cluster would address the issue:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// Connect to the PRIMARY member of CSRS and ALL Shard PRIMARY members</span>
<span class="c1">// and run the following command</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">system</span><span class="p">.</span><span class="nx">sessions</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// Connect to a single mongos configured for your cluster and run the following</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">getSiblingDB</span><span class="p">(</span><span class="dl">'</span><span class="s1">config</span><span class="dl">'</span><span class="p">).</span><span class="nx">chunks</span><span class="p">.</span><span class="nf">remove</span><span class="p">(</span> <span class="p">{</span><span class="na">ns</span><span class="p">:</span><span class="dl">'</span><span class="s1">config.system.sessions</span><span class="dl">'</span><span class="p">})</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">adminCommand</span><span class="p">(</span><span class="dl">"</span><span class="s2">flushRouterConfig</span><span class="dl">"</span><span class="p">)</span>
</pre></table></code></div></div><p>Hopefully you’ll never find yourself in a situation such as the one described above, but if you do this guide may be useful for getting your cluster back up and running.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/sharding/" class="post-tag no-text-decoration" >sharding</a> <a href="/tags/diagnostics/" class="post-tag no-text-decoration" >diagnostics</a> <a href="/tags/troubleshooting/" class="post-tag no-text-decoration" >troubleshooting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Live%20Migration%20of%20Sharded%20Clusters%20to%20MongoDB%20Atlas%20could%20result%20in%20%3Ctt%3ETooManyLogicalSessions%3C/tt%3E%20Errors%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F01%2F12%2Flive-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Live%20Migration%20of%20Sharded%20Clusters%20to%20MongoDB%20Atlas%20could%20result%20in%20%3Ctt%3ETooManyLogicalSessions%3C/tt%3E%20Errors%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F01%2F12%2Flive-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F01%2F12%2Flive-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions%2F&text=Live%20Migration%20of%20Sharded%20Clusters%20to%20MongoDB%20Atlas%20could%20result%20in%20%3Ctt%3ETooManyLogicalSessions%3C/tt%3E%20Errors%20-%20ALEX%20BEVILACQUA" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F01%2F12%2Flive-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Live%20Migration%20of%20Sharded%20Clusters%20to%20MongoDB%20Atlas%20could%20result%20in%20%3Ctt%3ETooManyLogicalSessions%3C/tt%3E%20Errors%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2023%2F01%2F12%2Flive-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo" > <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2021/07/28/adventure-games-1980-1999/">Let's Adventure! A Journey into Adventure Games (1980-1999)</a><li class="text-truncate lh-lg"> <a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Let's Adventure! Reviewed Games Sorted by Score</a><li class="text-truncate lh-lg"> <a href="/blog/2023/10/05/blade-runner/">Blade Runner (Westwood Studios) - 1997</a><li class="text-truncate lh-lg"> <a href="/blog/2023/10/07/rendezvous-with-rama/">Rendezvous with Rama (Telarium) - 1984</a><li class="text-truncate lh-lg"> <a href="/blog/2023/09/27/ripper/">Ripper (Take-Two Interactive) - 1996</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/snes/">snes</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/blog/2016/02/10/identifying-failing-system-dot-js-functions-in-mongodb/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1455135476" data-df="ll" > Feb 10, 2016 </em><h4 class="pt-0 my-2" data-toc-skip>Identifying failing system.js functions in MongoDB</h4><div class="text-muted small"><p> laptop(mongod-3.2.1) test&amp;gt; db.loadServerScripts() 2016-02-10T15:18:42.322-0500 E QUERY [thread1] SyntaxError: unterminated string literal : DB.prototype.loadServerScripts/&amp;lt;@src/mongo/shell...</p></div></div></a></div><div class="col"> <a href="/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1455154718" data-df="ll" > Feb 10, 2016 </em><h4 class="pt-0 my-2" data-toc-skip>Recovering a WiredTiger collection from a corrupt MongoDB installation</h4><div class="text-muted small"><p> April, 1 2019: I’ve received a LOT of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a --r...</p></div></div></a></div><div class="col"> <a href="/blog/2018/05/28/troubleshooting-a-mongodb-performance-issue/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1527513243" data-df="ll" > May 28, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>Troubleshooting a MongoDB Performance Issue</h4><div class="text-muted small"><p> UPDATE (2018-06-28): I actually sent a link to this article to the author of the previous blog post and in her reply she indicates that the improvements to cache management and checkpoint areas wer...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2023/01/12/cruise-for-a-corpse/" class="btn btn-outline-primary" prompt="Older" ><p>Cruise for a Corpse (Delphine Software International) - 1991</p></a> <a href="/blog/2023/01/13/will-upgrading-my-mongodb-server-version-break-my-application/" class="btn btn-outline-primary" prompt="Newer" ><p>Will Upgrading My MongoDB Server Version Break My Application?</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/'; this.page.identifier = '/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/snes/">snes</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a></p><p>© 2023 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="/assets/lib/jquery/jquery.min.js"></script> <script src="/assets/lib/bootstrap/bootstrap.bundle.min.js"></script> <script src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script src="/assets/lib/lazysizes/lazysizes.min.js"></script> <script src="/assets/lib/magnific-popup/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/clipboard/clipboard.min.js"></script> <script src="/assets/lib/dayjs/dayjs.min.js"></script> <script src="/assets/lib/dayjs/locale/en.min.js"></script> <script src="/assets/lib/dayjs/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs/plugin/localizedFormat.min.js"></script> <script src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
