<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="MongoDB 5.0 Initial Sync Progress Monitoring Improvements" /><meta name="author" content="Alex Bevilacqua" /><meta property="og:locale" content="en_US" /><meta name="description" content="&lt;SHAMELESS_PLUG&gt; My previous article about initial sync progress monitoring got some attention, and as I’m a Technical Services Engineer at MongoDB, I got to provide direct feedback during the design phase of SERVER-47863: Initial Sync Progress Metrics!." /><meta property="og:description" content="&lt;SHAMELESS_PLUG&gt; My previous article about initial sync progress monitoring got some attention, and as I’m a Technical Services Engineer at MongoDB, I got to provide direct feedback during the design phase of SERVER-47863: Initial Sync Progress Metrics!." /><link rel="canonical" href="https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-11-20T10:31:26-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="MongoDB 5.0 Initial Sync Progress Monitoring Improvements" /><meta name="twitter:site" content="@alexbevi" /><meta name="twitter:creator" content="@Alex Bevilacqua" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alex Bevilacqua"},"dateModified":"2021-03-28T13:22:31-04:00","datePublished":"2020-11-20T10:31:26-05:00","description":"&lt;SHAMELESS_PLUG&gt; My previous article about initial sync progress monitoring got some attention, and as I’m a Technical Services Engineer at MongoDB, I got to provide direct feedback during the design phase of SERVER-47863: Initial Sync Progress Metrics!.","headline":"MongoDB 5.0 Initial Sync Progress Monitoring Improvements","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/"},"url":"https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/"}</script><title>MongoDB 5.0 Initial Sync Progress Monitoring Improvements | ALEX BEVILACQUA</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/galleria.min.js"></script><link href="//cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/themes/classic/galleria.classic.min.css" media="screen, projection" rel="stylesheet" type="text/css" /><style> /* This rule is read by Galleria to define the gallery height: */ .galleria{ width: 700px; height: 400px; background: #000 } .responsive-wrap iframe{ max-width: 100%;}</style><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle font-italic">my little corner of the interwebs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/alexbevi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/alexbevi" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener"> <i class="fab fa-reddit"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> Blog </span> <span> 2020 </span> <span> 11 </span> <span> 20 </span> <span>MongoDB 5.0 Initial Sync Progress Monitoring Improvements</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>MongoDB 5.0 Initial Sync Progress Monitoring Improvements</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Nov 20, 2020, 10:31 AM -0500" > Nov 20, 2020 <i class="unloaded">2020-11-20T10:31:26-05:00</i> </span> by <span class="author"> Alex Bevilacqua </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Mar 28, 2021, 1:22 PM -0400" > Mar 28, 2021 <i class="unloaded">2021-03-28T13:22:31-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1404 words">7 min</span></div></div><div class="post-content"><p><code class="language-plaintext highlighter-rouge">&lt;SHAMELESS_PLUG&gt;</code> <br /> My <a href="/blog/2020/02/13/mongodb-initial-sync-progress-monitoring/">previous article about initial sync progress monitoring</a> got some attention, and as I’m a <a href="/blog/2018/10/01/technical-services-engineering-at-mongodb/">Technical Services Engineer</a> at MongoDB, I got to provide direct feedback during the design phase of <a href="https://jira.mongodb.org/browse/SERVER-47863">SERVER-47863: <em>Initial Sync Progress Metrics</em></a>!.</p><p>You can be a part of this team and this awesome organization too! Head on over to <a href="https://grnh.se/dcd90aac1">MongoDB’s careers page</a> to see what’s available, or feel free to ping me on <a href="https://www.linkedin.com/in/alexbevi/">LinkedIn</a> if you have any questions. <br /> <code class="language-plaintext highlighter-rouge">&lt;/SHAMELESS_PLUG&gt;</code></p><p>The goal of this post is to showcase a change that is coming in MongoDB 5.0 that will significantly improve the feedback loop regarding <a href="https://docs.mongodb.com/manual/core/replica-set-sync/#initial-sync">initial sync</a> progress monitoring. With <a href="https://jira.mongodb.org/browse/SERVER-47863">SERVER-47863</a> being completed, the results of the <a href="https://docs.mongodb.com/manual/reference/command/replSetGetStatus/"><code class="language-plaintext highlighter-rouge">db.adminCommand({ replSetGetStatus: 1, initialSync: 1 })</code></a> now include additional metrics that can be used to help determine how long (approximately) an initial sync will be running for.</p><p><strong>Though this feature is planned to be backported to versions 4.4.3 and 4.2.12, at the time of writing backports had not been completed.</strong></p><p>If you want to test this yourself, my setup was as follows:</p><p>1) <a href="https://github.com/mongodb/mongo/blob/master/docs/building.md#scons-targets">Build the server using the <code class="language-plaintext highlighter-rouge">install-mongod</code> SCons target</a>. My version of the server was <code class="language-plaintext highlighter-rouge">mongod-4.9.0-alpha-596-g4437864</code> as a result. <br /> 2) Start up a single node replicaset as follows:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">mkdir </span>data <span class="o">&amp;&amp;</span> build/install/bin/mongod <span class="nt">--dbpath</span> data <span class="nt">--bind_ip_all</span> <span class="nt">--replSet</span> rs0 <span class="nt">--logpath</span> data/mongod.log
</pre></table></code></div></div><p>3) Using the <code class="language-plaintext highlighter-rouge">mongo</code> shell, initialize the replica set:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mongo <span class="nt">--eval</span> <span class="s1">'rs.initiate()'</span>
</pre></table></code></div></div><p>4) Seed the <code class="language-plaintext highlighter-rouge">test.data</code> namespace using the following <a href="https://github.com/rueckstiess/mgeneratejs"><code class="language-plaintext highlighter-rouge">mgeneratejs</code></a> and <a href="https://docs.mongodb.com/database-tools/mongoimport/"><code class="language-plaintext highlighter-rouge">mongoimport</code></a>:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>curl <span class="nt">-s</span> https://gist.githubusercontent.com/alexbevi/955c6675337107e16d637233f865b1e3/raw/0c48178e9c570b7594f207559744f07ecf87ac28/template.json | mgeneratejs <span class="nt">-n</span> 1000000 | mongoimport <span class="nt">--collection</span> data <span class="nt">--numInsertionWorkers</span> 4
</pre></table></code></div></div><p>5) Start another <code class="language-plaintext highlighter-rouge">mongod</code> and add it to the replica set</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">mkdir </span>data2 <span class="o">&amp;&amp;</span> build/install/bin/mongod <span class="nt">--port</span> 27018 <span class="nt">--dbpath</span> data2 <span class="nt">--bind_ip_all</span> <span class="nt">--replSet</span> rs0 <span class="nt">--logpath</span> data2/mongod.log
mongo <span class="nt">--eval</span> <span class="s1">'rs.add("localhost:27018")'</span>
</pre></table></code></div></div><p>The above steps will build the <code class="language-plaintext highlighter-rouge">mongod</code> and start up 2 nodes in a replica set with one in a <a href="https://docs.mongodb.com/manual/reference/replica-states/#replstate.STARTUP2"><code class="language-plaintext highlighter-rouge">STARTUP2</code></a> (initial sync) state.</p><p>By connecting to the secondary node directly and issuing a <a href="https://docs.mongodb.com/manual/reference/command/replSetGetStatus/"><code class="language-plaintext highlighter-rouge">replSetGetStatus</code></a> command we can now review the progress of the copy. Note that this will need to be done <em>while</em> the initial sync is in progress; once the node exits the <code class="language-plaintext highlighter-rouge">STARTUP2</code> state and enters a <code class="language-plaintext highlighter-rouge">SECONDARY</code> state, the <code class="language-plaintext highlighter-rouge">initialSyncStatus</code> details will be unavailable.</p><p>For example:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>db.adminCommand({ replSetGetStatus: 1, initialSync: 1 });
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="p">{</span>
	<span class="dl">"</span><span class="s2">set</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">rs0</span><span class="dl">"</span><span class="p">,</span>
	<span class="p">...</span>
	<span class="dl">"</span><span class="s2">initialSyncStatus</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
		<span class="dl">"</span><span class="s2">failedInitialSyncAttempts</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">maxFailedInitialSyncAttempts</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">initialSyncStart</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="dl">"</span><span class="s2">2020-11-20T15:47:09.136Z</span><span class="dl">"</span><span class="p">),</span>
		<span class="dl">"</span><span class="s2">totalInitialSyncElapsedMillis</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">14925</span><span class="p">,</span>               <span class="o">&lt;-----------</span>
		<span class="dl">"</span><span class="s2">initialSyncAttempts</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span> <span class="p">],</span>
		<span class="dl">"</span><span class="s2">approxTotalDataSize</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">311911892</span><span class="p">,</span>                     <span class="o">&lt;-----------</span>
		<span class="dl">"</span><span class="s2">approxTotalBytesCopied</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">16811036</span><span class="p">,</span>                   <span class="o">&lt;-----------</span>
		<span class="dl">"</span><span class="s2">remainingInitialSyncEstimatedMillis</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>             <span class="o">&lt;-----------</span>
		<span class="dl">"</span><span class="s2">appliedOps</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="dl">"</span><span class="s2">initialSyncOplogStart</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">Timestamp</span><span class="p">(</span><span class="mi">1605887228</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
		<span class="dl">"</span><span class="s2">totalTimeUnreachableMillis</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">NumberLong</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		<span class="dl">"</span><span class="s2">databases</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
			<span class="dl">"</span><span class="s2">databasesToClone</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>                              <span class="o">&lt;-----------</span>
			<span class="dl">"</span><span class="s2">databasesCloned</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">...</span>
			<span class="p">},</span>
			<span class="dl">"</span><span class="s2">test</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
				<span class="dl">"</span><span class="s2">collections</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
				<span class="dl">"</span><span class="s2">clonedCollections</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="dl">"</span><span class="s2">start</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="dl">"</span><span class="s2">2020-11-20T15:47:13.968Z</span><span class="dl">"</span><span class="p">),</span>
				<span class="dl">"</span><span class="s2">test.data</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
					<span class="dl">"</span><span class="s2">documentsToCopy</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">250000</span><span class="p">,</span>
					<span class="dl">"</span><span class="s2">documentsCopied</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">13481</span><span class="p">,</span>
					<span class="dl">"</span><span class="s2">indexes</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
					<span class="dl">"</span><span class="s2">fetchedBatches</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
					<span class="dl">"</span><span class="s2">bytesToCopy</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">311911663</span><span class="p">,</span>                       <span class="o">&lt;-----------</span>
					<span class="dl">"</span><span class="s2">approxBytesCopied</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">16810807</span><span class="p">,</span>                  <span class="o">&lt;-----------</span>
					<span class="dl">"</span><span class="s2">start</span><span class="dl">"</span> <span class="p">:</span> <span class="nx">ISODate</span><span class="p">(</span><span class="dl">"</span><span class="s2">2020-11-20T15:47:13.968Z</span><span class="dl">"</span><span class="p">),</span>
					<span class="dl">"</span><span class="s2">receivedBatches</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">2</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">},</span>
	<span class="p">...</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The command output has been truncated to focus in on the new fields added to the <code class="language-plaintext highlighter-rouge">initialSyncStatus</code> document. The new metrics details are as follows:</p><p><code class="language-plaintext highlighter-rouge">totalInitialSyncElapsedMillis</code></p><blockquote><p>Current Time - Start Time</p></blockquote><p><code class="language-plaintext highlighter-rouge">remainingInitialSyncEstimatedMillis</code></p><blockquote><p>(<code class="language-plaintext highlighter-rouge">totalInitialSyncElapsedMillis</code> / <code class="language-plaintext highlighter-rouge">approxTotalBytesCopied</code>) * (<code class="language-plaintext highlighter-rouge">approxTotalDataSize</code> - <code class="language-plaintext highlighter-rouge">approxTotalBytesCopied</code>)</p><p>If (<code class="language-plaintext highlighter-rouge">approxBytesCopied</code> == 0), this field will not be shown</p></blockquote><p>I’ve opened <a href="https://jira.mongodb.org/browse/SERVER-53017">SERVER-53017</a> to review this particular entry as the value did not appear to be properly updated throughout the initial sync process. As MongoDB 5.0 is not expected to be GA until mid 2021, this will likely be addressed before then.</p><p><strong>Update 2021-01-26</strong>: <a href="https://jira.mongodb.org/browse/SERVER-53017">SERVER-53017</a> has been fixed.</p><p><code class="language-plaintext highlighter-rouge">&lt;collection&gt;.bytesToCopy</code></p><blockquote><p>= <a href="https://docs.mongodb.com/manual/reference/command/collStats/#collStats.size"><code class="language-plaintext highlighter-rouge">collStats.size</code></a></p></blockquote><p><code class="language-plaintext highlighter-rouge">&lt;collection&gt;.approxBytesCopied</code></p><blockquote><p>= <a href="https://docs.mongodb.com/manual/reference/command/collStats/#collStats.avgObjSize"><code class="language-plaintext highlighter-rouge">collStats.avgObjSize</code></a> * <code class="language-plaintext highlighter-rouge">documentsCopied</code></p></blockquote><p><code class="language-plaintext highlighter-rouge">databasesToClone</code></p><blockquote><p>= length of <a href="https://docs.mongodb.com/manual/reference/command/listDatabases/index.html#output"><code class="language-plaintext highlighter-rouge">listDatabases</code></a> response</p></blockquote><p><code class="language-plaintext highlighter-rouge">approxTotalDataSize</code></p><blockquote><p>= Sum (<a href="https://docs.mongodb.com/manual/reference/command/dbStats/index.html#dbStats.dataSize"><code class="language-plaintext highlighter-rouge">dbStats.dataSize</code></a> for all databases)</p></blockquote><p><code class="language-plaintext highlighter-rouge">approxTotalBytesCopied</code></p><blockquote><p>= Sum (<code class="language-plaintext highlighter-rouge">&lt;collection&gt;.approxBytesCopied</code> for all collections)</p></blockquote><p>What can we do with all this useful information you ask? Well I’ve written the following script that can be used to poll a secondary replica set member in STARTUP2 to provide details regarding the progress of the initial sync. This script will also provide estimated throughput and a calculated ETA based on data transfer rates.</p><p>The output will appear similar to:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># start monitoring the initial sync (default refresh interval is 5 seconds)</span>
mongo <span class="nt">--host</span> <span class="nv">$SECONDARY_HOST</span> <span class="nt">--port</span> <span class="nv">$SECONDARY_PORT</span> <span class="nt">--quiet</span> <span class="nt">--eval</span> <span class="s2">"load('measureInitialSyncProgress.js'); measureInitialSyncProgress();"</span>
<span class="c"># to use a custom refresh interval, the value is in milliseconds, so for a 1 second refresh</span>
<span class="c"># pass 1000 to measureInitialSyncProgress as follows:</span>
<span class="c"># mongo --host $SECONDARY_HOST --port $SECONDARY_PORT --quiet --eval "load('measureInitialSyncProgress.js'); measureInitialSyncProgress(1000);"</span>
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre>Initial Sync running for 00:18:05.2 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:54.2 to go!
Initial Sync running for 00:18:10.8 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:18:17.9 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:18:22.9 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:18:27.9 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:18:33.1 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:18:38.4 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:49.1 to go!
Initial Sync running for 00:18:43.5 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:18:48.5 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:18:53.9 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:18:59.5 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:44.2 to go!
Initial Sync running for 00:19:05.3 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:39.2 to go!
Initial Sync running for 00:19:11.0 (remainingInitialSyncEstimatedMillis 0). Cloned 1.1 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:34.2 to go!
Initial Sync running for 00:19:16.6 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:29.2 to go!
Initial Sync running for 00:19:22.3 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:19:28.4 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:24.2 to go!
Initial Sync running for 00:19:34.5 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:19.2 to go!
Initial Sync running for 00:19:39.6 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:14.2 to go!
Initial Sync running for 00:19:45.3 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:19:54.6 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:09.2 to go!
Initial Sync running for 00:20:01.9 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:20:10.1 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (15.9 MB in past 5 second(s)) at a rate of 3.2 MB/second - 00:00:04.2 to go!
Initial Sync running for 00:20:15.7 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (No progress in past 5 second(s))
Initial Sync running for 00:20:20.7 (remainingInitialSyncEstimatedMillis 0). Cloned 1.2 GB of 1.2 GB (11.6 MB in past 5 second(s)) at a rate of 2.3 MB/second - 00:00:00.7 to go!
Node not currently performing an initial sync
</pre></table></code></div></div><p><del>Once <a href="https://jira.mongodb.org/browse/SERVER-53017">SERVER-53017</a> has been addressed I will update this script so that the <code class="language-plaintext highlighter-rouge">remainingInitialSyncEstimatedMillis</code> values can be used consistently.</del></p><p><strong>Update 2021-01-26</strong>: <a href="https://jira.mongodb.org/browse/SERVER-53017">SERVER-53017</a> was addressed and the script has been modified to use the <code class="language-plaintext highlighter-rouge">remainingInitialSyncEstimatedMillis</code> value directly!</p><script src="https://gist.github.com/alexbevi/fc4f59621aee4efbae2c04187dcbf2c6.js"> </script></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/replication/" class="post-tag no-text-decoration" >replication</a> <a href="/tags/scripting/" class="post-tag no-text-decoration" >scripting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MongoDB 5.0 Initial Sync Progress Monitoring Improvements - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MongoDB 5.0 Initial Sync Progress Monitoring Improvements - ALEX BEVILACQUA&u=https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=MongoDB 5.0 Initial Sync Progress Monitoring Improvements - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=MongoDB 5.0 Initial Sync Progress Monitoring Improvements - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2021/07/28/adventure-games-1980-1999/">Journey into Adventure Games (1980-1999)</a><li><a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Adventure Games (1980-1999): Sorted by Score</a><li><a href="/blog/2022/12/14/tablecheck-empowering-restaurants-with-best-in-class-booking-tools-powered-by-mongodb/">TableCheck: Empowering Restaurants with Best-in-Class Booking Tools Powered by MongoDB</a><li><a href="/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/">Recovering a WiredTiger collection from a corrupt MongoDB installation</a><li><a href="/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/">Live Migration of Sharded Clusters to MongoDB could result in <tt>TooManyLogicalSessions</tt> Errors</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/scripting/">scripting</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2020/02/13/mongodb-initial-sync-progress-monitoring/"><div class="card-body"> <span class="timeago small" > Feb 13, 2020 <i class="unloaded">2020-02-13T12:34:49-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MongoDB Initial Sync Progress Monitoring</h3><div class="text-muted small"><p> Sometimes our replica set members fall off the oplog and the node needs to be resynced. When this happens, an Initial Sync is required, which does the following: Clones all databases except the...</p></div></div></a></div><div class="card"> <a href="/blog/2021/03/23/visualizing-a-replica-sets-sync-source-chain/"><div class="card-body"> <span class="timeago small" > Mar 23, 2021 <i class="unloaded">2021-03-23T10:47:41-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Visualizing a Replica Set's Sync Source Chain</h3><div class="text-muted small"><p> A MongoDB replica set is a group of mongod processes that maintain the same data set. The PRIMARY node receives all write operations and The SECONDARY nodes replicate the PRIMARY’s oplog and apply ...</p></div></div></a></div><div class="card"> <a href="/blog/2022/11/29/efficiently-identifying-duplicates-using-mongodb/"><div class="card-body"> <span class="timeago small" > Nov 29, 2022 <i class="unloaded">2022-11-29T10:50:52-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Efficiently Identifying Duplicates using MongoDB</h3><div class="text-muted small"><p> Efficiently Identifying Duplicates using MongoDB One question that comes up time and again on Stack Overflow or the MongoDB Developer Forums is “how can I find duplicate X and get a list of Y that...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" class="btn btn-outline-primary" prompt="Older"><p>MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</p></a> <a href="/blog/2021/03/23/visualizing-a-replica-sets-sync-source-chain/" class="btn btn-outline-primary" prompt="Newer"><p>Visualizing a Replica Set's Sync Source Chain</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//alexbevi.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'MongoDB 5.0 Initial Sync Progress Monitoring Improvements'; this.page.url = 'https://www.alexbevi.com/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/'; this.page.identifier = '/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/scripting/">scripting</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.alexbevi.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script type="text/javascript" src="/assets/js/lightbox.js"></script><link rel="stylesheet" href="/assets/css/lightbox.css">
