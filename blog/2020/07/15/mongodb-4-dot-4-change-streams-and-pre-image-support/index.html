<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="MongoDB 4.4 Change Streams and Experimental Pre-Image ‘Support’" /><meta name="author" content="Alex Bevilacqua" /><meta property="og:locale" content="en_US" /><meta name="description" content="As of MongoDB 6.0, Change Streams Support Pre- and Post-Image Retrieval, DDL operations, and more!" /><meta property="og:description" content="As of MongoDB 6.0, Change Streams Support Pre- and Post-Image Retrieval, DDL operations, and more!" /><link rel="canonical" href="https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-15T08:37:08-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="MongoDB 4.4 Change Streams and Experimental Pre-Image ‘Support’" /><meta name="twitter:site" content="@alexbevi" /><meta name="twitter:creator" content="@Alex Bevilacqua" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alex Bevilacqua"},"dateModified":"2022-08-18T11:26:09-04:00","datePublished":"2020-07-15T08:37:08-04:00","description":"As of MongoDB 6.0, Change Streams Support Pre- and Post-Image Retrieval, DDL operations, and more!","headline":"MongoDB 4.4 Change Streams and Experimental Pre-Image ‘Support’","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/"},"url":"https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/"}</script><title>MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support' | ALEX BEVILACQUA</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/galleria.min.js"></script><link href="//cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/themes/classic/galleria.classic.min.css" media="screen, projection" rel="stylesheet" type="text/css" /><style> /* This rule is read by Galleria to define the gallery height: */ .galleria{ width: 700px; height: 400px; background: #000 } .responsive-wrap iframe{ max-width: 100%;}</style><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle font-italic">my little corner of the interwebs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/alexbevi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/alexbevi" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener"> <i class="fab fa-reddit"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> Blog </span> <span> 2020 </span> <span> 07 </span> <span> 15 </span> <span>MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Jul 15, 2020, 8:37 AM -0400" > Jul 15, 2020 <i class="unloaded">2020-07-15T08:37:08-04:00</i> </span> by <span class="author"> Alex Bevilacqua </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Aug 18, 2022, 11:26 AM -0400" > Aug 18 <i class="unloaded">2022-08-18T11:26:09-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1801 words">10 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/mongodb-logo.png" class="preview-img" alt="MongoDB Logo"><div class="note info"> <small>As of MongoDB 6.0, <a href="https://www.mongodb.com/blog/post/change-streams-mongodb-6-0-support-pre-post-image-retrieval-ddl-operations">Change Streams Support Pre- and Post-Image Retrieval, DDL operations, and more!</a> </small></div><p><strong>Warning - Not for Production Use</strong></p><p><em>MongoDB’s source code is available (through an <a href="https://www.mongodb.com/licensing/server-side-public-license">SSPL license</a>) and the <a href="https://jira.mongodb.org/projects/SERVER/issues">Core Server</a> project in MongoDB’s JIRA is publicly accessible, which is where I found this information.</em><br /> <em>Until officially announced as stable/official the methods described herein should not be considered as “production ready”. This post is for informational purposes and though at the time of writing it I am a MongoDB Inc. employee this should not be considered an official communication.</em></p><h3 id="introduction">Introduction</h3><p>A feature that has long been requested since <a href="https://docs.mongodb.com/manual/changeStreams/">Change Streams</a> were <a href="https://www.mongodb.com/blog/post/an-introduction-to-change-streams">introduced in MongoDB 3.6</a> is the ability to support returning the n-1 state (or pre-image) of a document when it is changed.</p><p>In <a href="https://jira.mongodb.org/browse/SERVER-36941"><code class="language-plaintext highlighter-rouge">SERVER-36941</code>: <em>Option to provide “before image” with change streams</em></a> this request is captured, but at the time of writing this ticket is still in an <em>Open</em> state which would imply no progress has been made.</p><p>Interestingly enough, there actually has been some progress due to efforts surrounding the support of <a href="https://www.mongodb.com/realm/mobile/sync">Realm Sync</a>, namely in the following tickets:</p><ul><li><a href="https://jira.mongodb.org/browse/SERVER-45806"><code class="language-plaintext highlighter-rouge">SERVER-45806</code>: <em>Record pre-images on updates and deletes when recordPreImage is enabled</em></a><li><a href="https://jira.mongodb.org/browse/SERVER-45807"><code class="language-plaintext highlighter-rouge">SERVER-45807</code>: <em>Add change stream stage to fetch pre-image for update/replace/delete events</em></a></ul><h3 id="pre-image-support">Pre-Image Support</h3><p>“Support” for this feature is only available in MongoDB 4.4+, so first we must ensure we are running a compatible version.</p><p>Next, as change streams are only supported in <a href="https://docs.mongodb.com/manual/replication/">replica sets</a> or <a href="https://docs.mongodb.com/manual/sharding/">sharded clusters</a> our cluster cannot be a standalone instance.</p><p>Before a pre-image can be returned in a change stream support for the feature must be enabled at <em>the collection level</em>.</p><h4 id="create-a-new-collection-with-pre-image-support">Create a New Collection with Pre-Image Support</h4><p>To enable pre-image support on a new (non-existent) collection, the <code class="language-plaintext highlighter-rouge">recordPreImages</code> flag needs to be set when calling the <a href="https://docs.mongodb.com/manual/reference/command/create/#dbcmd.create"><code class="language-plaintext highlighter-rouge">create</code></a> command or <a href="https://docs.mongodb.com/manual/reference/method/db.createCollection/"><code class="language-plaintext highlighter-rouge">db.createCollection()</code></a> shell method:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
<span class="c1">// create command</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">({</span> <span class="na">create</span><span class="p">:</span> <span class="dl">"</span><span class="s2">coll1</span><span class="dl">"</span><span class="p">,</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="c1">// or</span>
<span class="c1">// using the createCollection() helper</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll1</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
</pre></table></code></div></div><h4 id="updating-an-existing-collection-with-pre-image-support">Updating an Existing Collection with Pre-Image Support</h4><p>If the collection already exists, the <code class="language-plaintext highlighter-rouge">recordPreImages</code> flag can be set using the <a href="https://docs.mongodb.com/manual/reference/command/collMod/"><code class="language-plaintext highlighter-rouge">collMod</code></a> command:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">});</span>
<span class="c1">// update the collection's metadata using the collMod command</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">runCommand</span><span class="p">({</span> <span class="na">collMod</span><span class="p">:</span> <span class="dl">"</span><span class="s2">coll1</span><span class="dl">"</span><span class="p">,</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
</pre></table></code></div></div><h3 id="pre-image-support-in-change-streams">Pre-Image Support in Change Streams</h3><p>First it’s important to understand that a change stream is actually an <a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">Aggregation Pipeline Stage</a>, even if it doesn’t appear as such in the documentation.</p><p>This can be easily verified by checking the source code for the <a href="https://github.com/mongodb/mongo/blob/v4.4/src/mongo/shell/mongo.js#L686"><code class="language-plaintext highlighter-rouge">Mongo.prototype.watch</code></a> implementation which coincides with <a href="https://docs.mongodb.com/manual/reference/method/db.collection.watch/"><code class="language-plaintext highlighter-rouge">db.collection.watch()</code></a> shell method.</p><p>We’ll be using the <code class="language-plaintext highlighter-rouge">$changeStream</code> pipeline stage directly to review the impact of pre-image support.</p><p>First we’ll being by opening a change stream cursor against our modified collection:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll1</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">whenAvailable</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
</pre></table></code></div></div><p>Note the options include a <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> field, which can accept one of three (3) <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> mode values:</p><ul><li><code class="language-plaintext highlighter-rouge">off</code>: Disables support for the <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> field<li><code class="language-plaintext highlighter-rouge">whenAvailable</code>: Only includes a <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> document if it’s available, but won’t fail if it’s not present<li><code class="language-plaintext highlighter-rouge">required</code>: Require the <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> document, and errors out if it’s not available</ul><p>Since we have a change stream cursor open, we can update our test document and iterate the cursor to see the change this option produces:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
<span class="cm">/*
{
	"operationType" : "update",
	"fullDocumentBeforeChange" : {
		"_id" : 1,
		"created_at" : ISODate("2020-07-15T17:41:32.043Z")
	},
	"ns" : {
		"db" : "test",
		"coll" : "coll1"
	},
	"documentKey" : {
		"_id" : 1
	},
	"updateDescription" : {
		"updatedFields" : {
			"updated_at" : ISODate("2020-07-15T17:41:32.056Z")
		},
		"removedFields" : [ ]
	}
}
*/</span>
</pre></table></code></div></div><p>The output contains a <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> field which includes the full document <em>prior</em> to the changes the update operation would apply. As this was the first update to this document and the field was being added for the first time the value here may not be apparent, but running the operation again produces result that contains our previous <code class="language-plaintext highlighter-rouge">created_at</code> value along with our updated <code class="language-plaintext highlighter-rouge">created_at</code> value in the <code class="language-plaintext highlighter-rouge">updateDescription</code>:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
<span class="cm">/*
{
	"operationType" : "update",
	"fullDocumentBeforeChange" : {
		"_id" : 1,
		"created_at" : ISODate("2020-07-15T17:41:32.043Z"),
		"updated_at" : ISODate("2020-07-15T17:41:32.056Z")
	},
	"ns" : {
		"db" : "test",
		"coll" : "coll1"
	},
	"documentKey" : {
		"_id" : 1
	},
	"updateDescription" : {
		"updatedFields" : {
			"updated_at" : ISODate("2020-07-15T17:44:29.494Z")
		},
		"removedFields" : [ ]
	}
}
*/</span>
</pre></table></code></div></div><p>If the <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> mode was set to <code class="language-plaintext highlighter-rouge">required</code> and the collection wasn’t created with the <code class="language-plaintext highlighter-rouge">recordPreImages</code> flag set, the change stream cursor will error out when iterated.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll2</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll2</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll2</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll2</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">required</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll2</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
<span class="cm">/*
2020-07-16T07:03:37.657-0400 E  QUERY    [js] Error: command failed: {
	"ok" : 0,
	"errmsg" : "Change stream was configured to require a pre-image for all update, delete and replace events, but no pre-image optime was recorded for event: {_id: {_data: \"825F103409000000042B022C0100296E5A10044912D5BB665545B48DDAD38FCD774270461E5F6964002B040004\", _typeBits: BinData(0, \"40\")}, operationType: \"update\", clusterTime: Timestamp(1594897417, 4), ns: {db: \"test\", coll: \"coll2\"}, documentKey: {_id: 2}, updateDescription: {updatedFields: {updated_at: 2020-07-16T11:03:37.611Z}, removedFields: []}}",
	"code" : 51770,
}
*/</span>
</pre></table></code></div></div><h3 id="pre-image-and--fulldocument-updatelookup-">Pre-Image and <code class="language-plaintext highlighter-rouge">{ fullDocument: "updateLookup" }</code></h3><p>The change stream cursors we’ve been opening have not been specifying a <code class="language-plaintext highlighter-rouge">fullDocument</code> options, which results in the default value of <code class="language-plaintext highlighter-rouge">{ fullDocument: "default" }</code> being used (or prior to <a href="https://jira.mongodb.org/browse/SPEC-909">SPEC-909</a> a value of <code class="language-plaintext highlighter-rouge">none</code>).</p><p>When we set <code class="language-plaintext highlighter-rouge">{ fullDocument: "updateLookup" }</code>, the cursor will look up the most current majority-committed version of the updated document and include a <code class="language-plaintext highlighter-rouge">fullDocument</code> field with the document lookup in addition to the <code class="language-plaintext highlighter-rouge">updateDescription</code> delta.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll3</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll3</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll3</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Alex</span><span class="dl">"</span><span class="p">,</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TSE</span><span class="dl">"</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll3</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocument</span><span class="p">:</span> <span class="dl">"</span><span class="s2">updateLookup</span><span class="dl">"</span><span class="p">,</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">whenAvailable</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll3</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">});</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
<span class="cm">/*
{
    "_id" : {
        "_data" : "825F103644000000042B022C0100296E5A100452A662230D6B4C08B0AF844900F3A335461E5F6964002B060004",
        "_typeBits" : BinData(0, "QA==")
    },
    "operationType" : "update",
    "clusterTime" : Timestamp(1594897988, 4),
    "fullDocument" : {
        "_id" : 3.0,
        "name" : "Alex",
        "role" : "TSE",
        "created_at" : ISODate("2020-07-16T11:13:08.180+0000"),
        "updated_at" : ISODate("2020-07-16T11:13:08.268+0000")
    },
    "fullDocumentBeforeChange" : {
        "_id" : 3.0,
        "name" : "Alex",
        "role" : "TSE",
        "created_at" : ISODate("2020-07-16T11:13:08.180+0000")
    },
    "ns" : {
        "db" : "test",
        "coll" : "coll3"
    },
    "documentKey" : {
        "_id" : 3.0
    },
    "updateDescription" : {
        "updatedFields" : {
            "updated_at" : ISODate("2020-07-16T11:13:08.268+0000")
        },
        "removedFields" : [

        ]
    }
}
*/</span>
</pre></table></code></div></div><p>By including both <code class="language-plaintext highlighter-rouge">fullDocument</code> and <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> options, the cursor now returns three fields that represent the state of the document before the change, after the change as well as a description of the changes in the form of the <code class="language-plaintext highlighter-rouge">updateDescription</code> field.</p><h3 id="how-are-pre-images-stored">How are Pre-Images Stored</h3><p>Since change streams are messages in the <a href="https://docs.mongodb.com/manual/core/replica-set-oplog/">oplog</a>, which are themselves <a href="https://docs.mongodb.com/manual/reference/glossary/#term-document">BSON documents</a> they must adhere to the <a href="https://docs.mongodb.com/manual/reference/limits/#bson-documents">BSON Document Size</a> limit of 16 megabytes.</p><p>Pre-image details aren’t stored directly within the oplog entry that describes the update or delete (<a href="https://github.com/mongodb/mongo/blob/v4.4/src/mongo/db/repl/oplog_entry.idl#L41"><code class="language-plaintext highlighter-rouge">op</code> type of <code class="language-plaintext highlighter-rouge">u</code> or <code class="language-plaintext highlighter-rouge">d</code></a>).</p><p>When <code class="language-plaintext highlighter-rouge">recordPreImages</code> has been enabled for a collection, prior to an oplog entry for an update or delete, a noop (<code class="language-plaintext highlighter-rouge">op: "n"</code>) is inserted into the oplog with current document state. The subsequent operation (the actual update or delete) will contain a <code class="language-plaintext highlighter-rouge">preImageOpTime</code> which contains the optime of the oplog entry containing this noop.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">getSiblingDB</span><span class="p">(</span><span class="dl">"</span><span class="s2">local</span><span class="dl">"</span><span class="p">).</span><span class="nx">getCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">oplog.rs</span><span class="dl">"</span><span class="p">).</span><span class="nx">find</span><span class="p">({</span> <span class="na">ns</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test.coll3</span><span class="dl">"</span> <span class="p">});</span>
<span class="cm">/*
{
  "op": "n",
  "ns": "test.coll3",
  "ui": UUID("d2c8288d-2748-4abf-b5f0-37de24e3128e"),
  "o": {
    "_id": 3,
    "name": "Alex",
    "role": "TSE",
    "created_at": ISODate("2020-07-17T13:09:52.612Z")
  },
  "ts": Timestamp(1594991392, 4),
  "t": NumberLong(4),
  "wall": ISODate("2020-07-17T13:09:52.649Z"),
  "v": NumberLong(2)
}
{
  "op": "u",
  "ns": "test.coll3",
  "ui": UUID("d2c8288d-2748-4abf-b5f0-37de24e3128e"),
  "o": {
    "$v": 1,
    "$set": {
      "updated_at": ISODate("2020-07-17T13:09:52.648Z")
    }
  },
  "o2": {
    "_id": 3
  },
  "preImageOpTime": {
    "ts": Timestamp(1594991392, 4),
    "t": NumberLong(4)
  },
  "ts": Timestamp(1594991392, 5),
  "t": NumberLong(4),
  "wall": ISODate("2020-07-17T13:09:52.649Z"),
  "v": NumberLong(2)
}
*/</span>
</pre></table></code></div></div><h3 id="what-could-go-wrong">What Could Go Wrong?</h3><p>Though enabling pre-images won’t bloat the oplog entry to the point where it may exceed the BSON max size, when the change stream cursor resolves resulting document the size cannot exceed the BSON max size.</p><p>For example:</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">randomString</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">result</span>           <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">characters</span>       <span class="o">=</span> <span class="dl">'</span><span class="s1">ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789</span><span class="dl">'</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">charactersLength</span> <span class="o">=</span> <span class="nx">characters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
   <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">characters</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">charactersLength</span><span class="p">));</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// BSON max size less 512 bytes</span>
<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">serverBuildInfo</span><span class="p">().</span><span class="nx">maxBsonObjectSize</span> <span class="o">-</span> <span class="mi">512</span><span class="p">;</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll4</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="na">junk</span><span class="p">:</span> <span class="nx">randomString</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocument</span><span class="p">:</span> <span class="dl">"</span><span class="s2">updateLookup</span><span class="dl">"</span><span class="p">,</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">off</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">4</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">});</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
</pre></table></code></div></div><p>The above example has the <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> disabled, which is the current default behavior of change streams. Though the result would be large (almost 16MB), iterating the change stream cursor would produce a result.</p><p>Modifying the cursor to now request a <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> (either <code class="language-plaintext highlighter-rouge">required</code> or <code class="language-plaintext highlighter-rouge">whenAvailable</code>) would now raise an error when the cursor is iterated.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c1">// ...</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nx">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll4</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nx">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">(),</span> <span class="na">junk</span><span class="p">:</span> <span class="nx">randomString</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nx">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocument</span><span class="p">:</span> <span class="dl">"</span><span class="s2">updateLookup</span><span class="dl">"</span><span class="p">,</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">required</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">4</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">});</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nx">next</span><span class="p">();</span>
<span class="cm">/*
2020-07-16T07:40:38.307-0400 E  QUERY    [js] Error: command failed: {
	"errmsg" : "BSONObj size: 33553900 (0x1FFFDEC) is invalid. Size must be between 0 and 16793600(16MB) First element: _id: { _data: \"825F103CB5000000032B022C0100296E5A100484010E04E239427B8CBCA810283D05A5461E5F6964002B080004\", _typeBits: BinData(0, 40) }",
	"code" : 10334,
	"codeName" : "BSONObjectTooLarge",
}
*/</span>
</pre></table></code></div></div><p>I personally look forward to pre-images being officially supported in MongoDB, however in the meantime be advised that this may not be ideal for production just yet.</p><p>Happy Coding!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/changestreams/" class="post-tag no-text-decoration" >changestreams</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support' - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support' - ALEX BEVILACQUA&u=https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support' - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support' - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2022/09/15/createindex-error-values-in-v-2-index-key-pattern-cannot-be-of-type-object/">Solving a mongorestore failure due to 'Values in v:2 index key pattern cannot be of type object.'</a><li><a href="/blog/2022/09/09/performance-profiling-a-mongoid-issue-using-appprofiler/">Performance Profiling a Mongoid Issue Using AppProfiler</a><li><a href="/blog/2022/08/18/why-use-mongodb-with-ruby/">Why Use MongoDB with Ruby</a><li><a href="/blog/2022/05/15/mongodb-driver-monitoring/">MongoDB Driver Monitoring</a><li><a href="/blog/2022/06/26/just-finished-terranigma/">Just Finished - Terranigma</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/replication/">replication</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2018/08/14/hello-mongodb/"><div class="card-body"> <span class="timeago small" > Aug 14, 2018 <i class="unloaded">2018-08-14T15:31:04-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hello MongoDB</h3><div class="text-muted small"><p> As of August 13th, I am no longer a System Architect at DAC Group. I have a public post on LinkedIn that got some good traction, but to summarize it was time to move on. I’ve been a software engin...</p></div></div></a></div><div class="card"> <a href="/blog/2018/10/01/technical-services-engineering-at-mongodb/"><div class="card-body"> <span class="timeago small" > Oct 1, 2018 <i class="unloaded">2018-10-01T15:39:28-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Technical Services Engineering at MongoDB</h3><div class="text-muted small"><p> The goal of this post is to provide a first hand account of what it means to be a Technical Services Engineer at MongoDB, as well as what the journey getting to this point has looked like for me. ...</p></div></div></a></div><div class="card"> <a href="/blog/2022/07/04/hello-product-management/"><div class="card-body"> <span class="timeago small" > Jul 4 <i class="unloaded">2022-07-04T11:44:20-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hello Product Management</h3><div class="text-muted small"><p> Past My MongoDB Career Journey began almost 4 years ago, and I’ve enjoyed my time as a Technical Services Engineer immensely. During my tenure as part of the organization I had the opportunity to ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" class="btn btn-outline-primary" prompt="Older"><p>Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule</p></a> <a href="/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/" class="btn btn-outline-primary" prompt="Newer"><p>MongoDB 5.0 Initial Sync Progress Monitoring Improvements</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//alexbevi.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support''; this.page.url = 'https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/'; this.page.identifier = '/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/replication/">replication</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.alexbevi.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script type="text/javascript" src="/assets/js/lightbox.js"></script><link rel="stylesheet" href="/assets/css/lightbox.css">
