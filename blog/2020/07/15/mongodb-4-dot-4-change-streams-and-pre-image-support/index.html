<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="MongoDB 4.4 Change Streams and Experimental Pre-Image ‘Support’" /><meta property="og:locale" content="en" /><meta name="description" content="As of MongoDB 6.0, Change Streams Support Pre- and Post-Image Retrieval, DDL operations, and more!" /><meta property="og:description" content="As of MongoDB 6.0, Change Streams Support Pre- and Post-Image Retrieval, DDL operations, and more!" /><link rel="canonical" href="https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content=" https://www.alexbevi.com/images/mongodb-logo.png " /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-07-15T08:37:08-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content=" https://www.alexbevi.com/images/mongodb-logo.png " /><meta property="twitter:title" content="MongoDB 4.4 Change Streams and Experimental Pre-Image ‘Support’" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-10-09T09:09:22-04:00","datePublished":"2020-07-15T08:37:08-04:00","description":"As of MongoDB 6.0, Change Streams Support Pre- and Post-Image Retrieval, DDL operations, and more!","headline":"MongoDB 4.4 Change Streams and Experimental Pre-Image ‘Support’","image":" https://www.alexbevi.com/images/mongodb-logo.png ","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/"},"url":"https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/"}</script><title>MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support' | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.min.css"><link rel="stylesheet" href="/assets/lib/glightbox/glightbox.min.css"> <script src="/assets/js/dist/theme.min.js"></script> <script defer src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script defer src="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.umd.min.js"></script> <script defer src="/assets/lib/glightbox/glightbox.min.js"></script> <script defer src="/assets/lib/clipboard/clipboard.min.js"></script> <script defer src="/assets/lib/dayjs/dayjs.min.js"></script> <script defer src="/assets/lib/dayjs/locale/en.js"></script> <script defer src="/assets/lib/dayjs/plugin/relativeTime.js"></script> <script defer src="/assets/lib/dayjs/plugin/localizedFormat.js"></script> <script defer src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.min.js?baseurl=&register=" ></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener('DOMContentLoaded', () => { window.dataLayer = window.dataLayer || []; function gtag() { dataLayer.push(arguments); } gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script><meta name="google-adsense-account" content="ca-pub-6215800856413580"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src=" /./images/avatar.png " width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">ALEX BEVILACQUA</a><p class="site-subtitle fst-italic mb-0">my little corner of the interwebs</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/specifications/" class="nav-link"> <i class="fa-fw fas fa-leaf"></i> <span>MONGODB DRIVER SPECIFICATIONS</span> </a><li class="nav-item"> <a href="/driver-compatibility-checker/" class="nav-link"> <i class="fa-fw fas fa-car"></i> <span>MONGODB DRIVER COMPATIBILITY CHECKER</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1" data-toc="true"><header><h1 data-toc-skip>MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1594816628" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Jul 15, 2020 </time> </span> <span> Updated <time data-ts="1760015362" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Oct 9, 2025 </time> </span><div class="mt-3 mb-3"> <a href=" /images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src=" /images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1804 words" > <em>10 min</em> read </span></div></div></div></header><div id="toc-bar" class="d-flex align-items-center justify-content-between invisible"> <span class="label text-truncate">MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</span> <button type="button" class="toc-trigger btn me-1"> <i class="fa-solid fa-list-ul fa-fw"></i> </button></div><button id="toc-solo-trigger" type="button" class="toc-trigger btn btn-outline-secondary btn-sm"> <span class="label ps-2 pe-1">Contents</span> <i class="fa-solid fa-angle-right fa-fw"></i> </button> <dialog id="toc-popup" class="p-0"><div class="header d-flex flex-row align-items-center justify-content-between"><div class="label text-truncate py-2 ms-4">MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</div><button id="toc-popup-close" type="button" class="btn mx-1 my-1 opacity-75"> <i class="fas fa-close"></i> </button></div><div id="toc-popup-content" class="px-4 py-3 pb-4"></div></dialog><div class="content"><blockquote class="prompt-info"><p>As of MongoDB 6.0, <a href="https://www.mongodb.com/blog/post/change-streams-mongodb-6-0-support-pre-post-image-retrieval-ddl-operations">Change Streams Support Pre- and Post-Image Retrieval, DDL operations, and more!</a></p></blockquote><blockquote class="prompt-danger"><p><strong>Warning - Not for Production Use (in MongoDB 4.4)</strong></p><p>MongoDB’s source code is available (through an <a href="https://www.mongodb.com/licensing/server-side-public-license">SSPL license</a>) and the <a href="https://jira.mongodb.org/projects/SERVER/issues">Core Server</a> project in MongoDB’s JIRA is publicly accessible, which is where I found this information.</p><p>Until officially announced as stable/official the methods described herein should not be considered as “production ready”.</p><p>This post is for informational purposes and though at the time of writing it I am a MongoDB Inc. employee this should not be considered an official communication.</p></blockquote><h3 id="introduction"><span class="me-2">Introduction</span><a href="#introduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>A feature that has long been requested since <a href="https://docs.mongodb.com/manual/changeStreams/">Change Streams</a> were <a href="https://www.mongodb.com/blog/post/an-introduction-to-change-streams">introduced in MongoDB 3.6</a> is the ability to support returning the n-1 state (or pre-image) of a document when it is changed.</p><p>In <a href="https://jira.mongodb.org/browse/SERVER-36941"><code class="language-plaintext highlighter-rouge">SERVER-36941</code>: <em>Option to provide “before image” with change streams</em></a> this request is captured, but at the time of writing this ticket is still in an <em>Open</em> state which would imply no progress has been made.</p><p>Interestingly enough, there actually has been some progress due to efforts surrounding the support of <a href="https://www.mongodb.com/realm/mobile/sync">Realm Sync</a>, namely in the following tickets:</p><ul><li><a href="https://jira.mongodb.org/browse/SERVER-45806"><code class="language-plaintext highlighter-rouge">SERVER-45806</code>: <em>Record pre-images on updates and deletes when recordPreImage is enabled</em></a><li><a href="https://jira.mongodb.org/browse/SERVER-45807"><code class="language-plaintext highlighter-rouge">SERVER-45807</code>: <em>Add change stream stage to fetch pre-image for update/replace/delete events</em></a></ul><h3 id="pre-image-support"><span class="me-2">Pre-Image Support</span><a href="#pre-image-support" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>“Support” for this feature is only available in MongoDB 4.4+, so first we must ensure we are running a compatible version.</p><p>Next, as change streams are only supported in <a href="https://docs.mongodb.com/manual/replication/">replica sets</a> or <a href="https://docs.mongodb.com/manual/sharding/">sharded clusters</a> our cluster cannot be a standalone instance.</p><p>Before a pre-image can be returned in a change stream support for the feature must be enabled at <em>the collection level</em>.</p><h4 id="create-a-new-collection-with-pre-image-support"><span class="me-2">Create a New Collection with Pre-Image Support</span><a href="#create-a-new-collection-with-pre-image-support" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>To enable pre-image support on a new (non-existent) collection, the <code class="language-plaintext highlighter-rouge">recordPreImages</code> flag needs to be set when calling the <a href="https://docs.mongodb.com/manual/reference/command/create/#dbcmd.create"><code class="language-plaintext highlighter-rouge">create</code></a> command or <a href="https://docs.mongodb.com/manual/reference/method/db.createCollection/"><code class="language-plaintext highlighter-rouge">db.createCollection()</code></a> shell method:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
<span class="c1">// create command</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">runCommand</span><span class="p">({</span> <span class="na">create</span><span class="p">:</span> <span class="dl">"</span><span class="s2">coll1</span><span class="dl">"</span><span class="p">,</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="c1">// or</span>
<span class="c1">// using the createCollection() helper</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll1</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
</pre></table></code></div></div><h4 id="updating-an-existing-collection-with-pre-image-support"><span class="me-2">Updating an Existing Collection with Pre-Image Support</span><a href="#updating-an-existing-collection-with-pre-image-support" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h4><p>If the collection already exists, the <code class="language-plaintext highlighter-rouge">recordPreImages</code> flag can be set using the <a href="https://docs.mongodb.com/manual/reference/command/collMod/"><code class="language-plaintext highlighter-rouge">collMod</code></a> command:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nf">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">});</span>
<span class="c1">// update the collection's metadata using the collMod command</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">runCommand</span><span class="p">({</span> <span class="na">collMod</span><span class="p">:</span> <span class="dl">"</span><span class="s2">coll1</span><span class="dl">"</span><span class="p">,</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
</pre></table></code></div></div><h3 id="pre-image-support-in-change-streams"><span class="me-2">Pre-Image Support in Change Streams</span><a href="#pre-image-support-in-change-streams" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>First it’s important to understand that a change stream is actually an <a href="https://docs.mongodb.com/manual/reference/operator/aggregation-pipeline/">Aggregation Pipeline Stage</a>, even if it doesn’t appear as such in the documentation.</p><p>This can be easily verified by checking the source code for the <a href="https://github.com/mongodb/mongo/blob/v4.4/src/mongo/shell/mongo.js#L686"><code class="language-plaintext highlighter-rouge">Mongo.prototype.watch</code></a> implementation which coincides with <a href="https://docs.mongodb.com/manual/reference/method/db.collection.watch/"><code class="language-plaintext highlighter-rouge">db.collection.watch()</code></a> shell method.</p><p>We’ll be using the <code class="language-plaintext highlighter-rouge">$changeStream</code> pipeline stage directly to review the impact of pre-image support.</p><p>First we’ll being by opening a change stream cursor against our modified collection:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll1</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nf">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nf">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">whenAvailable</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
</pre></table></code></div></div><p>Note the options include a <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> field, which can accept one of three (3) <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> mode values:</p><ul><li><code class="language-plaintext highlighter-rouge">off</code>: Disables support for the <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> field<li><code class="language-plaintext highlighter-rouge">whenAvailable</code>: Only includes a <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> document if it’s available, but won’t fail if it’s not present<li><code class="language-plaintext highlighter-rouge">required</code>: Require the <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> document, and errors out if it’s not available</ul><p>Since we have a change stream cursor open, we can update our test document and iterate the cursor to see the change this option produces:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
<span class="cm">/*
{
	"operationType" : "update",
	"fullDocumentBeforeChange" : {
		"_id" : 1,
		"created_at" : ISODate("2020-07-15T17:41:32.043Z")
	},
	"ns" : {
		"db" : "test",
		"coll" : "coll1"
	},
	"documentKey" : {
		"_id" : 1
	},
	"updateDescription" : {
		"updatedFields" : {
			"updated_at" : ISODate("2020-07-15T17:41:32.056Z")
		},
		"removedFields" : [ ]
	}
}
*/</span>
</pre></table></code></div></div><p>The output contains a <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> field which includes the full document <em>prior</em> to the changes the update operation would apply. As this was the first update to this document and the field was being added for the first time the value here may not be apparent, but running the operation again produces result that contains our previous <code class="language-plaintext highlighter-rouge">created_at</code> value along with our updated <code class="language-plaintext highlighter-rouge">created_at</code> value in the <code class="language-plaintext highlighter-rouge">updateDescription</code>:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll1</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">1</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
<span class="cm">/*
{
	"operationType" : "update",
	"fullDocumentBeforeChange" : {
		"_id" : 1,
		"created_at" : ISODate("2020-07-15T17:41:32.043Z"),
		"updated_at" : ISODate("2020-07-15T17:41:32.056Z")
	},
	"ns" : {
		"db" : "test",
		"coll" : "coll1"
	},
	"documentKey" : {
		"_id" : 1
	},
	"updateDescription" : {
		"updatedFields" : {
			"updated_at" : ISODate("2020-07-15T17:44:29.494Z")
		},
		"removedFields" : [ ]
	}
}
*/</span>
</pre></table></code></div></div><p>If the <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> mode was set to <code class="language-plaintext highlighter-rouge">required</code> and the collection wasn’t created with the <code class="language-plaintext highlighter-rouge">recordPreImages</code> flag set, the change stream cursor will error out when iterated.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll2</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll2</span><span class="dl">"</span><span class="p">);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll2</span><span class="p">.</span><span class="nf">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll2</span><span class="p">.</span><span class="nf">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">required</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll2</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">2</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">})</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
<span class="cm">/*
2020-07-16T07:03:37.657-0400 E  QUERY    [js] Error: command failed: {
	"ok" : 0,
	"errmsg" : "Change stream was configured to require a pre-image for all update, delete and replace events, but no pre-image optime was recorded for event: {_id: {_data: \"825F103409000000042B022C0100296E5A10044912D5BB665545B48DDAD38FCD774270461E5F6964002B040004\", _typeBits: BinData(0, \"40\")}, operationType: \"update\", clusterTime: Timestamp(1594897417, 4), ns: {db: \"test\", coll: \"coll2\"}, documentKey: {_id: 2}, updateDescription: {updatedFields: {updated_at: 2020-07-16T11:03:37.611Z}, removedFields: []}}",
	"code" : 51770,
}
*/</span>
</pre></table></code></div></div><h3 id="pre-image-and--fulldocument-updatelookup-"><span class="me-2">Pre-Image and <code class="language-plaintext highlighter-rouge">{ fullDocument: "updateLookup" }</code></span><a href="#pre-image-and--fulldocument-updatelookup-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The change stream cursors we’ve been opening have not been specifying a <code class="language-plaintext highlighter-rouge">fullDocument</code> options, which results in the default value of <code class="language-plaintext highlighter-rouge">{ fullDocument: "default" }</code> being used (or prior to <a href="https://jira.mongodb.org/browse/SPEC-909">SPEC-909</a> a value of <code class="language-plaintext highlighter-rouge">none</code>).</p><p>When we set <code class="language-plaintext highlighter-rouge">{ fullDocument: "updateLookup" }</code>, the cursor will look up the most current majority-committed version of the updated document and include a <code class="language-plaintext highlighter-rouge">fullDocument</code> field with the document lookup in addition to the <code class="language-plaintext highlighter-rouge">updateDescription</code> delta.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nx">coll3</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll3</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll3</span><span class="p">.</span><span class="nf">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Alex</span><span class="dl">"</span><span class="p">,</span> <span class="na">role</span><span class="p">:</span> <span class="dl">"</span><span class="s2">TSE</span><span class="dl">"</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll3</span><span class="p">.</span><span class="nf">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocument</span><span class="p">:</span> <span class="dl">"</span><span class="s2">updateLookup</span><span class="dl">"</span><span class="p">,</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">whenAvailable</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll3</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">3</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">});</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
<span class="cm">/*
{
    "_id" : {
        "_data" : "825F103644000000042B022C0100296E5A100452A662230D6B4C08B0AF844900F3A335461E5F6964002B060004",
        "_typeBits" : BinData(0, "QA==")
    },
    "operationType" : "update",
    "clusterTime" : Timestamp(1594897988, 4),
    "fullDocument" : {
        "_id" : 3.0,
        "name" : "Alex",
        "role" : "TSE",
        "created_at" : ISODate("2020-07-16T11:13:08.180+0000"),
        "updated_at" : ISODate("2020-07-16T11:13:08.268+0000")
    },
    "fullDocumentBeforeChange" : {
        "_id" : 3.0,
        "name" : "Alex",
        "role" : "TSE",
        "created_at" : ISODate("2020-07-16T11:13:08.180+0000")
    },
    "ns" : {
        "db" : "test",
        "coll" : "coll3"
    },
    "documentKey" : {
        "_id" : 3.0
    },
    "updateDescription" : {
        "updatedFields" : {
            "updated_at" : ISODate("2020-07-16T11:13:08.268+0000")
        },
        "removedFields" : [

        ]
    }
}
*/</span>
</pre></table></code></div></div><p>By including both <code class="language-plaintext highlighter-rouge">fullDocument</code> and <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> options, the cursor now returns three fields that represent the state of the document before the change, after the change as well as a description of the changes in the form of the <code class="language-plaintext highlighter-rouge">updateDescription</code> field.</p><h3 id="how-are-pre-images-stored"><span class="me-2">How are Pre-Images Stored</span><a href="#how-are-pre-images-stored" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Since change streams are messages in the <a href="https://docs.mongodb.com/manual/core/replica-set-oplog/">oplog</a>, which are themselves <a href="https://docs.mongodb.com/manual/reference/glossary/#term-document">BSON documents</a> they must adhere to the <a href="https://docs.mongodb.com/manual/reference/limits/#bson-documents">BSON Document Size</a> limit of 16 megabytes.</p><p>Pre-image details aren’t stored directly within the oplog entry that describes the update or delete (<a href="https://github.com/mongodb/mongo/blob/v4.4/src/mongo/db/repl/oplog_entry.idl#L41"><code class="language-plaintext highlighter-rouge">op</code> type of <code class="language-plaintext highlighter-rouge">u</code> or <code class="language-plaintext highlighter-rouge">d</code></a>).</p><p>When <code class="language-plaintext highlighter-rouge">recordPreImages</code> has been enabled for a collection, prior to an oplog entry for an update or delete, a noop (<code class="language-plaintext highlighter-rouge">op: "n"</code>) is inserted into the oplog with current document state. The subsequent operation (the actual update or delete) will contain a <code class="language-plaintext highlighter-rouge">preImageOpTime</code> which contains the optime of the oplog entry containing this noop.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nf">getSiblingDB</span><span class="p">(</span><span class="dl">"</span><span class="s2">local</span><span class="dl">"</span><span class="p">).</span><span class="nf">getCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">oplog.rs</span><span class="dl">"</span><span class="p">).</span><span class="nf">find</span><span class="p">({</span> <span class="na">ns</span><span class="p">:</span> <span class="dl">"</span><span class="s2">test.coll3</span><span class="dl">"</span> <span class="p">});</span>
<span class="cm">/*
{
  "op": "n",
  "ns": "test.coll3",
  "ui": UUID("d2c8288d-2748-4abf-b5f0-37de24e3128e"),
  "o": {
    "_id": 3,
    "name": "Alex",
    "role": "TSE",
    "created_at": ISODate("2020-07-17T13:09:52.612Z")
  },
  "ts": Timestamp(1594991392, 4),
  "t": NumberLong(4),
  "wall": ISODate("2020-07-17T13:09:52.649Z"),
  "v": NumberLong(2)
}
{
  "op": "u",
  "ns": "test.coll3",
  "ui": UUID("d2c8288d-2748-4abf-b5f0-37de24e3128e"),
  "o": {
    "$v": 1,
    "$set": {
      "updated_at": ISODate("2020-07-17T13:09:52.648Z")
    }
  },
  "o2": {
    "_id": 3
  },
  "preImageOpTime": {
    "ts": Timestamp(1594991392, 4),
    "t": NumberLong(4)
  },
  "ts": Timestamp(1594991392, 5),
  "t": NumberLong(4),
  "wall": ISODate("2020-07-17T13:09:52.649Z"),
  "v": NumberLong(2)
}
*/</span>
</pre></table></code></div></div><h3 id="what-could-go-wrong"><span class="me-2">What Could Go Wrong?</span><a href="#what-could-go-wrong" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Though enabling pre-images won’t bloat the oplog entry to the point where it may exceed the BSON max size, when the change stream cursor resolves resulting document the size cannot exceed the BSON max size.</p><p>For example:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nf">randomString</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">result</span>           <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">characters</span>       <span class="o">=</span> <span class="dl">'</span><span class="s1">ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789</span><span class="dl">'</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">charactersLength</span> <span class="o">=</span> <span class="nx">characters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
   <span class="k">for </span><span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">characters</span><span class="p">.</span><span class="nf">charAt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">charactersLength</span><span class="p">));</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// BSON max size less 512 bytes</span>
<span class="kd">var</span> <span class="nx">size</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nf">serverBuildInfo</span><span class="p">().</span><span class="nx">maxBsonObjectSize</span> <span class="o">-</span> <span class="mi">512</span><span class="p">;</span>

<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll4</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nf">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(),</span> <span class="na">junk</span><span class="p">:</span> <span class="nf">randomString</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nf">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocument</span><span class="p">:</span> <span class="dl">"</span><span class="s2">updateLookup</span><span class="dl">"</span><span class="p">,</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">off</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">4</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">});</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nf">next</span><span class="p">()</span>
</pre></table></code></div></div><p>The above example has the <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> disabled, which is the current default behavior of change streams. Though the result would be large (almost 16MB), iterating the change stream cursor would produce a result.</p><p>Modifying the cursor to now request a <code class="language-plaintext highlighter-rouge">fullDocumentBeforeChange</code> (either <code class="language-plaintext highlighter-rouge">required</code> or <code class="language-plaintext highlighter-rouge">whenAvailable</code>) would now raise an error when the cursor is iterated.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="c1">// ...</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nf">drop</span><span class="p">();</span>
<span class="nx">db</span><span class="p">.</span><span class="nf">createCollection</span><span class="p">(</span><span class="dl">"</span><span class="s2">coll4</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span> <span class="na">recordPreImages</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nf">insert</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="na">created_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">(),</span> <span class="na">junk</span><span class="p">:</span> <span class="nf">randomString</span><span class="p">(</span><span class="nx">size</span><span class="p">)</span> <span class="p">});</span>
<span class="kd">var</span> <span class="nx">cursor</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nf">aggregate</span><span class="p">([{</span>
    <span class="na">$changeStream</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocument</span><span class="p">:</span> <span class="dl">"</span><span class="s2">updateLookup</span><span class="dl">"</span><span class="p">,</span> <span class="na">fullDocumentBeforeChange</span><span class="p">:</span> <span class="dl">"</span><span class="s2">required</span><span class="dl">"</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">]);</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">coll4</span><span class="p">.</span><span class="nf">update</span><span class="p">({</span> <span class="na">_id</span><span class="p">:</span> <span class="mi">4</span> <span class="p">},</span> <span class="p">{</span> <span class="na">$set</span><span class="p">:</span> <span class="p">{</span> <span class="na">updated_at</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Date</span><span class="p">()</span> <span class="p">}</span> <span class="p">});</span>
<span class="nx">cursor</span><span class="p">.</span><span class="nf">next</span><span class="p">();</span>
<span class="cm">/*
2020-07-16T07:40:38.307-0400 E  QUERY    [js] Error: command failed: {
	"errmsg" : "BSONObj size: 33553900 (0x1FFFDEC) is invalid. Size must be between 0 and 16793600(16MB) First element: _id: { _data: \"825F103CB5000000032B022C0100296E5A100484010E04E239427B8CBCA810283D05A5461E5F6964002B080004\", _typeBits: BinData(0, 40) }",
	"code" : 10334,
	"codeName" : "BSONObjectTooLarge",
}
*/</span>
</pre></table></code></div></div><p>I personally look forward to pre-images being officially supported in MongoDB, however in the meantime be advised that this may not be ideal for production just yet.</p><p>Happy Coding!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/mongodb/">MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/changestreams/" class="post-tag no-text-decoration" >changestreams</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MongoDB%204.4%20Change%20Streams%20and%20Experimental%20Pre-Image%20'Support'%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F07%2F15%2Fmongodb-4-dot-4-change-streams-and-pre-image-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MongoDB%204.4%20Change%20Streams%20and%20Experimental%20Pre-Image%20'Support'%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F07%2F15%2Fmongodb-4-dot-4-change-streams-and-pre-image-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F07%2F15%2Fmongodb-4-dot-4-change-streams-and-pre-image-support%2F&text=MongoDB%204.4%20Change%20Streams%20and%20Experimental%20Pre-Image%20'Support'%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F07%2F15%2Fmongodb-4-dot-4-change-streams-and-pre-image-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=MongoDB%204.4%20Change%20Streams%20and%20Experimental%20Pre-Image%20'Support'%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F07%2F15%2Fmongodb-4-dot-4-change-streams-and-pre-image-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <a href="https://bsky.app/intent/compose?text=MongoDB%204.4%20Change%20Streams%20and%20Experimental%20Pre-Image%20'Support'%20-%20ALEX%20BEVILACQUA%20https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F07%2F15%2Fmongodb-4-dot-4-change-streams-and-pre-image-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Bluesky" aria-label="Bluesky"> <i class="fa-fw fa-brands fa-bluesky"></i> </a> <a href="https://www.reddit.com/submit?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F07%2F15%2Fmongodb-4-dot-4-change-streams-and-pre-image-support%2F&title=MongoDB%204.4%20Change%20Streams%20and%20Experimental%20Pre-Image%20'Support'%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Reddit" aria-label="Reddit"> <i class="fa-fw fa-brands fa-square-reddit"></i> </a> <a href="https://www.threads.net/intent/post?text=MongoDB%204.4%20Change%20Streams%20and%20Experimental%20Pre-Image%20'Support'%20-%20ALEX%20BEVILACQUA%20https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F07%2F15%2Fmongodb-4-dot-4-change-streams-and-pre-image-support%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Threads" aria-label="Threads"> <i class="fa-fw fa-brands fa-square-threads"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2023/02/10/beneath-a-steel-sky/">Beneath a Steel Sky (Revolution Software) - 1994</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/13/rise-of-the-dragon/">Rise of the Dragon (Dynamix) - 1990</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/13/ruby-on-rails-global-summit-23/">Ruby on Rails Global Summit '23</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/15/urban-runner/">Urban Runner (Coktel Vision) - 1996</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/15/the-crimson-crown-further-adventures-in-transylvania/">The Crimson Crown - Further Adventures in Transylvania (Penguin Software) - 1985</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/javascript/">javascript</a></div></section></div><div class="toc-border-cover z-3"></div><section id="toc-wrapper" class="invisible position-sticky ps-0 pe-4 pb-4"><h2 class="panel-heading ps-3 pb-2 mb-0">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/blog/2024/07/12/call-stack-but-make-it-async/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1720797350" data-df="ll" > Jul 12, 2024 </time><h4 class="pt-0 my-2">Call Stack, But Make It Async!</h4><div class="text-muted"><p>> Written by Neal Beeken ([Blog](https://nbbeeken.github.io/), [GitHub](https://github.com/nbbeeken)) - Canonical URL is at [medium.com](https://medium.com/@MongoDB/call-stack-but-make-it-async-f91...</p></div></div></a></article><article class="col"> <a href="/blog/2022/10/06/from-engineering-to-product-management/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1665040407" data-df="ll" > Oct 6, 2022 </time><h4 class="pt-0 my-2">From Engineering to Product Management</h4><div class="text-muted"><p>I've spent my entire professional career as an engineering IC either churning out code, working on architectural challenges or helping to lead engineering teams (while still churning out code). Whe...</p></div></div></a></article><article class="col"> <a href="/blog/2022/09/09/performance-profiling-a-mongoid-issue-using-appprofiler/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1662720061" data-df="ll" > Sep 9, 2022 </time><h4 class="pt-0 my-2">Performance Profiling a Mongoid Issue Using AppProfiler</h4><div class="text-muted"><p>In [MONGOID-4889](https://jira.mongodb.org/browse/MONGOID-4889) the claim was made that assignment of a large number of embedded documents to an instance of a model will take increasingly longer as...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" class="btn btn-outline-primary" aria-label="Older" ><p>Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule</p></a> <a href="/blog/2020/11/20/mongodb-5-dot-0-startup2-progress-monitoring-improvements/" class="btn btn-outline-primary" aria-label="Newer" ><p>MongoDB 5.0 Initial Sync Progress Monitoring Improvements</p></a></nav><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2025</time> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center d-none"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/javascript/">javascript</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/'; this.page.identifier = '/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/'; }; function addDisqus() { let disqusThread = document.createElement('div'); let paragraph = document.createElement('p'); disqusThread.id = 'disqus_thread'; paragraph.className = 'text-center text-muted small'; paragraph.innerHTML = 'Comments powered by <a href="https://disqus.com/">Disqus</a>.'; disqusThread.appendChild(paragraph); const footer = document.querySelector('footer'); footer.insertAdjacentElement("beforebegin", disqusThread); }function reloadDisqus(event) { if (event.source === window && event.data && event.data.id === Theme.ID) {if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } addDisqus(); if (Theme.switchable) { addEventListener('message', reloadDisqus); }var disqusObserver = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); disqusObserver.disconnect(); } }, { threshold: [0] } ); disqusObserver.observe(document.getElementById('disqus_thread')); </script> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{content}</p></article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script>
