<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Optimizing MongoDB Compound Indexes - The “Equality - Sort - Range” (ESR) Rule" /><meta name="author" content="Alex Bevilacqua" /><meta property="og:locale" content="en_US" /><meta name="description" content="Working in Technical Services at MongoDB I find that time and again customers need assistance understanding why the operations they’ve created indexes for may not be performing optimally. When providing supplementary documentation, the go-to article is “Optimizing MongoDB Compound Indexes” by MongoDB’s A. Jesse Jiryu Davis, however we do not have a formal public reference yet (though DOCS-11790 exists to track this effort)." /><meta property="og:description" content="Working in Technical Services at MongoDB I find that time and again customers need assistance understanding why the operations they’ve created indexes for may not be performing optimally. When providing supplementary documentation, the go-to article is “Optimizing MongoDB Compound Indexes” by MongoDB’s A. Jesse Jiryu Davis, however we do not have a formal public reference yet (though DOCS-11790 exists to track this effort)." /><link rel="canonical" href="https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-16T07:35:11-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Optimizing MongoDB Compound Indexes - The “Equality - Sort - Range” (ESR) Rule" /><meta name="twitter:site" content="@alexbevi" /><meta name="twitter:creator" content="@Alex Bevilacqua" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alex Bevilacqua"},"dateModified":"2022-03-02T09:32:32-05:00","datePublished":"2020-05-16T07:35:11-04:00","description":"Working in Technical Services at MongoDB I find that time and again customers need assistance understanding why the operations they’ve created indexes for may not be performing optimally. When providing supplementary documentation, the go-to article is “Optimizing MongoDB Compound Indexes” by MongoDB’s A. Jesse Jiryu Davis, however we do not have a formal public reference yet (though DOCS-11790 exists to track this effort).","headline":"Optimizing MongoDB Compound Indexes - The “Equality - Sort - Range” (ESR) Rule","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/"},"url":"https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/"}</script><title>Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule | ALEX BEVILACQUA</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/galleria.min.js"></script><link href="//cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/themes/classic/galleria.classic.min.css" media="screen, projection" rel="stylesheet" type="text/css" /><style> /* This rule is read by Galleria to define the gallery height: */ .galleria{ width: 700px; height: 400px; background: #000 } .responsive-wrap iframe{ max-width: 100%;}</style><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle font-italic">my little corner of the interwebs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/alexbevi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/alexbevi" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener"> <i class="fab fa-reddit"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> Blog </span> <span> 2020 </span> <span> 05 </span> <span> 16 </span> <span>Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, May 16, 2020, 7:35 AM -0400" > May 16, 2020 <i class="unloaded">2020-05-16T07:35:11-04:00</i> </span> by <span class="author"> Alex Bevilacqua </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Mar 2, 2022, 9:32 AM -0500" > Mar 2 <i class="unloaded">2022-03-02T09:32:32-05:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1573 words">8 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/mongodb-logo.png" class="preview-img" alt="MongoDB Logo"><p>Working in Technical Services at MongoDB I find that time and again customers need assistance understanding why the operations they’ve created <a href="https://docs.mongodb.com/manual/indexes/">indexes</a> for may not be performing optimally. When providing supplementary documentation, the go-to article is <a href="https://emptysqua.re/blog/optimizing-mongodb-compound-indexes/">“Optimizing MongoDB Compound Indexes”</a> by MongoDB’s <a href="https://emptysqua.re/blog/about/">A. Jesse Jiryu Davis</a>, <del>however we do not have a formal public reference yet (though <a href="https://jira.mongodb.org/browse/DOCS-11790">DOCS-11790</a> exists to track this effort)</del>.</p><div class="note info"> <span>UPDATE</span><p>The MongoDB public documentation now contains a tutorial for <a href="https://www.mongodb.com/docs/manual/tutorial/equality-sort-range-rule">The ESR (Equality, Sort, Range) Rule</a>!!! &lt;/div&gt; I've presented this topic now at [MongoDB.local Toronto 2019](https://mongodblocaltoronto2019.sched.com/event/VCf3/tips-and-tricks-for-effective-indexing-mongodb) (in ["Tips and Tricks for Effective Indexing"](https://www.slideshare.net/mongodb/mongodb-local-toronto-2019-tips-and-tricks-for-effective-indexing)) and at [MongoDB World 2019](https://mongodbworld2019.sched.com/event/OCX7/the-sights-and-smells-of-a-bad-query-mongodb) (in ["The Sights (and Smells) of a Bad Query"](https://www.slideshare.net/mongodb/mongodb-world-2019-the-sights-and-smells-of-a-bad-query)). My colleague [Chris Harris](https://www.linkedin.com/in/christopher-harris-483aa149/) has also covered this topic at MongoDB World 2019 (in ["Tips and Tricks++ for Querying and Indexing MongoDB"](https://www.slideshare.net/mongodb/mongodb-world-2019-tips-and-tricks-for-querying-and-indexing-mongodb)) and again at the MongoDB.local Houston 2019, for which [a video is available](https://www.youtube.com/watch?v=5mBY27wVau0&amp;list=PL4RCxklHWZ9u_xtprouvxCvzq2m6q_0_E&amp;index=9&amp;t=0s). Though we have Jesse's excellent (and still applicable and valid) article from 2012, I wanted to take this opportunity to collect some thoughts on this topic based on his work and previous presentations. ## The ESR "Rule" The ordering of index keys in a compound index is critically important, and the ESR "Rule" can be used as a rule of thumb to identify the optimal order _in most cases_. The reason we are putting "Rule" in quotations is because, though the guidance is applicable in most cases, there are exceptions to be aware of. These exceptions are covered in greater detail in my in ["Tips and Tricks for Effective Indexing"](https://www.slideshare.net/mongodb/mongodb-local-toronto-2019-tips-and-tricks-for-effective-indexing) presentation. ### The "Rules" (1) _**Equality**_ predicates should be placed first An equality predicate is any filter condition that is attempting to match a value _exactly_. For example: ```js find({ x: 123 }) find({ x: { $eq: 123 } }) aggregate([ { $match:{ "x.y": 123 } } ]) ``` These filters will be tightly bound when seen in the `indexBounds` of an [Explain Plan](https://docs.mongodb.com/manual/reference/explain-results/#explain-output): ```js "indexBounds" : { "x" : [ "[123.0, 123.0]" ] } ``` Note that _multiple equality predicates **do not** have to be ordered from most selective to least selective_. This guidance has been provided in the past however it is erroneous due to the nature of B-Tree indexes and how in leaf pages, a B-Tree will store combinations of all field’s values. As such, _there is exactly the same number of combinations regardless of key order_. (2) _**Sort**_ predicates follow _Equality_ predicates Sort predicates represent the entire requested sort for the operation and determine the ordering of results. For example: ```js find().sort({ a: 1 }) find().sort({ b: -1, a: 1 }) aggregate([ { $sort: { b: 1 } } ]) ``` A sort predicate will be _unbounded_ as it requires the entire key range to be scanned to satisfy the sort requirements: ```js "indexBounds" : { "b" : [ "[MaxKey, MinKey]" ], "a" : [ "[MinKey, MaxKey]" ] } ``` (3) _**Range**_ predicates follow _Equality_ and _Sort_ predicates Range predicates are filters that may scan multiple keys as they _are not_ testing for an exact match. For example: ```js find({ z: { $gte: 5} }) find({ z: { $lt: 10 } }) find({ z: { $ne: null } }) ``` The range predicates will be _loosely bounded_ as a subset of the key range will need to be scanned to satisfy the filter requirements: ```js "indexBounds" : { "z" : [ "[5.0, inf.0]" ] } "indexBounds" : { "z" : [ "[-inf.0, 10.0)" ] } "indexBounds" : { "z" : [ "[MinKey, undefined)", "(null, MaxKey]" ] } ``` These three tenets of the "rule" have to do with how a query will traverse an index to identify the keys that match the query’s filter and sort criteria. ### Setup For the duration of this section we’ll be working with the following data to help illustrate the various guiding principles: ```js { name: "Shakir", location: "Ottawa", region: "AMER", joined: 2015 } { name: "Chris", location: "Austin", region: "AMER", joined: 2016 } { name: "III", location: "Sydney", region: "APAC", joined: 2016 } { name: "Miguel", location: "Barcelona", region: "EMEA", joined: 2017 } { name: "Alex", location: "Toronto", region: "AMER", joined: 2018 } ``` We will also be examining simplified (filtered) Explain Plan’s [`executionStats`](https://docs.mongodb.com/manual/reference/explain-results/#executionstats) from each operation using a variation of the following command: ```js find({ ... }).sort({ ... }).explain("executionStats").executionStats ``` ### (E) _Equality_ First When [creating queries that ensure selectivity](https://docs.mongodb.com/manual/tutorial/create-queries-that-ensure-selectivity/), we learn that "selectivity" is the ability of a query to narrow results using the index. Effective indexes are more selective and allow MongoDB to use the index for a larger portion of the work associated with fulfilling the query. _Equality_ fields should always form the prefix for the index to ensure selectivity. ### (E → S) _Equality_ before _Sort_ Placing _Sort_ predicates after sequential _Equality_ keys allow for the index to: * Provide a non-blocking sort. * Minimize the amount of scanning required. To better understand why this is we will begin with the following example: ```js // operation createIndex({ name: 1, region: 1 }) find({ region: "AMER" }).sort({ name: 1 }) ``` With the _Sort_ predicate first, the full key range would have to be scanned prior to the more selective equality filter being applied: ```js // execution stats "nReturned" : 3.0, "totalKeysExamined" : 5.0, "totalDocsExamined" : 5.0, "executionStages" : { ... "inputStage" : { "stage" : "IXSCAN", ... "indexBounds" : { "name" : [ "[MinKey, MaxKey]" ], "region" : [ "[MinKey, MaxKey]" ] }, ``` ![](/images/esr01.png) With this index, all 5 keys have to be scanned (`totalKeysExamined`) to identify the 3 matching documents (`nReturned`). ```js // operation createIndex({ region: 1, name: 1 }) find({ region: "AMER" }).sort({ name: 1 }) ``` With the _Equality_ predict first, the tight bounds allow less keys to be scanned to satisfy the filter criteria: ```js // execution stats "nReturned" : 3.0, "totalKeysExamined" : 3.0, "totalDocsExamined" : 3.0, "executionStages" : { ... "inputStage" : { "stage" : "IXSCAN", ... "indexBounds" : { "region" : [ "[\"AMER\", \"AMER\"]" ], "name" : [ "[MinKey, MaxKey]" ] }, ``` ![](/images/esr02.png) ### (E → R) _Equality_ before _Range_ Though _Range_ predicates scan a subset of keys (unlike _Sort_ predicates), they should still be placed after Equality predicates to ensure the key ordering is optimized for selectivity. ```js // operation createIndex({ joined: 1, region: 1 }) find({ region: "AMER", joined: { $gt: 2015 } }) ``` Having the _Range_ before the _Equality_ predicate causes more keys to be scanned to identify the matching documents: ```js // execution stats "nReturned" : 2.0, "totalKeysExamined" : 4.0, "totalDocsExamined" : 2.0, "executionStages" : { ... "inputStage" : { "stage" : "IXSCAN", ... "indexBounds" : { "joined" : [ "(2015.0, inf.0]" ], "region" : [ "[\"AMER\", \"AMER\"]" ] }, ``` ![](/images/esr03.png) In this example, 4 keys had to be scanned to identify the 2 matches. Changing the order of the keys to place the Equality predicate first will reduce the amount of scanning required: ```js // operation createIndex({ region: 1, joined: 1 }) find({ region: "AMER", joined: { $gt: 2015 } }) ``` ```js // execution stats "nReturned" : 2.0, "totalKeysExamined" : 2.0, "totalDocsExamined" : 2.0, "executionStages" : { ... "inputStage" : { "stage" : "IXSCAN", ... "indexBounds" : { "region" : [ "[\"AMER\", \"AMER\"]" ], "joined" : [ "(2015.0, inf.0]" ] }, ``` ![](/images/esr04.png) After placing the _Equality_ predicate before the _Range_ predicate, only the number of keys necessary to satisfy the filter criteria are scanned. ### (S → R) _Sort_ before _Range_ Having a _Range_ predicate before the _Sort_ can result in a Blocking (In Memory) Sort being performed as the [index cannot be used to satisfy the sort criteria](https://docs.mongodb.com/manual/tutorial/sort-results-with-indexes/). ```js // operation createIndex({ joined: 1, region: 1 }) find({ joined: { $gt: 2015 } }).sort({ region: 1 }) ``` ```js // execution stats "nReturned" : 4.0, "totalKeysExamined" : 4.0, "totalDocsExamined" : 4.0, "executionStages" : { ... "inputStage" : { "stage" : "SORT", ... "sortPattern" : { "region" : 1.0 }, "memUsage" : 136.0, "memLimit" : 33554432.0, "inputStage" : { "stage" : "SORT_KEY_GENERATOR", ... "inputStage" : { "stage" : "IXSCAN", ... "indexBounds" : { "joined" : [ "(2015.0, inf.0]" ], "region" : [ "[MinKey, MaxKey]" ] }, ``` ![](/images/esr05.png) In this example, the filter was able to use the index selectively to identify the 4 keys needed to satisfy the query, however the results are not known to be in order. This results in the identified keys being sorted in memory prior to be returned to the calling stage in the execution plan. By moving the _Sort_ predicate before the _Range_ predicate however, even though more keys may need to be scanned the keys will be returned correctly ordered. ```js // operation createIndex({ region: 1, joined: 1 }) find({ joined: { $gt: 2015 } }).sort({ region: 1 }) ``` ```js // execution stats "nReturned" : 4.0, "totalKeysExamined" : 5.0, "totalDocsExamined" : 5.0, "executionStages" : { ... "inputStage" : { "stage" : "IXSCAN", ... "indexBounds" : { "region" : [ "[MinKey, MaxKey]" ], "joined" : [ "[MinKey, MaxKey]" ] }, ``` ![](/images/esr06.png) Though this method requires scanning additional keys the lack of a blocking sort will generally be far more efficient/performant. I hope that the _ESR "Rule"_ helps you optimize your MongoDB indexes and improve your query performance. If you have questions, feel free to hit me up in the comments, or check out the [MongoDB Developer Community forums](https://developer.mongodb.com/community/forums/). If you need more timely assistance, consider MongoDB's [Atlas Developer Support](https://docs.atlas.mongodb.com/support/) or [Enterprise Support](https://www.mongodb.com/products/enterprise-grade-support). Cheers, and happy optimizing!</p></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>MongoDB</a>, <a href='/categories/queries-indexing/'>Queries & Indexing</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule - ALEX BEVILACQUA&u=https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2021/07/28/adventure-games-1980-1999/">Journey into Adventure Games (1980-1999)</a><li><a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Adventure Games (1980-1999): Sorted by Score</a><li><a href="/blog/2021/08/23/the-impact-of-retryable-writes-on-the-mongodb-oplog/">Retryable Writes, findAndModify and the impact on the MongoDB Oplog</a><li><a href="/blog/2022/03/31/blue-force/">Blue Force (Tsunami Games) - 1993</a><li><a href="/blog/2022/03/02/performance-analysis-of-resuming-a-mongodb-change-stream/">Performance Analysis of Resuming a MongoDB Change Stream</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/replication/">replication</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2020/01/17/current-date-math-in-mongodb-aggregations/"><div class="card-body"> <span class="timeago small" > Jan 17, 2020 <i class="unloaded">2020-01-17T06:30:17-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Current Date Math in MongoDB Aggregations</h3><div class="text-muted small"><p> A challenge that I’ve had in the past while working with my data in MongoDB has been how to incorporate date math into my aggregations. db.foo.insertMany([ { lastUpdated: new Date(new Date().setDa...</p></div></div></a></div><div class="card"> <a href="/blog/2012/08/29/install-latest-mongodb-in-ubuntu/"><div class="card-body"> <span class="timeago small" > Aug 29, 2012 <i class="unloaded">2012-08-29T13:46:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Install Latest MongoDB in Ubuntu</h3><div class="text-muted small"><p> A couple projects I work on use MongoDB as the database, and I’m generally not satisfied to use the (often outdated) version that ships with Ubuntu. As a result, I wrote this script to automate fe...</p></div></div></a></div><div class="card"> <a href="/blog/2018/08/14/hello-mongodb/"><div class="card-body"> <span class="timeago small" > Aug 14, 2018 <i class="unloaded">2018-08-14T15:31:04-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Hello MongoDB</h3><div class="text-muted small"><p> As of August 13th, I am no longer a System Architect at DAC Group. I have a public post on LinkedIn that got some good traction, but to summarize it was time to move on. I’ve been a software engin...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2020/03/30/working-around-mongodb-stitchs-max-async-work-queue-limit/" class="btn btn-outline-primary" prompt="Older"><p>Working around MongoDB Stitch's "max async work queue" limit</p></a> <a href="/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" class="btn btn-outline-primary" prompt="Newer"><p>MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//alexbevi.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule'; this.page.url = 'https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/'; this.page.identifier = '/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/replication/">replication</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.alexbevi.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script type="text/javascript" src="/assets/js/lightbox.js"></script><link rel="stylesheet" href="/assets/css/lightbox.css">
