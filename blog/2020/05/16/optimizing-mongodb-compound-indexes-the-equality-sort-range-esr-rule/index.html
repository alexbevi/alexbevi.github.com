<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Optimizing MongoDB Compound Indexes - The “Equality - Sort - Range” (ESR) Rule" /><meta property="og:locale" content="en" /><meta name="description" content="UPDATE DOCS-11790 has finally been implemented and as a result the MongoDB public documentation now contains a tutorial for The ESR (Equality, Sort, Range) Rule!" /><meta property="og:description" content="UPDATE DOCS-11790 has finally been implemented and as a result the MongoDB public documentation now contains a tutorial for The ESR (Equality, Sort, Range) Rule!" /><link rel="canonical" href="https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-05-16T07:35:11-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="twitter:title" content="Optimizing MongoDB Compound Indexes - The “Equality - Sort - Range” (ESR) Rule" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-09T12:45:05-04:00","datePublished":"2020-05-16T07:35:11-04:00","description":"UPDATE DOCS-11790 has finally been implemented and as a result the MongoDB public documentation now contains a tutorial for The ESR (Equality, Sort, Range) Rule!","headline":"Optimizing MongoDB Compound Indexes - The “Equality - Sort - Range” (ESR) Rule","image":"https://www.alexbevi.com/images/mongodb-logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/"},"url":"https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/"}</script><title>Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="/assets/lib/bootstrap/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup/magnific-popup.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script><meta name="google-adsense-account" content="ca-pub-6215800856413580"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src=" /./images/avatar.png " width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">ALEX BEVILACQUA</a></h1><p class="site-subtitle fst-italic mb-0">my little corner of the interwebs</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Optimizing MongoDB Compound Indexes - The "Equality - Sort - Range" (ESR) Rule</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1589628911" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 16, 2020 </time> </span> <span> Updated <time data-ts="1683650705" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 9, 2023 </time> </span><div class="mt-3 mb-3"> <a href=" /images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src=" /images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1684 words" > <em>9 min</em> read </span></div></div></header><div class="content"><blockquote class="prompt-info"><p><strong>UPDATE</strong></p><p><a href="https://jira.mongodb.org/browse/DOCS-11790">DOCS-11790</a> has finally been implemented and as a result the MongoDB public documentation now contains a tutorial for <a href="https://www.mongodb.com/docs/manual/tutorial/equality-sort-range-rule">The ESR (Equality, Sort, Range) Rule</a>!</p></blockquote><p>Working in Technical Services at MongoDB I find that time and again customers need assistance understanding why the operations they’ve created <a href="https://docs.mongodb.com/manual/indexes/">indexes</a> for may not be performing optimally. When providing supplementary documentation, the go-to article is <a href="https://emptysqua.re/blog/optimizing-mongodb-compound-indexes/">“Optimizing MongoDB Compound Indexes”</a> by MongoDB’s <a href="https://emptysqua.re/blog/about/">A. Jesse Jiryu Davis</a>.</p><p>I’ve presented this topic now at <a href="https://mongodblocaltoronto2019.sched.com/event/VCf3/tips-and-tricks-for-effective-indexing-mongodb">MongoDB.local Toronto 2019</a> (in <a href="https://www.slideshare.net/mongodb/mongodb-local-toronto-2019-tips-and-tricks-for-effective-indexing">“Tips and Tricks for Effective Indexing”</a>) and at <a href="https://mongodbworld2019.sched.com/event/OCX7/the-sights-and-smells-of-a-bad-query-mongodb">MongoDB World 2019</a> (in <a href="https://www.slideshare.net/mongodb/mongodb-world-2019-the-sights-and-smells-of-a-bad-query">“The Sights (and Smells) of a Bad Query”</a>). My colleague <a href="https://www.linkedin.com/in/christopher-harris-483aa149/">Chris Harris</a> has also covered this topic at MongoDB World 2019 (in <a href="https://www.slideshare.net/mongodb/mongodb-world-2019-tips-and-tricks-for-querying-and-indexing-mongodb">“Tips and Tricks++ for Querying and Indexing MongoDB”</a>) and again at the MongoDB.local Houston 2019, for which <a href="https://www.youtube.com/watch?v=5mBY27wVau0&amp;list=PL4RCxklHWZ9u_xtprouvxCvzq2m6q_0_E&amp;index=9&amp;t=0s">a video is available</a>.</p><p>Though we have Jesse’s excellent (and still applicable and valid) article from 2012, I wanted to take this opportunity to collect some thoughts on this topic based on his work and previous presentations.</p><h2 id="the-esr-rule"><span class="me-2">The ESR “Rule”</span><a href="#the-esr-rule" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The ordering of index keys in a compound index is critically important, and the ESR “Rule” can be used as a rule of thumb to identify the optimal order <em>in most cases</em>.</p><p>The reason we are putting “Rule” in quotations is because, though the guidance is applicable in most cases, there are exceptions to be aware of. These exceptions are covered in greater detail in my in <a href="https://www.slideshare.net/mongodb/mongodb-local-toronto-2019-tips-and-tricks-for-effective-indexing">“Tips and Tricks for Effective Indexing”</a> presentation.</p><h3 id="the-rules"><span class="me-2">The “Rules”</span><a href="#the-rules" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>(1) <em><strong>Equality</strong></em> predicates should be placed first</p><p>An equality predicate is any filter condition that is attempting to match a value <em>exactly</em>. For example:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nf">find</span><span class="p">({</span> <span class="na">x</span><span class="p">:</span> <span class="mi">123</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">({</span> <span class="na">x</span><span class="p">:</span> <span class="p">{</span> <span class="na">$eq</span><span class="p">:</span> <span class="mi">123</span> <span class="p">}</span> <span class="p">})</span>
<span class="nf">aggregate</span><span class="p">([</span> <span class="p">{</span> <span class="na">$match</span><span class="p">:{</span> <span class="dl">"</span><span class="s2">x.y</span><span class="dl">"</span><span class="p">:</span> <span class="mi">123</span> <span class="p">}</span> <span class="p">}</span> <span class="p">])</span>
</pre></table></code></div></div><p>These filters will be tightly bound when seen in the <code class="language-plaintext highlighter-rouge">indexBounds</code> of an <a href="https://docs.mongodb.com/manual/reference/explain-results/#explain-output">Explain Plan</a>:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">x</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">[123.0, 123.0]</span><span class="dl">"</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Note that <em>multiple equality predicates <strong>do not</strong> have to be ordered from most selective to least selective</em>. This guidance has been provided in the past however it is erroneous due to the nature of B-Tree indexes and how in leaf pages, a B-Tree will store combinations of all field’s values. As such, <em>there is exactly the same number of combinations regardless of key order</em>.</p><p>(2) <em><strong>Sort</strong></em> predicates follow <em>Equality</em> predicates Sort predicates represent the entire requested sort for the operation and determine the ordering of results. For example:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nf">find</span><span class="p">().</span><span class="nf">sort</span><span class="p">({</span> <span class="na">a</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">().</span><span class="nf">sort</span><span class="p">({</span> <span class="na">b</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="na">a</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="nf">aggregate</span><span class="p">([</span> <span class="p">{</span> <span class="na">$sort</span><span class="p">:</span> <span class="p">{</span> <span class="na">b</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span> <span class="p">])</span>
</pre></table></code></div></div><p>A sort predicate will be <em>unbounded</em> as it requires the entire key range to be scanned to satisfy the sort requirements:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">b</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">[MaxKey, MinKey]</span><span class="dl">"</span>
    <span class="p">],</span>
    <span class="dl">"</span><span class="s2">a</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">[MinKey, MaxKey]</span><span class="dl">"</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><p>(3) <em><strong>Range</strong></em> predicates follow <em>Equality</em> and <em>Sort</em> predicates</p><p>Range predicates are filters that may scan multiple keys as they <em>are not</em> testing for an exact match. For example:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="nf">find</span><span class="p">({</span> <span class="na">z</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gte</span><span class="p">:</span> <span class="mi">5</span><span class="p">}</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">({</span> <span class="na">z</span><span class="p">:</span> <span class="p">{</span> <span class="na">$lt</span><span class="p">:</span> <span class="mi">10</span> <span class="p">}</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">({</span> <span class="na">z</span><span class="p">:</span> <span class="p">{</span> <span class="na">$ne</span><span class="p">:</span> <span class="kc">null</span> <span class="p">}</span> <span class="p">})</span>
</pre></table></code></div></div><p>The range predicates will be <em>loosely bounded</em> as a subset of the key range will need to be scanned to satisfy the filter requirements:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
</pre><td class="rouge-code"><pre><span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">z</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">[5.0, inf.0]</span><span class="dl">"</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">z</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">[-inf.0, 10.0)</span><span class="dl">"</span>
    <span class="p">]</span>
<span class="p">}</span>
<span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="dl">"</span><span class="s2">z</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
        <span class="dl">"</span><span class="s2">[MinKey, undefined)</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">(null, MaxKey]</span><span class="dl">"</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><p>These three tenets of the “rule” have to do with how a query will traverse an index to identify the keys that match the query’s filter and sort criteria.</p><h3 id="setup"><span class="me-2">Setup</span><a href="#setup" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>For the duration of this section we’ll be working with the following data to help illustrate the various guiding principles:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">{</span> <span class="nl">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Shakir</span><span class="dl">"</span><span class="p">,</span> <span class="nx">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Ottawa</span><span class="dl">"</span><span class="p">,</span>    <span class="nx">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AMER</span><span class="dl">"</span><span class="p">,</span> <span class="nx">joined</span><span class="p">:</span> <span class="mi">2015</span> <span class="p">}</span>
<span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Chris</span><span class="dl">"</span><span class="p">,</span>  <span class="na">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Austin</span><span class="dl">"</span><span class="p">,</span>    <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AMER</span><span class="dl">"</span><span class="p">,</span> <span class="na">joined</span><span class="p">:</span> <span class="mi">2016</span> <span class="p">}</span>
<span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">III</span><span class="dl">"</span><span class="p">,</span>    <span class="na">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Sydney</span><span class="dl">"</span><span class="p">,</span>    <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">APAC</span><span class="dl">"</span><span class="p">,</span> <span class="na">joined</span><span class="p">:</span> <span class="mi">2016</span> <span class="p">}</span>
<span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Miguel</span><span class="dl">"</span><span class="p">,</span> <span class="na">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Barcelona</span><span class="dl">"</span><span class="p">,</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">EMEA</span><span class="dl">"</span><span class="p">,</span> <span class="na">joined</span><span class="p">:</span> <span class="mi">2017</span> <span class="p">}</span>
<span class="p">{</span> <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Alex</span><span class="dl">"</span><span class="p">,</span>   <span class="na">location</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Toronto</span><span class="dl">"</span><span class="p">,</span>   <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AMER</span><span class="dl">"</span><span class="p">,</span> <span class="na">joined</span><span class="p">:</span> <span class="mi">2018</span> <span class="p">}</span>
</pre></table></code></div></div><p>We will also be examining simplified (filtered) Explain Plan’s <a href="https://docs.mongodb.com/manual/reference/explain-results/#executionstats"><code class="language-plaintext highlighter-rouge">executionStats</code></a> from each operation using a variation of the following command:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nf">find</span><span class="p">({</span> <span class="p">...</span> <span class="p">}).</span><span class="nf">sort</span><span class="p">({</span> <span class="p">...</span> <span class="p">}).</span><span class="nf">explain</span><span class="p">(</span><span class="dl">"</span><span class="s2">executionStats</span><span class="dl">"</span><span class="p">).</span><span class="nx">executionStats</span>
</pre></table></code></div></div><h3 id="e-equality-first"><span class="me-2">(E) <em>Equality</em> First</span><a href="#e-equality-first" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>When <a href="https://docs.mongodb.com/manual/tutorial/create-queries-that-ensure-selectivity/">creating queries that ensure selectivity</a>, we learn that “selectivity” is the ability of a query to narrow results using the index. Effective indexes are more selective and allow MongoDB to use the index for a larger portion of the work associated with fulfilling the query.</p><p><em>Equality</em> fields should always form the prefix for the index to ensure selectivity.</p><h3 id="e--s-equality-before-sort"><span class="me-2">(E → S) <em>Equality</em> before <em>Sort</em></span><a href="#e--s-equality-before-sort" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Placing <em>Sort</em> predicates after sequential <em>Equality</em> keys allow for the index to:</p><ul><li>Provide a non-blocking sort.<li>Minimize the amount of scanning required.</ul><p>To better understand why this is we will begin with the following example:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// operation</span>
<span class="nf">createIndex</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">region</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AMER</span><span class="dl">"</span> <span class="p">}).</span><span class="nf">sort</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
</pre></table></code></div></div><p>With the <em>Sort</em> predicate first, the full key range would have to be scanned prior to the more selective equality filter being applied:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// execution stats</span>
<span class="dl">"</span><span class="s2">nReturned</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalKeysExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalDocsExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">executionStages</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="dl">"</span><span class="s2">inputStage</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">stage</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">IXSCAN</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">[MinKey, MaxKey]</span><span class="dl">"</span>
            <span class="p">],</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">[MinKey, MaxKey]</span><span class="dl">"</span>
            <span class="p">]</span>
        <span class="p">},</span>
</pre></table></code></div></div><p><a href=" /images/esr01.png" class="popup img-link shimmer"><img src=" /images/esr01.png" alt="" loading="lazy"></a></p><p>With this index, all 5 keys have to be scanned (<code class="language-plaintext highlighter-rouge">totalKeysExamined</code>) to identify the 3 matching documents (<code class="language-plaintext highlighter-rouge">nReturned</code>).</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// operation</span>
<span class="nf">createIndex</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">name</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AMER</span><span class="dl">"</span> <span class="p">}).</span><span class="nf">sort</span><span class="p">({</span> <span class="na">name</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
</pre></table></code></div></div><p>With the <em>Equality</em> predict first, the tight bounds allow less keys to be scanned to satisfy the filter criteria:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// execution stats</span>
<span class="dl">"</span><span class="s2">nReturned</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalKeysExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalDocsExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">3.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">executionStages</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="dl">"</span><span class="s2">inputStage</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">stage</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">IXSCAN</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">[</span><span class="se">\"</span><span class="s2">AMER</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">AMER</span><span class="se">\"</span><span class="s2">]</span><span class="dl">"</span>
            <span class="p">],</span>
            <span class="dl">"</span><span class="s2">name</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">[MinKey, MaxKey]</span><span class="dl">"</span>
            <span class="p">]</span>
        <span class="p">},</span>
</pre></table></code></div></div><p><a href=" /images/esr02.png" class="popup img-link shimmer"><img src=" /images/esr02.png" alt="" loading="lazy"></a></p><h3 id="e--r-equality-before-range"><span class="me-2">(E → R) <em>Equality</em> before <em>Range</em></span><a href="#e--r-equality-before-range" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Though <em>Range</em> predicates scan a subset of keys (unlike <em>Sort</em> predicates), they should still be placed after Equality predicates to ensure the key ordering is optimized for selectivity.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// operation</span>
<span class="nf">createIndex</span><span class="p">({</span> <span class="na">joined</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">region</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AMER</span><span class="dl">"</span><span class="p">,</span> <span class="na">joined</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gt</span><span class="p">:</span> <span class="mi">2015</span> <span class="p">}</span> <span class="p">})</span>
</pre></table></code></div></div><p>Having the <em>Range</em> before the <em>Equality</em> predicate causes more keys to be scanned to identify the matching documents:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// execution stats</span>
<span class="dl">"</span><span class="s2">nReturned</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalKeysExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalDocsExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">executionStages</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="dl">"</span><span class="s2">inputStage</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">stage</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">IXSCAN</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">joined</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">(2015.0, inf.0]</span><span class="dl">"</span>
            <span class="p">],</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">[</span><span class="se">\"</span><span class="s2">AMER</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">AMER</span><span class="se">\"</span><span class="s2">]</span><span class="dl">"</span>
            <span class="p">]</span>
        <span class="p">},</span>
</pre></table></code></div></div><p><a href=" /images/esr03.png" class="popup img-link shimmer"><img src=" /images/esr03.png" alt="" loading="lazy"></a></p><p>In this example, 4 keys had to be scanned to identify the 2 matches. Changing the order of the keys to place the Equality predicate first will reduce the amount of scanning required:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// operation</span>
<span class="nf">createIndex</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">joined</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AMER</span><span class="dl">"</span><span class="p">,</span> <span class="na">joined</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gt</span><span class="p">:</span> <span class="mi">2015</span> <span class="p">}</span> <span class="p">})</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// execution stats</span>
<span class="dl">"</span><span class="s2">nReturned</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalKeysExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalDocsExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">2.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">executionStages</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="dl">"</span><span class="s2">inputStage</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">stage</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">IXSCAN</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">[</span><span class="se">\"</span><span class="s2">AMER</span><span class="se">\"</span><span class="s2">, </span><span class="se">\"</span><span class="s2">AMER</span><span class="se">\"</span><span class="s2">]</span><span class="dl">"</span>
            <span class="p">],</span>
            <span class="dl">"</span><span class="s2">joined</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">(2015.0, inf.0]</span><span class="dl">"</span>
            <span class="p">]</span>
        <span class="p">},</span>
</pre></table></code></div></div><p><a href=" /images/esr04.png" class="popup img-link shimmer"><img src=" /images/esr04.png" alt="" loading="lazy"></a></p><p>After placing the <em>Equality</em> predicate before the <em>Range</em> predicate, only the number of keys necessary to satisfy the filter criteria are scanned.</p><h3 id="s--r-sort-before-range"><span class="me-2">(S → R) <em>Sort</em> before <em>Range</em></span><a href="#s--r-sort-before-range" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Having a <em>Range</em> predicate before the <em>Sort</em> can result in a Blocking (In Memory) Sort being performed as the <a href="https://docs.mongodb.com/manual/tutorial/sort-results-with-indexes/">index cannot be used to satisfy the sort criteria</a>.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// operation</span>
<span class="nf">createIndex</span><span class="p">({</span> <span class="na">joined</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">region</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">({</span> <span class="na">joined</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gt</span><span class="p">:</span> <span class="mi">2015</span> <span class="p">}</span> <span class="p">}).</span><span class="nf">sort</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre><span class="c1">// execution stats</span>
<span class="dl">"</span><span class="s2">nReturned</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalKeysExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalDocsExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">executionStages</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="dl">"</span><span class="s2">inputStage</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">stage</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">SORT</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="dl">"</span><span class="s2">sortPattern</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">1.0</span>
        <span class="p">},</span>
        <span class="dl">"</span><span class="s2">memUsage</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">136.0</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">memLimit</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">33554432.0</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">inputStage</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">stage</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">SORT_KEY_GENERATOR</span><span class="dl">"</span><span class="p">,</span>
            <span class="p">...</span>
            <span class="dl">"</span><span class="s2">inputStage</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
                <span class="dl">"</span><span class="s2">stage</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">IXSCAN</span><span class="dl">"</span><span class="p">,</span>
                <span class="p">...</span>
                <span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
                    <span class="dl">"</span><span class="s2">joined</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                        <span class="dl">"</span><span class="s2">(2015.0, inf.0]</span><span class="dl">"</span>
                    <span class="p">],</span>
                    <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                        <span class="dl">"</span><span class="s2">[MinKey, MaxKey]</span><span class="dl">"</span>
                    <span class="p">]</span>
                <span class="p">},</span>
</pre></table></code></div></div><p><a href=" /images/esr05.png" class="popup img-link shimmer"><img src=" /images/esr05.png" alt="" loading="lazy"></a></p><p>In this example, the filter was able to use the index selectively to identify the 4 keys needed to satisfy the query, however the results are not known to be in order. This results in the identified keys being sorted in memory prior to be returned to the calling stage in the execution plan.</p><p>By moving the <em>Sort</em> predicate before the <em>Range</em> predicate however, even though more keys may need to be scanned the keys will be returned correctly ordered.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c1">// operation</span>
<span class="nf">createIndex</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">joined</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
<span class="nf">find</span><span class="p">({</span> <span class="na">joined</span><span class="p">:</span> <span class="p">{</span> <span class="na">$gt</span><span class="p">:</span> <span class="mi">2015</span> <span class="p">}</span> <span class="p">}).</span><span class="nf">sort</span><span class="p">({</span> <span class="na">region</span><span class="p">:</span> <span class="mi">1</span> <span class="p">})</span>
</pre></table></code></div></div><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// execution stats</span>
<span class="dl">"</span><span class="s2">nReturned</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalKeysExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">totalDocsExamined</span><span class="dl">"</span> <span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
<span class="dl">"</span><span class="s2">executionStages</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="dl">"</span><span class="s2">inputStage</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">stage</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">IXSCAN</span><span class="dl">"</span><span class="p">,</span>
        <span class="p">...</span>
        <span class="dl">"</span><span class="s2">indexBounds</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">region</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">[MinKey, MaxKey]</span><span class="dl">"</span>
            <span class="p">],</span>
            <span class="dl">"</span><span class="s2">joined</span><span class="dl">"</span> <span class="p">:</span> <span class="p">[</span>
                <span class="dl">"</span><span class="s2">[MinKey, MaxKey]</span><span class="dl">"</span>
            <span class="p">]</span>
        <span class="p">},</span>
</pre></table></code></div></div><p><a href=" /images/esr06.png" class="popup img-link shimmer"><img src=" /images/esr06.png" alt="" loading="lazy"></a></p><p>Though this method requires scanning additional keys the lack of a blocking sort will generally be far more efficient/performant.</p><p>I hope that the <em>ESR “Rule”</em> helps you optimize your MongoDB indexes and improve your query performance. If you have questions, feel free to hit me up in the comments, or check out the <a href="https://developer.mongodb.com/community/forums/">MongoDB Developer Community forums</a>.</p><p>If you need more timely assistance, consider MongoDB’s <a href="https://docs.atlas.mongodb.com/support/">Atlas Developer Support</a> or <a href="https://www.mongodb.com/products/enterprise-grade-support">Enterprise Support</a>.</p><p>Cheers, and happy optimizing!</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/mongodb/">MongoDB</a>, <a href="/categories/queries-indexing/">Queries & Indexing</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Optimizing%20MongoDB%20Compound%20Indexes%20-%20The%20%22Equality%20-%20Sort%20-%20Range%22%20(ESR)%20Rule%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F05%2F16%2Foptimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Optimizing%20MongoDB%20Compound%20Indexes%20-%20The%20%22Equality%20-%20Sort%20-%20Range%22%20(ESR)%20Rule%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F05%2F16%2Foptimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F05%2F16%2Foptimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule%2F&text=Optimizing%20MongoDB%20Compound%20Indexes%20-%20The%20%22Equality%20-%20Sort%20-%20Range%22%20(ESR)%20Rule%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F05%2F16%2Foptimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Optimizing%20MongoDB%20Compound%20Indexes%20-%20The%20%22Equality%20-%20Sort%20-%20Range%22%20(ESR)%20Rule%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2020%2F05%2F16%2Foptimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2024/04/26/event-monitoring-with-mongoose/">Event Monitoring with Mongoose</a><li class="text-truncate lh-lg"> <a href="/blog/2024/04/25/police-quest-open-season/">Police Quest: Open Season (Sierra On-Line) - 1993</a><li class="text-truncate lh-lg"> <a href="/blog/2021/07/28/adventure-games-1980-1999/">Let's Adventure! A Journey into Adventure Games (1980-1999)</a><li class="text-truncate lh-lg"> <a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Let's Adventure! Reviewed Games Sorted by Score</a><li class="text-truncate lh-lg"> <a href="/blog/2023/02/10/beneath-a-steel-sky/">Beneath a Steel Sky (Revolution Software) - 1994</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/blog/2020/01/17/current-date-math-in-mongodb-aggregations/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1579260617" data-df="ll" > Jan 17, 2020 </time><h4 class="pt-0 my-2">Current Date Math in MongoDB Aggregations</h4><div class="text-muted"><p> A challenge that I’ve had in the past while working with my data in MongoDB has been how to incorporate date math into my aggregations. db.foo.insertMany([ { lastUpdated: new Date(new Date().setDa...</p></div></div></a></article><article class="col"> <a href="/blog/2012/08/29/install-latest-mongodb-in-ubuntu/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1346262360" data-df="ll" > Aug 29, 2012 </time><h4 class="pt-0 my-2">Install Latest MongoDB in Ubuntu</h4><div class="text-muted"><p> A couple projects I work on use MongoDB as the database, and I’m generally not satisfied to use the (often outdated) version that ships with Ubuntu. As a result, I wrote this script to automate fe...</p></div></div></a></article><article class="col"> <a href="/blog/2018/08/14/hello-mongodb/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1534275064" data-df="ll" > Aug 14, 2018 </time><h4 class="pt-0 my-2">Hello MongoDB</h4><div class="text-muted"><p> As of August 13th, I am no longer a System Architect at DAC Group. I have a public post on LinkedIn that got some good traction, but to summarize it was time to move on. I’ve been a software engin...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/blog/2020/03/30/working-around-mongodb-stitchs-max-async-work-queue-limit/" class="btn btn-outline-primary" aria-label="Older" ><p>Working around MongoDB Stitch's "max async work queue" limit</p></a> <a href="/blog/2020/07/15/mongodb-4-dot-4-change-streams-and-pre-image-support/" class="btn btn-outline-primary" aria-label="Newer" ><p>MongoDB 4.4 Change Streams and Experimental Pre-Image 'Support'</p></a></nav><div id="disqus_thread"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/'; this.page.identifier = '/blog/2020/05/16/optimizing-mongodb-compound-indexes-the-equality-sort-range-esr-rule/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2024</time> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="/assets/lib/jquery/jquery.min.js"></script> <script src="/assets/lib/bootstrap/bootstrap.bundle.min.js"></script> <script src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script src="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.umd.min.js"></script> <script src="/assets/lib/magnific-popup/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/clipboard/clipboard.min.js"></script> <script src="/assets/lib/dayjs/dayjs.min.js"></script> <script src="/assets/lib/dayjs/locale/en.min.js"></script> <script src="/assets/lib/dayjs/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs/plugin/localizedFormat.min.js"></script> <script src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
