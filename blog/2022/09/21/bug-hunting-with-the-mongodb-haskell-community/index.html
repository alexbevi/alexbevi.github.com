<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Bug Hunting with the MongoDB Haskell Community" /><meta name="author" content="Alex Bevilacqua" /><meta property="og:locale" content="en_US" /><meta name="description" content="MongoDB currently maintains 10 programming language Drivers in-house, including a Ruby driver for which I’m presently the Product Manager. Additionally we also have a library of community maintained drivers, built using the MongoDB Driver specifications our engineers maintain and publish." /><meta property="og:description" content="MongoDB currently maintains 10 programming language Drivers in-house, including a Ruby driver for which I’m presently the Product Manager. Additionally we also have a library of community maintained drivers, built using the MongoDB Driver specifications our engineers maintain and publish." /><link rel="canonical" href="https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-21T06:21:02-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Bug Hunting with the MongoDB Haskell Community" /><meta name="twitter:site" content="@alexbevi" /><meta name="twitter:creator" content="@Alex Bevilacqua" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alex Bevilacqua"},"dateModified":"2022-10-06T03:13:06-04:00","datePublished":"2022-09-21T06:21:02-04:00","description":"MongoDB currently maintains 10 programming language Drivers in-house, including a Ruby driver for which I’m presently the Product Manager. Additionally we also have a library of community maintained drivers, built using the MongoDB Driver specifications our engineers maintain and publish.","headline":"Bug Hunting with the MongoDB Haskell Community","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/"},"url":"https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/"}</script><title>Bug Hunting with the MongoDB Haskell Community | ALEX BEVILACQUA</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/galleria.min.js"></script><link href="//cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/themes/classic/galleria.classic.min.css" media="screen, projection" rel="stylesheet" type="text/css" /><style> /* This rule is read by Galleria to define the gallery height: */ .galleria{ width: 700px; height: 400px; background: #000 } .responsive-wrap iframe{ max-width: 100%;}</style><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /images/avatar.png " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle font-italic">my little corner of the interwebs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href=" https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href=" /feed.xml " aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href=" https://linkedin.com/in/alexbevi " aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href=" https://stackoverflow.com/users/195509 " aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <a href=" https://www.facebook.com/alexbevi " aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href=" https://reddit.com/user/alexbevi " aria-label="reddit" target="_blank" rel="noopener"> <i class="fab fa-reddit"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> Blog </span> <span> 2022 </span> <span> 09 </span> <span> 21 </span> <span>Bug Hunting with the MongoDB Haskell Community</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Bug Hunting with the MongoDB Haskell Community</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Sep 21, 2022, 6:21 AM -0400" > Sep 21, 2022 <i class="unloaded">2022-09-21T06:21:02-04:00</i> </span> by <span class="author"> Alex Bevilacqua </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Thu, Oct 6, 2022, 3:13 AM -0400" > Oct 6, 2022 <i class="unloaded">2022-10-06T03:13:06-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1282 words">7 min</span></div></div><div class="post-content"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/images/mongodb-logo.png" class="preview-img" alt="MongoDB Logo"><p>MongoDB currently maintains 10 programming language <a href="https://www.mongodb.com/docs/drivers/">Drivers</a> in-house, including a <a href="https://www.mongodb.com/docs/ruby-driver/current/">Ruby</a> driver for which I’m presently the Product Manager. Additionally we also have a library of <a href="https://www.mongodb.com/docs/drivers/community-supported-drivers/">community maintained drivers</a>, built using the <a href="https://github.com/mongodb/specifications/tree/master/source">MongoDB Driver specifications</a> our engineers maintain and publish.</p><p>It was brought to my attention that one of these community drivers - the <a href="https://github.com/mongodb-haskell/mongodb">Haskell driver</a> - was experiencing an issue whereby queries were no longer returning results from the <a href="https://www.mongodb.com/docs/atlas/">MongoDB Atlas</a> clusters their applications were connected to.</p><p>Though I’ve never worked with <a href="https://www.haskell.org/">Haskell</a>, before joining the team I worked in <a href="/blog/2018/10/01/technical-services-engineering-at-mongodb/">Technical Services</a> providing support for customers experiencing problems with their applications via our drivers. This seemed like an interesting problem we could hopefully solve for our developer community so I’d like to share the diagnostic journey that lead us to the issue and ultimately enabled a resolution.</p><h2 id="overview">Overview</h2><p>When <a href="https://github.com/why-not-try-calmer">Adrien</a> first reported <a href="https://github.com/mongodb-haskell/mongodb/issues/131">issue #131 on GitHub</a> the initial assessment was that their application could successfully connect to a MongoDB Atlas cluster and write new content, but when trying to read those results back the result set was always empty. This had happened suddenly causing existing applications and workloads to break however no new code had been introduced which could potentially be the culprit.</p><p>As I’m unfamiliar with Haskell Adrien kindly provided a <a href="https://github.com/why-not-try-calmer/test-mongo">Dockerized reproduction</a> I could use to test this issue against my own Atlas clusters. This reproduction would write 3 documents to a collection, then try to read 3 documents back. To begin testing I setup an M10 cluster and ran the tests a few times.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Failures:

  src/Lib.hs:101:33:
  1) Reads Ensures reads work
       expected: 3
        but got: 9
</pre></table></code></div></div><p>Each time I ran the test it would fail, but the number of documents in the <em>“Ensures reads work”</em> that were received kept increasing. The cluster I was testing on was a dedicated cluster, however MongoDB Atlas also offers free and shared tier clusters so for completeness of testing I configured an M0 next and re-ran the tests.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Failures:

  src/Lib.hs:101:33:
  1) Reads Ensures reads work
       expected: 3
        but got: 0
</pre></table></code></div></div><p>No matter how many times I ran the tests against my M0 (also tested M2 and M5) the results were always 0.</p><p>Just to make sure this wasn’t a larger issue I tested with a script that uses the Ruby driver against an M0 cluster to verify the behavior didn’t reproduce there:</p><div class="language-ruby highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nb">require</span> <span class="s1">'bundler/inline'</span>

<span class="n">gemfile</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
  <span class="n">gem</span> <span class="s1">'mongo'</span>
<span class="k">end</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'mongodb+srv://....mongodb.net/test'</span><span class="p">)</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="ss">:foo</span><span class="p">]</span>
<span class="n">collection</span><span class="p">.</span><span class="nf">drop</span>

<span class="nb">puts</span> <span class="s2">"Found </span><span class="si">#{</span><span class="n">collection</span><span class="p">.</span><span class="nf">find</span><span class="p">.</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">length</span><span class="si">}</span><span class="s2"> documents"</span>
<span class="c1"># =&gt; Found 0 documents</span>

<span class="n">collection</span><span class="p">.</span><span class="nf">insert_many</span><span class="p">([].</span><span class="nf">fill</span><span class="p">({</span> <span class="s2">"bar"</span><span class="p">:</span> <span class="s2">"baz"</span> <span class="p">},</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">puts</span> <span class="s2">"Found </span><span class="si">#{</span><span class="n">collection</span><span class="p">.</span><span class="nf">find</span><span class="p">.</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">length</span><span class="si">}</span><span class="s2"> documents"</span>
<span class="c1"># =&gt; Found 3 documents</span>
</pre></table></code></div></div><p>The script would produce the expected result, which further pointed to a potential issue on the Atlas side that was specific to free and shared tier clusters.</p><p>MongoDB Atlas imposes some <a href="https://www.mongodb.com/docs/atlas/reference/free-shared-limitations/">limitations on free and shared tier</a> clusters, which in some cases are enforced by a proxy layer between the application and the underlying infrastructure backing the cluster.</p><h2 id="analysis">Analysis</h2><p>Now that the issue was narrowed down, working with a Cloud Operations Engineer to create an isolated M2 cluster in a development environment, we increased the <a href="https://www.mongodb.com/docs/manual/reference/log-messages/#verbosity-levels">log verbosity</a> for that cluster for <a href="https://www.mongodb.com/docs/manual/reference/log-messages/#mongodb-data-QUERY"><code class="language-plaintext highlighter-rouge">QUERY</code></a> and <a href="https://www.mongodb.com/docs/manual/reference/log-messages/#mongodb-data-COMMAND"><code class="language-plaintext highlighter-rouge">COMMAND</code></a> log components.</p><p>With this information, when we download logs for the node our test is targeting we should be able to get a lot more information as to what was being executed and where it might be failing.</p><div class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">// Test #1</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">$date</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2022-08-18T11:19:16.985+00:00</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">s</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">D2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">c</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">COMMAND</span><span class="dl">"</span><span class="p">,</span>  <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="mi">5578800</span><span class="p">,</span> <span class="dl">"</span><span class="s2">ctx</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">conn24194</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">msg</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Deprecated operation requested. The client driver may require an upgrade in order to ensure compatibility with future server versions. For more details see https://dochub.mongodb.org/core/legacy-opcode-compatibility</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">attr</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">op</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">query</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">clientInfo</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">driver</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">mongo-go-driver</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">version</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">v1.7.2+prerelease</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">os</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">linux</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">architecture</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">arm64</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">platform</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">go1.18.2</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">application</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Atlas Proxy v20220824.0.0.1660656950</span><span class="dl">"</span><span class="p">}}}}</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">$date</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2022-08-18T11:19:16.986+00:00</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">s</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">D2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">c</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">QUERY</span><span class="dl">"</span><span class="p">,</span>    <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="mi">20914</span><span class="p">,</span>   <span class="dl">"</span><span class="s2">ctx</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">conn24194</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">msg</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Running query</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">attr</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">query</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ns: 62fe1f7d37518e1c32149694_haskell.test123 query: { comment: { AtlasProxyAppName: </span><span class="se">\"\"</span><span class="s2">, AtlasProxyClientMetadata: {} } } sort: {} projection: {}</span><span class="dl">"</span><span class="p">}}</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">$date</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2022-08-18T11:19:16.986+00:00</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">s</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">D5</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">c</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">QUERY</span><span class="dl">"</span><span class="p">,</span>    <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="mi">20917</span><span class="p">,</span>   <span class="dl">"</span><span class="s2">ctx</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">conn24194</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">msg</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Not caching executor but returning results</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">attr</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">numResults</span><span class="dl">"</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span>
</pre></table></code></div></div><p>Based on log analysis we could not only verify the issue existed, but why it was affecting these operations from the Haskell driver:</p><p><strong>A deprecated operation was being run</strong></p><p>MongoDB uses a <a href="https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/">wire protocol</a> when sending/receiving messages internally and externally (via Drivers). Initially a number of <a href="https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/#opcodes">opcodes</a> existed, but starting with MongoDB 5.0 most of these were deprecated in favor of <a href="https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/#op_msg"><code class="language-plaintext highlighter-rouge">OP_MSG</code></a>.</p><p>Prior to MongoDB 3.6 when <a href="https://www.mongodb.com/docs/v5.0/release-notes/3.6/#wire-protocol-and-compression"><code class="language-plaintext highlighter-rouge">OP_MSG</code> was introduced</a> to subsume existing opcodes, query operations were executed via <a href="https://www.mongodb.com/docs/manual/legacy-opcodes/#op_query"><code class="language-plaintext highlighter-rouge">OP_QUERY</code></a>, which the Haskell driver is apparently still using for query execution.</p><p>Note that though <code class="language-plaintext highlighter-rouge">OP_QUERY</code> is deprecated, it would still be supported in the version of MongoDB we were testing (5.0) and as such is not the cause of this problem.</p><p><strong>The logs confirm no results are being returned by the query</strong></p><p>At the default level, the <a href="https://www.mongodb.com/docs/manual/tutorial/manage-the-database-profiler/">Database Profiler</a> will only output queries to the <code class="language-plaintext highlighter-rouge">mongod</code> logs if they exceed the slow query threshold (<a href="https://www.mongodb.com/docs/manual/reference/method/db.setProfilingLevel/#std-label-set-profiling-level-options-slowms"><code class="language-plaintext highlighter-rouge">slowms</code></a>) of 100ms. The tests we were running would likely have completed in under 10ms, which prevented anything useful from being logged.</p><blockquote><p><code class="language-plaintext highlighter-rouge">{"t":{"$date":"2022-08-18T11:19:16.986+00:00"},"s":"D5", "c":"QUERY", "id":20917, "ctx":"conn24194","msg":"Not caching executor but returning results","attr":{"numResults":0}}</code></p></blockquote><p>Once the log level was increased it was apparent that the operation in question was being executed, but was not returning any results.</p><p><strong>The logs highlight an issue with the query itself</strong></p><p>With the log level increased however the <code class="language-plaintext highlighter-rouge">QUERY</code> component logs showed clearly that not only were no results being returned, but the query <em>shape</em> that was being sent to the server didn’t match what we expected:</p><blockquote><p><code class="language-plaintext highlighter-rouge">{"t":{"$date":"2022-08-18T11:19:16.986+00:00"},"s":"D2", "c":"QUERY", "id":20914, "ctx":"conn24194","msg":"Running query","attr":{"query":"ns: 62fe1f7d37518e1c32149694_haskell.test123 query: { comment: { AtlasProxyAppName: \"\", AtlasProxyClientMetadata: {} } } sort: {} projection: {}"}}</code></p></blockquote><p>It appeared that the query’s filter - which we expected to be empty - was in fact filtering for <code class="language-plaintext highlighter-rouge">comment: { AtlasProxyAppName: "", AtlasProxyClientMetadata: {} }</code>. Since none of the sample documents that were being created as part of this test matched these criteria, the query returned 0 results.</p><h2 id="findings">Findings</h2><p>From our log analysis it would appear our operations were being rewritten to append a filter criteria for a <code class="language-plaintext highlighter-rouge">comment</code> field with a value of <code class="language-plaintext highlighter-rouge">{ AtlasProxyAppName: "", AtlasProxyClientMetadata: {} }</code>. As <code class="language-plaintext highlighter-rouge">comment</code> has a specific meaning within the context of MongoDB commands it was becoming apparent what the issue was and where it may have originated.</p><p>Starting with <a href="https://www.mongodb.com/docs/manual/release-notes/4.4/#comment-option-available-to-all-database-commands">MongoDB 4.4, a <code class="language-plaintext highlighter-rouge">comment</code> option was added to all database commands</a> (see <a href="https://jira.mongodb.org/browse/SERVER-29794">SERVER-29794</a>). This was not be confused with the <a href="https://www.mongodb.com/docs/v4.2/reference/operator/meta/comment/"><code class="language-plaintext highlighter-rouge">$comment</code> meta operator</a> that has been available <a href="https://jira.mongodb.org/browse/SERVER-2515">since MongoDB 2.0</a> for propagating metadata to query logs.</p><p>The Atlas team introduced a feature (released <code class="language-plaintext highlighter-rouge">2022-06-22</code>) that would utilize these comments to improve the <a href="https://www.mongodb.com/docs/manual/reference/command/currentOp/"><code class="language-plaintext highlighter-rouge">currentOp</code></a> output in free/shared clusters. As all “official” MongoDB Drivers communicate with modern MongoDB clusters using <code class="language-plaintext highlighter-rouge">OP_MSG</code>, when this feature was being tested there were no issues.</p><p>Unfortunately, drivers that still use <code class="language-plaintext highlighter-rouge">OP_QUERY</code> to make queries were negatively impacted as a result of the metadata comment injection occurring in the filter instead of one level above as is the case for <code class="language-plaintext highlighter-rouge">OP_MSG</code>.</p><p>Now that the issue could be verified, additional logic was introduced to use the <code class="language-plaintext highlighter-rouge">$comment</code> meta operator if an <code class="language-plaintext highlighter-rouge">OP_QUERY</code> was detected instead of improperly applying a <code class="language-plaintext highlighter-rouge">comment</code> option.</p><h2 id="outcome">Outcome</h2><p>With the assistance of the Haskell community we were able to identify and address a deficiency in the free and shared tiers of MongoDB Atlas. The fix for this was released in version <code class="language-plaintext highlighter-rouge">8ed75a4810@v20220914</code> on 2022-09-21, and any Haskell application using the community maintained Haskell driver should have started working as expected without the need for additional intervention.</p><p>We truly appreciate the investment our developer communities make when they put time and effort into building something as powerful as a MongoDB driver and want to ensure we do what we can to offer assistance if possible.</p><div class="note info"> <small><em>Cross posted to <a href="https://dev.to/alexbevi/bug-hunting-with-the-mongodb-haskell-community-469j">DEV</a></em></small></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/drivers/" class="post-tag no-text-decoration" >drivers</a> <a href="/tags/haskell/" class="post-tag no-text-decoration" >haskell</a> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Bug Hunting with the MongoDB Haskell Community - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Bug Hunting with the MongoDB Haskell Community - ALEX BEVILACQUA&u=https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Bug Hunting with the MongoDB Haskell Community - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Bug Hunting with the MongoDB Haskell Community - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2023/02/13/ruby-on-rails-global-summit-23/">Ruby on Rails Global Summit '23</a><li><a href="/blog/2022/11/02/mongodb-orms-odms-and-libraries/">MongoDB ORMs, ODMs, and Libraries</a><li><a href="/blog/2021/07/28/adventure-games-1980-1999/">Journey into Adventure Games (1980-1999)</a><li><a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Adventure Games (1980-1999): Sorted by Score</a><li><a href="/blog/2023/02/10/beneath-a-steel-sky/">Beneath a Steel Sky (Revolution Software) - 1994</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/rails/">rails</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2023/01/13/will-upgrading-my-mongodb-server-version-break-my-application/"><div class="card-body"> <span class="timeago small" > Jan 13 <i class="unloaded">2023-01-13T09:21:00-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Will Upgrading My MongoDB Server Version Break My Application?</h3><div class="text-muted small"><p> Upgrading components is an important part of maintaining a healthy application. The MongoDB Server is continually being developed to include new features and functionality, as well as to fix bugs, ...</p></div></div></a></div><div class="card"> <a href="/blog/2021/12/23/mongodb-driver-specifications/"><div class="card-body"> <span class="timeago small" > Dec 23, 2021 <i class="unloaded">2021-12-23T10:08:19-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MongoDB Driver Specifications</h3><div class="text-muted small"><p> To ensure official MongoDB Drivers are developed with consistent functionality and APIs MongoDB maintains a set of public specifications (see GitHub Repository) that driver engineers can reference ...</p></div></div></a></div><div class="card"> <a href="/blog/2022/05/15/mongodb-driver-monitoring/"><div class="card-body"> <span class="timeago small" > May 15, 2022 <i class="unloaded">2022-05-15T08:27:09-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MongoDB Driver Monitoring</h3><div class="text-muted small"><p> One of the great things about MongoDB Drivers is that they are all built around a common set of specifications. Though these specifications exist to facilitate the development of new language drive...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2022/09/15/createindex-error-values-in-v-2-index-key-pattern-cannot-be-of-type-object/" class="btn btn-outline-primary" prompt="Older"><p>Solving a mongorestore failure due to 'Values in v:2 index key pattern cannot be of type object.'</p></a> <a href="/blog/2022/10/06/from-engineering-to-product-management/" class="btn btn-outline-primary" prompt="Newer"><p>From Engineering to Product Management</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//alexbevi.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Bug Hunting with the MongoDB Haskell Community'; this.page.url = 'https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/'; this.page.identifier = '/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/rails/">rails</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.alexbevi.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script type="text/javascript" src="/assets/js/lightbox.js"></script><link rel="stylesheet" href="/assets/css/lightbox.css">
