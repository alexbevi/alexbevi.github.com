<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Bug Hunting with the MongoDB Haskell Community" /><meta property="og:locale" content="en" /><meta name="description" content="MongoDB currently maintains 10 programming language Drivers in-house, including a Ruby driver for which I’m presently the Product Manager. Additionally we also have a library of community maintained drivers, built using the MongoDB Driver specifications our engineers maintain and publish." /><meta property="og:description" content="MongoDB currently maintains 10 programming language Drivers in-house, including a Ruby driver for which I’m presently the Product Manager. Additionally we also have a library of community maintained drivers, built using the MongoDB Driver specifications our engineers maintain and publish." /><link rel="canonical" href="https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-09-21T06:21:02-04:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="twitter:title" content="Bug Hunting with the MongoDB Haskell Community" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-09T12:45:05-04:00","datePublished":"2022-09-21T06:21:02-04:00","description":"MongoDB currently maintains 10 programming language Drivers in-house, including a Ruby driver for which I’m presently the Product Manager. Additionally we also have a library of community maintained drivers, built using the MongoDB Driver specifications our engineers maintain and publish.","headline":"Bug Hunting with the MongoDB Haskell Community","image":"https://www.alexbevi.com/images/mongodb-logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/"},"url":"https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/"}</script><title>Bug Hunting with the MongoDB Haskell Community | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="/assets/lib/bootstrap/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup/magnific-popup.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><meta name="google-adsense-account" content="ca-pub-6215800856413580"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src=" /./images/avatar.png " width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">ALEX BEVILACQUA</a></h1><p class="site-subtitle fst-italic mb-0">my little corner of the interwebs</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Bug Hunting with the MongoDB Haskell Community</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Bug Hunting with the MongoDB Haskell Community</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1663755662" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Sep 21, 2022 </time> </span> <span> Updated <time data-ts="1683650705" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 9, 2023 </time> </span><div class="mt-3 mb-3"> <a href=" /images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src=" /images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1282 words" > <em>7 min</em> read </span></div></div></header><div class="content"><p>MongoDB currently maintains 10 programming language <a href="https://www.mongodb.com/docs/drivers/">Drivers</a> in-house, including a <a href="https://www.mongodb.com/docs/ruby-driver/current/">Ruby</a> driver for which I’m presently the Product Manager. Additionally we also have a library of <a href="https://www.mongodb.com/docs/drivers/community-supported-drivers/">community maintained drivers</a>, built using the <a href="https://github.com/mongodb/specifications/tree/master/source">MongoDB Driver specifications</a> our engineers maintain and publish.</p><p>It was brought to my attention that one of these community drivers - the <a href="https://github.com/mongodb-haskell/mongodb">Haskell driver</a> - was experiencing an issue whereby queries were no longer returning results from the <a href="https://www.mongodb.com/docs/atlas/">MongoDB Atlas</a> clusters their applications were connected to.</p><p>Though I’ve never worked with <a href="https://www.haskell.org/">Haskell</a>, before joining the team I worked in <a href="/blog/2018/10/01/technical-services-engineering-at-mongodb/">Technical Services</a> providing support for customers experiencing problems with their applications via our drivers. This seemed like an interesting problem we could hopefully solve for our developer community so I’d like to share the diagnostic journey that lead us to the issue and ultimately enabled a resolution.</p><h2 id="overview"><span class="me-2">Overview</span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When <a href="https://github.com/why-not-try-calmer">Adrien</a> first reported <a href="https://github.com/mongodb-haskell/mongodb/issues/131">issue #131 on GitHub</a> the initial assessment was that their application could successfully connect to a MongoDB Atlas cluster and write new content, but when trying to read those results back the result set was always empty. This had happened suddenly causing existing applications and workloads to break however no new code had been introduced which could potentially be the culprit.</p><p>As I’m unfamiliar with Haskell Adrien kindly provided a <a href="https://github.com/why-not-try-calmer/test-mongo">Dockerized reproduction</a> I could use to test this issue against my own Atlas clusters. This reproduction would write 3 documents to a collection, then try to read 3 documents back. To begin testing I setup an M10 cluster and ran the tests a few times.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Failures:

  src/Lib.hs:101:33:
  1) Reads Ensures reads work
       expected: 3
        but got: 9
</pre></table></code></div></div><p>Each time I ran the test it would fail, but the number of documents in the <em>“Ensures reads work”</em> that were received kept increasing. The cluster I was testing on was a dedicated cluster, however MongoDB Atlas also offers free and shared tier clusters so for completeness of testing I configured an M0 next and re-ran the tests.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>Failures:

  src/Lib.hs:101:33:
  1) Reads Ensures reads work
       expected: 3
        but got: 0
</pre></table></code></div></div><p>No matter how many times I ran the tests against my M0 (also tested M2 and M5) the results were always 0.</p><p>Just to make sure this wasn’t a larger issue I tested with a script that uses the Ruby driver against an M0 cluster to verify the behavior didn’t reproduce there:</p><div class="language-ruby highlighter-rouge"><div class="code-header"> <span data-label-text="Ruby"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="nb">require</span> <span class="s1">'bundler/inline'</span>

<span class="n">gemfile</span> <span class="k">do</span>
  <span class="n">source</span> <span class="s1">'https://rubygems.org'</span>
  <span class="n">gem</span> <span class="s1">'mongo'</span>
<span class="k">end</span>

<span class="n">client</span> <span class="o">=</span> <span class="no">Mongo</span><span class="o">::</span><span class="no">Client</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'mongodb+srv://....mongodb.net/test'</span><span class="p">)</span>
<span class="n">collection</span> <span class="o">=</span> <span class="n">client</span><span class="p">[</span><span class="ss">:foo</span><span class="p">]</span>
<span class="n">collection</span><span class="p">.</span><span class="nf">drop</span>

<span class="nb">puts</span> <span class="s2">"Found </span><span class="si">#{</span><span class="n">collection</span><span class="p">.</span><span class="nf">find</span><span class="p">.</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">length</span><span class="si">}</span><span class="s2"> documents"</span>
<span class="c1"># =&gt; Found 0 documents</span>

<span class="n">collection</span><span class="p">.</span><span class="nf">insert_many</span><span class="p">([].</span><span class="nf">fill</span><span class="p">({</span> <span class="s2">"bar"</span><span class="p">:</span> <span class="s2">"baz"</span> <span class="p">},</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="nb">puts</span> <span class="s2">"Found </span><span class="si">#{</span><span class="n">collection</span><span class="p">.</span><span class="nf">find</span><span class="p">.</span><span class="nf">to_a</span><span class="p">.</span><span class="nf">length</span><span class="si">}</span><span class="s2"> documents"</span>
<span class="c1"># =&gt; Found 3 documents</span>
</pre></table></code></div></div><p>The script would produce the expected result, which further pointed to a potential issue on the Atlas side that was specific to free and shared tier clusters.</p><p>MongoDB Atlas imposes some <a href="https://www.mongodb.com/docs/atlas/reference/free-shared-limitations/">limitations on free and shared tier</a> clusters, which in some cases are enforced by a proxy layer between the application and the underlying infrastructure backing the cluster.</p><h2 id="analysis"><span class="me-2">Analysis</span><a href="#analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that the issue was narrowed down, working with a Cloud Operations Engineer to create an isolated M2 cluster in a development environment, we increased the <a href="https://www.mongodb.com/docs/manual/reference/log-messages/#verbosity-levels">log verbosity</a> for that cluster for <a href="https://www.mongodb.com/docs/manual/reference/log-messages/#mongodb-data-QUERY"><code class="language-plaintext highlighter-rouge">QUERY</code></a> and <a href="https://www.mongodb.com/docs/manual/reference/log-messages/#mongodb-data-COMMAND"><code class="language-plaintext highlighter-rouge">COMMAND</code></a> log components.</p><p>With this information, when we download logs for the node our test is targeting we should be able to get a lot more information as to what was being executed and where it might be failing.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="c1">// Test #1</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">$date</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2022-08-18T11:19:16.985+00:00</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">s</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">D2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">c</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">COMMAND</span><span class="dl">"</span><span class="p">,</span>  <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="mi">5578800</span><span class="p">,</span> <span class="dl">"</span><span class="s2">ctx</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">conn24194</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">msg</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Deprecated operation requested. The client driver may require an upgrade in order to ensure compatibility with future server versions. For more details see https://dochub.mongodb.org/core/legacy-opcode-compatibility</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">attr</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">op</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">query</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">clientInfo</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">driver</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">mongo-go-driver</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">version</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">v1.7.2+prerelease</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">os</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">type</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">linux</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">architecture</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">arm64</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">platform</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">go1.18.2</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">application</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">name</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Atlas Proxy v20220824.0.0.1660656950</span><span class="dl">"</span><span class="p">}}}}</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">$date</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2022-08-18T11:19:16.986+00:00</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">s</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">D2</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">c</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">QUERY</span><span class="dl">"</span><span class="p">,</span>    <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="mi">20914</span><span class="p">,</span>   <span class="dl">"</span><span class="s2">ctx</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">conn24194</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">msg</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Running query</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">attr</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">query</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">ns: 62fe1f7d37518e1c32149694_haskell.test123 query: { comment: { AtlasProxyAppName: </span><span class="se">\"\"</span><span class="s2">, AtlasProxyClientMetadata: {} } } sort: {} projection: {}</span><span class="dl">"</span><span class="p">}}</span>
<span class="p">{</span><span class="dl">"</span><span class="s2">t</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">$date</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">2022-08-18T11:19:16.986+00:00</span><span class="dl">"</span><span class="p">},</span><span class="dl">"</span><span class="s2">s</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">D5</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">c</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">QUERY</span><span class="dl">"</span><span class="p">,</span>    <span class="dl">"</span><span class="s2">id</span><span class="dl">"</span><span class="p">:</span><span class="mi">20917</span><span class="p">,</span>   <span class="dl">"</span><span class="s2">ctx</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">conn24194</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">msg</span><span class="dl">"</span><span class="p">:</span><span class="dl">"</span><span class="s2">Not caching executor but returning results</span><span class="dl">"</span><span class="p">,</span><span class="dl">"</span><span class="s2">attr</span><span class="dl">"</span><span class="p">:{</span><span class="dl">"</span><span class="s2">numResults</span><span class="dl">"</span><span class="p">:</span><span class="mi">0</span><span class="p">}}</span>
</pre></table></code></div></div><p>Based on log analysis we could not only verify the issue existed, but why it was affecting these operations from the Haskell driver:</p><p><strong>A deprecated operation was being run</strong></p><p>MongoDB uses a <a href="https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/">wire protocol</a> when sending/receiving messages internally and externally (via Drivers). Initially a number of <a href="https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/#opcodes">opcodes</a> existed, but starting with MongoDB 5.0 most of these were deprecated in favor of <a href="https://www.mongodb.com/docs/manual/reference/mongodb-wire-protocol/#op_msg"><code class="language-plaintext highlighter-rouge">OP_MSG</code></a>.</p><p>Prior to MongoDB 3.6 when <a href="https://www.mongodb.com/docs/v5.0/release-notes/3.6/#wire-protocol-and-compression"><code class="language-plaintext highlighter-rouge">OP_MSG</code> was introduced</a> to subsume existing opcodes, query operations were executed via <a href="https://www.mongodb.com/docs/manual/legacy-opcodes/#op_query"><code class="language-plaintext highlighter-rouge">OP_QUERY</code></a>, which the Haskell driver is apparently still using for query execution.</p><p>Note that though <code class="language-plaintext highlighter-rouge">OP_QUERY</code> is deprecated, it would still be supported in the version of MongoDB we were testing (5.0) and as such is not the cause of this problem.</p><p><strong>The logs confirm no results are being returned by the query</strong></p><p>At the default level, the <a href="https://www.mongodb.com/docs/manual/tutorial/manage-the-database-profiler/">Database Profiler</a> will only output queries to the <code class="language-plaintext highlighter-rouge">mongod</code> logs if they exceed the slow query threshold (<a href="https://www.mongodb.com/docs/manual/reference/method/db.setProfilingLevel/#std-label-set-profiling-level-options-slowms"><code class="language-plaintext highlighter-rouge">slowms</code></a>) of 100ms. The tests we were running would likely have completed in under 10ms, which prevented anything useful from being logged.</p><blockquote><p><code class="language-plaintext highlighter-rouge">{"t":{"$date":"2022-08-18T11:19:16.986+00:00"},"s":"D5", "c":"QUERY", "id":20917, "ctx":"conn24194","msg":"Not caching executor but returning results","attr":{"numResults":0}}</code></p></blockquote><p>Once the log level was increased it was apparent that the operation in question was being executed, but was not returning any results.</p><p><strong>The logs highlight an issue with the query itself</strong></p><p>With the log level increased however the <code class="language-plaintext highlighter-rouge">QUERY</code> component logs showed clearly that not only were no results being returned, but the query <em>shape</em> that was being sent to the server didn’t match what we expected:</p><blockquote><p><code class="language-plaintext highlighter-rouge">{"t":{"$date":"2022-08-18T11:19:16.986+00:00"},"s":"D2", "c":"QUERY", "id":20914, "ctx":"conn24194","msg":"Running query","attr":{"query":"ns: 62fe1f7d37518e1c32149694_haskell.test123 query: { comment: { AtlasProxyAppName: \"\", AtlasProxyClientMetadata: {} } } sort: {} projection: {}"}}</code></p></blockquote><p>It appeared that the query’s filter - which we expected to be empty - was in fact filtering for <code class="language-plaintext highlighter-rouge">comment: { AtlasProxyAppName: "", AtlasProxyClientMetadata: {} }</code>. Since none of the sample documents that were being created as part of this test matched these criteria, the query returned 0 results.</p><h2 id="findings"><span class="me-2">Findings</span><a href="#findings" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>From our log analysis it would appear our operations were being rewritten to append a filter criteria for a <code class="language-plaintext highlighter-rouge">comment</code> field with a value of <code class="language-plaintext highlighter-rouge">{ AtlasProxyAppName: "", AtlasProxyClientMetadata: {} }</code>. As <code class="language-plaintext highlighter-rouge">comment</code> has a specific meaning within the context of MongoDB commands it was becoming apparent what the issue was and where it may have originated.</p><p>Starting with <a href="https://www.mongodb.com/docs/manual/release-notes/4.4/#comment-option-available-to-all-database-commands">MongoDB 4.4, a <code class="language-plaintext highlighter-rouge">comment</code> option was added to all database commands</a> (see <a href="https://jira.mongodb.org/browse/SERVER-29794">SERVER-29794</a>). This was not be confused with the <a href="https://www.mongodb.com/docs/v4.2/reference/operator/meta/comment/"><code class="language-plaintext highlighter-rouge">$comment</code> meta operator</a> that has been available <a href="https://jira.mongodb.org/browse/SERVER-2515">since MongoDB 2.0</a> for propagating metadata to query logs.</p><p>The Atlas team introduced a feature (released <code class="language-plaintext highlighter-rouge">2022-06-22</code>) that would utilize these comments to improve the <a href="https://www.mongodb.com/docs/manual/reference/command/currentOp/"><code class="language-plaintext highlighter-rouge">currentOp</code></a> output in free/shared clusters. As all “official” MongoDB Drivers communicate with modern MongoDB clusters using <code class="language-plaintext highlighter-rouge">OP_MSG</code>, when this feature was being tested there were no issues.</p><p>Unfortunately, drivers that still use <code class="language-plaintext highlighter-rouge">OP_QUERY</code> to make queries were negatively impacted as a result of the metadata comment injection occurring in the filter instead of one level above as is the case for <code class="language-plaintext highlighter-rouge">OP_MSG</code>.</p><p>Now that the issue could be verified, additional logic was introduced to use the <code class="language-plaintext highlighter-rouge">$comment</code> meta operator if an <code class="language-plaintext highlighter-rouge">OP_QUERY</code> was detected instead of improperly applying a <code class="language-plaintext highlighter-rouge">comment</code> option.</p><h2 id="outcome"><span class="me-2">Outcome</span><a href="#outcome" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>With the assistance of the Haskell community we were able to identify and address a deficiency in the free and shared tiers of MongoDB Atlas. The fix for this was released in version <code class="language-plaintext highlighter-rouge">8ed75a4810@v20220914</code> on 2022-09-21, and any Haskell application using the community maintained Haskell driver should have started working as expected without the need for additional intervention.</p><p>We truly appreciate the investment our developer communities make when they put time and effort into building something as powerful as a MongoDB driver and want to ensure we do what we can to offer assistance if possible.</p><blockquote class="prompt-info"><p>Cross posted to <a href="https://dev.to/alexbevi/bug-hunting-with-the-mongodb-haskell-community-469j">DEV</a></p></blockquote></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/mongodb/">MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/drivers/" class="post-tag no-text-decoration" >drivers</a> <a href="/tags/haskell/" class="post-tag no-text-decoration" >haskell</a> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Bug%20Hunting%20with%20the%20MongoDB%20Haskell%20Community%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F09%2F21%2Fbug-hunting-with-the-mongodb-haskell-community%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Bug%20Hunting%20with%20the%20MongoDB%20Haskell%20Community%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F09%2F21%2Fbug-hunting-with-the-mongodb-haskell-community%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F09%2F21%2Fbug-hunting-with-the-mongodb-haskell-community%2F&text=Bug%20Hunting%20with%20the%20MongoDB%20Haskell%20Community%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F09%2F21%2Fbug-hunting-with-the-mongodb-haskell-community%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Bug%20Hunting%20with%20the%20MongoDB%20Haskell%20Community%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F09%2F21%2Fbug-hunting-with-the-mongodb-haskell-community%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2024/01/29/innocent-until-caught/">Innocent Until Caught (Divide By Zero) - 1993</a><li class="text-truncate lh-lg"> <a href="/blog/2021/07/28/adventure-games-1980-1999/">Let's Adventure! A Journey into Adventure Games (1980-1999)</a><li class="text-truncate lh-lg"> <a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Let's Adventure! Reviewed Games Sorted by Score</a><li class="text-truncate lh-lg"> <a href="/blog/2024/01/20/day-of-the-tentacle/">Maniac Mansion: Day of the Tentacle (LucasArts) - 1993</a><li class="text-truncate lh-lg"> <a href="/blog/2023/12/27/tass-times-in-tonetown/">Tass Times in Tonetown (Interplay Productions, Brainwave Creations) - 1986</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/snes/">snes</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/blog/2023/01/13/will-upgrading-my-mongodb-server-version-break-my-application/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1673619660" data-df="ll" > Jan 13, 2023 </time><h4 class="pt-0 my-2">Will Upgrading My MongoDB Server Version Break My Application?</h4><div class="text-muted"><p> Upgrading components is an important part of maintaining a healthy application. The MongoDB Server is continually being developed to include new features and functionality, as well as to fix bugs, ...</p></div></div></a></article><article class="col"> <a href="/blog/2023/03/29/comparing-mongodb-to-not-mongodb-ex-documentdb-or-cosmos-db/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1680109957" data-df="ll" > Mar 29, 2023 </time><h4 class="pt-0 my-2">Comparing MongoDB to not-MongoDB (ex: DocumentDB or Cosmos DB)</h4><div class="text-muted"><p> Let’s start off first with what is MongoDB? MongoDB’s document model is simple for developers to learn and use, while still providing all the capabilities needed to meet the most complex requiremen...</p></div></div></a></article><article class="col"> <a href="/blog/2023/05/04/round-trips-to-authenticate-a-mongodb-client-connection/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1683225652" data-df="ll" > May 4, 2023 </time><h4 class="pt-0 my-2">Round Trips to Authenticate a MongoDB Client Connection</h4><div class="text-muted"><p> When MongoDB Drivers establish a connection with a MongoDB cluster a number of network round trips are performed. This can result in increased latency when measuring the time to response of an oper...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/blog/2022/09/15/createindex-error-values-in-v-2-index-key-pattern-cannot-be-of-type-object/" class="btn btn-outline-primary" aria-label="Older" ><p>Solving a mongorestore failure due to 'Values in v:2 index key pattern cannot be of type object.'</p></a> <a href="/blog/2022/10/06/from-engineering-to-product-management/" class="btn btn-outline-primary" aria-label="Newer" ><p>From Engineering to Product Management</p></a></nav><div id="disqus_thread"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/'; this.page.identifier = '/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p> © <time>2024</time> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/snes/">snes</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="/assets/lib/jquery/jquery.min.js"></script> <script src="/assets/lib/bootstrap/bootstrap.bundle.min.js"></script> <script src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script src="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.umd.min.js"></script> <script src="/assets/lib/magnific-popup/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/clipboard/clipboard.min.js"></script> <script src="/assets/lib/dayjs/dayjs.min.js"></script> <script src="/assets/lib/dayjs/locale/en.min.js"></script> <script src="/assets/lib/dayjs/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs/plugin/localizedFormat.min.js"></script> <script src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
