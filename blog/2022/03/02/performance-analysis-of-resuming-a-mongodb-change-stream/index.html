<!doctype html><html lang="en" data-mode="dark"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Performance Analysis of Resuming a MongoDB Change Stream" /><meta property="og:locale" content="en" /><meta name="description" content="Change Streams allow applications to access real-time data changes without the complexity and risk of tailing the oplog. Applications can use change streams to subscribe to all data changes on a single collection, a database, or an entire deployment, and immediately react to them." /><meta property="og:description" content="Change Streams allow applications to access real-time data changes without the complexity and risk of tailing the oplog. Applications can use change streams to subscribe to all data changes on a single collection, a database, or an entire deployment, and immediately react to them." /><link rel="canonical" href="https://www.alexbevi.com/blog/2022/03/02/performance-analysis-of-resuming-a-mongodb-change-stream/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2022/03/02/performance-analysis-of-resuming-a-mongodb-change-stream/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-03-02T06:50:39-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="twitter:title" content="Performance Analysis of Resuming a MongoDB Change Stream" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-09T12:45:05-04:00","datePublished":"2022-03-02T06:50:39-05:00","description":"Change Streams allow applications to access real-time data changes without the complexity and risk of tailing the oplog. Applications can use change streams to subscribe to all data changes on a single collection, a database, or an entire deployment, and immediately react to them.","headline":"Performance Analysis of Resuming a MongoDB Change Stream","image":"https://www.alexbevi.com/images/mongodb-logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2022/03/02/performance-analysis-of-resuming-a-mongodb-change-stream/"},"url":"https://www.alexbevi.com/blog/2022/03/02/performance-analysis-of-resuming-a-mongodb-change-stream/"}</script><title>Performance Analysis of Resuming a MongoDB Change Stream | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="/assets/lib/bootstrap/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup/magnific-popup.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script><meta name="google-adsense-account" content="ca-pub-6215800856413580"><body><aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"><header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src=" /./images/avatar.png " width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a><h1 class="site-title"> <a href="/">ALEX BEVILACQUA</a></h1><p class="site-subtitle fst-italic mb-0">my little corner of the interwebs</p></header><nav class="flex-column flex-grow-1 w-100 ps-0"><ul class="nav"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul></nav><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></aside><div id="main-wrapper" class="d-flex justify-content-center"><div class="container d-flex flex-column px-xxl-5"><header id="topbar-wrapper" aria-label="Top Bar"><div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" ><nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Performance Analysis of Resuming a MongoDB Change Stream</span></nav><button type="button" id="sidebar-trigger" class="btn btn-link"> <i class="fas fa-bars fa-fw"></i> </button><div id="topbar-title"> Post</div><button type="button" id="search-trigger" class="btn btn-link"> <i class="fas fa-search fa-fw"></i> </button> <search class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button></div></header><div class="row flex-grow-1"><main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"><article class="px-1"><header><h1 data-toc-skip>Performance Analysis of Resuming a MongoDB Change Stream</h1><div class="post-meta text-muted"> <span> Posted <time data-ts="1646221839" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Mar 2, 2022 </time> </span> <span> Updated <time data-ts="1683650705" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 9, 2023 </time> </span><div class="mt-3 mb-3"> <a href=" /images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src=" /images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" loading="lazy"></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="2315 words" > <em>12 min</em> read </span></div></div></header><div class="content"><p><a href="https://docs.mongodb.com/manual/changeStreams/">Change Streams</a> allow applications to access real-time data changes without the complexity and risk of tailing the <a href="https://docs.mongodb.com/manual/reference/glossary/#std-term-oplog">oplog</a>. Applications can use change streams to subscribe to all data changes on a single collection, a database, or an entire deployment, and immediately react to them.</p><p>For applications that rely on change streams, ensuring continuity on process restart can be accomplished by specifying a <a href="https://docs.mongodb.com/manual/changeStreams/#resume-a-change-stream">resume token to resume the change stream</a>. Depending on how many events have been recorded in the oplog after the resume token, the time taken to resume the stream can take longer than expected.</p><p>This article will attempt to explain the default behavior of change streams when resumed and how performance can potentially improved. Note that all scripts used in this article are shared in the <em>Reproduction</em> section at the end.</p><h2 id="capturing-our-first-change-event"><span class="me-2">Capturing Our First Change Event</span><a href="#capturing-our-first-change-event" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <code class="language-plaintext highlighter-rouge">nodejs-capture-first-event.js</code> script uses the <a href="https://docs.mongodb.com/drivers/node/current/">MongoDB Node Driver</a> to connect to the cluster we just created and listen for changes. First ensure you have Node.js installed, then using <code class="language-plaintext highlighter-rouge">npm</code> install the <a href="https://www.npmjs.com/package/mongodb"><code class="language-plaintext highlighter-rouge">mongo</code> package</a> and run the script:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>npm <span class="nb">install </span>mongo
node capture-first-event.js
</pre></table></code></div></div><p>Once the script is watching the collection connect to the cluster and run the <code class="language-plaintext highlighter-rouge">setupEnvironment()</code> function to setup the cluster and insert a test document:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mongo <span class="nt">--quiet</span> <span class="nt">--eval</span> <span class="s2">"load('shell-configure-test.js'); setupEnvironment();"</span>
</pre></table></code></div></div><p>Once this document is inserted, the <code class="language-plaintext highlighter-rouge">nodejs-capture-first-event.js</code> we started previously should produce a result similar to the following, then exit:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>2022-02-15T12:13:26.173Z Change received:  {
  _id: {
    _data: '82620B98E5000000022B022C0100296E5A1004437FB549CFDD45269DD59B9BF0EB354746645F69640064620B98E564DA118651C642000004'
  },
  operationType: 'insert',
  clusterTime: new Timestamp({ t: 1644927205, i: 2 }),
  fullDocument: {
    _id: new ObjectId("620b98e564da118651c64200"),
    msg: 'We expect our filter to match this'
  },
  ns: { db: 'test', coll: 'foo' },
  documentKey: { _id: new ObjectId("620b98e564da118651c64200") }
}
</pre></table></code></div></div><p>Note the <code class="language-plaintext highlighter-rouge">_id</code> value of the <a href="https://docs.mongodb.com/manual/reference/change-events/">change event</a> as this will be used to resume the change stream later.</p><h2 id="seeding-the-collection"><span class="me-2">Seeding the Collection</span><a href="#seeding-the-collection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The <code class="language-plaintext highlighter-rouge">nodejs-capture-first-event.js</code> script should have terminated after the change event was detected and printed. Next we want to fill the collection with content prior to attempting to resume processing, which can be done using our setup script from a <code class="language-plaintext highlighter-rouge">mongo</code>/<code class="language-plaintext highlighter-rouge">mongosh</code> shell:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mongo <span class="nt">--quiet</span> <span class="nt">--eval</span> <span class="s2">"load('shell-configure-test.js'); seedCollection();"</span>
</pre></table></code></div></div><p>The function above will push 3000 “junk” documents (~ 6MB in size) to the collection along with a few additional documents mixed in that should match our initial change stream filter. Once the collection is seeded, we can use the <a href="https://docs.mongodb.com/manual/reference/operator/aggregation/collStats/"><code class="language-plaintext highlighter-rouge">$collStats</code></a> aggregation stage to get an idea as to how much data we’ve just generated. This should be run from a <code class="language-plaintext highlighter-rouge">mongo</code>/<code class="language-plaintext highlighter-rouge">mongosh</code> shell connected to the cluster:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="nv">$ </span>mongosh <span class="nt">--quiet</span> <span class="nt">--eval</span> <span class="s2">"db.foo.aggregate([ { </span><span class="nv">$collStats</span><span class="s2">: { storageStats: {} }}, { </span><span class="nv">$project</span><span class="s2">: { 'storageStats.wiredTiger': 0, 'storageStats.indexDetails': 0 } }]).pretty();"</span>

<span class="o">[</span>
  <span class="o">{</span>
    ns: <span class="s1">'test.foo'</span>,
    host: <span class="s1">'Alexs-MacBook-Pro.local:27018'</span>,
    localTime: ISODate<span class="o">(</span><span class="s2">"2022-02-15T21:36:13.752Z"</span><span class="o">)</span>,
    storageStats: <span class="o">{</span>
      size: Long<span class="o">(</span><span class="s2">"16993324327"</span><span class="o">)</span>, // 16.99GB
      count: 2711,
      avgObjSize: 6268286, // 6.26MB
      storageSize: Long<span class="o">(</span><span class="s2">"17022169088"</span><span class="o">)</span>,
      freeStorageSize: 17760256,
      capped: <span class="nb">false</span>,
      nindexes: 1,
      indexBuilds: <span class="o">[]</span>,
      totalIndexSize: 114688,
      totalSize: Long<span class="o">(</span><span class="s2">"17022283776"</span><span class="o">)</span>,
      indexSizes: <span class="o">{</span> _id_: 114688 <span class="o">}</span>,
      scaleFactor: 1
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">]</span>
</pre></table></code></div></div><h2 id="resuming-a-change-stream-with-a-resumetoken"><span class="me-2">Resuming a Change Stream with a <code class="language-plaintext highlighter-rouge">ResumeToken</code></span><a href="#resuming-a-change-stream-with-a-resumetoken" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Change streams can be resumed by using a <a href="https://docs.mongodb.com/manual/changeStreams/#resume-tokens"><code class="language-plaintext highlighter-rouge">ResumeToken</code></a>. To <a href="https://docs.mongodb.com/manual/changeStreams/#resumeafter-for-change-streams"><code class="language-plaintext highlighter-rouge">resumeAfter</code></a> you use the <code class="language-plaintext highlighter-rouge">_id</code> value of the last change stream event as this acts as the <code class="language-plaintext highlighter-rouge">resumeToken</code>. This can be inspected via the <code class="language-plaintext highlighter-rouge">mongosh</code> shell using the <code class="language-plaintext highlighter-rouge">resumetoken</code> snippet (see <a href="https://github.com/mongodb-js/mongodb-resumetoken-decoder"><code class="language-plaintext highlighter-rouge">mongodb-js/mongodb-resumetoken-decoder</code></a>)</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="nx">Enterprise</span> <span class="nx">replset</span> <span class="p">[</span><span class="nx">direct</span><span class="p">:</span> <span class="nx">primary</span><span class="p">]</span> <span class="nx">test</span><span class="o">&gt;</span> <span class="nf">decodeResumeToken</span><span class="p">(</span><span class="dl">'</span><span class="s1">82620B98E5000000022B022C0100296E5A1004437FB549CFDD45269DD59B9BF0EB354746645F69640064620B98E564DA118651C642000004</span><span class="dl">'</span><span class="p">)</span>
<span class="p">{</span>
  <span class="nl">timestamp</span><span class="p">:</span> <span class="k">new</span> <span class="nc">Timestamp</span><span class="p">({</span> <span class="na">t</span><span class="p">:</span> <span class="mi">1644927205</span><span class="p">,</span> <span class="na">i</span><span class="p">:</span> <span class="mi">2</span> <span class="p">}),</span>
  <span class="nx">version</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="nx">tokenType</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
  <span class="nx">txnOpIndex</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
  <span class="nx">fromInvalidate</span><span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
  <span class="nx">uuid</span><span class="p">:</span> <span class="k">new</span> <span class="nc">UUID</span><span class="p">(</span><span class="dl">"</span><span class="s2">437fb549-cfdd-4526-9dd5-9b9bf0eb3547</span><span class="dl">"</span><span class="p">),</span>
  <span class="nx">documentKey</span><span class="p">:</span> <span class="p">{</span> <span class="nl">_id</span><span class="p">:</span> <span class="k">new</span> <span class="nc">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">620b98e564da118651c64200</span><span class="dl">"</span><span class="p">)</span> <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>To use the resume token, the <code class="language-plaintext highlighter-rouge">nodejs-resume-changestream.js</code> script can be adjusted to use our token we found earlier.</p><h2 id="performance-using-cursor-defaults"><span class="me-2">Performance Using Cursor Defaults</span><a href="#performance-using-cursor-defaults" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>When the above script is run, the output should be similar to the following:</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nv">$ </span>node capture-first-event.js

2022-03-02T11:38:37.014Z Resuming Change Stream ...
2022-03-02T11:38:49.888Z Change received: <span class="s2">"This document will be 1Kb"</span> <span class="o">(</span>token: 82621F54B3000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54B33284546A99670EFD0004<span class="o">)</span>
2022-03-02T11:38:49.888Z Change received: <span class="s2">"100 6MB documents, then another 1Kb document"</span> <span class="o">(</span>token: 82621F54C4000000062B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54C43284546A99670F620004<span class="o">)</span>
2022-03-02T11:38:49.889Z Change received: <span class="s2">"And another 100 6MB documents, then another 1Kb document"</span> <span class="o">(</span>token: 82621F54D4000000072B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54D43284546A99670FC70004<span class="o">)</span>
2022-03-02T11:38:49.889Z Change received: <span class="s2">"... followed immediately by a 1MB document"</span> <span class="o">(</span>token: 82621F54D5000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54D53284546A99670FC80004<span class="o">)</span>
2022-03-02T11:38:49.889Z Change received: <span class="s2">"100 6MB documents preceded this 3MB document"</span> <span class="o">(</span>token: 82621F54E8000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54E83284546A9967102D0004<span class="o">)</span>
2022-03-02T11:38:49.889Z Change received: <span class="s2">"... followed by another 1MB document"</span> <span class="o">(</span>token: 82621F54E9000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54E93284546A9967102E0004<span class="o">)</span>
2022-03-02T11:38:49.890Z Change received: <span class="s2">"500 6MB documents added"</span> <span class="o">(</span>token: 82621F5531000000072B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F55313284546A996712230004<span class="o">)</span>
2022-03-02T11:38:49.890Z Change received: <span class="s2">"200 6MB documents added"</span> <span class="o">(</span>token: 82621F554D000000052B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F554D3284546A996712EC0004<span class="o">)</span>
2022-03-02T11:38:49.890Z Change received: <span class="s2">"Adding 2000 more 6MB documents..."</span> <span class="o">(</span>token: 82621F554D000000062B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F554D3284546A996712ED0004<span class="o">)</span>
2022-03-02T11:38:49.891Z Change received: <span class="s2">"This is the last document we'd expect"</span> <span class="o">(</span>token: 82621F5724000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F57243284546A99671ABE0004<span class="o">)</span>
</pre></table></code></div></div><p>Note that ~12 seconds elapse between the cursor being opened and the results all being returned apparently at once.</p><p>Reviewing the logs for this operation show that a single <code class="language-plaintext highlighter-rouge">aggregate</code> command was executed that returned about 5MB of data (<a href="https://docs.mongodb.com/manual/reference/database-profiler/#mongodb-data-system.profile.responseLength"><code class="language-plaintext highlighter-rouge">reslen</code></a>) in 10 documents (<a href="https://docs.mongodb.com/manual/reference/database-profiler/#mongodb-data-system.profile.nreturned"><code class="language-plaintext highlighter-rouge">nreturned</code></a>). 3060 documents were scanned to identify these results and that required 19GB (<a href="https://docs.mongodb.com/manual/reference/database-profiler/#mongodb-data-system.profile.storage.data.bytesRead"><code class="language-plaintext highlighter-rouge">bytesRead</code></a>) to be read from disk into cache.</p><blockquote><p>{“t”:{“$date”:”2022-03-02T06:38:47.825-05:00”},”s”:”I”, “c”:”COMMAND”, “id”:51803, “ctx”:”conn53”,”msg”:”Slow query”,”attr”:{“type”:”command”,”ns”:”test.foo”,”command”:{<code class="language-plaintext highlighter-rouge">"aggregate":"foo"</code>,”pipeline”:[{“$changeStream”:{“fullDocument”:”default”,”resumeAfter”:{“_data”:”82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004”}}},{“$match”:{“fullDocument.msg”:{“$exists”:true}}},{“$project”:{“fullDocument”:1}}],”cursor”:{},”lsid”:{“id”:{“$uuid”:”14c4f916-957f-4245-8106-b617b17fa603”}},”$clusterTime”:{“clusterTime”:{“$timestamp”:{“t”:1646221107,”i”:1}},”signature”:{“hash”:{“$binary”:{“base64”:”AAAAAAAAAAAAAAAAAAAAAAAAAAA=”,”subType”:”0”}},”keyId”:0}},”$db”:”test”},”planSummary”:”COLLSCAN”,”cursorid”:8835322801609070020,”keysExamined”:0,”docsExamined”:3039,”numYields”:636,<code class="language-plaintext highlighter-rouge">"nreturned":10</code>,”queryHash”:”7C2ADF3A”,<code class="language-plaintext highlighter-rouge">"reslen":5248534</code>,”locks”:{“Global”:{“acquireCount”:{“r”:640}},”Mutex”:{“acquireCount”:{“r”:4}}},”readConcern”:{“level”:”majority”},”writeConcern”:{“w”:”majority”,”wtimeout”:0,”provenance”:”implicitDefault”},”storage”:{“data”:{<code class="language-plaintext highlighter-rouge">"bytesRead":19528768718</code>,”timeReadingMicros”:9979872},”timeWaitingMicros”:{“cache”:4991}},”remote”:”192.168.2.100:61953”,”protocol”:”op_msg”,”durationMillis”:12356}}</p></blockquote><p>The entire operation took 12.36 seconds (<a href="https://docs.mongodb.com/manual/reference/database-profiler/#mongodb-data-system.profile.millis"><code class="language-plaintext highlighter-rouge">durationMillis</code></a>) to complete.</p><h2 id="performance-using-a-smaller-cursor-batchsize"><span class="me-2">Performance Using a Smaller Cursor <code class="language-plaintext highlighter-rouge">batchSize</code></span><a href="#performance-using-a-smaller-cursor-batchsize" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>According to the previous log entry, all outstanding results following the resume token were returned in a single <a href="https://docs.mongodb.com/manual/tutorial/iterate-a-cursor/#cursor-batches">cursor batch</a>. By default, <code class="language-plaintext highlighter-rouge">find()</code> and <code class="language-plaintext highlighter-rouge">aggregate()</code> operations have an initial batch size of 101 documents. Subsequent <a href="https://docs.mongodb.com/manual/reference/command/getMore/"><code class="language-plaintext highlighter-rouge">getMore</code></a> operations issued against the resulting cursor have no default batch size, so they are limited only by the 16 megabyte message size (the <a href="https://docs.mongodb.com/manual/reference/limits/#std-label-limit-bson-document-size">BSON Max Size</a>).</p><p>Let’s try adjusting <code class="language-plaintext highlighter-rouge">nodejs-resume-changestream.js</code> with a <a href="https://docs.mongodb.com/manual/reference/method/cursor.batchSize"><code class="language-plaintext highlighter-rouge">cursor.batchSize()</code></a> of 1, as this should return documents as they’re found.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">var</span> <span class="nx">changeStream</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">watch</span><span class="p">([</span>
  <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">fullDocument.msg</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="na">$exists</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
  <span class="p">{</span> <span class="na">$project</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocument</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
  <span class="p">],</span> <span class="p">{</span> <span class="na">resumeAfter</span><span class="p">:</span> <span class="nx">resumeToken</span><span class="p">,</span> <span class="na">batchSize</span><span class="p">:</span> <span class="mi">1</span> <span class="p">});</span> <span class="c1">// &lt;-- add `batchSize: 1`</span>
</pre></table></code></div></div><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre>2022-03-02T11:47:26.743Z Resuming Change Stream ...
2022-03-02T11:47:27.952Z Change received: <span class="s2">"This document will be 1Kb"</span> <span class="o">(</span>token: 82621F54B3000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54B33284546A99670EFD0004<span class="o">)</span>
2022-03-02T11:47:27.958Z Change received: <span class="s2">"100 6MB documents, then another 1Kb document"</span> <span class="o">(</span>token: 82621F54C4000000062B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54C43284546A99670F620004<span class="o">)</span>
2022-03-02T11:47:27.962Z Change received: <span class="s2">"And another 100 6MB documents, then another 1Kb document"</span> <span class="o">(</span>token: 82621F54D4000000072B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54D43284546A99670FC70004<span class="o">)</span>
2022-03-02T11:47:28.097Z Change received: <span class="s2">"... followed immediately by a 1MB document"</span> <span class="o">(</span>token: 82621F54D5000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54D53284546A99670FC80004<span class="o">)</span>
2022-03-02T11:47:28.364Z Change received: <span class="s2">"100 6MB documents preceded this 3MB document"</span> <span class="o">(</span>token: 82621F54E8000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54E83284546A9967102D0004<span class="o">)</span>
2022-03-02T11:47:28.463Z Change received: <span class="s2">"... followed by another 1MB document"</span> <span class="o">(</span>token: 82621F54E9000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54E93284546A9967102E0004<span class="o">)</span>
2022-03-02T11:47:30.474Z Change received: <span class="s2">"500 6MB documents added"</span> <span class="o">(</span>token: 82621F5531000000072B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F55313284546A996712230004<span class="o">)</span>
2022-03-02T11:47:31.234Z Change received: <span class="s2">"200 6MB documents added"</span> <span class="o">(</span>token: 82621F554D000000052B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F554D3284546A996712EC0004<span class="o">)</span>
2022-03-02T11:47:31.239Z Change received: <span class="s2">"Adding 2000 more 6MB documents..."</span> <span class="o">(</span>token: 82621F554D000000062B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F554D3284546A996712ED0004<span class="o">)</span>
2022-03-02T11:47:39.334Z Change received: <span class="s2">"This is the last document we'd expect"</span> <span class="o">(</span>token: 82621F5724000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F57243284546A99671ABE0004<span class="o">)</span>
</pre></table></code></div></div><p>Unlike the first example that returned all results as they fit into the initial batch size, now a <code class="language-plaintext highlighter-rouge">getMore</code> is being issued for each result returned from the cursor. Checking the logs again we can verify this as we expect there to be 10 log entries associated with the change stream’s cursor id (<code class="language-plaintext highlighter-rouge">8620417026431980160</code> in this case):</p><pre><code class="language-log">{"t":{"$date":"2022-03-02T06:47:26.367-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":309,"numYields":59,"nreturned":1,"queryHash":"7C2ADF3A","reslen":1618,"locks":{"Global":{"acquireCount":{"r":61}},"Mutex":{"acquireCount":{"r":2}}},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"storage":{"data":{"bytesRead":1942084556,"timeReadingMicros":951431},"timeWaitingMicros":{"cache":3195}},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":1181}}
{"t":{"$date":"2022-03-02T06:47:26.375-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"getMore":8620417026431980160,"collection":"foo","batchSize":1,"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"originatingCommand":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":0,"numYields":0,"nreturned":1,"queryHash":"7C2ADF3A","reslen":1636,"locks":{},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":0}}
{"t":{"$date":"2022-03-02T06:47:26.380-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"getMore":8620417026431980160,"collection":"foo","batchSize":1,"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"originatingCommand":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":0,"numYields":0,"nreturned":1,"queryHash":"7C2ADF3A","reslen":1648,"locks":{},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":0}}
{"t":{"$date":"2022-03-02T06:47:26.385-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"getMore":8620417026431980160,"collection":"foo","batchSize":1,"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"originatingCommand":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":0,"numYields":0,"nreturned":1,"queryHash":"7C2ADF3A","reslen":1049186,"locks":{},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":0}}
{"t":{"$date":"2022-03-02T06:47:26.521-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"getMore":8620417026431980160,"collection":"foo","batchSize":1,"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"originatingCommand":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":0,"numYields":0,"nreturned":1,"queryHash":"7C2ADF3A","reslen":3146340,"locks":{},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":2}}
{"t":{"$date":"2022-03-02T06:47:26.790-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"getMore":8620417026431980160,"collection":"foo","batchSize":1,"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"originatingCommand":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":1,"numYields":0,"nreturned":1,"queryHash":"7C2ADF3A","reslen":1049180,"locks":{"Global":{"acquireCount":{"r":1}},"Mutex":{"acquireCount":{"r":1}}},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"storage":{"data":{"bytesRead":1048977,"timeReadingMicros":1974}},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":3}}
{"t":{"$date":"2022-03-02T06:47:28.885-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"getMore":8620417026431980160,"collection":"foo","batchSize":1,"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"originatingCommand":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":501,"numYields":104,"nreturned":1,"queryHash":"7C2ADF3A","reslen":583,"locks":{"Global":{"acquireCount":{"r":105}},"Mutex":{"acquireCount":{"r":1}}},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"storage":{"data":{"bytesRead":3246578426,"timeReadingMicros":1613240},"timeWaitingMicros":{"cache":2390}},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":2000}}
{"t":{"$date":"2022-03-02T06:47:29.651-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"getMore":8620417026431980160,"collection":"foo","batchSize":1,"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221647,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"originatingCommand":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":201,"numYields":38,"nreturned":1,"queryHash":"7C2ADF3A","reslen":583,"locks":{"Global":{"acquireCount":{"r":39}},"Mutex":{"acquireCount":{"r":1}}},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"storage":{"data":{"bytesRead":1289823601,"timeReadingMicros":625733},"timeWaitingMicros":{"cache":15}},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":754}}
{"t":{"$date":"2022-03-02T06:47:29.656-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"getMore":8620417026431980160,"collection":"foo","batchSize":1,"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221647,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"originatingCommand":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":1,"numYields":0,"nreturned":1,"queryHash":"7C2ADF3A","reslen":593,"locks":{"Global":{"acquireCount":{"r":1}},"Mutex":{"acquireCount":{"r":1}}},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"storage":{},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":0}}
{"t":{"$date":"2022-03-02T06:47:37.751-05:00"},"s":"I",  "c":"COMMAND",  "id":51803,   "ctx":"conn66","msg":"Slow query","attr":{"type":"command","ns":"test.foo","command":{"getMore":8620417026431980160,"collection":"foo","batchSize":1,"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221647,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"originatingCommand":{"aggregate":"foo","pipeline":[{"$changeStream":{"fullDocument":"default","resumeAfter":{"_data":"82621F5485000000022B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F54853284546A99670EFC0004"}}},{"$match":{"fullDocument.msg":{"$exists":true}}},{"$project":{"fullDocument":1}}],"cursor":{"batchSize":1},"lsid":{"id":{"$uuid":"4a230956-9cbe-48a9-9093-8c2fae2b659f"}},"$clusterTime":{"clusterTime":{"$timestamp":{"t":1646221637,"i":1}},"signature":{"hash":{"$binary":{"base64":"AAAAAAAAAAAAAAAAAAAAAAAAAAA=","subType":"0"}},"keyId":0}},"$db":"test"},"planSummary":"COLLSCAN","cursorid":8620417026431980160,"keysExamined":0,"docsExamined":2024,"numYields":411,"nreturned":1,"queryHash":"7C2ADF3A","reslen":597,"locks":{"Global":{"acquireCount":{"r":412}},"Mutex":{"acquireCount":{"r":1}}},"readConcern":{"level":"majority"},"writeConcern":{"w":"majority","wtimeout":0,"provenance":"implicitDefault"},"storage":{"data":{"bytesRead":13017774068,"timeReadingMicros":6513189},"timeWaitingMicros":{"cache":19677}},"remote":"192.168.2.100:53792","protocol":"op_msg","durationMillis":8090}}
</code></pre><p>From start to finish both approaches will take approximately the same amount of time, however from an application responsiveness point of view processing events as they’re found compared to waiting for a batch is likely a better user experience.</p><h2 id="how-internal-aggregation-batching-logic-affects-batchsize"><span class="me-2">How Internal Aggregation Batching Logic Affects <code class="language-plaintext highlighter-rouge">batchSize</code></span><a href="#how-internal-aggregation-batching-logic-affects-batchsize" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Expanding on this further, let’s say we wanted to resume after the third last entry (<em>“200 6MB documents added”</em>):</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>2022-03-02T11:47:31.234Z Change received: "200 6MB documents added" (token: 82621F554D000000052B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F554D3284546A996712EC0004)
2022-03-02T11:47:31.239Z Change received: "Adding 2000 more 6MB documents..." (token: 82621F554D000000062B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F554D3284546A996712ED0004)
2022-03-02T11:47:39.334Z Change received: "This is the last document we'd expect" (token: 82621F5724000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F57243284546A99671ABE0004)
</pre></table></code></div></div><p>To do this we’d supply the <code class="language-plaintext highlighter-rouge">resumeToken</code> (<code class="language-plaintext highlighter-rouge">82621F554D000000052B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F554D3284546A996712EC0004</code> as seen above) to the code sample and run again. The expectation in this case would be that <em>“Adding 2000 more 6MB documents…“</em> would almost immediately return, followed after a brief delay by <em>“This is the last document we’d expect”</em>, however when we run the code … that’s not what we see. Instead after 6+ seconds <em>both</em> documents are returned:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>2022-03-02T12:15:49.134Z Resuming Change Stream ...
2022-03-02T12:15:55.831Z Change received: "Adding 2000 more 6MB documents..." (token: 82621F554D000000062B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F554D3284546A996712ED0004)
2022-03-02T12:15:55.838Z Change received: "This is the last document we'd expect" (token: 82621F5724000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F57243284546A99671ABE0004)
</pre></table></code></div></div><p>As an optimization, MongoDB’s query engine internally caches data from a cursor before pipeline processing. This is controlled by the <a href="https://github.com/mongodb/mongo/blob/a94caa502cf94fa6c8fcfea7283d7eaf3bd55ad5/src/mongo/db/query/query_knobs.idl#L391-L399"><code class="language-plaintext highlighter-rouge">internalDocumentSourceCursorBatchSizeBytes</code> query execution knob</a> which defaults to 4MB (lowered from 16MB in MongoDB 3.4.2 via <a href="https://jira.mongodb.org/browse/SERVER-27406"><code class="language-plaintext highlighter-rouge">SERVER-27406</code></a>).</p><p>We can verify this tuneable is in fact affecting the behavior of our change stream by lowering the value from 4194304 to 128 (via the <code class="language-plaintext highlighter-rouge">mongosh</code> shell):</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nf">adminCommand</span><span class="p">({</span>
  <span class="na">setParameter</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="na">internalDocumentSourceCursorBatchSizeBytes</span><span class="p">:</span> <span class="mi">128</span>
<span class="p">});</span>
</pre></table></code></div></div><p>After making this change, resuming our change stream returns <em>“Adding 2000 more 6MB documents…“</em> almost instantly whereas <em>“This is the last document we’d expect”</em> returns 7 seconds later.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>2022-03-02T14:11:41.416Z Resuming Change Stream ...
2022-03-02T14:11:41.445Z Change received: "Adding 2000 more 6MB documents..." (token: 82621F554D000000062B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F554D3284546A996712ED0004)
2022-03-02T14:11:48.054Z Change received: "This is the last document we'd expect" (token: 82621F5724000000012B022C0100296E5A1004D9EC8991B42F4F71BA61FC5BA26E2DED46645F69640064621F57243284546A99671ABE0004)
</pre></table></code></div></div><blockquote class="prompt-warning"><p>Though this improves the performance of our isolated test, this batching behavior is in place for a reason (one example outlined in <a href="https://jira.mongodb.org/browse/SERVER-27829"><code class="language-plaintext highlighter-rouge">SERVER-27829</code></a>). Changing <code class="language-plaintext highlighter-rouge">internalDocumentSourceCursorBatchSizeBytes</code> in production may adversely affect other workloads and would not be advisable.</p></blockquote><h2 id="summary"><span class="me-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>If you’re using MongoDB Change Streams and filtering for events that occur infrequently (compared to other activity within the oplog) resuming the change stream may appear “sluggish” using the defaults. Consider specifying a custom <code class="language-plaintext highlighter-rouge">batchSize</code> based on your workload to potentially improve the time to returning the first event.</p><p>Let me know in the comments below if you found this article helpful :)</p><hr /><h2 id="reproduction"><span class="me-2">Reproduction</span><a href="#reproduction" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The scripts used in this article can be found below. I configured a local environment running a MongoDB 5.2.0 3 node replica set using the <a href="https://github.com/aheckmann/m"><code class="language-plaintext highlighter-rouge">m</code> version manager</a> as well as <a href="https://github.com/rueckstiess/mtools"><code class="language-plaintext highlighter-rouge">mtools</code></a>.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>m 5.2.0-ent
mlaunch init <span class="nt">--replicaset</span> <span class="nt">--nodes</span> 3 <span class="nt">--bind_ip_all</span> <span class="nt">--binarypath</span> <span class="si">$(</span>m bin 5.2.0-ent<span class="si">)</span>
</pre></table></code></div></div><p>To use the scripts below save them locally and execute the associated commands from the same directory.</p><h3 id="shell-configure-testjs"><span class="me-2"><code class="language-plaintext highlighter-rouge">shell-configure-test.js</code></span><a href="#shell-configure-testjs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This script for the <code class="language-plaintext highlighter-rouge">mongo</code>/<code class="language-plaintext highlighter-rouge">mongosh</code> shell contains the helper functions used in this article to configure the environment and generate the write load.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
</pre><td class="rouge-code"><pre><span class="c1">// filename: shell-configure-test.js</span>
<span class="c1">//</span>
<span class="kd">function</span> <span class="nf">setupEnvironment</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// set the oplog to at least 20GB (20480MB) so our workload doesn't roll out</span>
  <span class="nx">db</span><span class="p">.</span><span class="nf">adminCommand</span><span class="p">({</span> <span class="na">replSetResizeOplog</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="na">size</span><span class="p">:</span> <span class="mi">20480</span> <span class="p">});</span>

  <span class="c1">// insert one document and observe the result from the change stream cursor</span>
  <span class="nx">db</span><span class="p">.</span><span class="nf">getSiblingDB</span><span class="p">(</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">).</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">We expect our filter to match this</span><span class="dl">"</span> <span class="p">});</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">randomString</span><span class="p">(</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
   <span class="kd">var</span> <span class="nx">result</span>           <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">characters</span>       <span class="o">=</span> <span class="dl">'</span><span class="s1">ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789</span><span class="dl">'</span><span class="p">;</span>
   <span class="kd">var</span> <span class="nx">charactersLength</span> <span class="o">=</span> <span class="nx">characters</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
   <span class="k">for </span><span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">result</span> <span class="o">+=</span> <span class="nx">characters</span><span class="p">.</span><span class="nf">charAt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nf">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">charactersLength</span><span class="p">));</span>
   <span class="p">}</span>
   <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">writeJunk</span><span class="p">(</span><span class="nx">count</span><span class="p">,</span> <span class="nx">stringLength</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">print</span><span class="p">(</span><span class="dl">"</span><span class="s2">Pushing </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">count</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> junk docs of size </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">stringLength</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[];</span>
  <span class="c1">// doesn't matter what the string is so just reuse it</span>
  <span class="kd">var</span> <span class="nx">string</span> <span class="o">=</span> <span class="nf">randomString</span><span class="p">(</span><span class="nx">stringLength</span><span class="p">);</span>
  <span class="k">for </span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">count</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">data</span><span class="p">.</span><span class="nf">push</span><span class="p">({</span> <span class="na">i</span><span class="p">:</span> <span class="nx">i</span><span class="p">,</span> <span class="na">s</span><span class="p">:</span> <span class="nx">string</span> <span class="p">});</span>
  <span class="p">}</span>
  <span class="nx">db</span><span class="p">.</span><span class="nf">getSiblingDB</span><span class="p">(</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">).</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertMany</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nf">seedCollection</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This document will be 1Kb</span><span class="dl">"</span><span class="p">,</span> <span class="na">s</span><span class="p">:</span> <span class="nf">randomString</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span> <span class="p">});</span>
  <span class="nf">writeJunk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1048576</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">100 6MB documents, then another 1Kb document</span><span class="dl">"</span><span class="p">,</span> <span class="na">s</span><span class="p">:</span> <span class="nf">randomString</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span> <span class="p">});</span>
  <span class="nf">writeJunk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1048576</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">And another 100 6MB documents, then another 1Kb document</span><span class="dl">"</span><span class="p">,</span> <span class="na">s</span><span class="p">:</span> <span class="nf">randomString</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span> <span class="p">});</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">... followed immediately by a 1MB document</span><span class="dl">"</span><span class="p">,</span> <span class="na">s</span><span class="p">:</span> <span class="nf">randomString</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">});</span>
  <span class="nf">writeJunk</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1048576</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">100 6MB documents preceded this 3MB document</span><span class="dl">"</span><span class="p">,</span> <span class="na">s</span><span class="p">:</span> <span class="nf">randomString</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="p">});</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">... followed by another 1MB document</span><span class="dl">"</span><span class="p">,</span> <span class="na">s</span><span class="p">:</span> <span class="nf">randomString</span><span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span> <span class="p">});</span>
  <span class="nf">writeJunk</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="mi">1048576</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">500 6MB documents added</span><span class="dl">"</span> <span class="p">});</span>
  <span class="nf">writeJunk</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="mi">1048576</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">200 6MB documents added</span><span class="dl">"</span> <span class="p">});</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Adding 2000 more 6MB documents...</span><span class="dl">"</span> <span class="p">});</span>
  <span class="nf">writeJunk</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="mi">1048576</span> <span class="o">*</span> <span class="mi">6</span><span class="p">);</span>
  <span class="nx">db</span><span class="p">.</span><span class="nx">foo</span><span class="p">.</span><span class="nf">insertOne</span><span class="p">({</span> <span class="na">msg</span><span class="p">:</span> <span class="dl">"</span><span class="s2">This is the last document we'd expect</span><span class="dl">"</span> <span class="p">});</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="nodejs-capture-first-eventjs"><span class="me-2"><code class="language-plaintext highlighter-rouge">nodejs-capture-first-event.js</code></span><a href="#nodejs-capture-first-eventjs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This Node.js script should be used to listen for the first change event from which we’ll extract a resume token for later use.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre><span class="c1">// file: nodejs-capture-first-event.js</span>
<span class="c1">//</span>
<span class="c1">// Configure the `MongoClient` with connection details appropriate to your environment</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">MongoClient</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">mongodb</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MongoClient</span><span class="p">(</span><span class="dl">"</span><span class="s2">mongodb://localhost:27017/test?replicaSet=replset</span><span class="dl">"</span><span class="p">);</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nf">connect</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">database</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">db</span><span class="p">(</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">database</span><span class="p">.</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">foo</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">changeStream</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">watch</span><span class="p">([</span> <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">fullDocument.msg</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="na">$exists</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}]);</span>
  <span class="nx">changeStream</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">change</span><span class="dl">"</span><span class="p">,</span> <span class="nx">next</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="k">new</span> <span class="nc">Date</span><span class="p">().</span><span class="nf">toISOString</span><span class="p">()}</span><span class="s2"> Change received: `</span><span class="p">,</span> <span class="nx">next</span><span class="p">);</span>
    <span class="nx">process</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
<span class="nf">run</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">);</span>
</pre></table></code></div></div><h3 id="nodejs-resume-changestreamjs"><span class="me-2"><code class="language-plaintext highlighter-rouge">nodejs-resume-changestream.js</code></span><a href="#nodejs-resume-changestreamjs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The resume token found when running <code class="language-plaintext highlighter-rouge">nodejs-capture-first-event.js</code> can be plugged into this script to capture matching events following the token.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre><td class="rouge-code"><pre><span class="c1">// file: nodejs-resume-changestream.js</span>
<span class="c1">//</span>
<span class="c1">// Configure the `MongoClient` with connection details appropriate to your environment</span>
<span class="kd">const</span> <span class="p">{</span> <span class="nx">MongoClient</span> <span class="p">}</span> <span class="o">=</span> <span class="nf">require</span><span class="p">(</span><span class="dl">"</span><span class="s2">mongodb</span><span class="dl">"</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MongoClient</span><span class="p">(</span><span class="dl">"</span><span class="s2">mongodb://localhost:27017/test?replicaSet=replset</span><span class="dl">"</span><span class="p">);</span>

<span class="k">async</span> <span class="kd">function</span> <span class="nf">run</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">await</span> <span class="nx">client</span><span class="p">.</span><span class="nf">connect</span><span class="p">();</span>
  <span class="kd">const</span> <span class="nx">database</span> <span class="o">=</span> <span class="nx">client</span><span class="p">.</span><span class="nf">db</span><span class="p">(</span><span class="dl">"</span><span class="s2">test</span><span class="dl">"</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">collection</span> <span class="o">=</span> <span class="nx">database</span><span class="p">.</span><span class="nf">collection</span><span class="p">(</span><span class="dl">"</span><span class="s2">foo</span><span class="dl">"</span><span class="p">);</span>
  <span class="c1">// replace the resume token with the value from your own tests</span>
  <span class="kd">var</span> <span class="nx">resumeToken</span> <span class="o">=</span> <span class="p">{</span> <span class="na">_data</span><span class="p">:</span> <span class="dl">'</span><span class="s1">82620B98E5000000022B022C0100296E5A1004437FB549CFDD45269DD59B9BF0EB354746645F69640064620B98E564DA118651C642000004</span><span class="dl">'</span> <span class="p">}</span>
  <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="k">new</span> <span class="nc">Date</span><span class="p">().</span><span class="nf">toISOString</span><span class="p">()}</span><span class="s2"> Resuming Change Stream ...`</span><span class="p">);</span>
  <span class="kd">var</span> <span class="nx">changeStream</span> <span class="o">=</span> <span class="nx">collection</span><span class="p">.</span><span class="nf">watch</span><span class="p">([</span>
    <span class="p">{</span> <span class="na">$match</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">fullDocument.msg</span><span class="dl">"</span><span class="p">:</span> <span class="p">{</span> <span class="na">$exists</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">}</span> <span class="p">},</span>
    <span class="p">{</span> <span class="na">$project</span><span class="p">:</span> <span class="p">{</span> <span class="na">fullDocument</span><span class="p">:</span> <span class="mi">1</span> <span class="p">}</span> <span class="p">}</span>
  <span class="p">],</span> <span class="p">{</span> <span class="na">resumeAfter</span><span class="p">:</span> <span class="nx">resumeToken</span> <span class="p">});</span>
  <span class="nx">changeStream</span><span class="p">.</span><span class="nf">on</span><span class="p">(</span><span class="dl">"</span><span class="s2">change</span><span class="dl">"</span><span class="p">,</span> <span class="nx">next</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="k">new</span> <span class="nc">Date</span><span class="p">().</span><span class="nf">toISOString</span><span class="p">()}</span><span class="s2"> Change received: </span><span class="p">${</span><span class="nx">next</span><span class="p">.</span><span class="nx">fullDocument</span><span class="p">.</span><span class="nx">msg</span><span class="p">}</span><span class="s2"> (token: </span><span class="p">${</span><span class="nx">next</span><span class="p">.</span><span class="nx">_id</span><span class="p">.</span><span class="nx">_data</span><span class="p">}</span><span class="s2">)`</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>
<span class="nf">run</span><span class="p">().</span><span class="k">catch</span><span class="p">(</span><span class="nx">console</span><span class="p">.</span><span class="nx">dir</span><span class="p">);</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href="/categories/mongodb/">MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/changestream/" class="post-tag no-text-decoration" >changestream</a> <a href="/tags/performance/" class="post-tag no-text-decoration" >performance</a></div><div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " ><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Performance%20Analysis%20of%20Resuming%20a%20MongoDB%20Change%20Stream%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F03%2F02%2Fperformance-analysis-of-resuming-a-mongodb-change-stream%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Performance%20Analysis%20of%20Resuming%20a%20MongoDB%20Change%20Stream%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F03%2F02%2Fperformance-analysis-of-resuming-a-mongodb-change-stream%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F03%2F02%2Fperformance-analysis-of-resuming-a-mongodb-change-stream%2F&text=Performance%20Analysis%20of%20Resuming%20a%20MongoDB%20Change%20Stream%20-%20ALEX%20BEVILACQUA" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F03%2F02%2Fperformance-analysis-of-resuming-a-mongodb-change-stream%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Performance%20Analysis%20of%20Resuming%20a%20MongoDB%20Change%20Stream%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2022%2F03%2F02%2Fperformance-analysis-of-resuming-a-mongodb-change-stream%2F" target="_blank" rel="noopener" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span></div></div></div></article></main><aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 mb-5 text-muted"><div class="access"><section id="access-lastmod"><h2 class="panel-heading">Recently Updated</h2><ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2021/07/28/adventure-games-1980-1999/">Let's Adventure! A Journey into Adventure Games (1980-1999)</a><li class="text-truncate lh-lg"> <a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Let's Adventure! Reviewed Games Sorted by Score</a><li class="text-truncate lh-lg"> <a href="/blog/2024/04/30/the-secret-of-monkey-island/">The Secret of Monkey Island (Lucasfilm Games) - 1990</a><li class="text-truncate lh-lg"> <a href="/blog/2024/04/26/event-monitoring-with-mongoose/">Event Monitoring with Mongoose</a><li class="text-truncate lh-lg"> <a href="/blog/2024/04/25/police-quest-open-season/">Police Quest: Open Season (Sierra On-Line) - 1993</a></ul></section><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a></div></section></div><section id="toc-wrapper" class="ps-0 pe-4"><h2 class="panel-heading ps-3 pt-2 mb-2">Contents</h2><nav id="toc"></nav></section></aside></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"><aside id="related-posts" aria-labelledby="related-label"><h3 class="mb-4" id="related-label">Further Reading</h3><nav class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><article class="col"> <a href="/blog/2018/05/28/troubleshooting-a-mongodb-performance-issue/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1527513243" data-df="ll" > May 28, 2018 </time><h4 class="pt-0 my-2">Troubleshooting a MongoDB Performance Issue</h4><div class="text-muted"><p> UPDATE (2018-06-28): I actually sent a link to this article to the author of the previous blog post and in her reply she indicates that the improvements to cache management and checkpoint areas wer...</p></div></div></a></article><article class="col"> <a href="/blog/2012/08/29/install-latest-mongodb-in-ubuntu/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1346262360" data-df="ll" > Aug 29, 2012 </time><h4 class="pt-0 my-2">Install Latest MongoDB in Ubuntu</h4><div class="text-muted"><p> A couple projects I work on use MongoDB as the database, and I’m generally not satisfied to use the (often outdated) version that ships with Ubuntu. As a result, I wrote this script to automate fe...</p></div></div></a></article><article class="col"> <a href="/blog/2018/08/14/hello-mongodb/" class="post-preview card h-100"><div class="card-body"> <time data-ts="1534275064" data-df="ll" > Aug 14, 2018 </time><h4 class="pt-0 my-2">Hello MongoDB</h4><div class="text-muted"><p> As of August 13th, I am no longer a System Architect at DAC Group. I have a public post on LinkedIn that got some good traction, but to summarize it was time to move on. I’ve been a software engin...</p></div></div></a></article></nav></aside><nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/blog/2022/02/07/cleaning-up-etl-results-in-mongodb-by-transposing-multiple-arrays/" class="btn btn-outline-primary" aria-label="Older" ><p>Cleaning Up ETL Results in MongoDB by Transposing Multiple Arrays</p></a> <a href="/blog/2022/03/15/police-quest-1/" class="btn btn-outline-primary" aria-label="Newer" ><p>Police Quest: In Pursuit of the Death Angel (Sierra On-Line) - 1987</p></a></nav><div id="disqus_thread"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2022/03/02/performance-analysis-of-resuming-a-mongodb-change-stream/'; this.page.identifier = '/blog/2022/03/02/performance-analysis-of-resuming-a-mongodb-change-stream/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script><footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " ><p>© <time>2024</time> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p><p>Using the <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>.</p></footer></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 content"><div id="search-hints"><section><h2 class="panel-heading">Trending Tags</h2><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/sci/">SCI</a></div></section></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button></aside></div><div id="mask"></div><aside id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></aside><script src="/assets/lib/jquery/jquery.min.js"></script> <script src="/assets/lib/bootstrap/bootstrap.bundle.min.js"></script> <script src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script src="/assets/lib/loading-attribute-polyfill/loading-attribute-polyfill.umd.min.js"></script> <script src="/assets/lib/magnific-popup/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/clipboard/clipboard.min.js"></script> <script src="/assets/lib/dayjs/dayjs.min.js"></script> <script src="/assets/lib/dayjs/locale/en.min.js"></script> <script src="/assets/lib/dayjs/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs/plugin/localizedFormat.min.js"></script> <script src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/assets/js/dist/app.min.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<article class="px-1 px-sm-2 px-lg-4 px-xl-0"><header><h2><a href="{url}">{title}</a></h2><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div></header><p>{snippet}</p></article>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
