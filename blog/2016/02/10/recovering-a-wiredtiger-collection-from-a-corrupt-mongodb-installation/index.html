<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Recovering a WiredTiger collection from a corrupt MongoDB installation" /><meta name="author" content="Alex Bevilacqua" /><meta property="og:locale" content="en_US" /><meta name="description" content="April, 1 2019: I&#39;ve received a LOT of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a --repair flag in 4.0.3 that simplifies this process significantly." /><meta property="og:description" content="April, 1 2019: I&#39;ve received a LOT of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a --repair flag in 4.0.3 that simplifies this process significantly." /><link rel="canonical" href="https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2016-02-10T20:38:38-05:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Recovering a WiredTiger collection from a corrupt MongoDB installation" /><meta name="twitter:site" content="@alexbevi" /><meta name="twitter:creator" content="@Alex Bevilacqua" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Alex Bevilacqua"},"dateModified":"2021-03-28T13:22:31-04:00","datePublished":"2016-02-10T20:38:38-05:00","description":"April, 1 2019: I&#39;ve received a LOT of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a --repair flag in 4.0.3 that simplifies this process significantly.","headline":"Recovering a WiredTiger collection from a corrupt MongoDB installation","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/"},"url":"https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/"}</script><title>Recovering a WiredTiger collection from a corrupt MongoDB installation | ALEX BEVILACQUA</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6215800856413580" crossorigin="anonymous"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/galleria.min.js"></script><link href="//cdnjs.cloudflare.com/ajax/libs/galleria/1.5.7/themes/classic/galleria.classic.min.css" media="screen, projection" rel="stylesheet" type="text/css" /><style> /* This rule is read by Galleria to define the gallery height: */ .galleria{ width: 700px; height: 400px; background: #000 } .responsive-wrap iframe{ max-width: 100%;}</style><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/images/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle font-italic">my little corner of the interwebs</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/alexbevi" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/alexbevi" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener"> <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener"> <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener"> <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener"> <i class="fab fa-reddit"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> Blog </span> <span> 2016 </span> <span> 02 </span> <span> 10 </span> <span>Recovering a WiredTiger collection from a corrupt MongoDB installation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Recovering a WiredTiger collection from a corrupt MongoDB installation</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Wed, Feb 10, 2016, 8:38 PM -0500" > Feb 10, 2016 <i class="unloaded">2016-02-10T20:38:38-05:00</i> </span> by <span class="author"> Alex Bevilacqua </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sun, Mar 28, 2021, 1:22 PM -0400" > Mar 28, 2021 <i class="unloaded">2021-03-28T13:22:31-04:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1872 words">10 min</span></div></div><div class="post-content"><blockquote> April, 1 2019: I've received a <em>LOT</em> of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a <tt>--repair</tt> flag in 4.0.3 that simplifies this process significantly. I would recommend reading their <a href="https://docs.mongodb.com/manual/tutorial/recover-data-following-unexpected-shutdown">"Recover a Standalone after an Unexpected Shutdown"</a> tutorial to see if it applies to your recovery scenario.</blockquote><p>Recently at work, we experienced a series of events that could have proven to be catastrophic for one of our datasets. We have a daily process that does daily cleanup, but relies on the presence of control data that is ETL’d in from another process.</p><p>The secondary process failed, and as a result, <em>everything</em> was “cleaned” … aka, we purged an entire dataset.</p><p>This data happens to be on a 5 node replicaset (primary-secondary-secondary-arbiter-hidden), and the hidden node died over the holidays and I waited too long to recover it, so it was unable to ever catch up to the primary (always stuck in a RECOVERING state).</p><p>My incredible foresight (… laziness … ) resulted in us having a backup of the data ready to be extracted from the out of sync hidden node. All we had to do was start up <strong>mongod</strong> … right?</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>2016-01-29T21:06:05.180-0500 I CONTROL  ***** SERVER RESTARTED *****
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] MongoDB starting : pid=1745 port=27021 dbpath=/data 64-bit host=xxx
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] db version v3.0.8
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] git version: 83d8cc25e00e42856924d84e220fbe4a839e605d
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] build info: Linux build3.ny.cbi.10gen.cc 2.6.32-431.3.1.el6.x86_64 #1 SMP Fri Jan 3 21:39:27 UTC 2014 x86_64 BOOST_LIB_VERSION=1_49
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] allocator: tcmalloc
...
2016-01-29T21:06:05.315-0500 W -        [initandlisten] Detected unclean shutdown - /data/mongod.lock is not empty.
2016-01-29T21:06:05.315-0500 W STORAGE  [initandlisten] Recovering data from the last clean checkpoint.
2016-01-29T21:06:05.324-0500 I STORAGE  [initandlisten] wiredtiger_open config: create,cache_size=13G,session_max=20000,eviction=(threads_max=4),statistics=(fast),log=(enabled=true,archive=true
,path=journal,compressor=snappy),file_manager=(close_idle_time=100000),checkpoint=(wait=60,log_size=2GB),statistics_log=(wait=0),
2016-01-29T21:06:05.725-0500 E STORAGE  [initandlisten] WiredTiger (0) [1454119565:724960][1745:0x7f2ac9534bc0], file:WiredTiger.wt, cursor.next: read checksum error for 4096B block at offset 6
799360: block header checksum of 1769173605 doesn't match expected checksum of 4176084783
2016-01-29T21:06:05.725-0500 E STORAGE  [initandlisten] WiredTiger (0) [1454119565:725067][1745:0x7f2ac9534bc0], file:WiredTiger.wt, cursor.next: WiredTiger.wt: encountered an illegal file form
at or internal value
2016-01-29T21:06:05.725-0500 E STORAGE  [initandlisten] WiredTiger (-31804) [1454119565:725088][1745:0x7f2ac9534bc0], file:WiredTiger.wt, cursor.next: the process must exit and restart: WT_PANI
C: WiredTiger library panic
2016-01-29T21:06:05.725-0500 I -        [initandlisten] Fatal Assertion 28558
</pre></table></code></div></div><p>Aw crap. I could not for the life of me get the node back up and running. Since this was a replica-set member, I thought maybe if I just copied the failing file from the (working) primary it would just work. Apparently that’s not the way MongoDB or WiredTiger works :P. Back to the drawing board.</p><p>I could see that my data directory contained a bunch of <code class="language-plaintext highlighter-rouge">collection-*.wt</code> and <code class="language-plaintext highlighter-rouge">index-*.wt</code> files, so I assumed these were the WiredTiger collection and index files. These are binary files so <code class="language-plaintext highlighter-rouge">grep</code>-ing didn’t help me identify the collection I needed.</p><p>I wanted to next see if I could just copy the collection’s backing file directly to a new (working) MongoDB installation, so I started up a new <code class="language-plaintext highlighter-rouge">mongod</code>, created a new collection with a document in it, then copied over any <code class="language-plaintext highlighter-rouge">collection-*.wt</code> file to see what would happen.</p><p>Guess what … didn’t work.</p><p><strong>Identify the WiredTiger collection’s backing file</strong></p><p>Since we had access to a working node, plus the collection hadn’t been dropped (just purged), I thought maybe the files on each node would be the same. I logged into the primary via the shell to get some info from my collection.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre>db.getCollection('borkedCollection').stats()

{
    "ns" : "production.borkedCollection",
    "count" : 0,
    "size" : 0,
    "storageSize" : 1138688,
    "capped" : false,
    "wiredTiger" : {
        "metadata" : {
            "formatVersion" : 1
        },
        "creationString" : "allocation_size=4KB,app_metadata=(formatVersion=1),block_allocation=best,block_compressor=snappy,cache_resident=0,checkpoint=(WiredTigerCheckpoint.5149=(addr=\"01808080808080c0b081e40ebe4855808080e3113fc0e401417fc0\",order=5149,time=1454966060,size=21078016,write_gen=119495)),checkpoint_lsn=(224134,44112768),checksum=on,collator=,columns=,dictionary=0,format=btree,huffman_key=,huffman_value=,id=178668,internal_item_max=0,internal_key_max=0,internal_key_truncate=,internal_page_max=4KB,key_format=q,key_gap=10,leaf_item_max=0,leaf_key_max=0,leaf_page_max=32KB,leaf_value_max=1MB,memory_page_max=10m,os_cache_dirty_max=0,os_cache_max=0,prefix_compression=0,prefix_compression_min=4,split_deepen_min_child=0,split_deepen_per_child=0,split_pct=90,value_format=u,version=(major=1,minor=1)",
        "type" : "file",
        "uri" : "statistics:table:collection-7895--1435676552983097781",
        "LSM" : {
            //...
        },
        "block-manager" : {
            //...
        },
        "btree" : {
            // ...
        },
        // ...
    },
    "nindexes" : 4,
    "totalIndexSize" : 1437696,
    "indexSizes" : {
        "_id_" : 212992,
        // ...
    },
    "ok" : 1
}
</pre></table></code></div></div><p>That <code class="language-plaintext highlighter-rouge">"uri" : "statistics:table:collection-7895--1435676552983097781"</code> entry looked promising.</p><p>I started hunting for a way to extract the data from this file without having to “mount” the file in another MongoDB installation, as I assumed this was not possible. I stumbled across a command line utility for WiredTiger that <a href="http://source.wiredtiger.com/2.7.0/command_line.html#util_salvage">happened to have a ‘salvage’ command</a>.</p><p><strong>Salvaging the WiredTiger collection</strong></p><p>In order to use the <code class="language-plaintext highlighter-rouge">wt</code> utility, you have to build it from source. Being comfortable in Linux, this was not daunting ;)</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>wget http://source.wiredtiger.com/releases/wiredtiger-2.7.0.tar.bz2
tar xvf wiredtiger-2.7.0.tar.bz2
cd wiredtiger-2.7.0
sudo apt-get install libsnappy-dev build-essential
./configure --enable-snappy
make
</pre></table></code></div></div><p><strong>NOTE</strong> adding support for Google’s <a href="https://github.com/google/snappy">snappy</a> compressor when building WiredTiger will save you some errors that I initially encountered when trying to salvage the data.</p><p>Now that I had a <code class="language-plaintext highlighter-rouge">wt</code> utility, I wanted to test it out on the collection file. It turns out that you need additional supporting files before you can do this. Once I’d copied over the necessary files, my working directory (called <code class="language-plaintext highlighter-rouge">mongo-bak</code>) looked like this:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>-rw-r--r-- 1 root      root      4738772992 Feb  9 14:06 collection-2657--1723320556100349955.wt
-rw-r--r-- 1 root      root         1155072 Feb  9 14:05 _mdb_catalog.wt
-rw-r--r-- 1 root      root        26935296 Feb  9 14:05 sizeStorer.wt
-rw-r--r-- 1 root      root              95 Feb  9 14:05 storage.bson
-rw-r--r-- 1 root      root              46 Feb  9 14:04 WiredTiger
-rw-r--r-- 1 root      root             495 Feb  9 14:04 WiredTiger.basecfg
-rw-r--r-- 1 root      root              21 Feb  9 14:04 WiredTiger.lock
-rw-r--r-- 1 root      root             916 Feb  9 14:04 WiredTiger.turtle
-rw-r--r-- 1 root      root        10436608 Feb  9 14:04 WiredTiger.wt
</pre></table></code></div></div><p>Now, from the directory where we compiled WiredTiger, we started salvaging the collection:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./wt -v -h ../mongo-bak -C "extensions=[./ext/compressors/snappy/.libs/libwiredtiger_snappy.so]" -R salvage collection-2657--1723320556100349955.wt
</pre></table></code></div></div><p>You know it’s working if you see output along the lines of:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>WT_SESSION.salvage 639400
</pre></table></code></div></div><p>which I believe is just counting up the number of documents recovered. Once the operation has completed, it will have overwritten the source <code class="language-plaintext highlighter-rouge">*.wt</code> collection file with whatever it could salvage.</p><p>The only issue is that you still can’t load this into MongoDB yet.</p><p><strong>Importing the WiredTiger collection via dump/load into MongoDB</strong></p><p>In order to get the data into MongoDB, first we need to generate a dump file from the WiredTiger collection file. This is done using the <code class="language-plaintext highlighter-rouge">wt</code> utility:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./wt -v -h ../data -C "extensions=[./ext/compressors/snappy/.libs/libwiredtiger_snappy.so]" -R dump -f ../collection.dump collection-2657--1723320556100349955
</pre></table></code></div></div><p>This operation produces no output, so you’ll just have to sit tight and wait a while. You can always <code class="language-plaintext highlighter-rouge">watch ls -l</code> in another console if you want to make sure it’s working ;)</p><p>Once completed, you’ll have a <code class="language-plaintext highlighter-rouge">collection.dump</code> file, but this <em>still</em> can’t be loaded directly into MongoDB. You can however, using the <code class="language-plaintext highlighter-rouge">wt</code> utility one more time, load the dump back into a WiredTiger collection.</p><p>First, let’s startup a new <code class="language-plaintext highlighter-rouge">mongod</code> instance that we can try this out on.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mongod --dbpath tmp-mongo --storageEngine wiredTiger --nojournal
</pre></table></code></div></div><p>Next, let’s connect to this instance via the mongo shell and create a new collection:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>use Recovery
db.borkedCollection.insert({test: 1})
db.borkedCollection.remove({})
db.borkedCollection.stats()
</pre></table></code></div></div><p>I’ve created a new db called <em>Recovery</em>, and inserted/removed a document so the collection’s backing file would be generated. You can use the <code class="language-plaintext highlighter-rouge">stats()</code> method to get the collection name, but since we’re only using one collection, it’s easy enough to find just using <code class="language-plaintext highlighter-rouge">ls</code>.</p><p>Now we’re going to take the backing file name of the collection we just created and use that to load our WiredTiger dump file:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./wt -v -h ../data -C "extensions=[./ext/compressors/snappy/.libs/libwiredtiger_snappy.so]" -R load -f ../collection.dump -r collection-2-880383588247732034
</pre></table></code></div></div><p>Note that we drop the <code class="language-plaintext highlighter-rouge">.wt</code> extension from the collection file above. Also, the <code class="language-plaintext highlighter-rouge">-h</code> flag needs to point to the directory where our <code class="language-plaintext highlighter-rouge">mongod</code> has it’s <code class="language-plaintext highlighter-rouge">dbPath</code>. Finally, <code class="language-plaintext highlighter-rouge">mongod</code> should not be running.</p><p>This operation also provides a progress indicator showing how much data has been loaded:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>table:collection-4--4286091263744514813: 1386220
</pre></table></code></div></div><p>Once completed, we can start <code class="language-plaintext highlighter-rouge">mongod</code> back up, shell in and have a look:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>$ mongo
MongoDB shell version: 3.2.1
connecting to: test
Mongo-Hacker 0.0.9
laptop(mongod-3.2.1) test&gt; show dbs
Recovery → 0.087GB
local    → 0.000GB
laptop(mongod-3.2.1) test&gt; use Recovery
switched to db Recovery
laptop(mongod-3.2.1) Recovery&gt; show collections
borkedCollection → 0.000MB / 88.801MB
laptop(mongod-3.2.1) Recovery&gt; db.borkedCollection.count()
0
</pre></table></code></div></div><p>WTF? The size looks right, but there are no documents???</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>laptop(mongod-3.2.1) Recovery&gt; db.borkedCollection.find({}, {_id: 1})
{
  "_id": ObjectId("55e07f3b2e967329c888ac74")
}
{
  "_id": ObjectId("55e07f3b2e967329c888ac76")
}
...
{
  "_id": ObjectId("55e07f402e967329c888ac85")
}
Fetched 20 record(s) in 29ms -- More[true]
</pre></table></code></div></div><p>Well that’s promising, but the collection still hasn’t been <em>properly</em> restored yet.</p><p><strong>Restoring the MongoDB collection to a usable state</strong></p><p>This final part is pretty straightforward, as we’re just going to do a <code class="language-plaintext highlighter-rouge">mongodump</code>, followed by a <code class="language-plaintext highlighter-rouge">mongorestore</code>.</p><p><strong>NOTE</strong> The <code class="language-plaintext highlighter-rouge">mongodump</code> will fail if you’re using a version of MongoDB &lt; 3.2, as 3.2 is built against WiredTiger 2.7. I initially tested this using MongoDB 3.0.9 and the dump operation just returned 0 results.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre>$ mongodump
2016-02-10T22:04:00.580-0500    writing Recovery.borkedCollection to
2016-02-10T22:04:03.579-0500    Recovery.borkedCollection  268219
2016-02-10T22:04:06.579-0500    Recovery.borkedCollection  340655
2016-02-10T22:04:09.579-0500    Recovery.borkedCollection  496787
2016-02-10T22:04:12.579-0500    Recovery.borkedCollection  670894
2016-02-10T22:04:15.579-0500    Recovery.borkedCollection  778539
2016-02-10T22:04:18.579-0500    Recovery.borkedCollection  848525
2016-02-10T22:04:21.579-0500    Recovery.borkedCollection  991277
2016-02-10T22:04:24.579-0500    Recovery.borkedCollection  1147718
2016-02-10T22:04:27.579-0500    Recovery.borkedCollection  1187600
2016-02-10T22:04:30.579-0500    Recovery.borkedCollection  1353665
2016-02-10T22:04:33.579-0500    Recovery.borkedCollection  1376255
2016-02-10T22:04:33.681-0500    Recovery.borkedCollection  1386220
2016-02-10T22:04:33.682-0500    done dumping Recovery.borkedCollection (1386220 documents)

$ mongorestore --drop
2016-02-10T22:05:51.959-0500    using default 'dump' directory
2016-02-10T22:05:51.960-0500    building a list of dbs and collections to restore from dump dir
2016-02-10T22:05:52.307-0500    reading metadata for Recovery.borkedCollection from dump/Recovery/borkedCollection.metadata.json
2016-02-10T22:05:52.330-0500    restoring Recovery.borkedCollection from dump/Recovery/borkedCollection.bson
2016-02-10T22:05:54.962-0500    [#.......................]  Recovery.borkedCollection  32.8 MB/569.8 MB  (5.8%)
2016-02-10T22:05:57.962-0500    [###.....................]  Recovery.borkedCollection  80.5 MB/569.8 MB  (14.1%)
2016-02-10T22:06:00.962-0500    [#####...................]  Recovery.borkedCollection  131.5 MB/569.8 MB  (23.1%)
2016-02-10T22:06:03.962-0500    [#######.................]  Recovery.borkedCollection  178.5 MB/569.8 MB  (31.3%)
2016-02-10T22:06:06.962-0500    [#########...............]  Recovery.borkedCollection  230.1 MB/569.8 MB  (40.4%)
2016-02-10T22:06:09.962-0500    [###########.............]  Recovery.borkedCollection  271.6 MB/569.8 MB  (47.7%)
2016-02-10T22:06:12.962-0500    [#############...........]  Recovery.borkedCollection  320.6 MB/569.8 MB  (56.3%)
2016-02-10T22:06:15.962-0500    [###############.........]  Recovery.borkedCollection  366.3 MB/569.8 MB  (64.3%)
2016-02-10T22:06:18.962-0500    [#################.......]  Recovery.borkedCollection  414.9 MB/569.8 MB  (72.8%)
2016-02-10T22:06:21.962-0500    [###################.....]  Recovery.borkedCollection  464.8 MB/569.8 MB  (81.6%)
2016-02-10T22:06:24.962-0500    [#####################...]  Recovery.borkedCollection  504.0 MB/569.8 MB  (88.4%)
2016-02-10T22:06:27.962-0500    [#######################.]  Recovery.borkedCollection  554.5 MB/569.8 MB  (97.3%)
2016-02-10T22:06:29.082-0500    [########################]  Recovery.borkedCollection  569.8 MB/569.8 MB  (100.0%)
2016-02-10T22:06:29.082-0500    restoring indexes for collection Recovery.borkedCollection from metadata
2016-02-10T22:06:29.104-0500    finished restoring Recovery.borkedCollection (1386220 documents)
2016-02-10T22:06:29.104-0500    done
</pre></table></code></div></div><p>Now that we’ve dumped and reloaded the collection <em>yet again</em>, we can shell back in and validate that our recovery attempt has succeeded:</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>$ mongo
MongoDB shell version: 3.2.1
connecting to: test
Mongo-Hacker 0.0.9
laptop(mongod-3.2.1) test&gt; show dbs
Recovery → 0.099GB
local    → 0.000GB
laptop(mongod-3.2.1) test&gt; use Recovery
switched to db Recovery
laptop(mongod-3.2.1) Recovery&gt; show collections
borkedCollection → 569.845MB / 88.594MB
laptop(mongod-3.2.1) Recovery&gt; db.borkedCollection.count()
1386220
</pre></table></code></div></div><p>BOOYA! Everything is back and properly accessible.</p><p>The <code class="language-plaintext highlighter-rouge">mongorestore</code> could actually have been done to the primary node in order to recover the data for production purposes. Once that’s done, just recreate the necessary indexes and you’re back in business.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/wiredtiger/" class="post-tag no-text-decoration" >wiredtiger</a> <a href="/tags/data-corruption/" class="post-tag no-text-decoration" >data-corruption</a> <a href="/tags/troubleshooting/" class="post-tag no-text-decoration" >troubleshooting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Recovering a WiredTiger collection from a corrupt MongoDB installation - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Recovering a WiredTiger collection from a corrupt MongoDB installation - ALEX BEVILACQUA&u=https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Recovering a WiredTiger collection from a corrupt MongoDB installation - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" data-toggle="tooltip" data-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin"> <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Recovering a WiredTiger collection from a corrupt MongoDB installation - ALEX BEVILACQUA&url=https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" data-toggle="tooltip" data-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo"> <i class="fa-fw fab fa-weibo"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/blog/2022/08/18/why-use-mongodb-with-ruby/">Why Use MongoDB with Ruby</a><li><a href="/blog/2022/11/02/mongodb-orms-odms-and-libraries/">MongoDB ORMs, ODMs, and Libraries</a><li><a href="/blog/2022/10/06/from-engineering-to-product-management/">From Engineering to Product Management</a><li><a href="/blog/2022/09/21/bug-hunting-with-the-mongodb-haskell-community/">Bug Hunting with the MongoDB Haskell Community</a><li><a href="/blog/2022/09/15/createindex-error-values-in-v-2-index-key-pattern-cannot-be-of-type-object/">Solving a mongorestore failure due to 'Values in v:2 index key pattern cannot be of type object.'</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/replication/">replication</a></div></div></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/blog/2016/02/10/identifying-failing-system-dot-js-functions-in-mongodb/"><div class="card-body"> <span class="timeago small" > Feb 10, 2016 <i class="unloaded">2016-02-10T15:17:56-05:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Identifying failing system.js functions in MongoDB</h3><div class="text-muted small"><p> laptop(mongod-3.2.1) test&gt; db.loadServerScripts() 2016-02-10T15:18:42.322-0500 E QUERY [thread1] SyntaxError: unterminated string literal : DB.prototype.loadServerScripts/&lt;@src/mongo/shell...</p></div></div></a></div><div class="card"> <a href="/blog/2018/05/28/troubleshooting-a-mongodb-performance-issue/"><div class="card-body"> <span class="timeago small" > May 28, 2018 <i class="unloaded">2018-05-28T09:14:03-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Troubleshooting a MongoDB Performance Issue</h3><div class="text-muted small"><p> UPDATE (2018-06-28): I actually sent a link to this article to the author of the previous blog post and in her reply she indicates that the improvements to cache management and checkpoint areas wer...</p></div></div></a></div><div class="card"> <a href="/blog/2020/03/15/identifying-and-reclaiming-disk-space-in-mongodb/"><div class="card-body"> <span class="timeago small" > Mar 15, 2020 <i class="unloaded">2020-03-15T16:23:38-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Identifying and Reclaiming Disk Space in MongoDB</h3><div class="text-muted small"><p> A common question when it comes to MongoDB and the (default) storage engine (WiredTiger) is “Why is it after I removed a bunch of documents my free space didn’t increase”? The WiredTiger storage e...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2016/02/10/identifying-failing-system-dot-js-functions-in-mongodb/" class="btn btn-outline-primary" prompt="Older"><p>Identifying failing system.js functions in MongoDB</p></a> <a href="/blog/2016/02/23/just-finished-shadowrun/" class="btn btn-outline-primary" prompt="Newer"><p>Just Finished - Shadowrun</p></a></div><div id="disqus" class="pt-2 pb-2"><p class="text-center text-muted small pb-5"> Loading comments from <a href="https://disqus.com/">Disqus</a> ...</p></div><script src="/assets/js/lib/jquery.disqusloader.min.js"></script> <script> const options = { scriptUrl: '//alexbevi.disqus.com/embed.js', disqusConfig: function() { this.page.title = 'Recovering a WiredTiger collection from a corrupt MongoDB installation'; this.page.url = 'https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/'; this.page.identifier = '/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/'; } }; $.disqusLoader('#disqus', options); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/mongodb/">mongodb</a> <a class="post-tag" href="/tags/adventure/">adventure</a> <a class="post-tag" href="/tags/redmine/">redmine</a> <a class="post-tag" href="/tags/rpg/">rpg</a> <a class="post-tag" href="/tags/book/">book</a> <a class="post-tag" href="/tags/ruby/">ruby</a> <a class="post-tag" href="/tags/snes/">snes</a> <a class="post-tag" href="/tags/jrpg/">jrpg</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/replication/">replication</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://www.alexbevi.com{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script type="text/javascript" src="/assets/js/lightbox.js"></script><link rel="stylesheet" href="/assets/css/lightbox.css">
