<!doctype html><html lang="en" data-mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="Recovering a WiredTiger collection from a corrupt MongoDB installation" /><meta property="og:locale" content="en" /><meta name="description" content="April, 1 2019: I’ve received a LOT of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a --repair flag in 4.0.3 that simplifies this process significantly. I would recommend reading their “Recover a Standalone after an Unexpected Shutdown” tutorial to see if it applies to your recovery scenario." /><meta property="og:description" content="April, 1 2019: I’ve received a LOT of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a --repair flag in 4.0.3 that simplifies this process significantly. I would recommend reading their “Recover a Standalone after an Unexpected Shutdown” tutorial to see if it applies to your recovery scenario." /><link rel="canonical" href="https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" /><meta property="og:url" content="https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/" /><meta property="og:site_name" content="ALEX BEVILACQUA" /><meta property="og:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2016-02-10T20:38:38-05:00" /><meta name="twitter:card" content="summary_large_image" /><meta property="twitter:image" content="https://www.alexbevi.com/images/mongodb-logo.png" /><meta property="twitter:title" content="Recovering a WiredTiger collection from a corrupt MongoDB installation" /><meta name="twitter:site" content="@alexbevi" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-09T12:45:05-04:00","datePublished":"2016-02-10T20:38:38-05:00","description":"April, 1 2019: I’ve received a LOT of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a --repair flag in 4.0.3 that simplifies this process significantly. I would recommend reading their “Recover a Standalone after an Unexpected Shutdown” tutorial to see if it applies to your recovery scenario.","headline":"Recovering a WiredTiger collection from a corrupt MongoDB installation","image":"https://www.alexbevi.com/images/mongodb-logo.png","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/"},"url":"https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/"}</script><title>Recovering a WiredTiger collection from a corrupt MongoDB installation | ALEX BEVILACQUA</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="ALEX BEVILACQUA"><meta name="application-name" content="ALEX BEVILACQUA"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="/assets/lib/bootstrap/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/tocbot/tocbot.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup/magnific-popup.css"> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/lightgallery.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/zoom/lg-zoom.min.js"></script> <script src="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/plugins/thumbnail/lg-thumbnail.min.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lightgallery-bundle.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-transitions.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-zoom.min.css" rel="stylesheet"><link href="https://cdnjs.cloudflare.com/ajax/libs/lightgallery/2.7.1/css/lg-thumbnail.min.css" rel="stylesheet"><style> .inline-gallery-container { width: 100%; // set 60% height height: 0; padding-bottom: 65%; }</style><body><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"> <img src="/images/avatar.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"> </a><div class="site-title"> <a href="/">ALEX BEVILACQUA</a></div><div class="site-subtitle fst-italic">my little corner of the interwebs</div></div><ul class="nav flex-column flex-grow-1 w-100 ps-0"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <a href="https://github.com/alexbevi " aria-label="github" target="_blank" rel="noopener noreferrer" > <i class="fab fa-github"></i> </a> <a href="https://twitter.com/alexbevi " aria-label="twitter" target="_blank" rel="noopener noreferrer" > <i class="fab fa-twitter"></i> </a> <a href="javascript:location.href = 'mailto:' + ['alex','alexbevi.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a> <a href="@alexbevi@ruby.social" aria-label="mastodon" target="_blank" rel="noopener noreferrer me" > <i class="fab fa-mastodon"></i> </a> <a href="https://linkedin.com/in/alexbevi" aria-label="linkedin" target="_blank" rel="noopener noreferrer" > <i class="fab fa-linkedin"></i> </a> <a href="https://stackoverflow.com/users/195509" aria-label="stack-overflow" target="_blank" rel="noopener noreferrer" > <i class="fab fa-stack-overflow"></i> </a> <a href="https://www.facebook.com/alexbevi" aria-label="facebook" target="_blank" rel="noopener noreferrer" > <i class="fab fa-facebook"></i> </a> <a href="https://reddit.com/user/alexbevi" aria-label="reddit" target="_blank" rel="noopener noreferrer" > <i class="fab fa-reddit"></i> </a></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container px-xxl-5"><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100" > <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Recovering a WiredTiger collection from a corrupt MongoDB installation</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </span> <span id="search-cancel">Cancel</span></div></div><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pe-xl-4"><div class="post px-1 px-md-2"><h1 data-toc-skip>Recovering a WiredTiger collection from a corrupt MongoDB installation</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1455154718" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Feb 10, 2016 </em> </span> <span> Updated <em class="" data-ts="1683650705" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > May 9, 2023 </em> </span><div class="mt-3 mb-3"> <a href="/images/mongodb-logo.png" class="popup img-link preview-img shimmer"><img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1200 630'%3E%3C/svg%3E" data-src="/images/mongodb-logo.png" alt="Preview Image" width="1200" height="630" class="lazyload" data-proofer-ignore></a></div><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a> </em> </span><div> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="1870 words" > <em>10 min</em> read </span></div></div></div><div class="post-content"><blockquote class="prompt-info"><p><strong>April, 1 2019</strong>: I’ve received a LOT of feedback on this article since it was published. I would like to point out that although the methods described here may still work, MongoDB introduced a <code class="language-plaintext highlighter-rouge">--repair</code> flag in 4.0.3 that simplifies this process significantly.</p><p>I would recommend reading their <a href="https://docs.mongodb.com/manual/tutorial/recover-data-following-unexpected-shutdown">“Recover a Standalone after an Unexpected Shutdown”</a> tutorial to see if it applies to your recovery scenario.</p></blockquote><p>Recently at work, we experienced a series of events that could have proven to be catastrophic for one of our datasets. We have a daily process that does daily cleanup, but relies on the presence of control data that is ETL’d in from another process.</p><p>The secondary process failed, and as a result, <em>everything</em> was “cleaned” … aka, we purged an entire dataset.</p><p>This data happens to be on a 5 node replicaset (primary-secondary-secondary-arbiter-hidden), and the hidden node died over the holidays and I waited too long to recover it, so it was unable to ever catch up to the primary (always stuck in a RECOVERING state).</p><p>My incredible foresight (… laziness … ) resulted in us having a backup of the data ready to be extracted from the out of sync hidden node. All we had to do was start up <strong>mongod</strong> … right?</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>2016-01-29T21:06:05.180-0500 I CONTROL  ***** SERVER RESTARTED *****
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] MongoDB starting : pid=1745 port=27021 dbpath=/data 64-bit host=xxx
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] db version v3.0.8
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] git version: 83d8cc25e00e42856924d84e220fbe4a839e605d
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] build info: Linux build3.ny.cbi.10gen.cc 2.6.32-431.3.1.el6.x86_64 #1 SMP Fri Jan 3 21:39:27 UTC 2014 x86_64 BOOST_LIB_VERSION=1_49
2016-01-29T21:06:05.241-0500 I CONTROL  [initandlisten] allocator: tcmalloc
...
2016-01-29T21:06:05.315-0500 W -        [initandlisten] Detected unclean shutdown - /data/mongod.lock is not empty.
2016-01-29T21:06:05.315-0500 W STORAGE  [initandlisten] Recovering data from the last clean checkpoint.
2016-01-29T21:06:05.324-0500 I STORAGE  [initandlisten] wiredtiger_open config: create,cache_size=13G,session_max=20000,eviction=(threads_max=4),statistics=(fast),log=(enabled=true,archive=true
,path=journal,compressor=snappy),file_manager=(close_idle_time=100000),checkpoint=(wait=60,log_size=2GB),statistics_log=(wait=0),
2016-01-29T21:06:05.725-0500 E STORAGE  [initandlisten] WiredTiger (0) [1454119565:724960][1745:0x7f2ac9534bc0], file:WiredTiger.wt, cursor.next: read checksum error for 4096B block at offset 6
799360: block header checksum of 1769173605 doesn't match expected checksum of 4176084783
2016-01-29T21:06:05.725-0500 E STORAGE  [initandlisten] WiredTiger (0) [1454119565:725067][1745:0x7f2ac9534bc0], file:WiredTiger.wt, cursor.next: WiredTiger.wt: encountered an illegal file form
at or internal value
2016-01-29T21:06:05.725-0500 E STORAGE  [initandlisten] WiredTiger (-31804) [1454119565:725088][1745:0x7f2ac9534bc0], file:WiredTiger.wt, cursor.next: the process must exit and restart: WT_PANI
C: WiredTiger library panic
2016-01-29T21:06:05.725-0500 I -        [initandlisten] Fatal Assertion 28558
</pre></table></code></div></div><p>Aw crap. I could not for the life of me get the node back up and running. Since this was a replica-set member, I thought maybe if I just copied the failing file from the (working) primary it would just work. Apparently that’s not the way MongoDB or WiredTiger works :P. Back to the drawing board.</p><p>I could see that my data directory contained a bunch of <code class="language-plaintext highlighter-rouge">collection-*.wt</code> and <code class="language-plaintext highlighter-rouge">index-*.wt</code> files, so I assumed these were the WiredTiger collection and index files. These are binary files so <code class="language-plaintext highlighter-rouge">grep</code>-ing didn’t help me identify the collection I needed.</p><p>I wanted to next see if I could just copy the collection’s backing file directly to a new (working) MongoDB installation, so I started up a new <code class="language-plaintext highlighter-rouge">mongod</code>, created a new collection with a document in it, then copied over any <code class="language-plaintext highlighter-rouge">collection-*.wt</code> file to see what would happen.</p><p>Guess what … didn’t work.</p><h2 id="identify-the-wiredtiger-collections-backing-file"><span class="me-2">Identify the WiredTiger collection’s backing file</span><a href="#identify-the-wiredtiger-collections-backing-file" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Since we had access to a working node, plus the collection hadn’t been dropped (just purged), I thought maybe the files on each node would be the same. I logged into the primary via the shell to get some info from my collection.</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="nx">db</span><span class="p">.</span><span class="nf">getCollection</span><span class="p">(</span><span class="dl">'</span><span class="s1">borkedCollection</span><span class="dl">'</span><span class="p">).</span><span class="nf">stats</span><span class="p">()</span>

<span class="p">{</span>
    <span class="dl">"</span><span class="s2">ns</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">production.borkedCollection</span><span class="dl">"</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">count</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">size</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">storageSize</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1138688</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">capped</span><span class="dl">"</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">wiredTiger</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">metadata</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="dl">"</span><span class="s2">formatVersion</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1</span>
        <span class="p">},</span>
        <span class="dl">"</span><span class="s2">creationString</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">allocation_size=4KB,app_metadata=(formatVersion=1),block_allocation=best,block_compressor=snappy,cache_resident=0,checkpoint=(WiredTigerCheckpoint.5149=(addr=</span><span class="se">\"</span><span class="s2">01808080808080c0b081e40ebe4855808080e3113fc0e401417fc0</span><span class="se">\"</span><span class="s2">,order=5149,time=1454966060,size=21078016,write_gen=119495)),checkpoint_lsn=(224134,44112768),checksum=on,collator=,columns=,dictionary=0,format=btree,huffman_key=,huffman_value=,id=178668,internal_item_max=0,internal_key_max=0,internal_key_truncate=,internal_page_max=4KB,key_format=q,key_gap=10,leaf_item_max=0,leaf_key_max=0,leaf_page_max=32KB,leaf_value_max=1MB,memory_page_max=10m,os_cache_dirty_max=0,os_cache_max=0,prefix_compression=0,prefix_compression_min=4,split_deepen_min_child=0,split_deepen_per_child=0,split_pct=90,value_format=u,version=(major=1,minor=1)</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">type</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">file</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">uri</span><span class="dl">"</span> <span class="p">:</span> <span class="dl">"</span><span class="s2">statistics:table:collection-7895--1435676552983097781</span><span class="dl">"</span><span class="p">,</span>
        <span class="dl">"</span><span class="s2">LSM</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="c1">//...</span>
        <span class="p">},</span>
        <span class="dl">"</span><span class="s2">block-manager</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="c1">//...</span>
        <span class="p">},</span>
        <span class="dl">"</span><span class="s2">btree</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="c1">// ...</span>
        <span class="p">},</span>
        <span class="c1">// ...</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">nindexes</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">totalIndexSize</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1437696</span><span class="p">,</span>
    <span class="dl">"</span><span class="s2">indexSizes</span><span class="dl">"</span> <span class="p">:</span> <span class="p">{</span>
        <span class="dl">"</span><span class="s2">_id_</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">212992</span><span class="p">,</span>
        <span class="c1">// ...</span>
    <span class="p">},</span>
    <span class="dl">"</span><span class="s2">ok</span><span class="dl">"</span> <span class="p">:</span> <span class="mi">1</span>
<span class="p">}</span>
</pre></table></code></div></div><p>That <code class="language-plaintext highlighter-rouge">"uri" : "statistics:table:collection-7895--1435676552983097781"</code> entry looked promising.</p><p>I started hunting for a way to extract the data from this file without having to “mount” the file in another MongoDB installation, as I assumed this was not possible. I stumbled across a command line utility for WiredTiger that <a href="http://source.wiredtiger.com/2.7.0/command_line.html#util_salvage">happened to have a ‘salvage’ command</a>.</p><h2 id="salvaging-the-wiredtiger-collection"><span class="me-2">Salvaging the WiredTiger collection</span><a href="#salvaging-the-wiredtiger-collection" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In order to use the <code class="language-plaintext highlighter-rouge">wt</code> utility, you have to build it from source. Being comfortable in Linux, this was not daunting ;)</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre>wget http://source.wiredtiger.com/releases/wiredtiger-2.7.0.tar.bz2
tar xvf wiredtiger-2.7.0.tar.bz2
cd wiredtiger-2.7.0
sudo apt-get install libsnappy-dev build-essential
./configure --enable-snappy
make
</pre></table></code></div></div><blockquote class="prompt-tip"><p>Adding support for Google’s <a href="https://github.com/google/snappy">snappy</a> compressor when building WiredTiger will save you some errors that I initially encountered when trying to salvage the data.</p></blockquote><p>Now that I had a <code class="language-plaintext highlighter-rouge">wt</code> utility, I wanted to test it out on the collection file. It turns out that you need additional supporting files before you can do this. Once I’d copied over the necessary files, my working directory (called <code class="language-plaintext highlighter-rouge">mongo-bak</code>) looked like this:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>-rw-r--r-- 1 root      root      4738772992 Feb  9 14:06 collection-2657--1723320556100349955.wt
-rw-r--r-- 1 root      root         1155072 Feb  9 14:05 _mdb_catalog.wt
-rw-r--r-- 1 root      root        26935296 Feb  9 14:05 sizeStorer.wt
-rw-r--r-- 1 root      root              95 Feb  9 14:05 storage.bson
-rw-r--r-- 1 root      root              46 Feb  9 14:04 WiredTiger
-rw-r--r-- 1 root      root             495 Feb  9 14:04 WiredTiger.basecfg
-rw-r--r-- 1 root      root              21 Feb  9 14:04 WiredTiger.lock
-rw-r--r-- 1 root      root             916 Feb  9 14:04 WiredTiger.turtle
-rw-r--r-- 1 root      root        10436608 Feb  9 14:04 WiredTiger.wt
</pre></table></code></div></div><p>Now, from the directory where we compiled WiredTiger, we started salvaging the collection:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./wt -v -h ../mongo-bak -C "extensions=[./ext/compressors/snappy/.libs/libwiredtiger_snappy.so]" -R salvage collection-2657--1723320556100349955.wt
</pre></table></code></div></div><p>You know it’s working if you see output along the lines of:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>WT_SESSION.salvage 639400
</pre></table></code></div></div><p>which I believe is just counting up the number of documents recovered. Once the operation has completed, it will have overwritten the source <code class="language-plaintext highlighter-rouge">*.wt</code> collection file with whatever it could salvage.</p><p>The only issue is that you still can’t load this into MongoDB yet.</p><h2 id="importing-the-wiredtiger-collection-via-dumpload-into-mongodb"><span class="me-2">Importing the WiredTiger collection via dump/load into MongoDB</span><a href="#importing-the-wiredtiger-collection-via-dumpload-into-mongodb" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In order to get the data into MongoDB, first we need to generate a dump file from the WiredTiger collection file. This is done using the <code class="language-plaintext highlighter-rouge">wt</code> utility:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./wt -v -h ../data -C "extensions=[./ext/compressors/snappy/.libs/libwiredtiger_snappy.so]" -R dump -f ../collection.dump collection-2657--1723320556100349955
</pre></table></code></div></div><p>This operation produces no output, so you’ll just have to sit tight and wait a while. You can always <code class="language-plaintext highlighter-rouge">watch ls -l</code> in another console if you want to make sure it’s working ;)</p><p>Once completed, you’ll have a <code class="language-plaintext highlighter-rouge">collection.dump</code> file, but this <em>still</em> can’t be loaded directly into MongoDB. You can however, using the <code class="language-plaintext highlighter-rouge">wt</code> utility one more time, load the dump back into a WiredTiger collection.</p><p>First, let’s startup a new <code class="language-plaintext highlighter-rouge">mongod</code> instance that we can try this out on.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>mongod --dbpath tmp-mongo --storageEngine wiredTiger --nojournal
</pre></table></code></div></div><p>Next, let’s connect to this instance via the mongo shell and create a new collection:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>use Recovery
db.borkedCollection.insert({test: 1})
db.borkedCollection.remove({})
db.borkedCollection.stats()
</pre></table></code></div></div><p>I’ve created a new db called <em>Recovery</em>, and inserted/removed a document so the collection’s backing file would be generated. You can use the <code class="language-plaintext highlighter-rouge">stats()</code> method to get the collection name, but since we’re only using one collection, it’s easy enough to find just using <code class="language-plaintext highlighter-rouge">ls</code>.</p><p>Now we’re going to take the backing file name of the collection we just created and use that to load our WiredTiger dump file:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>./wt -v -h ../data -C "extensions=[./ext/compressors/snappy/.libs/libwiredtiger_snappy.so]" -R load -f ../collection.dump -r collection-2-880383588247732034
</pre></table></code></div></div><p>Note that we drop the <code class="language-plaintext highlighter-rouge">.wt</code> extension from the collection file above. Also, the <code class="language-plaintext highlighter-rouge">-h</code> flag needs to point to the directory where our <code class="language-plaintext highlighter-rouge">mongod</code> has it’s <code class="language-plaintext highlighter-rouge">dbPath</code>. Finally, <code class="language-plaintext highlighter-rouge">mongod</code> should not be running.</p><p>This operation also provides a progress indicator showing how much data has been loaded:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>table:collection-4--4286091263744514813: 1386220
</pre></table></code></div></div><p>Once completed, we can start <code class="language-plaintext highlighter-rouge">mongod</code> back up, shell in and have a look:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nx">$</span> <span class="nx">mongo</span>
<span class="nx">MongoDB</span> <span class="nx">shell</span> <span class="nx">version</span><span class="p">:</span> <span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span>
<span class="nx">connecting</span> <span class="nx">to</span><span class="p">:</span> <span class="nx">test</span>
<span class="nx">Mongo</span><span class="o">-</span><span class="nx">Hacker</span> <span class="mf">0.0</span><span class="p">.</span><span class="mi">9</span>
<span class="nf">laptop</span><span class="p">(</span><span class="nx">mongod</span><span class="o">-</span><span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="nx">test</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">dbs</span>
<span class="nx">Recovery</span> <span class="err">→</span> <span class="mf">0.087</span><span class="nx">GB</span>
<span class="nx">local</span>    <span class="err">→</span> <span class="mf">0.000</span><span class="nx">GB</span>
<span class="nf">laptop</span><span class="p">(</span><span class="nx">mongod</span><span class="o">-</span><span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="nx">test</span><span class="o">&gt;</span> <span class="nx">use</span> <span class="nx">Recovery</span>
<span class="nx">switched</span> <span class="nx">to</span> <span class="nx">db</span> <span class="nx">Recovery</span>
<span class="nf">laptop</span><span class="p">(</span><span class="nx">mongod</span><span class="o">-</span><span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="nx">Recovery</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">collections</span>
<span class="nx">borkedCollection</span> <span class="err">→</span> <span class="mf">0.000</span><span class="nx">MB</span> <span class="o">/</span> <span class="mf">88.801</span><span class="nx">MB</span>
<span class="nf">laptop</span><span class="p">(</span><span class="nx">mongod</span><span class="o">-</span><span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="nx">Recovery</span><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">borkedCollection</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
<span class="mi">0</span>
</pre></table></code></div></div><p>WTF? The size looks right, but there are no documents???</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="nf">laptop</span><span class="p">(</span><span class="nx">mongod</span><span class="o">-</span><span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="nx">Recovery</span><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">borkedCollection</span><span class="p">.</span><span class="nf">find</span><span class="p">({},</span> <span class="p">{</span><span class="na">_id</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span><span class="p">:</span> <span class="nc">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">55e07f3b2e967329c888ac74</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span><span class="p">:</span> <span class="nc">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">55e07f3b2e967329c888ac76</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>
<span class="p">...</span>
<span class="p">{</span>
  <span class="dl">"</span><span class="s2">_id</span><span class="dl">"</span><span class="p">:</span> <span class="nc">ObjectId</span><span class="p">(</span><span class="dl">"</span><span class="s2">55e07f402e967329c888ac85</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">Fetched</span> <span class="mi">20</span> <span class="nf">record</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="k">in</span> <span class="mi">29</span><span class="nx">ms</span> <span class="o">--</span> <span class="nx">More</span><span class="p">[</span><span class="kc">true</span><span class="p">]</span>
</pre></table></code></div></div><p>Well that’s promising, but the collection still hasn’t been <em>properly</em> restored yet.</p><h2 id="restoring-the-mongodb-collection-to-a-usable-state"><span class="me-2">Restoring the MongoDB collection to a usable state</span><a href="#restoring-the-mongodb-collection-to-a-usable-state" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This final part is pretty straightforward, as we’re just going to do a <code class="language-plaintext highlighter-rouge">mongodump</code>, followed by a <code class="language-plaintext highlighter-rouge">mongorestore</code>.</p><blockquote class="prompt-tip"><p>The <code class="language-plaintext highlighter-rouge">mongodump</code> will fail if you’re using a version of MongoDB &lt; 3.2, as 3.2 is built against WiredTiger 2.7. I initially tested this using MongoDB 3.0.9 and the dump operation just returned 0 results.</p></blockquote><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre>$ mongodump
2016-02-10T22:04:00.580-0500    writing Recovery.borkedCollection to
2016-02-10T22:04:03.579-0500    Recovery.borkedCollection  268219
2016-02-10T22:04:06.579-0500    Recovery.borkedCollection  340655
2016-02-10T22:04:09.579-0500    Recovery.borkedCollection  496787
2016-02-10T22:04:12.579-0500    Recovery.borkedCollection  670894
2016-02-10T22:04:15.579-0500    Recovery.borkedCollection  778539
2016-02-10T22:04:18.579-0500    Recovery.borkedCollection  848525
2016-02-10T22:04:21.579-0500    Recovery.borkedCollection  991277
2016-02-10T22:04:24.579-0500    Recovery.borkedCollection  1147718
2016-02-10T22:04:27.579-0500    Recovery.borkedCollection  1187600
2016-02-10T22:04:30.579-0500    Recovery.borkedCollection  1353665
2016-02-10T22:04:33.579-0500    Recovery.borkedCollection  1376255
2016-02-10T22:04:33.681-0500    Recovery.borkedCollection  1386220
2016-02-10T22:04:33.682-0500    done dumping Recovery.borkedCollection (1386220 documents)

$ mongorestore --drop
2016-02-10T22:05:51.959-0500    using default 'dump' directory
2016-02-10T22:05:51.960-0500    building a list of dbs and collections to restore from dump dir
2016-02-10T22:05:52.307-0500    reading metadata for Recovery.borkedCollection from dump/Recovery/borkedCollection.metadata.json
2016-02-10T22:05:52.330-0500    restoring Recovery.borkedCollection from dump/Recovery/borkedCollection.bson
2016-02-10T22:05:54.962-0500    [#.......................]  Recovery.borkedCollection  32.8 MB/569.8 MB  (5.8%)
2016-02-10T22:05:57.962-0500    [###.....................]  Recovery.borkedCollection  80.5 MB/569.8 MB  (14.1%)
2016-02-10T22:06:00.962-0500    [#####...................]  Recovery.borkedCollection  131.5 MB/569.8 MB  (23.1%)
2016-02-10T22:06:03.962-0500    [#######.................]  Recovery.borkedCollection  178.5 MB/569.8 MB  (31.3%)
2016-02-10T22:06:06.962-0500    [#########...............]  Recovery.borkedCollection  230.1 MB/569.8 MB  (40.4%)
2016-02-10T22:06:09.962-0500    [###########.............]  Recovery.borkedCollection  271.6 MB/569.8 MB  (47.7%)
2016-02-10T22:06:12.962-0500    [#############...........]  Recovery.borkedCollection  320.6 MB/569.8 MB  (56.3%)
2016-02-10T22:06:15.962-0500    [###############.........]  Recovery.borkedCollection  366.3 MB/569.8 MB  (64.3%)
2016-02-10T22:06:18.962-0500    [#################.......]  Recovery.borkedCollection  414.9 MB/569.8 MB  (72.8%)
2016-02-10T22:06:21.962-0500    [###################.....]  Recovery.borkedCollection  464.8 MB/569.8 MB  (81.6%)
2016-02-10T22:06:24.962-0500    [#####################...]  Recovery.borkedCollection  504.0 MB/569.8 MB  (88.4%)
2016-02-10T22:06:27.962-0500    [#######################.]  Recovery.borkedCollection  554.5 MB/569.8 MB  (97.3%)
2016-02-10T22:06:29.082-0500    [########################]  Recovery.borkedCollection  569.8 MB/569.8 MB  (100.0%)
2016-02-10T22:06:29.082-0500    restoring indexes for collection Recovery.borkedCollection from metadata
2016-02-10T22:06:29.104-0500    finished restoring Recovery.borkedCollection (1386220 documents)
2016-02-10T22:06:29.104-0500    done
</pre></table></code></div></div><p>Now that we’ve dumped and reloaded the collection <em>yet again</em>, we can shell back in and validate that our recovery attempt has succeeded:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre><span class="nx">$</span> <span class="nx">mongo</span>
<span class="nx">MongoDB</span> <span class="nx">shell</span> <span class="nx">version</span><span class="p">:</span> <span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span>
<span class="nx">connecting</span> <span class="nx">to</span><span class="p">:</span> <span class="nx">test</span>
<span class="nx">Mongo</span><span class="o">-</span><span class="nx">Hacker</span> <span class="mf">0.0</span><span class="p">.</span><span class="mi">9</span>
<span class="nf">laptop</span><span class="p">(</span><span class="nx">mongod</span><span class="o">-</span><span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="nx">test</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">dbs</span>
<span class="nx">Recovery</span> <span class="err">→</span> <span class="mf">0.099</span><span class="nx">GB</span>
<span class="nx">local</span>    <span class="err">→</span> <span class="mf">0.000</span><span class="nx">GB</span>
<span class="nf">laptop</span><span class="p">(</span><span class="nx">mongod</span><span class="o">-</span><span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="nx">test</span><span class="o">&gt;</span> <span class="nx">use</span> <span class="nx">Recovery</span>
<span class="nx">switched</span> <span class="nx">to</span> <span class="nx">db</span> <span class="nx">Recovery</span>
<span class="nf">laptop</span><span class="p">(</span><span class="nx">mongod</span><span class="o">-</span><span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="nx">Recovery</span><span class="o">&gt;</span> <span class="nx">show</span> <span class="nx">collections</span>
<span class="nx">borkedCollection</span> <span class="err">→</span> <span class="mf">569.845</span><span class="nx">MB</span> <span class="o">/</span> <span class="mf">88.594</span><span class="nx">MB</span>
<span class="nf">laptop</span><span class="p">(</span><span class="nx">mongod</span><span class="o">-</span><span class="mf">3.2</span><span class="p">.</span><span class="mi">1</span><span class="p">)</span> <span class="nx">Recovery</span><span class="o">&gt;</span> <span class="nx">db</span><span class="p">.</span><span class="nx">borkedCollection</span><span class="p">.</span><span class="nf">count</span><span class="p">()</span>
<span class="mi">1386220</span>
</pre></table></code></div></div><p>BOOYA! Everything is back and properly accessible.</p><p>The <code class="language-plaintext highlighter-rouge">mongorestore</code> could actually have been done to the primary node in order to recover the data for production purposes. Once that’s done, just recreate the necessary indexes and you’re back in business.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw me-1"></i> <a href='/categories/mongodb/'>MongoDB</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw me-1"></i> <a href="/tags/mongodb/" class="post-tag no-text-decoration" >mongodb</a> <a href="/tags/wiredtiger/" class="post-tag no-text-decoration" >wiredtiger</a> <a href="/tags/data-corruption/" class="post-tag no-text-decoration" >data-corruption</a> <a href="/tags/troubleshooting/" class="post-tag no-text-decoration" >troubleshooting</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted me-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Recovering%20a%20WiredTiger%20collection%20from%20a%20corrupt%20MongoDB%20installation%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2016%2F02%2F10%2Frecovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter" > <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Recovering%20a%20WiredTiger%20collection%20from%20a%20corrupt%20MongoDB%20installation%20-%20ALEX%20BEVILACQUA&u=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2016%2F02%2F10%2Frecovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook" > <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2016%2F02%2F10%2Frecovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation%2F&text=Recovering%20a%20WiredTiger%20collection%20from%20a%20corrupt%20MongoDB%20installation%20-%20ALEX%20BEVILACQUA" data-bs-toggle="tooltip" data-bs-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram" > <i class="fa-fw fab fa-telegram"></i> </a> <a href="https://www.linkedin.com/sharing/share-offsite/?url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2016%2F02%2F10%2Frecovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Linkedin" target="_blank" rel="noopener" aria-label="Linkedin" > <i class="fa-fw fab fa-linkedin"></i> </a> <a href="http://service.weibo.com/share/share.php?title=Recovering%20a%20WiredTiger%20collection%20from%20a%20corrupt%20MongoDB%20installation%20-%20ALEX%20BEVILACQUA&url=https%3A%2F%2Fwww.alexbevi.com%2Fblog%2F2016%2F02%2F10%2Frecovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation%2F" data-bs-toggle="tooltip" data-bs-placement="top" title="Weibo" target="_blank" rel="noopener" aria-label="Weibo" > <i class="fa-fw fab fa-weibo"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 ps-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content list-unstyled ps-0 pb-1 ms-1 mt-2"><li class="text-truncate lh-lg"> <a href="/blog/2023/11/29/gateway/">Frederik Pohl's Gateway (Legend Entertainment) - 1992</a><li class="text-truncate lh-lg"> <a href="/blog/2021/07/28/adventure-games-1980-1999/">Let's Adventure! A Journey into Adventure Games (1980-1999)</a><li class="text-truncate lh-lg"> <a href="/blog/2021/08/08/adventure-games-1980-1999-sorted-by-score/">Let's Adventure! Reviewed Games Sorted by Score</a><li class="text-truncate lh-lg"> <a href="/blog/2023/11/24/the-legend-of-kyrandia/">The Legend of Kyrandia: Fables and Fiends (Westwood Studios) - 1992</a><li class="text-truncate lh-lg"> <a href="/blog/2023/11/13/querysrv-errors-when-connecting-to-mongodb-atlas/">querySrv errors when connecting to MongoDB Atlas</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/snes/">snes</a></div></div></div><div id="toc-wrapper" class="ps-0 pe-4 mb-5"><div class="panel-heading ps-3 pt-2 mb-2">Contents</div><nav id="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-3 pe-xl-4 mt-5"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ms-1" data-toc-skip> Further Reading</h3><div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4 mb-4"><div class="col"> <a href="/blog/2023/01/12/live-migration-of-sharded-clusters-can-result-in-toomanylogicalsessions/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1673554490" data-df="ll" > Jan 12, 2023 </em><h4 class="pt-0 my-2" data-toc-skip>Live Migration of Sharded Clusters to MongoDB Atlas could result in <tt>TooManyLogicalSessions</tt> Errors</h4><div class="text-muted small"><p> The following is more of a diagnostic journey than anything else, and does not reflect a current issue with MongoDB Atlas. While I was still working as a Technical Services Engineer at MongoDB...</p></div></div></a></div><div class="col"> <a href="/blog/2016/02/10/identifying-failing-system-dot-js-functions-in-mongodb/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1455135476" data-df="ll" > Feb 10, 2016 </em><h4 class="pt-0 my-2" data-toc-skip>Identifying failing system.js functions in MongoDB</h4><div class="text-muted small"><p> laptop(mongod-3.2.1) test&amp;gt; db.loadServerScripts() 2016-02-10T15:18:42.322-0500 E QUERY [thread1] SyntaxError: unterminated string literal : DB.prototype.loadServerScripts/&amp;lt;@src/mongo/shell...</p></div></div></a></div><div class="col"> <a href="/blog/2018/05/28/troubleshooting-a-mongodb-performance-issue/" class="card post-preview h-100"><div class="card-body"> <em class="small" data-ts="1527513243" data-df="ll" > May 28, 2018 </em><h4 class="pt-0 my-2" data-toc-skip>Troubleshooting a MongoDB Performance Issue</h4><div class="text-muted small"><p> UPDATE (2018-06-28): I actually sent a link to this article to the author of the previous blog post and in her reply she indicates that the improvements to cache management and checkpoint areas wer...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/blog/2016/02/10/identifying-failing-system-dot-js-functions-in-mongodb/" class="btn btn-outline-primary" prompt="Older" ><p>Identifying failing system.js functions in MongoDB</p></a> <a href="/blog/2016/02/23/just-finished-shadowrun/" class="btn btn-outline-primary" prompt="Newer" ><p>Just Finished - Shadowrun</p></a></div><div id="disqus_thread" class="pt-2 pb-2"><p class="text-center text-muted small">Comments powered by <a href="https://disqus.com/">Disqus</a>.</p></div><script type="text/javascript"> var disqus_config = function () { this.page.url = 'https://www.alexbevi.com/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/'; this.page.identifier = '/blog/2016/02/10/recovering-a-wiredtiger-collection-from-a-corrupt-mongodb-installation/'; }; /* Lazy loading */ var disqus_observer = new IntersectionObserver( function (entries) { if (entries[0].isIntersecting) { (function () { var d = document, s = d.createElement('script'); s.src = 'https://alexbevi.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); disqus_observer.disconnect(); } }, { threshold: [0] } ); disqus_observer.observe(document.querySelector('#disqus_thread')); /* Auto switch theme */ function reloadDisqus() { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* Disqus hasn't been loaded */ if (typeof DISQUS === 'undefined') { return; } if (document.readyState == 'complete') { DISQUS.reset({ reload: true, config: disqus_config }); } } } if (document.querySelector('.mode-toggle')) { window.addEventListener('message', reloadDisqus); } </script></div></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 me-3"> <a class="post-tag btn btn-outline-primary" href="/tags/adventure/">adventure</a> <a class="post-tag btn btn-outline-primary" href="/tags/mongodb/">mongodb</a> <a class="post-tag btn btn-outline-primary" href="/tags/sierra-on-line/">Sierra On-Line</a> <a class="post-tag btn btn-outline-primary" href="/tags/redmine/">redmine</a> <a class="post-tag btn btn-outline-primary" href="/tags/rpg/">rpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/ruby/">ruby</a> <a class="post-tag btn btn-outline-primary" href="/tags/book/">book</a> <a class="post-tag btn btn-outline-primary" href="/tags/drivers/">drivers</a> <a class="post-tag btn btn-outline-primary" href="/tags/jrpg/">jrpg</a> <a class="post-tag btn btn-outline-primary" href="/tags/snes/">snes</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div></div><footer><div class="container px-lg-4"><div class="d-flex justify-content-center align-items-center text-muted mx-md-3"><p>Using the <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> theme <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a></p><p>© 2023 <a href="https://twitter.com/alexbevi">Alex Bevilacqua</a>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span></p></div></div></footer><div id="mask"></div><button id="back-to-top" aria-label="back-to-top" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-bs-animation="true" data-bs-autohide="false" ><div class="toast-header"> <button type="button" class="btn-close ms-auto" data-bs-dismiss="toast" aria-label="Close" ></button></div><div class="toast-body text-center pt-0"><p class="px-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="/assets/lib/jquery/jquery.min.js"></script> <script src="/assets/lib/bootstrap/bootstrap.bundle.min.js"></script> <script src="/assets/lib/simple-jekyll-search/simple-jekyll-search.min.js"></script> <script src="/assets/lib/lazysizes/lazysizes.min.js"></script> <script src="/assets/lib/magnific-popup/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/clipboard/clipboard.min.js"></script> <script src="/assets/lib/dayjs/dayjs.min.js"></script> <script src="/assets/lib/dayjs/locale/en.min.js"></script> <script src="/assets/lib/dayjs/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs/plugin/localizedFormat.min.js"></script> <script src="/assets/lib/tocbot/tocbot.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=UA-36490021-1"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-36490021-1'); }); </script> <script> /* Note: dependent library will be loaded in `js-selector.html` */ SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="px-1 px-sm-2 px-lg-4 px-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5"></p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
